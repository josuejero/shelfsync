This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.github/
  ISSUE_TEMPLATE/
    bug_report.yml
    feature_request.yml
  workflows/
    ci.yml
    codeql.yml
  dependabot.yml
  PULL_REQUEST_TEMPLATE.md
apps/
  web/
    src/
      app/
        api/
          proxy/
            sse/
              route.ts
        books/
          [id]/
            page.tsx
        dashboard/
          matches/
            page.tsx
          page.tsx
        notifications/
          page.tsx
        settings/
          goodreads/
            page.tsx
          page.tsx
        signin/
          page.tsx
        signup/
          page.tsx
        globals.css
        layout.tsx
        page.test.tsx
        page.tsx
      components/
        AuthGuard.tsx
        NotificationBell.tsx
        TryDemoButton.tsx
      hooks/
        useSyncRun.ts
      lib/
        api.ts
        readNext.ts
        syncRuns.ts
      test/
        msw/
          handlers.ts
          server.ts
        setup.ts
    .env.local.example
    .eslintrc.json
    next-env.d.ts
    next.config.mjs
    package.json
    postcss.config.js
    tailwind.config.js
    tsconfig.json
    tsconfig.tsbuildinfo
    vitest.config.ts
docs/
  adr/
    0001-tech-stack.md
    0002-goodreads-ingestion.md
  openapi/
    goodreads-mock.yaml
  architecture.md
infra/
  docker-compose.full.yml
  docker-compose.yml
  goodreads-mock.yaml
mock/
  goodreads/
    export.csv
    shelf.xml
scripts/
  dev-env.sh
  dev.sh
services/
  api/
    alembic/
      versions/
        06ccc00c800a_phase7_notifications.py
        156614e6d7d6_phase4_seed_libraries.py
        32191e629780_add_sync_runs_table.py
        8399dceac96e_phase1_init_schema.py
        8f008b42145c_phase2_ingestion_fields.py
        b2c2190162bb_phase3_catalog_matching.py
        bedca43b8c03_phase3_catalog_matching.py
        c7a5b2b4af1e_add_missing_shelf_columns.py
      env.py
      README
      script.py.mako
    app/
      api/
        routes/
          auth.py
          books.py
          dashboard.py
          health.py
          libraries.py
          matching.py
          notifications.py
          settings.py
          shelf_items.py
          shelf_sources.py
          sync_runs.py
        __init__.py
        deps.py
        rate_limit.py
        router.py
      core/
        config.py
        otel.py
        redis_client.py
        redis.py
        security.py
      crud/
        availability.py
        catalog_matches.py
        notifications.py
        shelf_items.py
        sync_runs.py
      db/
        session.py
      domain/
        normalize.py
      fixtures/
        catalog_fixture.json
      ingestion/
        csv_import.py
        fetch.py
        rss.py
      middleware/
        request_id.py
      models/
        __init__.py
        availability_snapshot.py
        base.py
        catalog_item.py
        catalog_match.py
        library.py
        notification_event.py
        shelf_item.py
        shelf_source.py
        sync_run.py
        user_settings.py
        user.py
      providers/
        factory.py
        fixture_provider.py
        types.py
      schemas/
        auth.py
        books.py
        dashboard.py
        library.py
        matching.py
        notifications.py
        settings.py
        shelf.py
        sync_run.py
      services/
        catalog/
          factory.py
          fixture_provider.py
          overdrive_provider.py
          provider.py
          types.py
        matching/
          matcher.py
          persist.py
        read_next/
          scoring.py
        availability_cache.py
        goodreads_csv.py
        goodreads_rss.py
        import_service.py
        normalization.py
        read_next_scoring.py
        shelf_import.py
      workers/
        async_utils.py
        events.py
        jobs.py
        queue.py
        redis_conn.py
      __init__.py
      main.py
    bin/
      alembic
    tests/
      conftest.py
      test_auth.py
      test_goodreads_csv_parser.py
      test_goodreads_rss_parser.py
      test_health.py
      test_matching.py
      test_notifications.py
      test_read_next_scoring.py
      test_shelf_import_idempotent.py
      test_sync_runs.py
    .dockerignore
    .env.example
    alembic.ini
    Dockerfile
    requirements-dev.txt
    requirements.txt
.editorconfig
.gitignore
.nvmrc
.python-version
CODE_OF_CONDUCT.md
cookies.txt
LICENSE
Makefile
pyproject.toml
README.md
SECURITY.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="apps/web/src/app/notifications/page.tsx">
"use client";

import Link from "next/link";
import { useEffect, useState } from "react";

import { AuthGuard } from "@/components/AuthGuard";
import { apiFetch } from "@/lib/api";

type NotificationOut = {
  id: string;
  created_at: string;
  read_at: string | null;
  shelf_item_id: string;
  title: string;
  author: string | null;
  format: string;
  old_status: string;
  new_status: string;
  deep_link: string | null;
};

type NotificationListOut = {
  page: { total: number; limit: number; offset: number };
  items: NotificationOut[];
};

export default function NotificationsPage() {
  const [data, setData] = useState<NotificationListOut | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [unreadOnly, setUnreadOnly] = useState(true);

  async function load() {
    setLoading(true);
    setError(null);
    try {
      const res = await apiFetch<NotificationListOut>(
        `/v1/notifications?limit=100&offset=0&unread_only=${unreadOnly ? "true" : "false"}`
      );
      setData(res);
    } catch (e) {
      setError(String(e));
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [unreadOnly]);

  async function markRead(id: string) {
    await apiFetch<void>(`/v1/notifications/${id}/read`, { method: "POST" });
    await load();
  }

  async function markAllRead() {
    await apiFetch<{ updated: number }>(`/v1/notifications/mark-all-read`, { method: "POST" });
    await load();
  }

  return (
    <AuthGuard>
      <main className="p-6 max-w-4xl mx-auto">
        <div className="flex items-center justify-between gap-4">
          <div>
            <Link href="/dashboard" className="text-sm text-blue-600 hover:underline">
              ‚Üê Back to dashboard
            </Link>
            <h1 className="text-2xl font-semibold mt-2">Notifications</h1>
            <p className="text-sm text-gray-600">Items that became available recently.</p>
          </div>
          <button
            onClick={markAllRead}
            className="rounded border px-3 py-2 text-sm hover:bg-gray-50"
          >
            Mark all read
          </button>
        </div>

        <div className="mt-4 flex items-center gap-2 text-sm">
          <label className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={unreadOnly}
              onChange={(e) => setUnreadOnly(e.target.checked)}
            />
            Show unread only
          </label>
        </div>

        {loading ? <div className="mt-6 text-sm text-gray-600">Loading‚Ä¶</div> : null}
        {error ? <div className="mt-6 text-sm text-red-600">{error}</div> : null}

        {!loading && data && data.items.length === 0 ? (
          <div className="mt-6 rounded border p-4 text-sm text-gray-600">No notifications yet.</div>
        ) : null}

        <div className="mt-6 space-y-3">
          {data?.items.map((n) => (
            <div key={n.id} className="rounded border p-4">
              <div className="flex items-start justify-between gap-4">
                <div>
                  <div className="text-sm text-gray-500">
                    {new Date(n.created_at).toLocaleString()} ‚Ä¢ {n.format}
                  </div>
                  <div className="mt-1 font-medium">
                    <Link href={`/books/${n.shelf_item_id}`} className="hover:underline">
                      {n.title}
                    </Link>
                  </div>
                  {n.author ? <div className="text-sm text-gray-600">{n.author}</div> : null}

                  <div className="mt-2 text-sm">
                    <span className="font-medium">Status:</span> {n.old_status} ‚Üí {n.new_status}
                  </div>

                  {n.deep_link ? (
                    <div className="mt-2">
                      <a
                        href={n.deep_link}
                        target="_blank"
                        rel="noreferrer"
                        className="text-sm text-blue-600 hover:underline"
                      >
                        Open in library
                      </a>
                    </div>
                  ) : null}
                </div>

                {n.read_at ? (
                  <span className="text-xs text-gray-500">Read</span>
                ) : (
                  <button
                    onClick={() => markRead(n.id)}
                    className="rounded border px-3 py-2 text-sm hover:bg-gray-50"
                  >
                    Mark read
                  </button>
                )}
              </div>
            </div>
          ))}
        </div>
      </main>
    </AuthGuard>
  );
}
</file>

<file path="apps/web/src/components/NotificationBell.tsx">
"use client";

import Link from "next/link";
import { useEffect, useRef, useState } from "react";

import { apiFetch } from "@/lib/api";

type UnreadCountOut = { unread: number };

export function NotificationBell() {
  const [unread, setUnread] = useState<number>(0);
  const startedRef = useRef(false);

  async function loadCount() {
    try {
      const res = await apiFetch<UnreadCountOut>("/v1/notifications/unread-count");
      setUnread(res.unread);
    } catch {
      // ignore
    }
  }

  useEffect(() => {
    if (startedRef.current) return;
    startedRef.current = true;

    let alive = true;
    let pollTimer: ReturnType<typeof setInterval> | null = null;

    loadCount();

    // Live updates (SSE). If it fails, fall back to polling.
    const url = `/api/proxy/sse?path=${encodeURIComponent("/v1/notifications/events")}`;
    const es = new EventSource(url);

    es.onmessage = (evt) => {
      if (!alive) return;
      try {
        const msg = JSON.parse(evt.data);
        if (msg?.type === "notification") {
          setUnread((n) => n + 1);
        }
      } catch {
        // ignore
      }
    };

    es.onerror = () => {
      if (!alive) return;
      es.close();

      // fallback polling every 30s
      if (!pollTimer) {
        pollTimer = setInterval(() => {
          if (!alive) return;
          loadCount();
        }, 30_000);
      }
    };

    return () => {
      alive = false;
      es.close();
      if (pollTimer) clearInterval(pollTimer);
    };
  }, []);

  return (
    <Link
      href="/notifications"
      className="relative inline-flex items-center justify-center rounded border px-3 py-2 text-sm hover:bg-gray-50"
      aria-label="Notifications"
      title="Notifications"
    >
      <span aria-hidden>üîî</span>
      {unread > 0 ? (
        <span className="absolute -top-2 -right-2 min-w-[1.25rem] h-5 px-1 rounded-full bg-red-600 text-white text-xs flex items-center justify-center">
          {unread}
        </span>
      ) : null}
    </Link>
  );
}
</file>

<file path="services/api/alembic/versions/06ccc00c800a_phase7_notifications.py">
"""phase7 notifications

Revision ID: 06ccc00c800a
Revises: 32191e629780
Create Date: 2025-12-25 14:42:40.739694

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '06ccc00c800a'
down_revision: Union[str, Sequence[str], None] = '32191e629780'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    pass


def downgrade() -> None:
    """Downgrade schema."""
    pass
</file>

<file path="services/api/app/api/routes/notifications.py">
from __future__ import annotations

import json
from datetime import datetime, timezone
from typing import AsyncGenerator

from app.api.deps import get_current_user
from app.api.rate_limit import rate_limiter
from app.core.config import settings
from app.core.redis import get_redis_async
from app.crud.notifications import list_notifications, mark_all_read, mark_read, unread_count
from app.db.session import get_db
from app.schemas.notifications import (
    NotificationListOut,
    NotificationOut,
    PageOut,
    UnreadCountOut,
)
from fastapi import APIRouter, Depends, HTTPException, Query
from fastapi.responses import StreamingResponse
from sqlalchemy.orm import Session

router = APIRouter(prefix="/v1", tags=["notifications"])


@router.get(
    "/notifications",
    response_model=NotificationListOut,
    dependencies=[Depends(rate_limiter("notifications", limit=120, window_seconds=60))],
)
def get_notifications(
    *,
    limit: int = Query(50, ge=1, le=200),
    offset: int = Query(0, ge=0),
    unread_only: bool = Query(False),
    db: Session = Depends(get_db),
    user=Depends(get_current_user),
):
    total, rows = list_notifications(
        db,
        user_id=user.id,
        unread_only=unread_only,
        limit=limit,
        offset=offset,
    )

    items = [
        NotificationOut(
            id=r.event.id,
            created_at=r.event.created_at,
            read_at=r.event.read_at,
            shelf_item_id=r.event.shelf_item_id,
            title=r.title,
            author=r.author,
            format=r.event.format,
            old_status=r.event.old_status,
            new_status=r.event.new_status,
            deep_link=r.event.deep_link,
        )
        for r in rows
    ]

    return NotificationListOut(page=PageOut(limit=limit, offset=offset, total=total), items=items)


@router.get(
    "/notifications/unread-count",
    response_model=UnreadCountOut,
    dependencies=[Depends(rate_limiter("notifications_unread", limit=240, window_seconds=60))],
)
def get_unread_count(
    db: Session = Depends(get_db),
    user=Depends(get_current_user),
):
    return UnreadCountOut(unread=unread_count(db, user_id=user.id))


@router.post(
    "/notifications/{notification_id}/read",
    status_code=204,
    dependencies=[Depends(rate_limiter("notifications_mark_read", limit=240, window_seconds=60))],
)
def mark_notification_read(
    notification_id: str,
    db: Session = Depends(get_db),
    user=Depends(get_current_user),
):
    ok = mark_read(db, user_id=user.id, notification_id=notification_id)
    if not ok:
        raise HTTPException(status_code=404, detail="Notification not found")
    return None


@router.post(
    "/notifications/mark-all-read",
    dependencies=[Depends(rate_limiter("notifications_mark_all", limit=60, window_seconds=60))],
)
def mark_all_notifications_read(
    db: Session = Depends(get_db),
    user=Depends(get_current_user),
):
    n = mark_all_read(db, user_id=user.id)
    return {"updated": n}


@router.get("/notifications/events")
async def stream_notifications(
    user=Depends(get_current_user),
) -> StreamingResponse:
    redis_client = get_redis_async(settings.redis_url)
    channel = f"notify:{user.id}"

    async def event_generator() -> AsyncGenerator[str, None]:
        pubsub = redis_client.pubsub()
        await pubsub.subscribe(channel)

        # Basic keepalive to help proxies (optional)
        last_keepalive = datetime.now(timezone.utc)

        try:
            async for message in pubsub.listen():
                now = datetime.now(timezone.utc)

                # Keepalive comment every ~25s
                if (now - last_keepalive).total_seconds() > 25:
                    yield ": keepalive\n\n"
                    last_keepalive = now

                if message is None:
                    continue
                if message.get("type") != "message":
                    continue

                data_raw = message.get("data")
                if isinstance(data_raw, (bytes, bytearray)):
                    data_str = data_raw.decode("utf-8")
                else:
                    data_str = str(data_raw)

                payload = json.loads(data_str)
                payload.setdefault("ts", now.isoformat())

                yield f"data: {json.dumps(payload)}\n\n"
        finally:
            await pubsub.unsubscribe(channel)
            await pubsub.close()

    return StreamingResponse(event_generator(), media_type="text/event-stream")
</file>

<file path="services/api/app/crud/notifications.py">
from __future__ import annotations

from dataclasses import dataclass
from datetime import datetime, timezone

from app.models.notification_event import NotificationEvent
from app.models.shelf_item import ShelfItem
from sqlalchemy import func, select, update
from sqlalchemy.orm import Session


def utcnow() -> datetime:
    return datetime.now(timezone.utc)


@dataclass(frozen=True)
class NotificationRow:
    event: NotificationEvent
    title: str
    author: str | None


def unread_count(db: Session, *, user_id: str) -> int:
    return int(
        db.execute(
            select(func.count())
            .select_from(NotificationEvent)
            .where(NotificationEvent.user_id == user_id, NotificationEvent.read_at.is_(None))
        ).scalar_one()
    )


def list_notifications(
    db: Session,
    *,
    user_id: str,
    unread_only: bool,
    limit: int,
    offset: int,
) -> tuple[int, list[NotificationRow]]:
    base = (
        select(NotificationEvent, ShelfItem.title, ShelfItem.author)
        .join(ShelfItem, ShelfItem.id == NotificationEvent.shelf_item_id)
        .where(NotificationEvent.user_id == user_id)
    )
    if unread_only:
        base = base.where(NotificationEvent.read_at.is_(None))

    total = int(db.execute(select(func.count()).select_from(base.subquery())).scalar_one())

    stmt = base.order_by(NotificationEvent.created_at.desc()).limit(limit).offset(offset)

    rows: list[NotificationRow] = []
    for ev, title, author in db.execute(stmt).all():
        rows.append(NotificationRow(event=ev, title=title, author=author))

    return total, rows


def mark_read(db: Session, *, user_id: str, notification_id: str) -> bool:
    ev = db.get(NotificationEvent, notification_id)
    if ev is None or ev.user_id != user_id:
        return False

    if ev.read_at is None:
        ev.read_at = utcnow()
        db.add(ev)
        db.commit()
    return True


def mark_all_read(db: Session, *, user_id: str) -> int:
    now = utcnow()
    res = db.execute(
        update(NotificationEvent)
        .where(NotificationEvent.user_id == user_id, NotificationEvent.read_at.is_(None))
        .values(read_at=now)
    )
    db.commit()
    return int(res.rowcount or 0)
</file>

<file path="services/api/app/models/notification_event.py">
from __future__ import annotations

from datetime import datetime, timezone
from uuid import uuid4

from app.models.base import Base
from sqlalchemy import DateTime, ForeignKey, String
from sqlalchemy.orm import Mapped, mapped_column


def utcnow() -> datetime:
    return datetime.now(timezone.utc)


class NotificationEvent(Base):
    __tablename__ = "notification_events"

    id: Mapped[str] = mapped_column(
        String(36), primary_key=True, default=lambda: str(uuid4())
    )

    user_id: Mapped[str] = mapped_column(
        String(36),
        ForeignKey("users.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
    )

    shelf_item_id: Mapped[str] = mapped_column(
        String(36),
        ForeignKey("shelf_items.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
    )

    format: Mapped[str] = mapped_column(String(20), nullable=False)
    old_status: Mapped[str] = mapped_column(String(20), nullable=False)
    new_status: Mapped[str] = mapped_column(String(20), nullable=False)

    deep_link: Mapped[str | None] = mapped_column(String(500), nullable=True)

    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), default=utcnow, nullable=False, index=True
    )
    read_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True), nullable=True)
</file>

<file path="services/api/app/schemas/notifications.py">
from __future__ import annotations

from datetime import datetime

from pydantic import BaseModel


class NotificationOut(BaseModel):
    id: str
    created_at: datetime
    read_at: datetime | None

    shelf_item_id: str
    title: str
    author: str | None

    format: str
    old_status: str
    new_status: str
    deep_link: str | None


class PageOut(BaseModel):
    limit: int
    offset: int
    total: int


class NotificationListOut(BaseModel):
    page: PageOut
    items: list[NotificationOut]


class UnreadCountOut(BaseModel):
    unread: int
</file>

<file path="services/api/tests/test_notifications.py">
from app.crud.availability import upsert_snapshots
from app.models import AvailabilitySnapshot, CatalogItem, CatalogMatch, ShelfItem, User, UserSettings
from app.providers.types import AvailabilityResult
from app.services.catalog.types import ProviderAvailability, Format, AvailabilityStatus


def test_notification_created_on_hold_to_available(db_session):
    user = User(email="a@example.com", hashed_password="x")
    db_session.add(user)
    db_session.commit()

    db_session.add(
        UserSettings(
            user_id=user.id,
            library_system="demo",
            preferred_formats=["ebook"],
            notifications_enabled=True,
        )
    )

    shelf_item = ShelfItem(user_id=user.id, title="T", author="A")
    db_session.add(shelf_item)

    catalog_item = CatalogItem(
        id="c1",
        provider="fixture",
        provider_item_id="p1",
        title="T",
        author="A",
    )
    db_session.add(catalog_item)

    db_session.add(
        CatalogMatch(
            user_id=user.id,
            shelf_item_id=shelf_item.id,
            catalog_item_id=catalog_item.id,
            provider="fixture",
            method="exact",
            confidence=1.0,
        )
    )

    # Existing snapshot: hold
    db_session.add(
        AvailabilitySnapshot(
            user_id=user.id,
            catalog_item_id=catalog_item.id,
            format="ebook",
            status="hold",
            copies_available=0,
            copies_total=1,
            holds=5,
            deep_link=None,
            last_checked_at=None,
        )
    )
    db_session.commit()

    # New result: available
    a = ProviderAvailability(
        provider="fixture",
        provider_item_id="p1",
        format=Format.ebook,
        status=AvailabilityStatus.available,
        copies_available=1,
        copies_total=1,
        holds=0,
        deep_link=None,
    )

    created = upsert_snapshots(
        db_session,
        user_id=user.id,
        results=[AvailabilityResult(catalog_item_id=catalog_item.id, availability=a)],
    )

    assert len(created) == 1


def test_notifications_respect_user_setting(db_session):
    user = User(email="b@example.com", hashed_password="x")
    db_session.add(user)
    db_session.commit()

    db_session.add(
        UserSettings(
            user_id=user.id,
            library_system="demo",
            preferred_formats=["ebook"],
            notifications_enabled=False,
        )
    )
    db_session.commit()

    a = ProviderAvailability(
        provider="fixture",
        provider_item_id="p1",
        format=Format.ebook,
        status=AvailabilityStatus.available,
        copies_available=1,
        copies_total=1,
        holds=0,
        deep_link=None,
    )

    created = upsert_snapshots(
        db_session,
        user_id=user.id,
        results=[AvailabilityResult(catalog_item_id="c1", availability=a)],
    )

    assert created == []
</file>

<file path=".github/ISSUE_TEMPLATE/bug_report.yml">
name: Bug report
description: Report a problem
body:
  - type: textarea
    id: repro
    attributes:
      label: Repro steps
      description: Steps to reproduce
    validations:
      required: true
  - type: textarea
    id: expected
    attributes:
      label: Expected
    validations:
      required: true
  - type: textarea
    id: actual
    attributes:
      label: Actual
    validations:
      required: true
</file>

<file path=".github/ISSUE_TEMPLATE/feature_request.yml">
name: Feature request
description: Propose a feature for ShelfSync
body:
  - type: textarea
    id: problem
    attributes:
      label: Problem
      description: What user problem does this solve?
    validations:
      required: true
  - type: textarea
    id: proposal
    attributes:
      label: Proposal
      description: What should we build?
    validations:
      required: true
</file>

<file path=".github/workflows/ci.yml">
name: CI

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  api:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/api
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v6
        with:
          python-version: "3.14"
          cache: "pip"
          cache-dependency-path: services/api/requirements-dev.txt
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt
      - run: black --check .
      - run: isort --check-only .
      - run: mypy app || true
      - run: pytest

  web:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: apps/web/package-lock.json
      - run: npm ci
      - run: npm run lint
      - run: npm run build
</file>

<file path=".github/workflows/codeql.yml">
name: CodeQL

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    - cron: "0 6 * * 1"

permissions:
  contents: read

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ["javascript", "python"]
    steps:
      - uses: actions/checkout@v5
      - uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
      - uses: github/codeql-action/autobuild@v3
      - uses: github/codeql-action/analyze@v3
</file>

<file path=".github/dependabot.yml">
version: 2
updates:
  - package-ecosystem: "npm"
    directory: "/apps/web"
    schedule:
      interval: "weekly"
  - package-ecosystem: "pip"
    directory: "/services/api"
    schedule:
      interval: "weekly"
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "weekly"
</file>

<file path=".github/PULL_REQUEST_TEMPLATE.md">
## Summary

## Acceptance criteria
- [ ] Phase 0 CI passes
- [ ] Includes tests or explains why not

## Testing
- [ ] API: pytest
- [ ] Web: npm run lint && npm run build

## Notes
</file>

<file path="apps/web/src/app/api/proxy/sse/route.ts">
import { NextRequest } from "next/server";

export const runtime = "nodejs";

export async function GET(req: NextRequest) {
  const path = req.nextUrl.searchParams.get("path");
  if (!path) {
    return new Response("Missing path", { status: 400 });
  }

  const apiBase = process.env.NEXT_PUBLIC_API_BASE_URL || "http://localhost:8000";
  const targetUrl = new URL(path, apiBase);

  const res = await fetch(targetUrl, {
    method: "GET",
    headers: {
      // forward cookies for auth
      cookie: req.headers.get("cookie") || "",
      accept: "text/event-stream",
    },
    cache: "no-store",
  });

  return new Response(res.body, {
    status: res.status,
    headers: {
      "content-type": "text/event-stream",
      "cache-control": "no-cache, no-transform",
      connection: "keep-alive",
    },
  });
}
</file>

<file path="apps/web/src/app/dashboard/matches/page.tsx">
"use client";

import { apiFetch } from "@/lib/api";
import { useEffect, useState } from "react";

type Availability = {
  format: string;
  status: string;
  copies_available: number | null;
  copies_total: number | null;
  holds: number | null;
  deep_link: string | null;
  last_checked_at: string;
};

type MatchRow = {
  shelf_item_id: string;
  method: string;
  confidence: number;
  evidence: Record<string, unknown>;
  catalog_item: {
    id: string;
    provider: string;
    provider_item_id: string;
    title: string;
    author: string | null;
    isbn10: string | null;
    isbn13: string | null;
    asin: string | null;
  };
  availability: Availability[];
};

type JobStatus = {
  id: string;
  status: string;
  result: Record<string, unknown> | null;
  exc_info: string | null;
};

export default function MatchesPage() {
  const [rows, setRows] = useState<MatchRow[]>([]);
  const [loading, setLoading] = useState(false);
  const [job, setJob] = useState<JobStatus | null>(null);
  const [error, setError] = useState<string | null>(null);

  async function loadRows() {
    const data = await apiFetch<MatchRow[]>("/v1/matches");
    setRows(data);
  }

  useEffect(() => {
    loadRows().catch((e) => setError(String(e)));
  }, []);

  async function refresh() {
    setError(null);
    setLoading(true);
    try {
      const { job_id } = await apiFetch<{ job_id: string }>("/v1/matching/refresh", {
        method: "POST",
      });

      // Poll status. Keep it simple; a websocket can come later.
      for (let i = 0; i < 30; i++) {
        const st = await apiFetch<JobStatus>(`/v1/matching/refresh/${job_id}`);
        setJob(st);
        if (st.status === "finished" || st.status === "failed") break;
        await new Promise((r) => setTimeout(r, 1000));
      }

      await loadRows();
    } catch (e) {
      setError(String(e));
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="p-6 space-y-4">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-semibold">Matches</h1>
        <button
          className="px-3 py-2 rounded bg-black text-white disabled:opacity-50"
          onClick={refresh}
          disabled={loading}
        >
          {loading ? "Refreshing‚Ä¶" : "Refresh matches"}
        </button>
      </div>

      {error && <div className="p-3 rounded bg-red-50 text-red-800">{error}</div>}

      {job && (
        <div className="p-3 rounded bg-gray-50 text-sm">
          <div>
            Job: <span className="font-mono">{job.id}</span> ({job.status})
          </div>
          {job.exc_info && <div className="text-red-700">{job.exc_info}</div>}
          {job.result && <pre className="mt-2 overflow-auto">{JSON.stringify(job.result, null, 2)}</pre>}
        </div>
      )}

      <div className="space-y-3">
        {rows.length === 0 ? (
          <div className="text-gray-600">No matches yet. Import shelf items (Phase 2) and refresh.</div>
        ) : (
          rows.map((r) => (
            <div key={r.shelf_item_id} className="border rounded p-4">
              <div className="flex items-start justify-between gap-4">
                <div>
                  <div className="font-medium">{r.catalog_item.title}</div>
                  {r.catalog_item.author && <div className="text-sm text-gray-600">{r.catalog_item.author}</div>}
                  <div className="text-xs text-gray-500">
                    {r.method} ¬∑ confidence {r.confidence.toFixed(2)} ¬∑ {r.catalog_item.provider}:{r.catalog_item.provider_item_id}
                  </div>
                </div>
              </div>

              <div className="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2">
                {r.availability.map((a) => (
                  <div key={a.format} className="rounded bg-gray-50 p-3 text-sm">
                    <div className="font-medium">{a.format}</div>
                    <div>Status: {a.status}</div>
                    {typeof a.copies_total === "number" && (
                      <div>
                        Copies: {a.copies_available ?? "?"}/{a.copies_total}
                      </div>
                    )}
                    {typeof a.holds === "number" && <div>Holds: {a.holds}</div>}
                    {a.deep_link && (
                      <a className="text-blue-700 underline" href={a.deep_link} target="_blank" rel="noreferrer">
                        Open
                      </a>
                    )}
                  </div>
                ))}
              </div>

              <details className="mt-3">
                <summary className="cursor-pointer text-sm text-gray-700">Why this match?</summary>
                <pre className="mt-2 overflow-auto text-xs bg-gray-50 p-3 rounded">{JSON.stringify(r.evidence, null, 2)}</pre>
              </details>
            </div>
          ))
        )}
      </div>
    </div>
  );
}
</file>

<file path="apps/web/src/app/settings/goodreads/page.tsx">
"use client";

import { apiFetch } from "@/lib/api";
import { useEffect, useState } from "react";

type ShelfSource = {
  id: string;
  source_type: string;
  provider: string;
  source_ref: string;
  meta: Record<string, unknown>;
  is_active: boolean;
  last_synced_at: string | null;
  last_sync_status: string | null;
  last_sync_error: string | null;
};

type ShelfItem = {
  id: string;
  title: string;
  author: string;
  isbn10: string | null;
  isbn13: string | null;
  asin: string | null;
  shelf: string | null;
  needs_fuzzy_match: boolean;
};

type ImportSummary = {
  created: number;
  updated: number;
  skipped: number;
  errors: { key: string; error: string }[];
};

export default function GoodreadsSettingsPage() {
  const [rssUrl, setRssUrl] = useState("http://localhost:4010/mock/goodreads/shelf/demo/read/rss");
  const [shelf, setShelf] = useState("to-read");

  const [rssSource, setRssSource] = useState<ShelfSource | null>(null);
  const [items, setItems] = useState<ShelfItem[]>([]);
  const [summary, setSummary] = useState<ImportSummary | null>(null);

  const [csvFile, setCsvFile] = useState<File | null>(null);

  const [busy, setBusy] = useState(false);
  const [error, setError] = useState<string | null>(null);

  async function refreshItems(sourceId?: string) {
    const qs = new URLSearchParams();
    if (sourceId) qs.set("source_id", sourceId);
    const rows = await apiFetch<ShelfItem[]>(`/v1/shelf-items?${qs.toString()}`);
    setItems(rows);
  }

  async function connectRss() {
    setBusy(true);
    setError(null);
    setSummary(null);
    try {
      const src = await apiFetch<ShelfSource>("/v1/shelf-sources/rss", {
        method: "POST",
        body: JSON.stringify({ rss_url: rssUrl, shelf, sync_now: true }),
      });
      setRssSource(src);

      // Let the worker run; poll once after a short delay.
      setTimeout(() => {
        refreshItems(src.id).catch(() => undefined);
      }, 750);
    } catch (e: any) {
      setError(e?.message || String(e));
    } finally {
      setBusy(false);
    }
  }

  async function syncNow() {
    if (!rssSource) return;
    setBusy(true);
    setError(null);
    try {
      await apiFetch<{ job_id: string }>(`/v1/shelf-sources/${rssSource.id}/sync`, { method: "POST" });
      setTimeout(() => {
        refreshItems(rssSource.id).catch(() => undefined);
      }, 750);
    } catch (e: any) {
      setError(e?.message || String(e));
    } finally {
      setBusy(false);
    }
  }

  async function disconnect() {
    if (!rssSource) return;
    setBusy(true);
    setError(null);
    try {
      await apiFetch<void>(`/v1/shelf-sources/${rssSource.id}`, { method: "DELETE" });
      setRssSource(null);
      setItems([]);
    } catch (e: any) {
      setError(e?.message || String(e));
    } finally {
      setBusy(false);
    }
  }

  async function uploadCsv() {
    if (!csvFile) return;
    setBusy(true);
    setError(null);
    setSummary(null);
    try {
      const fd = new FormData();
      fd.append("file", csvFile);
      const res = await apiFetch<ImportSummary>("/v1/shelf-sources/csv", {
        method: "POST",
        body: fd,
      });
      setSummary(res);
      await refreshItems();
    } catch (e: any) {
      setError(e?.message || String(e));
    } finally {
      setBusy(false);
    }
  }

  useEffect(() => {
    // Load items on first open (works even before connecting)
    refreshItems().catch(() => undefined);
  }, []);

  return (
    <main className="min-h-screen p-8">
      <div className="mx-auto max-w-3xl space-y-8">
        <header className="space-y-2">
          <h1 className="text-3xl font-bold">Goodreads</h1>
          <p className="text-gray-600">Connect an RSS shelf or upload a Goodreads CSV export.</p>
        </header>

        {error ? (
          <div className="rounded-xl border border-red-200 bg-red-50 p-4 text-sm text-red-800">
            {error}
          </div>
        ) : null}

        <section className="rounded-2xl border p-6 shadow-sm space-y-4">
          <h2 className="text-xl font-semibold">Connect RSS</h2>

          <div className="space-y-2">
            <label className="block text-sm font-medium">RSS URL (or path)</label>
            <input
              className="w-full rounded-xl border px-3 py-2"
              value={rssUrl}
              onChange={(e) => setRssUrl(e.target.value)}
              placeholder="https://www.goodreads.com/review/list_rss/..."
            />
          </div>

          <div className="space-y-2">
            <label className="block text-sm font-medium">Shelf label (stored as metadata)</label>
            <input className="w-full rounded-xl border px-3 py-2" value={shelf} onChange={(e) => setShelf(e.target.value)} />
          </div>

          <div className="flex flex-wrap gap-2">
            <button
              className="rounded-xl bg-black px-4 py-2 text-white disabled:opacity-60"
              onClick={connectRss}
              disabled={busy}
            >
              Connect & Import
            </button>

            <button
              className="rounded-xl border px-4 py-2 disabled:opacity-60"
              onClick={syncNow}
              disabled={busy || !rssSource}
            >
              Re-import (Sync)
            </button>

            <button
              className="rounded-xl border px-4 py-2 disabled:opacity-60"
              onClick={disconnect}
              disabled={busy || !rssSource}
            >
              Disconnect
            </button>
          </div>

          {rssSource ? (
            <div className="text-sm text-gray-700">
              <div>
                <span className="font-medium">Connected:</span> {rssSource.source_ref}
              </div>
              <div>
                <span className="font-medium">Last sync:</span> {rssSource.last_synced_at || "(not yet)"}
              </div>
              {rssSource.last_sync_status === "error" ? (
                <div className="text-red-700">{rssSource.last_sync_error}</div>
              ) : null}
            </div>
          ) : (
            <div className="text-sm text-gray-500">No RSS source connected yet.</div>
          )}
        </section>

        <section className="rounded-2xl border p-6 shadow-sm space-y-4">
          <h2 className="text-xl font-semibold">CSV Upload (fallback)</h2>
          <p className="text-sm text-gray-600">
            Export from Goodreads: <span className="font-medium">My Books ‚Üí Import and Export ‚Üí Export Library</span>.
          </p>

          <input
            type="file"
            accept=".csv"
            onChange={(e) => setCsvFile(e.target.files?.[0] || null)}
          />

          <button
            className="rounded-xl bg-black px-4 py-2 text-white disabled:opacity-60"
            onClick={uploadCsv}
            disabled={busy || !csvFile}
          >
            Upload & Import
          </button>

          {summary ? (
            <div className="rounded-xl border bg-gray-50 p-4 text-sm">
              <div className="font-medium">Import summary</div>
              <div>Created: {summary.created}</div>
              <div>Updated: {summary.updated}</div>
              <div>Skipped: {summary.skipped}</div>
              {summary.errors?.length ? (
                <div className="mt-2">
                  <div className="font-medium">Errors</div>
                  <ul className="list-disc pl-5">
                    {summary.errors.slice(0, 20).map((e) => (
                      <li key={`${e.key}-${e.error}`}>{e.key}: {e.error}</li>
                    ))}
                  </ul>
                </div>
              ) : null}
            </div>
          ) : null}
        </section>

        <section className="rounded-2xl border p-6 shadow-sm space-y-4">
          <h2 className="text-xl font-semibold">Imported shelf items</h2>
          <div className="text-sm text-gray-600">Showing most recently updated first.</div>

          <div className="divide-y rounded-xl border">
            {items.length === 0 ? (
              <div className="p-4 text-sm text-gray-500">No items yet. Connect RSS or upload CSV.</div>
            ) : (
              items.map((b) => (
                <div key={b.id} className="p-4">
                  <div className="font-medium">{b.title}</div>
                  <div className="text-sm text-gray-700">{b.author}</div>
                  <div className="mt-1 text-xs text-gray-500">
                    {b.isbn13 ? `ISBN13: ${b.isbn13}` : b.isbn10 ? `ISBN: ${b.isbn10}` : b.asin ? `ASIN: ${b.asin}` : "No ISBN (fuzzy match later)"}
                    {b.shelf ? ` ¬∑ shelf: ${b.shelf}` : ""}
                    {b.needs_fuzzy_match ? " ¬∑ needs match" : ""}
                  </div>
                </div>
              ))
            )}
          </div>
        </section>
      </div>
    </main>
  );
}
</file>

<file path="apps/web/src/app/settings/page.tsx">
"use client";

import Link from "next/link";
import { useEffect, useMemo, useState } from "react";

import { AuthGuard } from "@/components/AuthGuard";
import { apiFetch } from "@/lib/api";

type SettingsOut = { library_system: string | null; preferred_formats: string[]; updated_at: string };
type LibraryOut = { id: string; name: string };

export default function SettingsPage() {
  const [settings, setSettings] = useState<SettingsOut | null>(null);
  const [libraries, setLibraries] = useState<LibraryOut[]>([]);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [ok, setOk] = useState<string | null>(null);

  const [librarySystem, setLibrarySystem] = useState<string>("");
  const [formats, setFormats] = useState<{ ebook: boolean; audiobook: boolean }>({ ebook: true, audiobook: false });

  useEffect(() => {
    (async () => {
      try {
        const [s, libs] = await Promise.all([
          apiFetch<SettingsOut>("/v1/settings"),
          apiFetch<LibraryOut[]>("/v1/libraries"),
        ]);
        setSettings(s);
        setLibraries(libs);
        setLibrarySystem(s.library_system ?? "");
        setFormats({ ebook: s.preferred_formats.includes("ebook"), audiobook: s.preferred_formats.includes("audiobook") });
      } catch (e) {
        const msg = e instanceof Error ? e.message : "Failed to load settings.";
        setError(msg);
      }
    })();
  }, []);

  const preferredFormats = useMemo(() => {
    const out: string[] = [];
    if (formats.ebook) out.push("ebook");
    if (formats.audiobook) out.push("audiobook");
    // Always keep at least one format selected
    return out.length ? out : ["ebook"];
  }, [formats]);

  async function save() {
    setOk(null);
    setError(null);
    setSaving(true);
    try {
      const res = await apiFetch<SettingsOut>("/v1/settings", {
        method: "PATCH",
        body: JSON.stringify({
          library_system: librarySystem || null,
          preferred_formats: preferredFormats,
        }),
      });
      setSettings(res);
      setOk("Saved.");
    } catch (e) {
      const msg = e instanceof Error ? e.message : "Failed to save.";
      setError(msg);
    } finally {
      setSaving(false);
    }
  }

  return (
    <AuthGuard>
      <main className="min-h-screen px-6 py-10">
        <div className="mx-auto flex max-w-3xl flex-col gap-6">
          <header className="rounded-3xl border border-black/10 bg-white/70 p-6 shadow-sm">
            <div className="flex items-center justify-between gap-4">
              <div>
                <h1 className="font-display text-3xl tracking-tight">Preferences</h1>
                <p className="text-sm text-black/60">Choose your library and formats.</p>
              </div>
              <div className="flex items-center gap-2 text-sm">
                <Link className="rounded-full border border-black/10 px-4 py-2 hover:bg-black/5" href="/dashboard">
                  Back
                </Link>
                <Link className="rounded-full border border-black/10 px-4 py-2 hover:bg-black/5" href="/settings/goodreads">
                  Import/Connect
                </Link>
              </div>
            </div>
          </header>

          <section className="rounded-3xl border border-black/10 bg-white/70 p-6 shadow-sm">
            {error ? (
              <div className="mb-4 rounded-2xl border border-red-200 bg-red-50 p-4 text-sm text-red-900">{error}</div>
            ) : null}
            {ok ? (
              <div className="mb-4 rounded-2xl border border-emerald-200 bg-emerald-50 p-4 text-sm text-emerald-900">
                {ok}
              </div>
            ) : null}

            <div className="space-y-5">
              <div>
                <label className="mb-1 block text-sm font-medium">Library</label>
                <select
                  value={librarySystem}
                  onChange={(e) => setLibrarySystem(e.target.value)}
                  className="w-full rounded-2xl border border-black/10 bg-white px-4 py-2 text-sm"
                >
                  <option value="">‚Äî Select a library ‚Äî</option>
                  {libraries.map((l) => (
                    <option key={l.id} value={l.id}>
                      {l.name} ({l.id})
                    </option>
                  ))}
                </select>
                <p className="mt-2 text-xs text-black/60">Library selection is used to scope availability lookups and caching.</p>
              </div>

              <div>
                <label className="mb-1 block text-sm font-medium">Preferred formats</label>
                <div className="flex flex-wrap gap-3 text-sm">
                  <label className="flex items-center gap-2">
                    <input
                      type="checkbox"
                      checked={formats.ebook}
                      onChange={(e) => setFormats((f) => ({ ...f, ebook: e.target.checked }))}
                    />
                    Ebook
                  </label>
                  <label className="flex items-center gap-2">
                    <input
                      type="checkbox"
                      checked={formats.audiobook}
                      onChange={(e) => setFormats((f) => ({ ...f, audiobook: e.target.checked }))}
                    />
                    Audiobook
                  </label>
                </div>
                <p className="mt-2 text-xs text-black/60">At least one format must be selected.</p>
              </div>

              <div className="flex items-center justify-between">
                <div className="text-xs text-black/60">
                  Last updated: {settings?.updated_at ? new Date(settings.updated_at).toLocaleString() : "‚Äî"}
                </div>
                <button
                  onClick={save}
                  disabled={saving}
                  className="rounded-full bg-black px-5 py-2 text-sm text-white disabled:opacity-60"
                >
                  {saving ? "Saving‚Ä¶" : "Save"}
                </button>
              </div>
            </div>
          </section>
        </div>
      </main>
    </AuthGuard>
  );
}
</file>

<file path="apps/web/src/app/signin/page.tsx">
"use client";

import { apiFetch } from "@/lib/api";
import { useRouter } from "next/navigation";
import { useState } from "react";

type UserOut = { id: string; email: string };

export default function SignInPage() {
  const router = useRouter();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError(null);
    setLoading(true);
    try {
      await apiFetch<UserOut>("/v1/auth/login", {
        method: "POST",
        body: JSON.stringify({ email, password }),
      });
      router.push("/dashboard");
    } catch (err: any) {
      setError(err?.message ?? "Sign in failed");
    } finally {
      setLoading(false);
    }
  }

  return (
    <main className="min-h-screen p-8">
      <div className="mx-auto max-w-md space-y-6">
        <h1 className="text-3xl font-bold">Sign in</h1>

        {error && (
          <div className="rounded-xl border border-red-200 bg-red-50 p-3 text-sm">
            {error}
          </div>
        )}

        <form onSubmit={onSubmit} className="space-y-4">
          <label className="block space-y-1">
            <span className="text-sm font-medium">Email</span>
            <input
              className="w-full rounded-lg border p-2"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              type="email"
              required
              autoComplete="email"
            />
          </label>

          <label className="block space-y-1">
            <span className="text-sm font-medium">Password</span>
            <input
              className="w-full rounded-lg border p-2"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              type="password"
              required
              minLength={8}
              autoComplete="current-password"
            />
          </label>

          <button
            disabled={loading}
            className="w-full rounded-lg bg-black px-4 py-2 text-white disabled:opacity-50"
          >
            {loading ? "Signing in‚Ä¶" : "Sign in"}
          </button>
        </form>

        <p className="text-sm text-gray-600">
          New here? <a className="underline" href="/signup">Create an account</a>
        </p>
      </div>
    </main>
  );
}
</file>

<file path="apps/web/src/app/signup/page.tsx">
"use client";

import { apiFetch } from "@/lib/api";
import { useRouter } from "next/navigation";
import { useState } from "react";

type UserOut = { id: string; email: string };

export default function SignUpPage() {
  const router = useRouter();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError(null);
    setLoading(true);
    try {
      await apiFetch<UserOut>("/v1/auth/signup", {
        method: "POST",
        body: JSON.stringify({ email, password }),
      });
      router.push("/dashboard");
    } catch (err: any) {
      setError(err?.message ?? "Sign up failed");
    } finally {
      setLoading(false);
    }
  }

  return (
    <main className="min-h-screen p-8">
      <div className="mx-auto max-w-md space-y-6">
        <h1 className="text-3xl font-bold">Create account</h1>

        {error && (
          <div className="rounded-xl border border-red-200 bg-red-50 p-3 text-sm">
            {error}
          </div>
        )}

        <form onSubmit={onSubmit} className="space-y-4">
          <label className="block space-y-1">
            <span className="text-sm font-medium">Email</span>
            <input
              className="w-full rounded-lg border p-2"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              type="email"
              required
              autoComplete="email"
            />
          </label>

          <label className="block space-y-1">
            <span className="text-sm font-medium">Password</span>
            <input
              className="w-full rounded-lg border p-2"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              type="password"
              required
              minLength={8}
              autoComplete="new-password"
            />
          </label>

          <button
            disabled={loading}
            className="w-full rounded-lg bg-black px-4 py-2 text-white disabled:opacity-50"
          >
            {loading ? "Creating‚Ä¶" : "Create account"}
          </button>
        </form>

        <p className="text-sm text-gray-600">
          Already have an account? <a className="underline" href="/signin">Sign in</a>
        </p>
      </div>
    </main>
  );
}
</file>

<file path="apps/web/src/app/page.test.tsx">
/// <reference types="vitest" />

import { render, screen } from "@testing-library/react";

beforeAll(() => {
  process.env.NEXT_PUBLIC_API_BASE_URL = "http://localhost:8000";
});

test("renders the hero title", async () => {
  const { default: Home } = await import("./page");
  render(<Home />);

  expect(screen.getByText("ShelfSync")).toBeInTheDocument();
});
</file>

<file path="apps/web/src/components/AuthGuard.tsx">
"use client";

import { apiFetch } from "@/lib/api";
import { useRouter } from "next/navigation";
import { useEffect, useState } from "react";

type UserOut = { id: string; email: string };

export function AuthGuard({ children }: { children: React.ReactNode }) {
  const router = useRouter();
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState<UserOut | null>(null);

  useEffect(() => {
    let alive = true;
    (async () => {
      try {
        const me = await apiFetch<UserOut>("/v1/auth/me");
        if (!alive) return;
        setUser(me);
      } catch {
        router.push("/signin");
      } finally {
        if (alive) setLoading(false);
      }
    })();
    return () => {
      alive = false;
    };
  }, [router]);

  if (loading) {
    return <div className="p-8 text-sm text-gray-600">Checking session‚Ä¶</div>;
  }

  if (!user) return null;

  return <>{children}</>;
}
</file>

<file path="apps/web/src/components/TryDemoButton.tsx">
"use client";

import { apiFetch } from "@/lib/api";
import { useRouter } from "next/navigation";
import { useState } from "react";

const DEMO_EMAIL = "demo@example.com";
const DEMO_PASSWORD = "password123";
const DEMO_RSS_URL = "https://www.goodreads.com/shelf/rss?user=demo&shelf=read";

type TryDemoButtonProps = {
  className?: string;
};

export function TryDemoButton({ className }: TryDemoButtonProps) {
  const router = useRouter();
  const [pending, setPending] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const label = pending ? "Loading demo..." : "Try demo data";

  async function handleClick() {
    setError(null);
    setPending(true);

    try {
      await apiFetch("/v1/auth/login", {
        method: "POST",
        body: JSON.stringify({ email: DEMO_EMAIL, password: DEMO_PASSWORD }),
      });

      await apiFetch("/v1/shelf-sources/rss", {
        method: "POST",
        body: JSON.stringify({ rss_url: DEMO_RSS_URL, shelf_name: "Demo shelf" }),
      });

      router.push("/dashboard");
    } catch (err) {
      const message = err instanceof Error ? err.message : "Unable to load demo data.";
      setError(message);
    } finally {
      setPending(false);
    }
  }

  const buttonClassName = `${className ?? ""} disabled:opacity-60 disabled:cursor-not-allowed`;

  return (
    <div className="space-y-2">
      <button className={buttonClassName} disabled={pending} onClick={handleClick}>
        {label}
      </button>
      {error ? <p className="text-xs text-[var(--accent)]">{error}</p> : null}
    </div>
  );
}
</file>

<file path="apps/web/src/hooks/useSyncRun.ts">
"use client";

import { getSyncRun, startAvailabilityRefresh, subscribeSyncRun, SyncRun } from "@/lib/syncRuns";
import { useCallback, useEffect, useRef, useState } from "react";

export function useSyncRun() {
  const [run, setRun] = useState<SyncRun | null>(null);
  const [error, setError] = useState<string | null>(null);
  const unsubscribeRef = useRef<null | (() => void)>(null);

  const stop = useCallback(() => {
    unsubscribeRef.current?.();
    unsubscribeRef.current = null;
  }, []);

  const start = useCallback(async () => {
    setError(null);
    stop();

    const created = await startAvailabilityRefresh();
    setRun(created);

    unsubscribeRef.current = subscribeSyncRun(created.id, (evt) => {
      const t = evt.type;
      if (t === "progress") {
        setRun((r) =>
          r
            ? {
                ...r,
                status: "running",
                progress_current: evt.payload.current,
                progress_total: evt.payload.total,
              }
            : r
        );
      }
      if (t === "failed") {
        setRun((r) => (r ? { ...r, status: "failed", error_message: evt.payload.message } : r));
        stop();
      }
      if (t === "succeeded") {
        setRun((r) => (r ? { ...r, status: "succeeded", progress_current: r.progress_total } : r));
        stop();
      }
    });

    // Fallback polling in case SSE disconnects
    const poll = async () => {
      try {
        const fresh = await getSyncRun(created.id);
        setRun(fresh);
        if (fresh.status === "succeeded" || fresh.status === "failed") return;
        setTimeout(poll, 2500);
      } catch {
        setTimeout(poll, 2500);
      }
    };

    setTimeout(poll, 2500);
  }, [stop]);

  useEffect(() => {
    return () => stop();
  }, [stop]);

  return { run, error, start, stop };
}
</file>

<file path="apps/web/src/lib/readNext.ts">
export type ReadNext = {
  score: number;
  tier: string;
  best_format: string | null;
  hold_ratio: number | null;
  reasons: string[];
};

export function compareReadNext(
  a: { title: string; author?: string | null; shelf_item_id?: string; read_next?: ReadNext },
  b: { title: string; author?: string | null; shelf_item_id?: string; read_next?: ReadNext },
) {
  const sa = a.read_next?.score ?? -Infinity;
  const sb = b.read_next?.score ?? -Infinity;
  if (sa !== sb) return sb - sa; // desc

  const ta = (a.title ?? "").toLowerCase();
  const tb = (b.title ?? "").toLowerCase();
  if (ta < tb) return -1;
  if (ta > tb) return 1;

  const aa = (a.author ?? "").toLowerCase();
  const ab = (b.author ?? "").toLowerCase();
  if (aa < ab) return -1;
  if (aa > ab) return 1;

  const ida = a.shelf_item_id ?? "";
  const idb = b.shelf_item_id ?? "";
  if (ida < idb) return -1;
  if (ida > idb) return 1;

  return 0;
}

export function readNextTooltip(rn?: ReadNext) {
  if (!rn) return "No Read Next score";
  const lines = [`Score: ${rn.score.toFixed(1)}`, ...rn.reasons];
  return lines.join("\n");
}
</file>

<file path="apps/web/src/lib/syncRuns.ts">
import { apiFetch } from "@/lib/api";

export type SyncRun = {
  id: string;
  kind: string;
  status: "queued" | "running" | "succeeded" | "failed";
  progress_current: number;
  progress_total: number;
  error_message?: string | null;
  started_at?: string | null;
  finished_at?: string | null;
  created_at: string;
};

export async function startAvailabilityRefresh(): Promise<SyncRun> {
  return apiFetch<SyncRun>("/v1/sync-runs", {
    method: "POST",
    body: JSON.stringify({ kind: "availability_refresh" }),
  });
}

export async function getSyncRun(id: string): Promise<SyncRun> {
  return apiFetch<SyncRun>(`/v1/sync-runs/${id}`);
}

export function subscribeSyncRun(id: string, onEvent: (evt: any) => void) {
  const es = new EventSource(`/api/proxy/sse?path=/v1/sync-runs/${id}/events`);

  es.addEventListener("sync", (e) => {
    try {
      onEvent(JSON.parse((e as MessageEvent).data));
    } catch {
      // ignore
    }
  });

  es.onerror = () => {
    // Let caller decide fallback.
  };

  return () => es.close();
}
</file>

<file path="apps/web/src/test/msw/handlers.ts">
import { http, HttpResponse } from "msw";

export const handlers = [
  http.get("*/health", () => HttpResponse.json({ ok: true })),
];
</file>

<file path="apps/web/src/test/msw/server.ts">
import { setupServer } from "msw/node";

import { handlers } from "./handlers";

export const server = setupServer(...handlers);
</file>

<file path="apps/web/src/test/setup.ts">
import "@testing-library/jest-dom/vitest";
import { afterAll, afterEach, beforeAll, vi } from "vitest";

import { server } from "./msw/server";

vi.mock("next/navigation", () => ({
  useRouter: () => ({
    push: vi.fn(),
  }),
}));

beforeAll(() => server.listen({ onUnhandledRequest: "error" }));
afterEach(() => server.resetHandlers());
afterAll(() => server.close());
</file>

<file path="apps/web/.env.local.example">
NEXT_PUBLIC_API_BASE_URL=http://localhost:8000
</file>

<file path="apps/web/.eslintrc.json">
{
  "extends": ["next/core-web-vitals"]
}
</file>

<file path="apps/web/next-env.d.ts">
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/building-your-application/configuring/typescript for more information.
</file>

<file path="apps/web/next.config.mjs">
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true
};

export default nextConfig;
</file>

<file path="apps/web/postcss.config.js">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {}
  }
};
</file>

<file path="apps/web/tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: ["./src/**/*.{js,ts,jsx,tsx,mdx}"],
  theme: {
    extend: {}
  },
  plugins: []
};
</file>

<file path="apps/web/vitest.config.ts">
import react from "@vitejs/plugin-react";
import path from "node:path";
import { defineConfig } from "vitest/config";

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./src"),
    },
  },
  test: {
    environment: "jsdom",
    setupFiles: ["src/test/setup.ts"],
    globals: true,
    css: true,
  },
});
</file>

<file path="docs/adr/0001-tech-stack.md">
# ADR 0001: Tech stack

## Status
Accepted

## Context
ShelfSync needs a fast-to-demo full-stack portfolio project with modern tooling, strong local dev ergonomics, and a clear path to deployment.

## Decision
- Web: Next.js + React + TypeScript + Tailwind
- API: FastAPI + Uvicorn + Pydantic
- Data: Postgres + SQLAlchemy + Alembic
- Caching/queue: Redis
- HTTP: httpx

## Consequences
- Great developer experience and hiring-manager familiarity.
- Python backend supports data parsing and automation easily.
- Clear hosting story: Vercel + Koyeb + Supabase + Upstash.
</file>

<file path="docs/adr/0002-goodreads-ingestion.md">
# 0002: Goodreads ingestion strategy

## Status
Accepted

## Context
We need a reliable way to ingest a user‚Äôs Goodreads shelves into ShelfSync.

## Decision
Use RSS as the primary ingestion mechanism and CSV as a fallback.

## Consequences
- RSS allows periodic background sync.
- CSV supports users who cannot access RSS.
- Idempotency is enforced by external IDs when present.
</file>

<file path="docs/openapi/goodreads-mock.yaml">
openapi: 3.0.3
info:
  title: Goodreads Mock
  version: "0.2.0"
servers:
  - url: http://localhost:4010
paths:
  /health:
    get:
      responses:
        "200":
          description: ok
          content:
            application/json:
              example:
                status: ok
  /shelf/rss:
    get:
      parameters:
        - name: user
          in: query
          schema:
            type: string
        - name: shelf
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Sample RSS feed
          content:
            application/rss+xml:
              schema:
                type: string
              examples:
                sample:
                  summary: Sample shelf RSS feed
                  externalValue: mock/goodreads/shelf.xml
  /shelf/export.csv:
    get:
      parameters:
        - name: user
          in: query
          schema:
            type: string
        - name: shelf
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Goodreads export CSV
          content:
            text/csv:
              schema:
                type: string
              examples:
                sample:
                  summary: Sample Goodreads export
                  externalValue: mock/goodreads/export.csv
</file>

<file path="docs/architecture.md">
# Architecture (Phase 0)

## High-level

- `apps/web` is a Next.js UI.
- `services/api` is a FastAPI backend.
- `infra/docker-compose.yml` runs local Postgres + Redis.

## Data flow (today)

Web -> API: health checks only.

## Data flow (planned)

Web -> API -> Goodreads + Library adapters -> normalized database -> jobs/streams -> UI.
</file>

<file path="infra/docker-compose.full.yml">
services:
  api:
    build:
      context: ../services/api
    command: sh -c "python -m alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8000"
    environment:
      DATABASE_URL: postgresql+psycopg2://shelfsync:shelfsync@postgres:5432/shelfsync
      REDIS_URL: redis://redis:6379/0
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
</file>

<file path="infra/goodreads-mock.yaml">
openapi: 3.0.3
info:
  title: Goodreads Mock
  version: "0.1.0"
paths:
  /health:
    get:
      responses:
        "200":
          description: ok
          content:
            application/json:
              example:
                status: ok
  /shelf/rss:
    get:
      parameters:
        - name: user
          in: query
          schema:
            type: string
        - name: shelf
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Sample RSS feed
          content:
            application/rss+xml:
              example: |
                <?xml version="1.0" encoding="UTF-8"?>
                <rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/">
                  <channel>
                    <title>Goodreads Shelf</title>
                    <item>
                      <title>The Great Gatsby</title>
                      <dc:creator>F. Scott Fitzgerald</dc:creator>
                      <link>https://www.goodreads.com/book/show/4671.The_Great_Gatsby</link>
                      <description><![CDATA[ISBN: 9780743273565]]></description>
                    </item>
                  </channel>
                </rss>
</file>

<file path="mock/goodreads/export.csv">
Title,Author,ISBN13,ISBN,ASIN
The Great Gatsby,F. Scott Fitzgerald,9780743273565,0743273567,B000FC1PWA
Pride and Prejudice,Jane Austen,9780141439518,0141439513,B000QCS8TW
Neuromancer,William Gibson,9780441569595,0441569595,B000FC2L5M
</file>

<file path="mock/goodreads/shelf.xml">
<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <title>Goodreads Shelf</title>
    <item>
      <title>The Great Gatsby</title>
      <dc:creator>F. Scott Fitzgerald</dc:creator>
      <link>https://www.goodreads.com/book/show/4671.The_Great_Gatsby</link>
      <description><![CDATA[ISBN: 9780743273565 ASIN: B000FC1PWA]]></description>
    </item>
    <item>
      <title>Pride and Prejudice</title>
      <dc:creator>Jane Austen</dc:creator>
      <link>https://www.goodreads.com/book/show/1885.Pride_and_Prejudice</link>
      <description><![CDATA[ISBN13: 9780141439518 ASIN: B000QCS8TW]]></description>
    </item>
  </channel>
</rss>
</file>

<file path="scripts/dev-env.sh">
#!/usr/bin/env bash

script_path=""
if [[ -n "${BASH_SOURCE[0]-}" ]]; then
  script_path="${BASH_SOURCE[0]}"
elif [[ -n "${ZSH_VERSION-}" ]]; then
  script_path="${(%):-%x}"
else
  script_path="$0"
fi

is_sourced=false
if [[ -n "${BASH_SOURCE[0]-}" ]]; then
  [[ "${BASH_SOURCE[0]}" != "${0}" ]] && is_sourced=true
elif [[ -n "${ZSH_VERSION-}" ]]; then
  [[ "${ZSH_EVAL_CONTEXT-}" == *:file ]] && is_sourced=true
fi

saved_shell_opts=""
if [[ "$is_sourced" == true && -n "${BASH_VERSION-}" ]]; then
  saved_shell_opts="$(set +o)"
fi

if [[ -n "${ZSH_VERSION-}" ]]; then
  emulate -L sh
fi

set -euo pipefail

# Source this file to export API env vars into your shell.
ROOT_DIR="$(cd "$(dirname "$script_path")/.." && pwd)"
ENV_FILE="$ROOT_DIR/services/api/.env"

if [[ ! -f "$ENV_FILE" ]]; then
  ENV_FILE="$ROOT_DIR/services/api/.env.example"
fi

env_file_exists=true
if [[ ! -f "$ENV_FILE" ]]; then
  echo "Missing env file at services/api/.env or services/api/.env.example" >&2
  env_file_exists=false
fi

load_env() {
  local mode="${1:-export}"
  local line key value export_line

  while IFS= read -r line || [[ -n "$line" ]]; do
    line="${line%$'\r'}"
    [[ -z "$line" || "$line" == \#* ]] && continue
    [[ "$line" != *"="* ]] && continue

    key="${line%%=*}"
    value="${line#*=}"

    key="${key#export }"
    key="${key#"${key%%[![:space:]]*}"}"
    key="${key%"${key##*[![:space:]]}"}"
    [[ -z "$key" ]] && continue

    value="${value#"${value%%[![:space:]]*}"}"
    value="${value%"${value##*[![:space:]]}"}"

    if [[ "$value" == \"*\" && "$value" == *\" ]]; then
      value="${value:1:-1}"
    elif [[ "$value" == \'*\' && "$value" == *\' ]]; then
      value="${value:1:-1}"
    fi

    if [[ "$mode" == "print" ]]; then
      printf 'export %s=%q\n' "$key" "$value"
    else
      printf -v export_line 'export %s=%q' "$key" "$value"
      eval "$export_line"
    fi
  done < "$ENV_FILE"
}

usage() {
  cat <<'USAGE'
Usage:
  source scripts/dev-env.sh
  eval "$(scripts/dev-env.sh --print)"
  scripts/dev-env.sh -- <command> [args...]
USAGE
}

if [[ "$is_sourced" == false ]]; then
  if [[ "${1-}" == "--print" ]]; then
    if [[ "$env_file_exists" == true ]]; then
      load_env "print"
    fi
    exit 0
  fi

  if [[ "${1-}" == "--" ]]; then
    shift
  fi

  if [[ $# -gt 0 ]]; then
    if [[ "$env_file_exists" == true ]]; then
      load_env "export"
    fi
    exec "$@"
  fi

  usage >&2
  exit 2
fi

if [[ "$env_file_exists" == true ]]; then
  load_env "export"
fi

if [[ "$is_sourced" == true && -n "${BASH_VERSION-}" ]]; then
  eval "$saved_shell_opts"
fi
</file>

<file path="scripts/dev.sh">
#!/usr/bin/env bash
set -euo pipefail

# Phase 0: start local backing services + run web/api in watch mode

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

cd "$ROOT_DIR"

docker compose -f infra/docker-compose.yml up -d

echo "Backends are starting..."

echo "\nStarting API (FastAPI + Uvicorn reload)"
(
  cd services/api
  source .venv/bin/activate
  uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
) &

API_PID=$!

echo "\nStarting Web (Next dev server)"
(
  cd apps/web
  npm run dev
) &

WEB_PID=$!

trap 'echo "\nShutting down..."; kill $API_PID $WEB_PID; docker compose -f infra/docker-compose.yml down' INT TERM

wait
</file>

<file path="services/api/alembic/versions/32191e629780_add_sync_runs_table.py">
"""add sync_runs table

Revision ID: 32191e629780
Revises: 156614e6d7d6
Create Date: 2025-12-24 07:08:52.372695

"""

from typing import Sequence, Union

import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision: str = "32191e629780"
down_revision: Union[str, Sequence[str], None] = "156614e6d7d6"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    pass


def downgrade() -> None:
    """Downgrade schema."""
    pass
</file>

<file path="services/api/alembic/README">
Generic single-database configuration.
</file>

<file path="services/api/alembic/script.py.mako">
"""${message}

Revision ID: ${up_revision}
Revises: ${down_revision | comma,n}
Create Date: ${create_date}

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
${imports if imports else ""}

# revision identifiers, used by Alembic.
revision: str = ${repr(up_revision)}
down_revision: Union[str, Sequence[str], None] = ${repr(down_revision)}
branch_labels: Union[str, Sequence[str], None] = ${repr(branch_labels)}
depends_on: Union[str, Sequence[str], None] = ${repr(depends_on)}


def upgrade() -> None:
    """Upgrade schema."""
    ${upgrades if upgrades else "pass"}


def downgrade() -> None:
    """Downgrade schema."""
    ${downgrades if downgrades else "pass"}
</file>

<file path="services/api/app/api/routes/libraries.py">
from __future__ import annotations

from app.api.deps import get_current_user
from app.db.session import get_db
from app.models.library import Library
from app.schemas.library import LibraryOut
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

router = APIRouter(prefix="/v1", tags=["libraries"])


@router.get("/libraries", response_model=list[LibraryOut])
def list_libraries(db: Session = Depends(get_db), user=Depends(get_current_user)):
    # user dependency enforces auth
    return db.query(Library).order_by(Library.name.asc()).all()
</file>

<file path="services/api/app/api/routes/settings.py">
from __future__ import annotations

from app.api.deps import get_current_user
from app.db.session import get_db
from app.models.user_settings import UserSettings
from app.schemas.settings import SettingsPatchIn, UserSettingsOut
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session

router = APIRouter(prefix="/v1", tags=["settings"])


@router.get("/settings", response_model=UserSettingsOut)
def get_settings(db: Session = Depends(get_db), user=Depends(get_current_user)):
    s = db.get(UserSettings, user.id)
    if not s:
        raise HTTPException(status_code=404, detail="Settings not found")
    return s


@router.patch("/settings", response_model=UserSettingsOut)
def patch_settings(
    payload: SettingsPatchIn,
    db: Session = Depends(get_db),
    user=Depends(get_current_user),
):
    s = db.get(UserSettings, user.id)
    if not s:
        raise HTTPException(status_code=404, detail="Settings not found")

    if payload.library_system is not None:
        s.library_system = payload.library_system

    if payload.preferred_formats is not None:
        # Normalize + de-dupe, keep stable order ebook->audiobook
        want = []
        for fmt in ["ebook", "audiobook"]:
            if fmt in payload.preferred_formats:
                want.append(fmt)
        s.preferred_formats = want
    
    if payload.notifications_enabled is not None:
        s.notifications_enabled = payload.notifications_enabled

    db.add(s)
    db.commit()
    db.refresh(s)
    return s
</file>

<file path="services/api/app/api/__init__.py">

</file>

<file path="services/api/app/core/redis.py">
from __future__ import annotations

from functools import lru_cache

import redis
import redis.asyncio as redis_async


@lru_cache
def get_redis(url: str) -> redis.Redis:
    return redis.Redis.from_url(url, decode_responses=True)


def get_redis_async(url: str) -> redis_async.Redis:
    return redis_async.Redis.from_url(url, decode_responses=False)
</file>

<file path="services/api/app/crud/catalog_matches.py">
from __future__ import annotations

from app.models.catalog_match import CatalogMatch
from sqlalchemy import select
from sqlalchemy.orm import Session


def get_matches_for_shelf_item(
    db: Session,
    *,
    shelf_item_id: str,
    user_id: str | None = None,
    provider: str | None = None,
) -> list[CatalogMatch]:
    """Return all catalog matches for a given shelf item.

    Optional filters:
    - user_id: scope matches to a user (recommended)
    - provider: scope matches to a provider (e.g. "overdrive")
    """
    stmt = select(CatalogMatch).where(CatalogMatch.shelf_item_id == shelf_item_id)

    if user_id is not None:
        stmt = stmt.where(CatalogMatch.user_id == user_id)

    if provider is not None:
        stmt = stmt.where(CatalogMatch.provider == provider)

    # Prefer high-confidence matches first.
    stmt = stmt.order_by(CatalogMatch.confidence.desc(), CatalogMatch.updated_at.desc())

    return list(db.execute(stmt).scalars().all())
</file>

<file path="services/api/app/db/session.py">
from __future__ import annotations

from typing import Generator

from app.core.config import settings
from sqlalchemy import create_engine
from sqlalchemy.orm import Session, sessionmaker

engine = create_engine(
    settings.database_url,
    pool_pre_ping=True,
)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)


def get_db() -> Generator[Session, None, None]:
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
</file>

<file path="services/api/app/fixtures/catalog_fixture.json">
{
  "provider": "fixture",
  "items": [
    {
      "provider_item_id": "fx_001",
      "title": "Project Hail Mary",
      "author": "Andy Weir",
      "isbn13": "9780593135204",
      "formats": {
        "ebook": {
          "status": "available",
          "copies_available": 3,
          "copies_total": 8,
          "holds": 12,
          "deep_link": "https://example.invalid/libby/ebook/fx_001"
        },
        "audiobook": {
          "status": "hold",
          "copies_available": 0,
          "copies_total": 4,
          "holds": 44,
          "deep_link": "https://example.invalid/libby/audiobook/fx_001"
        }
      }
    },
    {
      "provider_item_id": "fx_002",
      "title": "The Hobbit",
      "author": "J.R.R. Tolkien",
      "isbn13": "9780547928227",
      "formats": {
        "ebook": {
          "status": "hold",
          "copies_available": 0,
          "copies_total": 2,
          "holds": 120,
          "deep_link": "https://example.invalid/libby/ebook/fx_002"
        },
        "audiobook": {
          "status": "available",
          "copies_available": 1,
          "copies_total": 2,
          "holds": 5,
          "deep_link": "https://example.invalid/libby/audiobook/fx_002"
        }
      }
    },
    {
      "provider_item_id": "fx_003",
      "title": "The Pragmatic Programmer",
      "author": "Andrew Hunt; David Thomas",
      "isbn13": "9780135957059",
      "formats": {
        "ebook": {
          "status": "not_owned",
          "deep_link": "https://example.invalid/libby/ebook/fx_003"
        },
        "audiobook": {
          "status": "not_owned",
          "deep_link": "https://example.invalid/libby/audiobook/fx_003"
        }
      }
    },
    {
      "provider_item_id": "fx_004",
      "title": "Dune",
      "author": "Frank Herbert",
      "isbn13": "9780441013593",
      "formats": {
        "ebook": {
          "status": "available",
          "copies_available": 2,
          "copies_total": 6,
          "holds": 18,
          "deep_link": "https://example.invalid/libby/ebook/fx_004"
        },
        "audiobook": {
          "status": "hold",
          "copies_available": 0,
          "copies_total": 3,
          "holds": 66,
          "deep_link": "https://example.invalid/libby/audiobook/fx_004"
        }
      }
    }
  ]
}
</file>

<file path="services/api/app/middleware/request_id.py">
import uuid

from starlette.middleware.base import BaseHTTPMiddleware


class RequestIdMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request, call_next):
        req_id = request.headers.get("X-Request-Id") or str(uuid.uuid4())
        request.state.request_id = req_id
        response = await call_next(request)
        response.headers["X-Request-Id"] = req_id
        return response
</file>

<file path="services/api/app/models/base.py">
from __future__ import annotations

from sqlalchemy.orm import DeclarativeBase


class Base(DeclarativeBase):
    pass
</file>

<file path="services/api/app/models/library.py">
from __future__ import annotations

from app.models.base import Base
from sqlalchemy import String
from sqlalchemy.orm import Mapped, mapped_column


class Library(Base):
    __tablename__ = "libraries"

    # A stable identifier you choose (later phases can replace with provider-driven IDs)
    id: Mapped[str] = mapped_column(String(80), primary_key=True)
    name: Mapped[str] = mapped_column(String(200), nullable=False)
</file>

<file path="services/api/app/providers/types.py">
from __future__ import annotations

from dataclasses import dataclass

from app.services.catalog.types import ProviderAvailability


@dataclass(frozen=True)
class AvailabilityResult:
    """Holds availability data keyed by the catalog item that owns it."""

    catalog_item_id: str
    availability: ProviderAvailability
</file>

<file path="services/api/app/schemas/books.py">
from __future__ import annotations

from datetime import datetime

from app.schemas.dashboard import AvailabilityOut, ReadNextOut
from pydantic import BaseModel


class BookDetailShelfItemOut(BaseModel):
    id: str
    title: str
    author: str | None
    isbn10: str | None
    isbn13: str | None
    asin: str | None
    shelf: str | None
    needs_fuzzy_match: bool


class BookDetailMatchOut(BaseModel):
    catalog_item_id: str
    provider: str
    provider_item_id: str
    method: str
    confidence: float


class BookDetailSourceOut(BaseModel):
    id: str
    source_type: str
    provider: str
    source_ref: str
    last_synced_at: datetime | None
    last_sync_status: str | None
    last_sync_error: str | None


class BookDetailSettingsOut(BaseModel):
    library_system: str | None
    preferred_formats: list[str]


class BookDetailOut(BaseModel):
    shelf_item: BookDetailShelfItemOut
    match: BookDetailMatchOut | None
    availability: list[AvailabilityOut]
    source: BookDetailSourceOut | None
    settings: BookDetailSettingsOut
    read_next: ReadNextOut
    generated_at: datetime
</file>

<file path="services/api/app/schemas/library.py">
from __future__ import annotations

from pydantic import BaseModel


class LibraryOut(BaseModel):
    id: str
    name: str

    class Config:
        from_attributes = True
</file>

<file path="services/api/app/schemas/matching.py">
from __future__ import annotations

from datetime import datetime

from pydantic import BaseModel


class CatalogItemOut(BaseModel):
    id: str
    provider: str
    provider_item_id: str
    title: str
    author: str | None
    isbn10: str | None
    isbn13: str | None
    asin: str | None


class AvailabilityOut(BaseModel):
    format: str
    status: str
    copies_available: int | None
    copies_total: int | None
    holds: int | None
    deep_link: str | None
    last_checked_at: datetime


class MatchOut(BaseModel):
    shelf_item_id: str
    catalog_item: CatalogItemOut
    method: str
    confidence: float
    evidence: dict
    availability: list[AvailabilityOut]


class RefreshEnqueuedOut(BaseModel):
    job_id: str


class JobStatusOut(BaseModel):
    id: str
    status: str
    created_at: datetime | None
    started_at: datetime | None
    ended_at: datetime | None
    result: dict | None
    exc_info: str | None
</file>

<file path="services/api/app/schemas/settings.py">
from __future__ import annotations

from datetime import datetime

from pydantic import BaseModel





class UserSettingsOut(BaseModel):
    library_system: str | None
    preferred_formats: list[str]
    notifications_enabled: bool
    updated_at: datetime

    class Config:
        from_attributes = True


class SettingsPatchIn(BaseModel):
    library_system: str | None = None
    preferred_formats: list[str] | None = None
    notifications_enabled: bool | None = None
</file>

<file path="services/api/app/services/catalog/factory.py">
from __future__ import annotations

from functools import lru_cache

from app.core.config import settings
from app.services.catalog.fixture_provider import FixtureProvider
from app.services.catalog.overdrive_provider import OverDriveProvider
from app.services.catalog.provider import CatalogProvider


@lru_cache
def get_provider() -> CatalogProvider:
    if settings.catalog_provider == "fixture":
        return FixtureProvider(fixture_path=settings.fixture_catalog_path)
    if settings.catalog_provider == "overdrive":
        return OverDriveProvider()
    raise ValueError(f"Unknown catalog provider: {settings.catalog_provider}")
</file>

<file path="services/api/app/services/catalog/fixture_provider.py">
from __future__ import annotations

import json
import re
from pathlib import Path

from app.services.catalog.types import (
    AvailabilityStatus,
    Format,
    ProviderAvailability,
    ProviderBook,
)


def _norm(s: str) -> str:
    s = s.lower().strip()
    s = re.sub(r"[^a-z0-9\s]", " ", s)
    s = re.sub(r"\s+", " ", s)
    return s


def _norm_isbn(s: str | None) -> str | None:
    if not s:
        return None
    digits = re.sub(r"[^0-9xX]", "", s)
    return digits.upper() if digits else None


class FixtureProvider:
    name = "fixture"

    def __init__(self, fixture_path: str):
        self.fixture_path = fixture_path
        self._data = self._load()

    def _load(self) -> dict:
        p = Path(self.fixture_path)
        if not p.exists():
            raise FileNotFoundError(f"Fixture file not found: {p}")
        raw = p.read_text(encoding="utf-8")
        return json.loads(raw)

    async def search(
        self,
        *,
        title: str | None,
        author: str | None,
        isbn10: str | None,
        isbn13: str | None,
        limit: int = 10,
    ) -> list[ProviderBook]:
        items: list[dict] = self._data.get("items", [])
        q_title = _norm(title or "")
        q_author = _norm(author or "")
        q_isbn10 = _norm_isbn(isbn10)
        q_isbn13 = _norm_isbn(isbn13)

        out: list[ProviderBook] = []
        for it in items:
            it_isbn13 = _norm_isbn(it.get("isbn13"))
            it_isbn10 = _norm_isbn(it.get("isbn10"))

            # ISBN: strongest filter
            if q_isbn13 and it_isbn13 == q_isbn13:
                out.append(self._to_book(it))
                continue
            if q_isbn10 and it_isbn10 == q_isbn10:
                out.append(self._to_book(it))
                continue

            # Otherwise: basic substring match on normalized fields
            t = _norm(it.get("title", ""))
            a = _norm(it.get("author", ""))

            if q_title and q_title not in t:
                continue
            if q_author and q_author not in a:
                # allow title-only searches
                if q_title:
                    pass
                else:
                    continue

            out.append(self._to_book(it))

        return out[:limit]

    async def availability_bulk(
        self, *, provider_item_ids: list[str]
    ) -> list[ProviderAvailability]:
        wanted = set(provider_item_ids)
        out: list[ProviderAvailability] = []

        for it in self._data.get("items", []):
            if it.get("provider_item_id") not in wanted:
                continue
            formats: dict = it.get("formats", {})
            for fmt_key, payload in formats.items():
                out.append(
                    ProviderAvailability(
                        provider=self.name,
                        provider_item_id=it["provider_item_id"],
                        format=Format(fmt_key),
                        status=AvailabilityStatus(payload["status"]),
                        copies_available=payload.get("copies_available"),
                        copies_total=payload.get("copies_total"),
                        holds=payload.get("holds"),
                        deep_link=payload.get("deep_link"),
                    )
                )

        return out

    def _to_book(self, it: dict) -> ProviderBook:
        return ProviderBook(
            provider=self.name,
            provider_item_id=it["provider_item_id"],
            title=it.get("title") or "",
            author=it.get("author"),
            isbn10=it.get("isbn10"),
            isbn13=it.get("isbn13"),
            asin=it.get("asin"),
            raw=it,
        )
</file>

<file path="services/api/app/services/catalog/provider.py">
from __future__ import annotations

from typing import Protocol

from app.services.catalog.types import ProviderAvailability, ProviderBook


class CatalogProvider(Protocol):
    name: str

    async def search(
        self,
        *,
        title: str | None,
        author: str | None,
        isbn10: str | None,
        isbn13: str | None,
        limit: int = 10,
    ) -> list[ProviderBook]: ...

    async def availability_bulk(
        self, *, provider_item_ids: list[str]
    ) -> list[ProviderAvailability]: ...
</file>

<file path="services/api/app/services/catalog/types.py">
from __future__ import annotations

from enum import Enum
from typing import Any

from pydantic import BaseModel, Field


class Format(str, Enum):
    ebook = "ebook"
    audiobook = "audiobook"


class AvailabilityStatus(str, Enum):
    available = "available"
    hold = "hold"
    not_owned = "not_owned"


class ProviderBook(BaseModel):
    provider: str
    provider_item_id: str

    title: str
    author: str | None = None

    isbn10: str | None = None
    isbn13: str | None = None
    asin: str | None = None

    # arbitrary provider metadata (deep links, formats, etc.)
    raw: dict[str, Any] = Field(default_factory=dict)


class ProviderAvailability(BaseModel):
    provider: str
    provider_item_id: str

    format: Format
    status: AvailabilityStatus

    copies_available: int | None = None
    copies_total: int | None = None
    holds: int | None = None

    deep_link: str | None = None
</file>

<file path="services/api/app/services/matching/matcher.py">
from __future__ import annotations

import re
from dataclasses import dataclass
from difflib import SequenceMatcher

from app.models.shelf_item import ShelfItem
from app.services.catalog.provider import CatalogProvider
from app.services.catalog.types import ProviderBook


def _norm_text(s: str) -> str:
    s = s.lower().strip()
    s = re.sub(r"[^a-z0-9\s]", " ", s)
    s = re.sub(r"\s+", " ", s)
    return s


def _ratio(a: str, b: str) -> float:
    if not a or not b:
        return 0.0
    return SequenceMatcher(None, a, b).ratio()


@dataclass(frozen=True)
class MatchResult:
    book: ProviderBook
    method: str  # isbn | fuzzy
    confidence: float
    evidence: dict


async def match_shelf_item(
    provider: CatalogProvider, item: ShelfItem, *, limit: int = 10
) -> MatchResult | None:
    # 1) ISBN exact
    candidates = await provider.search(
        title=item.title,
        author=item.author,
        isbn10=item.isbn10,
        isbn13=item.isbn13,
        limit=limit,
    )

    if item.isbn13:
        for c in candidates:
            if c.isbn13 and c.isbn13.replace("-", "") == item.isbn13.replace("-", ""):
                return MatchResult(
                    book=c,
                    method="isbn",
                    confidence=1.0,
                    evidence={"reason": "isbn13 exact", "candidates": [c.model_dump()]},
                )

    if item.isbn10:
        for c in candidates:
            if c.isbn10 and c.isbn10.replace("-", "") == item.isbn10.replace("-", ""):
                return MatchResult(
                    book=c,
                    method="isbn",
                    confidence=1.0,
                    evidence={"reason": "isbn10 exact", "candidates": [c.model_dump()]},
                )

    # 2) Fuzzy (title + author)
    t = _norm_text(item.title or "")
    a = _norm_text(item.author or "")

    scored: list[tuple[float, float, ProviderBook]] = []
    for c in candidates:
        ct = _norm_text(c.title or "")
        ca = _norm_text(c.author or "")
        title_score = _ratio(t, ct)
        author_score = _ratio(a, ca) if a and ca else 0.5
        combined = 0.75 * title_score + 0.25 * author_score
        scored.append((combined, title_score, c))

    if not scored:
        return None

    scored.sort(key=lambda x: (x[0], x[1]), reverse=True)
    best_combined, best_title, best = scored[0]

    # Threshold: tune later; keep conservative to avoid false positives
    if best_combined < 0.72:
        return None

    evidence = {
        "threshold": 0.72,
        "title_norm": t,
        "author_norm": a,
        "best": {
            "combined": best_combined,
            "title_score": best_title,
            "book": best.model_dump(),
        },
        "top_candidates": [
            {
                "combined": s[0],
                "title_score": s[1],
                "book": s[2].model_dump(),
            }
            for s in scored[:5]
        ],
    }

    return MatchResult(
        book=best, method="fuzzy", confidence=float(best_combined), evidence=evidence
    )
</file>

<file path="services/api/app/services/matching/persist.py">
from __future__ import annotations

from datetime import datetime, timezone

from app.models.availability_snapshot import AvailabilitySnapshot
from app.models.catalog_item import CatalogItem
from app.models.catalog_match import CatalogMatch
from app.services.catalog.types import ProviderAvailability, ProviderBook
from sqlalchemy import select
from sqlalchemy.orm import Session


def upsert_catalog_item(db: Session, book: ProviderBook) -> CatalogItem:
    existing = db.execute(
        select(CatalogItem)
        .where(CatalogItem.provider == book.provider)
        .where(CatalogItem.provider_item_id == book.provider_item_id)
    ).scalar_one_or_none()

    if existing:
        existing.title = book.title
        existing.author = book.author
        existing.isbn10 = book.isbn10
        existing.isbn13 = book.isbn13
        existing.asin = book.asin
        existing.raw = book.raw
        return existing

    item = CatalogItem(
        provider=book.provider,
        provider_item_id=book.provider_item_id,
        title=book.title,
        author=book.author,
        isbn10=book.isbn10,
        isbn13=book.isbn13,
        asin=book.asin,
        raw=book.raw,
    )
    db.add(item)
    return item


def upsert_match(
    db: Session,
    *,
    user_id: str,
    shelf_item_id: str,
    catalog_item_id: str,
    provider: str,
    method: str,
    confidence: float,
    evidence: dict,
) -> CatalogMatch:
    existing = db.execute(
        select(CatalogMatch)
        .where(CatalogMatch.user_id == user_id)
        .where(CatalogMatch.shelf_item_id == shelf_item_id)
    ).scalar_one_or_none()

    if existing:
        existing.catalog_item_id = catalog_item_id
        existing.provider = provider
        existing.method = method
        existing.confidence = confidence
        existing.evidence = evidence
        return existing

    m = CatalogMatch(
        user_id=user_id,
        shelf_item_id=shelf_item_id,
        catalog_item_id=catalog_item_id,
        provider=provider,
        method=method,
        confidence=confidence,
        evidence=evidence,
    )
    db.add(m)
    return m


def upsert_availability_snapshot(
    db: Session,
    *,
    user_id: str,
    catalog_item_id: str,
    a: ProviderAvailability,
) -> AvailabilitySnapshot:
    existing = db.execute(
        select(AvailabilitySnapshot)
        .where(AvailabilitySnapshot.user_id == user_id)
        .where(AvailabilitySnapshot.catalog_item_id == catalog_item_id)
        .where(AvailabilitySnapshot.format == a.format.value)
    ).scalar_one_or_none()

    now = datetime.now(timezone.utc)

    if existing:
        existing.status = a.status.value
        existing.copies_available = a.copies_available
        existing.copies_total = a.copies_total
        existing.holds = a.holds
        existing.deep_link = a.deep_link
        existing.last_checked_at = now
        return existing

    row = AvailabilitySnapshot(
        user_id=user_id,
        catalog_item_id=catalog_item_id,
        format=a.format.value,
        status=a.status.value,
        copies_available=a.copies_available,
        copies_total=a.copies_total,
        holds=a.holds,
        deep_link=a.deep_link,
        last_checked_at=now,
    )
    db.add(row)
    return row
</file>

<file path="services/api/app/services/read_next/scoring.py">
from __future__ import annotations

from dataclasses import dataclass
from typing import Any


def _ci(s: str | None) -> str:
    return (s or "").strip().casefold()


def _fmt(fmt: str | None) -> str:
    return _ci(fmt)


def estimate_hold_pressure(holds: int | None, copies_total: int | None) -> float | None:
    if holds is None or copies_total is None or copies_total <= 0:
        return None
    return holds / copies_total


@dataclass(frozen=True)
class ReadNextScore:
    score: float
    tier: str
    best_format: str | None
    hold_ratio: float | None
    reasons: list[str]


def score_candidates(
    availability: list[dict[str, Any]],
    preferred_formats: list[str],
) -> ReadNextScore:
    preferred = [_fmt(f) for f in preferred_formats]

    best_score = -1.0
    best_tier = "not_owned"
    best_format: str | None = None
    best_hold_ratio: float | None = None
    reasons: list[str] = []

    for a in availability:
        fmt = _fmt(a.get("format"))
        status = _ci(a.get("status"))

        copies_available = a.get("copies_available")
        copies_total = a.get("copies_total")
        holds = a.get("holds")

        tier = "not_owned"
        base = 0.0
        if status == "available" and (copies_available or 0) > 0:
            tier = "available"
            base = 100.0
        elif status in {"hold", "holds"}:
            tier = "hold"
            base = 50.0
        elif status == "not_owned":
            tier = "not_owned"
            base = 0.0
        else:
            tier = "unknown"
            base = 10.0

        fmt_bonus = 0.0
        if fmt in preferred:
            fmt_bonus = 10.0 * (len(preferred) - preferred.index(fmt))

        hold_ratio = estimate_hold_pressure(holds, copies_total)
        pressure_penalty = 0.0
        if tier == "hold" and hold_ratio is not None:
            pressure_penalty = min(25.0, hold_ratio * 5.0)

        score = base + fmt_bonus - pressure_penalty

        if score > best_score:
            best_score = score
            best_tier = tier
            best_format = fmt or None
            best_hold_ratio = hold_ratio

    reasons.append(f"tier={best_tier}")
    if best_format:
        reasons.append(f"format={best_format}")

    return ReadNextScore(
        score=float(best_score),
        tier=best_tier,
        best_format=best_format,
        hold_ratio=best_hold_ratio,
        reasons=reasons,
    )
</file>

<file path="services/api/app/services/availability_cache.py">
from __future__ import annotations

import json
from dataclasses import dataclass
from datetime import datetime, timezone

from app.core.config import settings
from app.core.redis_client import get_redis
from app.services.catalog.factory import get_provider
from app.services.catalog.types import AvailabilityStatus, Format, ProviderAvailability
from app.workers.async_utils import run_async


@dataclass(frozen=True)
class CachedAvailability:
    availability: ProviderAvailability
    last_checked_at: datetime


def _availability_key(
    *, provider: str, library_system: str, provider_item_id: str, fmt: str
) -> str:
    return f"availability:{provider}:{library_system}:{provider_item_id}:{fmt}"


def _now_utc() -> datetime:
    return datetime.now(timezone.utc)


def get_availability_cached(
    *,
    library_system: str,
    provider_item_ids: list[str],
    formats: list[str],
) -> dict[tuple[str, str], CachedAvailability]:
    """Return availability per (provider_item_id, format).

    Behavior:
    - Reads from Redis first.
    - Only calls provider for cache misses.
    - Writes misses back to Redis with TTL.

    Returns a map keyed by (provider_item_id, format).
    """

    provider = get_provider()
    provider_name = getattr(provider, "name", "unknown")

    r = get_redis()
    ttl = int(settings.availability_cache_ttl_secs)
    wanted = [(pid, fmt) for pid in provider_item_ids for fmt in formats]

    out: dict[tuple[str, str], CachedAvailability] = {}
    missing_provider_ids: set[str] = set()

    # 1) Try cache
    if r is not None:
        pipe = r.pipeline()
        keys = [
            _availability_key(
                provider=provider_name,
                library_system=library_system,
                provider_item_id=pid,
                fmt=fmt,
            )
            for (pid, fmt) in wanted
        ]
        for k in keys:
            pipe.get(k)
        values = pipe.execute()

        for (pid, fmt), raw in zip(wanted, values):
            if not raw:
                missing_provider_ids.add(pid)
                continue
            try:
                payload = json.loads(raw)
                avail = ProviderAvailability.model_validate(payload["availability"])
                last_checked = datetime.fromisoformat(payload["last_checked_at"])
                out[(pid, fmt)] = CachedAvailability(
                    availability=avail, last_checked_at=last_checked
                )
            except Exception:
                missing_provider_ids.add(pid)

    else:
        missing_provider_ids = set(provider_item_ids)

    # 2) Fetch misses
    if missing_provider_ids:
        fetched = run_async(
            provider.availability_bulk(provider_item_ids=sorted(missing_provider_ids))
        )

        checked_at = _now_utc()

        # Store provider results
        for item in fetched:
            fmt = str(item.format)
            key = (item.provider_item_id, fmt)
            out[key] = CachedAvailability(availability=item, last_checked_at=checked_at)

        # Fill any requested (pid, fmt) that provider didn't return
        for pid in missing_provider_ids:
            for fmt in formats:
                if (pid, fmt) in out:
                    continue
                out[(pid, fmt)] = CachedAvailability(
                    availability=ProviderAvailability(
                        provider=provider_name,
                        provider_item_id=pid,
                        format=Format(fmt),
                        status=AvailabilityStatus.not_owned,
                        copies_available=None,
                        copies_total=None,
                        holds=None,
                        deep_link=None,
                    ),
                    last_checked_at=checked_at,
                )

        # Write to Redis
        if r is not None:
            pipe = r.pipeline()
            for (pid, fmt), entry in out.items():
                if pid not in missing_provider_ids:
                    continue
                k = _availability_key(
                    provider=provider_name,
                    library_system=library_system,
                    provider_item_id=pid,
                    fmt=fmt,
                )
                payload = {
                    "availability": entry.availability.model_dump(mode="json"),
                    "last_checked_at": entry.last_checked_at.isoformat(),
                }
                pipe.setex(k, ttl, json.dumps(payload))
            pipe.execute()

    return out
</file>

<file path="services/api/app/services/read_next_scoring.py">
from __future__ import annotations

from dataclasses import dataclass
from typing import Any, Sequence


@dataclass(frozen=True)
class ReadNextScore:
    score: float
    tier: str  # available | hold | not_owned
    best_format: str | None
    hold_ratio: float | None
    reasons: list[str]


# Large tier weights ensure ‚Äúavailable now‚Äù dominates ‚Äúhold‚Äù, etc.
_STATUS_WEIGHT: dict[str, float] = {
    "available": 1000.0,
    "hold": 500.0,
    "not_owned": 0.0,
}


def _get(obj: Any, key: str) -> Any:
    if isinstance(obj, dict):
        return obj.get(key)
    return getattr(obj, key, None)


def compute_read_next(
    availability: Sequence[Any] | None,
    preferred_formats: Sequence[str],
) -> ReadNextScore:
    """Compute a deterministic, explainable score.

    `availability` can be a list of dicts (book detail endpoint) or a list of
    Pydantic models (dashboard endpoint).

    The algorithm:
    - Filter to preferred formats
    - Score each format candidate
    - Choose best candidate
    - Return score + tier + explanation

    NOTE: This is intentionally a pure function.
    """
    preferred = list(preferred_formats or [])
    avail = list(availability or [])

    if not avail:
        return ReadNextScore(
            score=_STATUS_WEIGHT["not_owned"],
            tier="not_owned",
            best_format=None,
            hold_ratio=None,
            reasons=[
                "No availability data (not owned or not checked yet)",
                "Tier: not_owned",
            ],
        )

    candidates: list[dict[str, Any]] = []

    for a in avail:
        fmt = _get(a, "format")
        if not fmt:
            continue
        if preferred and fmt not in preferred:
            continue

        status = _get(a, "status") or "not_owned"
        copies_available = _get(a, "copies_available")
        copies_total = _get(a, "copies_total")
        holds = _get(a, "holds")

        fmt_index = preferred.index(fmt) if (fmt in preferred) else 999
        # Earlier preferred formats get a larger, but bounded bonus.
        fmt_bonus = 20.0 / (fmt_index + 1) if fmt_index != 999 else 0.0

        base = _STATUS_WEIGHT.get(status, _STATUS_WEIGHT["not_owned"])

        hold_ratio: float | None = None
        hold_penalty = 0.0

        if status == "available":
            # Prefer more available copies, capped to avoid overpowering tier.
            ca = int(copies_available or 0)
            copies_bonus = float(min(max(ca, 0), 10))
        else:
            copies_bonus = 0.0

        if status == "hold":
            h = holds if holds is not None else None
            ct = copies_total if copies_total is not None else None

            if h is not None and ct is not None and int(ct) > 0:
                hold_ratio = float(h) / float(max(int(ct), 1))
                # penalty grows with queue ratio but is capped
                hold_penalty = min(hold_ratio * 25.0, 400.0)
            elif h is not None:
                # fallback: direct holds as penalty; also capped
                hold_penalty = min(float(h) * 2.0, 400.0)

        score = base + fmt_bonus + copies_bonus - hold_penalty

        candidates.append(
            {
                "fmt": fmt,
                "status": status,
                "score": score,
                "hold_ratio": hold_ratio,
                "copies_available": copies_available,
                "copies_total": copies_total,
                "holds": holds,
                "fmt_index": fmt_index,
            }
        )

    if not candidates:
        return ReadNextScore(
            score=_STATUS_WEIGHT["not_owned"],
            tier="not_owned",
            best_format=None,
            hold_ratio=None,
            reasons=["No preferred-format availability data", "Tier: not_owned"],
        )

    # Pick the highest numeric score. The tie-break here prefers better fmt index only
    # when scores are equal; overall stability is handled by API/UI sorting tie-breaks.
    best = max(candidates, key=lambda x: (x["score"], -x["fmt_index"]))

    tier = best["status"]
    best_format = best["fmt"]
    hold_ratio = best["hold_ratio"]

    reasons: list[str] = []

    if tier == "available":
        reasons.append(
            f"Available now in {best_format} (preferred #{best['fmt_index'] + 1})"
            if best_format in preferred
            else f"Available now in {best_format}"
        )
        if (
            best.get("copies_available") is not None
            or best.get("copies_total") is not None
        ):
            reasons.append(
                f"Copies available: {best.get('copies_available') or 0} / {best.get('copies_total') or 0}"
            )

    elif tier == "hold":
        reasons.append(
            f"On hold in {best_format} (preferred #{best['fmt_index'] + 1})"
            if best_format in preferred
            else f"On hold in {best_format}"
        )
        if (
            hold_ratio is not None
            and best.get("holds") is not None
            and best.get("copies_total") is not None
        ):
            reasons.append(
                f"Hold queue: {best.get('holds')} holds / {best.get('copies_total')} copies (ratio {hold_ratio:.2f})"
            )
        elif best.get("holds") is not None:
            reasons.append(f"Hold queue: {best.get('holds')} holds")
        else:
            reasons.append("Hold queue length unavailable")

    else:
        reasons.append("Not owned in your selected library/catalog")

    reasons.append(f"Tier: {tier}")

    return ReadNextScore(
        score=float(best["score"]),
        tier=tier,
        best_format=best_format,
        hold_ratio=hold_ratio,
        reasons=reasons,
    )
</file>

<file path="services/api/app/workers/redis_conn.py">
from __future__ import annotations

import redis
from app.core.config import settings
from redis import Redis


def get_redis_connection() -> Redis:
    """Return a Redis connection suitable for RQ (jobs + metadata)."""
    return redis.from_url(settings.redis_url)
</file>

<file path="services/api/app/__init__.py">

</file>

<file path="services/api/bin/alembic">
#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
VENV_DIR="$ROOT_DIR/.venv"
PYTHON_BIN="$VENV_DIR/bin/python"

if [[ ! -x "$PYTHON_BIN" ]]; then
  echo "Expected a virtualenv at $VENV_DIR. Create it and install requirements first." >&2
  exit 1
fi

cd "$ROOT_DIR"
exec "$PYTHON_BIN" -m alembic "$@"
</file>

<file path="services/api/tests/test_health.py">
def test_health_check(client):
    response = client.get("/health")

    assert response.status_code == 200
    assert response.json() == {"ok": True}
</file>

<file path="services/api/tests/test_read_next_scoring.py">
from app.services.read_next_scoring import compute_read_next


def test_available_beats_hold_beats_not_owned():
    preferred = ["ebook", "audiobook"]

    available = [
        {
            "format": "ebook",
            "status": "available",
            "copies_available": 1,
            "copies_total": 1,
            "holds": 0,
        }
    ]
    hold = [
        {
            "format": "ebook",
            "status": "hold",
            "copies_available": 0,
            "copies_total": 2,
            "holds": 10,
        }
    ]
    not_owned = [
        {
            "format": "ebook",
            "status": "not_owned",
            "copies_available": 0,
            "copies_total": 0,
            "holds": 0,
        }
    ]

    s1 = compute_read_next(available, preferred)
    s2 = compute_read_next(hold, preferred)
    s3 = compute_read_next(not_owned, preferred)

    assert s1.tier == "available"
    assert s2.tier == "hold"
    assert s3.tier == "not_owned"


def test_preferred_format_wins_when_same_status():
    preferred = ["ebook", "audiobook"]

    ebook_avail = [{"format": "ebook", "status": "available", "copies_available": 1}]
    audio_avail = [
        {"format": "audiobook", "status": "available", "copies_available": 1}
    ]

    s_ebook = compute_read_next(ebook_avail, preferred)
    s_audio = compute_read_next(audio_avail, preferred)

    assert s_ebook.score > s_audio.score


def test_graceful_on_missing_fields():
    preferred = ["ebook"]
    # Missing copies/holds fields should not throw.
    weird = [{"format": "ebook", "status": "hold"}]
    s = compute_read_next(weird, preferred)
    assert s.tier == "hold"
    assert isinstance(s.reasons, list)
</file>

<file path="services/api/.dockerignore">
.venv/
__pycache__/
*.py[cod]
.pytest_cache/
.mypy_cache/
.coverage
.env
dist/
build/
</file>

<file path="services/api/alembic.ini">
# A generic, single database configuration.

[alembic]
# path to migration scripts.
# this is typically a path given in POSIX (e.g. forward slashes)
# format, relative to the token %(here)s which refers to the location of this
# ini file
script_location = %(here)s/alembic

# template used to generate migration file names; The default value is %%(rev)s_%%(slug)s
# Uncomment the line below if you want the files to be prepended with date and time
# see https://alembic.sqlalchemy.org/en/latest/tutorial.html#editing-the-ini-file
# for all available tokens
# file_template = %%(year)d_%%(month).2d_%%(day).2d_%%(hour).2d%%(minute).2d-%%(rev)s_%%(slug)s

# sys.path path, will be prepended to sys.path if present.
# defaults to the current working directory.  for multiple paths, the path separator
# is defined by "path_separator" below.
prepend_sys_path = .


# timezone to use when rendering the date within the migration file
# as well as the filename.
# If specified, requires the tzdata library which can be installed by adding
# `alembic[tz]` to the pip requirements.
# string value is passed to ZoneInfo()
# leave blank for localtime
# timezone =

# max length of characters to apply to the "slug" field
# truncate_slug_length = 40

# set to 'true' to run the environment during
# the 'revision' command, regardless of autogenerate
# revision_environment = false

# set to 'true' to allow .pyc and .pyo files without
# a source .py file to be detected as revisions in the
# versions/ directory
# sourceless = false

# version location specification; This defaults
# to <script_location>/versions.  When using multiple version
# directories, initial revisions must be specified with --version-path.
# The path separator used here should be the separator specified by "path_separator"
# below.
# version_locations = %(here)s/bar:%(here)s/bat:%(here)s/alembic/versions

# path_separator; This indicates what character is used to split lists of file
# paths, including version_locations and prepend_sys_path within configparser
# files such as alembic.ini.
# The default rendered in new alembic.ini files is "os", which uses os.pathsep
# to provide os-dependent path splitting.
#
# Note that in order to support legacy alembic.ini files, this default does NOT
# take place if path_separator is not present in alembic.ini.  If this
# option is omitted entirely, fallback logic is as follows:
#
# 1. Parsing of the version_locations option falls back to using the legacy
#    "version_path_separator" key, which if absent then falls back to the legacy
#    behavior of splitting on spaces and/or commas.
# 2. Parsing of the prepend_sys_path option falls back to the legacy
#    behavior of splitting on spaces, commas, or colons.
#
# Valid values for path_separator are:
#
# path_separator = :
# path_separator = ;
# path_separator = space
# path_separator = newline
#
# Use os.pathsep. Default configuration used for new projects.
path_separator = os

# set to 'true' to search source files recursively
# in each "version_locations" directory
# new in Alembic version 1.10
# recursive_version_locations = false

# the output encoding used when revision files
# are written from script.py.mako
# output_encoding = utf-8

# database URL.  This is consumed by the user-maintained env.py script only.
# other means of configuring database URLs may be customized within the env.py
# file.
sqlalchemy.url = driver://user:pass@localhost/dbname


[post_write_hooks]
# post_write_hooks defines scripts or Python functions that are run
# on newly generated revision scripts.  See the documentation for further
# detail and examples

# format using "black" - use the console_scripts runner, against the "black" entrypoint
# hooks = black
# black.type = console_scripts
# black.entrypoint = black
# black.options = -l 79 REVISION_SCRIPT_FILENAME

# lint with attempts to fix using "ruff" - use the module runner, against the "ruff" module
# hooks = ruff
# ruff.type = module
# ruff.module = ruff
# ruff.options = check --fix REVISION_SCRIPT_FILENAME

# Alternatively, use the exec runner to execute a binary found on your PATH
# hooks = ruff
# ruff.type = exec
# ruff.executable = ruff
# ruff.options = check --fix REVISION_SCRIPT_FILENAME

# Logging configuration.  This is also consumed by the user-maintained
# env.py script only.
[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARNING
handlers = console
qualname =

[logger_sqlalchemy]
level = WARNING
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S
</file>

<file path="services/api/Dockerfile">
FROM python:3.14-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
</file>

<file path=".editorconfig">
root = true

[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
indent_style = space
indent_size = 2
trim_trailing_whitespace = true

[*.py]
indent_size = 4
</file>

<file path=".nvmrc">
24
</file>

<file path=".python-version">
3.14
</file>

<file path="CODE_OF_CONDUCT.md">

</file>

<file path="cookies.txt">
# Netscape HTTP Cookie File
# https://curl.se/docs/http-cookies.html
# This file was generated by libcurl! Edit at your own risk.

#HttpOnly_localhost	FALSE	/	FALSE	1767150950	access_token	eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2ZmE5ZTkwMi05MDc2LTQzNmMtODI5Yi0yZjA0MDkxZmU4ZGUiLCJleHAiOjE3NjcxNTA5NTB9.JEhcZx6I0SfZaY3ibfHB6UrlnUzS39_ptL_7XcistGw
</file>

<file path="LICENSE">

</file>

<file path="SECURITY.md">

</file>

<file path="apps/web/src/app/books/[id]/page.tsx">
import Link from "next/link";

import { apiFetch } from "@/lib/api";
import { compareReadNext, readNextTooltip, type ReadNext } from "@/lib/readNext";

type Availability = {
  format: string;
  status: "available" | "hold" | "not_owned";
  copies_available: number | null;
  copies_total: number | null;
  holds: number | null;
  deep_link: string | null;
  last_checked_at: string;
};

type CatalogItem = {
  id: string;
  provider: string;
  provider_item_id: string;
  title: string;
  author: string | null;
  isbn10: string | null;
  isbn13: string | null;
  asin: string | null;
};

type Match = {
  method: string;
  confidence: number;
  evidence: Record<string, unknown>;
  catalog_item: CatalogItem;
} | null;

type BookDetail = {
  shelf_item: {
    id: string;
    title: string;
    author: string;
    isbn10: string | null;
    isbn13: string | null;
    asin: string | null;
    shelf: string | null;
    needs_fuzzy_match: boolean;
    created_at: string;
  };
  source: {
    source_type: string | null;
    source_ref: string | null;
    last_synced_at: string | null;
    last_sync_status: string | null;
    last_sync_error: string | null;
  };
  match: Match;
  availability: Availability[];
  settings: {
    library_system: string | null;
    preferred_formats: string[];
    updated_at: string;
  };
  read_next: ReadNext;
};

type DashboardRow = {
  shelf_item_id: string;
  title: string;
  author: string | null;
  read_next: ReadNext;
};

type DashboardResponse = {
  items: DashboardRow[];
  page: { total: number; limit: number; offset: number };
};

export default async function BookDetailPage({ params }: { params: { id: string } }) {
  const data = await apiFetch<BookDetail>(`/v1/books/${params.id}`);

  // Compute rank by fetching the dashboard list.
  // If your library size grows, consider a dedicated rank endpoint or server-side caching.
  const dash = await apiFetch<DashboardResponse>(`/v1/dashboard?limit=500&offset=0&sort=read_next`);
  const ranked = [...dash.items].sort(compareReadNext);
  const idx = ranked.findIndex((r) => r.shelf_item_id === params.id);
  const rank = idx >= 0 ? idx + 1 : null;

  const rnTooltip = readNextTooltip(data.read_next);

  return (
    <main className="p-6 max-w-4xl mx-auto">
      <div className="flex items-start justify-between gap-4">
        <div>
          <Link href="/dashboard" className="text-sm text-blue-600 hover:underline">
            ‚Üê Back to dashboard
          </Link>
          <h1 className="text-2xl font-semibold mt-2">{data.shelf_item.title}</h1>
          <p className="text-gray-600">{data.shelf_item.author}</p>
          {data.shelf_item.shelf ? (
            <p className="text-xs text-gray-500 mt-1">Shelf: {data.shelf_item.shelf}</p>
          ) : null}
        </div>
      </div>

      <section className="mt-6 rounded border p-4">
        <h2 className="font-semibold">Read Next</h2>
        <p className="text-sm text-gray-600 mt-1">
          {rank ? (
            <span>
              When sorting by Read Next, this item is ranked <span className="font-medium">#{rank}</span>.
            </span>
          ) : (
            <span>Rank unavailable (not found in the dashboard list).</span>
          )}
        </p>

        <div className="mt-3 text-sm">
          <div>
            <span className="font-medium">Tier:</span> {data.read_next.tier.replace("_", " ")}
          </div>
          <div className="mt-1">
            <span className="font-medium">Score:</span> {data.read_next.score.toFixed(1)}
          </div>
          {data.read_next.best_format ? (
            <div className="mt-1">
              <span className="font-medium">Best format:</span> {data.read_next.best_format}
            </div>
          ) : null}

          <div className="mt-3">
            <div className="font-medium">Why it ranks here</div>
            <ul className="list-disc pl-5 mt-2 text-gray-700">
              {data.read_next.reasons.map((r, i) => (
                <li key={i}>{r}</li>
              ))}
            </ul>
            <div className="text-xs text-gray-500 mt-3 whitespace-pre-line" title={rnTooltip}>
              Tip: hover for the full scoring summary.
            </div>
          </div>
        </div>
      </section>

      <section className="mt-6 rounded border p-4">
        <h2 className="font-semibold">Availability</h2>
        {data.availability.length ? (
          <ul className="mt-2 space-y-2">
            {data.availability.map((a) => (
              <li key={a.format} className="text-sm">
                <div className="flex items-center justify-between">
                  <div className="capitalize">
                    {a.format}: {a.status.replace("_", " ")}
                  </div>
                  {a.deep_link ? (
                    <a
                      href={a.deep_link}
                      className="text-blue-600 hover:underline"
                      target="_blank"
                      rel="noreferrer"
                    >
                      Open
                    </a>
                  ) : null}
                </div>
                <div className="text-xs text-gray-600 mt-1">
                  {a.status === "available" && a.copies_available != null ? (
                    <span>{a.copies_available} available</span>
                  ) : null}
                  {a.status === "hold" && a.holds != null ? <span>{a.holds} holds</span> : null}
                  {a.last_checked_at ? <span className="ml-2">Checked: {new Date(a.last_checked_at).toLocaleString()}</span> : null}
                </div>
              </li>
            ))}
          </ul>
        ) : (
          <p className="text-sm text-gray-600 mt-2">No availability data yet.</p>
        )}
      </section>

      <section className="mt-6 rounded border p-4">
        <h2 className="font-semibold">Match</h2>
        {data.match ? (
          <div className="text-sm mt-2">
            <div>
              <span className="font-medium">Method:</span> {data.match.method} ({Math.round(data.match.confidence * 100)}%)
            </div>
            <div className="mt-2">
              <span className="font-medium">Catalog title:</span> {data.match.catalog_item.title}
            </div>
            <div className="text-xs text-gray-600 mt-2">
              Evidence:
              <pre className="mt-1 p-2 bg-gray-50 rounded overflow-auto">{JSON.stringify(data.match.evidence, null, 2)}</pre>
            </div>
          </div>
        ) : (
          <p className="text-sm text-gray-600 mt-2">No match found.</p>
        )}
      </section>
    </main>
  );
}
</file>

<file path="apps/web/src/app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  color-scheme: light;
  --ink: #1c1b1a;
  --paper: #fbf4ea;
  --paper-strong: #f5e8d7;
  --accent: #d95d39;
  --accent-2: #2a9d8f;
  --accent-3: #f4a261;
  --card: #fffaf2;
  --shadow: rgba(38, 31, 20, 0.12);
}

body {
  min-height: 100%;
  background-color: var(--paper);
  font-family: var(--font-body, ui-sans-serif, system-ui);
}

.font-display {
  font-family: var(--font-display, ui-serif, serif);
  letter-spacing: -0.02em;
}
</file>

<file path="apps/web/src/app/layout.tsx">
import type { Metadata } from "next";
import { Newsreader, Space_Grotesk } from "next/font/google";

import "./globals.css";

const displayFont = Newsreader({
  subsets: ["latin"],
  variable: "--font-display",
});

const bodyFont = Space_Grotesk({
  subsets: ["latin"],
  variable: "--font-body",
});

export const metadata: Metadata = {
  title: "ShelfSync",
  description: "Find library availability for your Goodreads shelves."
};

export default function RootLayout({
  children
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body
        className={`${displayFont.variable} ${bodyFont.variable} bg-[var(--paper)] text-[var(--ink)] antialiased`}
      >
        {children}
      </body>
    </html>
  );
}
</file>

<file path="apps/web/src/app/page.tsx">
import Link from "next/link";

import { TryDemoButton } from "@/components/TryDemoButton";

export default function Home() {
  return (
    <main className="min-h-screen">
      <div className="relative overflow-hidden">
        <div className="pointer-events-none absolute inset-0 -z-10">
          <div className="absolute -left-32 top-10 h-72 w-72 rounded-full bg-[radial-gradient(circle_at_center,_rgba(217,93,57,0.35),_rgba(217,93,57,0))] blur-2xl" />
          <div className="absolute right-10 top-24 h-80 w-80 rounded-full bg-[radial-gradient(circle_at_center,_rgba(42,157,143,0.35),_rgba(42,157,143,0))] blur-2xl" />
          <div className="absolute bottom-0 left-1/3 h-96 w-96 rounded-full bg-[radial-gradient(circle_at_center,_rgba(244,162,97,0.25),_rgba(244,162,97,0))] blur-3xl" />
        </div>

        <div className="mx-auto flex max-w-6xl flex-col gap-16 px-6 py-12 lg:py-20">
          <nav className="flex items-center justify-between text-sm">
            <div className="font-display text-xl tracking-tight">ShelfSync</div>
            <div className="flex items-center gap-4">
              <Link className="rounded-full border border-black/10 px-4 py-2 text-xs uppercase tracking-[0.2em]" href="/signin">
                Sign in
              </Link>
              <Link className="rounded-full bg-[var(--ink)] px-4 py-2 text-xs uppercase tracking-[0.2em] text-[var(--paper)]" href="/signup">
                Create account
              </Link>
            </div>
          </nav>

          <section className="grid items-center gap-12 lg:grid-cols-[1.1fr_0.9fr]">
            <div className="space-y-6">
              <p className="text-xs uppercase tracking-[0.5em] text-black/50">Goodreads ‚Üí Library</p>
              <h1 className="font-display text-4xl leading-tight sm:text-5xl">
                Sync your shelves, then see what your library can actually loan today.
              </h1>
              <p className="max-w-xl text-lg text-black/70">
                Import RSS or CSV exports from Goodreads, normalize the titles, and get a clean
                availability snapshot you can act on.
              </p>
              <div className="flex flex-wrap items-center gap-4">
                <TryDemoButton className="rounded-full bg-[var(--accent)] px-6 py-3 text-sm font-semibold text-white shadow-[0_18px_40px_-28px_var(--accent)]" />
                <Link className="rounded-full border border-black/20 px-6 py-3 text-sm font-semibold" href="/signup">
                  Start a new shelf
                </Link>
              </div>
            </div>

            <div className="rounded-3xl border border-black/10 bg-[var(--card)] p-6 shadow-[0_25px_60px_-40px_var(--shadow)]">
              <div className="space-y-4">
                <div className="flex items-center justify-between text-xs uppercase tracking-[0.3em] text-black/40">
                  <span>Connect</span>
                  <span>Import</span>
                  <span>Check</span>
                </div>
                <div className="rounded-2xl border border-black/10 bg-white/70 p-5">
                  <p className="text-sm font-semibold">Demo pipeline</p>
                  <div className="mt-4 space-y-3 text-sm text-black/60">
                    <div className="flex items-center justify-between">
                      <span>Goodreads RSS</span>
                      <span className="rounded-full bg-black/5 px-3 py-1 text-xs">connected</span>
                    </div>
                    <div className="flex items-center justify-between">
                      <span>CSV export</span>
                      <span className="rounded-full bg-black/5 px-3 py-1 text-xs">optional</span>
                    </div>
                    <div className="flex items-center justify-between">
                      <span>Availability scan</span>
                      <span className="rounded-full bg-black/5 px-3 py-1 text-xs">next</span>
                    </div>
                  </div>
                </div>
                <div className="grid gap-4 sm:grid-cols-2">
                  <div className="rounded-2xl border border-black/10 bg-white/70 p-4 text-sm">
                    <p className="text-xs uppercase tracking-[0.3em] text-black/40">Snapshot</p>
                    <p className="mt-3 text-2xl font-semibold text-[var(--accent)]">24</p>
                    <p className="text-xs text-black/50">titles ready to check</p>
                  </div>
                  <div className="rounded-2xl border border-black/10 bg-white/70 p-4 text-sm">
                    <p className="text-xs uppercase tracking-[0.3em] text-black/40">Coverage</p>
                    <p className="mt-3 text-2xl font-semibold text-[var(--accent-2)]">82%</p>
                    <p className="text-xs text-black/50">with ISBN metadata</p>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section className="grid gap-6 lg:grid-cols-3">
            {[
              {
                title: "Connect once",
                description: "Paste your Goodreads RSS or upload CSV exports. We store the source and keep it fresh."
              },
              {
                title: "Normalize titles",
                description: "We extract ISBNs, ASINs, and Goodreads IDs so every item is ready for matching."
              },
              {
                title: "Track availability",
                description: "See what your library can deliver today and what needs a manual check."
              }
            ].map((item) => (
              <div
                key={item.title}
                className="rounded-2xl border border-black/10 bg-white/70 p-6 shadow-[0_25px_60px_-48px_var(--shadow)]"
              >
                <p className="font-display text-xl">{item.title}</p>
                <p className="mt-3 text-sm text-black/60">{item.description}</p>
              </div>
            ))}
          </section>
        </div>
      </div>
    </main>
  );
}
</file>

<file path="apps/web/src/lib/api.ts">
export const API_BASE = process.env.NEXT_PUBLIC_API_BASE_URL;

if (!API_BASE) {
  throw new Error("Missing NEXT_PUBLIC_API_BASE_URL");
}

export async function apiFetch<T>(path: string, init?: RequestInit): Promise<T> {
  const isFormData = typeof FormData !== "undefined" && init?.body instanceof FormData;

  const headers: HeadersInit = {
    ...(isFormData ? {} : { "Content-Type": "application/json" }),
    ...(init?.headers || {}),
  };

  const res = await fetch(`${API_BASE}${path}`, {
    ...init,
    headers,
    credentials: "include",
  });

  if (!res.ok) {
    const text = await res.text();
    throw new Error(text || `Request failed: ${res.status}`);
  }

  // 204
  if (res.status === 204) return undefined as unknown as T;

  return (await res.json()) as T;
}
</file>

<file path="apps/web/package.json">
{
  "name": "web",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "lint": "next lint",
    "build": "next build",
    "start": "next start",
    "test": "vitest run",
    "test:watch": "vitest"
  },
  "dependencies": {
    "next": "^14.2.5",
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@testing-library/jest-dom": "^6.8.0",
    "@testing-library/react": "^16.3.0",
    "@types/node": "^20.14.10",
    "@types/react": "^18.3.3",
    "@types/react-dom": "^18.3.0",
    "@vitejs/plugin-react": "^5.0.2",
    "autoprefixer": "^10.4.20",
    "eslint": "^8.57.0",
    "eslint-config-next": "^14.2.35",
    "jsdom": "^25.0.1",
    "msw": "^2.10.0",
    "postcss": "^8.4.49",
    "tailwindcss": "^3.4.17",
    "typescript": "^5.5.4",
    "vitest": "^3.2.4"
  }
}
</file>

<file path="infra/docker-compose.yml">
name: shelfsync

services:
  postgres:
    image: postgres:18-alpine
    environment:
      POSTGRES_USER: shelfsync
      POSTGRES_PASSWORD: shelfsync
      POSTGRES_DB: shelfsync
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U shelfsync -d shelfsync"]
      interval: 5s
      timeout: 5s
      retries: 10

  redis:
    image: redis:8-alpine
    ports:
      - "6379:6379"
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10

  goodreads-mock:
    image: stoplight/prism:5
    command: ["mock", "-h", "0.0.0.0", "/spec/goodreads-mock.yaml"]
    ports:
      - "4010:4010"
    volumes:
      - ../docs/openapi/goodreads-mock.yaml:/spec/goodreads-mock.yaml:ro
      - ../mock:/spec/mock:ro

volumes:
  postgres_data:
</file>

<file path="services/api/alembic/versions/156614e6d7d6_phase4_seed_libraries.py">
"""phase4 seed libraries

Revision ID: 156614e6d7d6
Revises: bedca43b8c03
Create Date: 2025-12-24 06:17:16.861999

"""

from typing import Sequence, Union

# revision identifiers, used by Alembic.
revision: str = "156614e6d7d6"
down_revision: Union[str, Sequence[str], None] = "bedca43b8c03"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    pass


def downgrade() -> None:
    """Downgrade schema."""
    pass
</file>

<file path="services/api/alembic/versions/8399dceac96e_phase1_init_schema.py">
"""phase1 init schema

Revision ID: 8399dceac96e
Revises:
Create Date: 2025-12-22 20:48:21.235631

"""

from typing import Sequence, Union

import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision: str = "8399dceac96e"
down_revision: Union[str, Sequence[str], None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "libraries",
        sa.Column("id", sa.String(length=80), nullable=False),
        sa.Column("name", sa.String(length=200), nullable=False),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_table(
        "users",
        sa.Column("id", sa.String(length=36), nullable=False),
        sa.Column("email", sa.String(length=320), nullable=False),
        sa.Column("password_hash", sa.String(length=255), nullable=False),
        sa.Column("is_active", sa.Boolean(), nullable=False),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(op.f("ix_users_email"), "users", ["email"], unique=True)
    op.create_table(
        "shelf_sources",
        sa.Column("id", sa.String(length=36), nullable=False),
        sa.Column("user_id", sa.String(length=36), nullable=False),
        sa.Column("source_type", sa.String(length=20), nullable=False),
        sa.Column("source_ref", sa.String(length=2000), nullable=False),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.ForeignKeyConstraint(["user_id"], ["users.id"], ondelete="CASCADE"),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_shelf_sources_user_id"), "shelf_sources", ["user_id"], unique=False
    )
    op.create_table(
        "user_settings",
        sa.Column("user_id", sa.String(length=36), nullable=False),
        sa.Column("library_system", sa.String(length=200), nullable=True),
        sa.Column("preferred_formats", sa.JSON(), nullable=False),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
        sa.ForeignKeyConstraint(["user_id"], ["users.id"], ondelete="CASCADE"),
        sa.PrimaryKeyConstraint("user_id"),
    )
    op.create_table(
        "shelf_items",
        sa.Column("id", sa.String(length=36), nullable=False),
        sa.Column("user_id", sa.String(length=36), nullable=False),
        sa.Column("shelf_source_id", sa.String(length=36), nullable=True),
        sa.Column("title", sa.String(length=600), nullable=False),
        sa.Column("author", sa.String(length=400), nullable=False),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.ForeignKeyConstraint(
            ["shelf_source_id"], ["shelf_sources.id"], ondelete="SET NULL"
        ),
        sa.ForeignKeyConstraint(["user_id"], ["users.id"], ondelete="CASCADE"),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_shelf_items_shelf_source_id"),
        "shelf_items",
        ["shelf_source_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_shelf_items_user_id"), "shelf_items", ["user_id"], unique=False
    )
    op.create_index(
        "ix_shelf_items_user_title_author",
        "shelf_items",
        ["user_id", "title", "author"],
        unique=False,
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index("ix_shelf_items_user_title_author", table_name="shelf_items")
    op.drop_index(op.f("ix_shelf_items_user_id"), table_name="shelf_items")
    op.drop_index(op.f("ix_shelf_items_shelf_source_id"), table_name="shelf_items")
    op.drop_table("shelf_items")
    op.drop_table("user_settings")
    op.drop_index(op.f("ix_shelf_sources_user_id"), table_name="shelf_sources")
    op.drop_table("shelf_sources")
    op.drop_index(op.f("ix_users_email"), table_name="users")
    op.drop_table("users")
    op.drop_table("libraries")
    # ### end Alembic commands ###
</file>

<file path="services/api/alembic/versions/b2c2190162bb_phase3_catalog_matching.py">
"""phase3 catalog matching

Revision ID: b2c2190162bb
Revises: c7a5b2b4af1e
Create Date: 2025-12-23 19:37:31.748233

"""

from typing import Sequence, Union

import sqlalchemy as sa
from alembic import op
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = "b2c2190162bb"
down_revision: Union[str, Sequence[str], None] = "c7a5b2b4af1e"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "catalog_items",
        sa.Column("id", sa.String(length=36), nullable=False),
        sa.Column("provider", sa.String(length=40), nullable=False),
        sa.Column("provider_item_id", sa.String(length=160), nullable=False),
        sa.Column("title", sa.String(length=400), nullable=False),
        sa.Column("author", sa.String(length=240), nullable=True),
        sa.Column("isbn10", sa.String(length=10), nullable=True),
        sa.Column("isbn13", sa.String(length=13), nullable=True),
        sa.Column("asin", sa.String(length=20), nullable=True),
        sa.Column("raw", sa.JSON(), nullable=False),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint(
            "provider", "provider_item_id", name="uq_catalog_items_provider_item"
        ),
    )
    op.create_table(
        "availability_snapshots",
        sa.Column("id", sa.String(length=36), nullable=False),
        sa.Column("user_id", sa.String(length=36), nullable=False),
        sa.Column("catalog_item_id", sa.String(length=36), nullable=False),
        sa.Column("format", sa.String(length=20), nullable=False),
        sa.Column("status", sa.String(length=20), nullable=False),
        sa.Column("copies_available", sa.Integer(), nullable=True),
        sa.Column("copies_total", sa.Integer(), nullable=True),
        sa.Column("holds", sa.Integer(), nullable=True),
        sa.Column("deep_link", sa.String(length=500), nullable=True),
        sa.Column("last_checked_at", sa.DateTime(timezone=True), nullable=False),
        sa.ForeignKeyConstraint(
            ["catalog_item_id"], ["catalog_items.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(["user_id"], ["users.id"], ondelete="CASCADE"),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint(
            "user_id", "catalog_item_id", "format", name="uq_avail_user_item_format"
        ),
    )
    op.create_index(
        op.f("ix_availability_snapshots_catalog_item_id"),
        "availability_snapshots",
        ["catalog_item_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_availability_snapshots_user_id"),
        "availability_snapshots",
        ["user_id"],
        unique=False,
    )
    op.create_table(
        "catalog_matches",
        sa.Column("id", sa.String(length=36), nullable=False),
        sa.Column("user_id", sa.String(length=36), nullable=False),
        sa.Column("shelf_item_id", sa.String(length=36), nullable=False),
        sa.Column("catalog_item_id", sa.String(length=36), nullable=False),
        sa.Column("provider", sa.String(length=40), nullable=False),
        sa.Column("method", sa.String(length=40), nullable=False),
        sa.Column("confidence", sa.Float(), nullable=False),
        sa.Column("evidence", sa.JSON(), nullable=False),
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
        sa.ForeignKeyConstraint(
            ["catalog_item_id"], ["catalog_items.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["shelf_item_id"], ["shelf_items.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(["user_id"], ["users.id"], ondelete="CASCADE"),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint(
            "user_id", "shelf_item_id", name="uq_catalog_match_user_shelf_item"
        ),
    )
    op.create_index(
        op.f("ix_catalog_matches_catalog_item_id"),
        "catalog_matches",
        ["catalog_item_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_catalog_matches_shelf_item_id"),
        "catalog_matches",
        ["shelf_item_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_catalog_matches_user_id"), "catalog_matches", ["user_id"], unique=False
    )
    op.alter_column(
        "shelf_items",
        "isbn10",
        existing_type=sa.VARCHAR(length=10),
        type_=sa.String(length=20),
        existing_nullable=True,
    )
    op.alter_column(
        "shelf_items",
        "isbn13",
        existing_type=sa.VARCHAR(length=13),
        type_=sa.String(length=20),
        existing_nullable=True,
    )
    op.drop_index(op.f("ix_shelf_items_user_normkey"), table_name="shelf_items")
    op.drop_constraint(
        op.f("uq_shelf_item_user_normkey"), "shelf_items", type_="unique"
    )
    op.create_index(
        "ix_shelf_items_source_external_unique",
        "shelf_items",
        ["shelf_source_id", "external_id"],
        unique=True,
        postgresql_where=sa.text("external_id IS NOT NULL"),
    )
    op.drop_column("shelf_items", "normalized_key")
    op.drop_column("shelf_items", "goodreads_book_id")
    op.drop_constraint(
        op.f("uq_shelf_source_user_type_ref"), "shelf_sources", type_="unique"
    )
    op.drop_column("shelf_sources", "shelf_name")
    op.drop_column("shelf_sources", "last_imported_at")
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "shelf_sources",
        sa.Column(
            "last_imported_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "shelf_sources",
        sa.Column(
            "shelf_name", sa.VARCHAR(length=200), autoincrement=False, nullable=True
        ),
    )
    op.create_unique_constraint(
        op.f("uq_shelf_source_user_type_ref"),
        "shelf_sources",
        ["user_id", "source_type", "source_ref"],
        postgresql_nulls_not_distinct=False,
    )
    op.add_column(
        "shelf_items",
        sa.Column(
            "goodreads_book_id",
            sa.VARCHAR(length=40),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "shelf_items",
        sa.Column(
            "normalized_key",
            sa.VARCHAR(length=1100),
            autoincrement=False,
            nullable=False,
        ),
    )
    op.drop_index(
        "ix_shelf_items_source_external_unique",
        table_name="shelf_items",
        postgresql_where=sa.text("external_id IS NOT NULL"),
    )
    op.create_unique_constraint(
        op.f("uq_shelf_item_user_normkey"),
        "shelf_items",
        ["user_id", "normalized_key"],
        postgresql_nulls_not_distinct=False,
    )
    op.create_index(
        op.f("ix_shelf_items_user_normkey"),
        "shelf_items",
        ["user_id", "normalized_key"],
        unique=False,
    )
    op.alter_column(
        "shelf_items",
        "isbn13",
        existing_type=sa.String(length=20),
        type_=sa.VARCHAR(length=13),
        existing_nullable=True,
    )
    op.alter_column(
        "shelf_items",
        "isbn10",
        existing_type=sa.String(length=20),
        type_=sa.VARCHAR(length=10),
        existing_nullable=True,
    )
    op.drop_index(op.f("ix_catalog_matches_user_id"), table_name="catalog_matches")
    op.drop_index(
        op.f("ix_catalog_matches_shelf_item_id"), table_name="catalog_matches"
    )
    op.drop_index(
        op.f("ix_catalog_matches_catalog_item_id"), table_name="catalog_matches"
    )
    op.drop_table("catalog_matches")
    op.drop_index(
        op.f("ix_availability_snapshots_user_id"), table_name="availability_snapshots"
    )
    op.drop_index(
        op.f("ix_availability_snapshots_catalog_item_id"),
        table_name="availability_snapshots",
    )
    op.drop_table("availability_snapshots")
    op.drop_table("catalog_items")
    # ### end Alembic commands ###
</file>

<file path="services/api/alembic/versions/bedca43b8c03_phase3_catalog_matching.py">
"""phase3 catalog matching

Revision ID: bedca43b8c03
Revises: b2c2190162bb
Create Date: 2025-12-23 19:50:47.846892

"""

from typing import Sequence, Union

# revision identifiers, used by Alembic.
revision: str = "bedca43b8c03"
down_revision: Union[str, Sequence[str], None] = "b2c2190162bb"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###
</file>

<file path="services/api/alembic/versions/c7a5b2b4af1e_add_missing_shelf_columns.py">
"""add missing shelf columns

Revision ID: c7a5b2b4af1e
Revises: 8f008b42145c
Create Date: 2025-12-23 23:59:00.000000

"""

from typing import Sequence, Union

import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision: str = "c7a5b2b4af1e"
down_revision: Union[str, Sequence[str], None] = "8f008b42145c"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    op.add_column(
        "shelf_sources",
        sa.Column(
            "provider", sa.String(length=40), nullable=False, server_default="goodreads"
        ),
    )
    op.add_column(
        "shelf_sources",
        sa.Column(
            "meta",
            sa.JSON(),
            nullable=False,
            server_default=sa.text("'{}'::json"),
        ),
    )
    op.add_column(
        "shelf_sources",
        sa.Column("last_synced_at", sa.DateTime(timezone=True), nullable=True),
    )
    op.add_column(
        "shelf_sources",
        sa.Column("last_sync_status", sa.String(length=30), nullable=True),
    )
    op.add_column(
        "shelf_sources",
        sa.Column("last_sync_error", sa.String(length=2000), nullable=True),
    )
    op.add_column(
        "shelf_sources",
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            nullable=False,
            server_default=sa.text("now()"),
        ),
    )

    op.add_column(
        "shelf_items",
        sa.Column("external_id", sa.String(length=120), nullable=True),
    )
    op.add_column(
        "shelf_items",
        sa.Column("shelf", sa.String(length=80), nullable=True),
    )


def downgrade() -> None:
    """Downgrade schema."""
    op.drop_column("shelf_items", "shelf")
    op.drop_column("shelf_items", "external_id")
    op.drop_column("shelf_sources", "updated_at")
    op.drop_column("shelf_sources", "last_sync_error")
    op.drop_column("shelf_sources", "last_sync_status")
    op.drop_column("shelf_sources", "last_synced_at")
    op.drop_column("shelf_sources", "meta")
    op.drop_column("shelf_sources", "provider")
</file>

<file path="services/api/alembic/env.py">
from __future__ import annotations

import os
from logging.config import fileConfig

from alembic import context
from app.models import Base  # noqa: F401
from sqlalchemy import engine_from_config, pool

config = context.config

if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# Point Alembic at your metadata
target_metadata = Base.metadata

DEFAULT_DATABASE_URL = (
    "postgresql+psycopg2://shelfsync:shelfsync@localhost:5432/shelfsync"
)


def get_database_url() -> str:
    env_url = os.getenv("DATABASE_URL")
    if env_url:
        return env_url

    ini_url = config.get_main_option("sqlalchemy.url")
    if ini_url and ini_url != "driver://user:pass@localhost/dbname":
        return ini_url

    try:
        from app.core.config import settings
    except Exception:
        return DEFAULT_DATABASE_URL

    return settings.database_url


def run_migrations_offline() -> None:
    url = get_database_url()
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online() -> None:
    configuration = config.get_section(config.config_ini_section) or {}
    configuration["sqlalchemy.url"] = get_database_url()

    connectable = engine_from_config(
        configuration,
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(connection=connection, target_metadata=target_metadata)

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
</file>

<file path="services/api/app/api/routes/books.py">
from __future__ import annotations

from dataclasses import asdict
from datetime import datetime, timezone

from app.api.deps import get_current_user
from app.api.rate_limit import rate_limiter
from app.core.config import settings
from app.db.session import get_db
from app.models.availability_snapshot import AvailabilitySnapshot
from app.models.catalog_item import CatalogItem
from app.models.catalog_match import CatalogMatch
from app.models.shelf_item import ShelfItem
from app.models.shelf_source import ShelfSource
from app.models.user_settings import UserSettings
from app.schemas.books import (
    BookDetailMatchOut,
    BookDetailOut,
    BookDetailSettingsOut,
    BookDetailShelfItemOut,
    BookDetailSourceOut,
)
from app.schemas.dashboard import AvailabilityOut, ReadNextOut
from app.services.read_next_scoring import compute_read_next
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy import select
from sqlalchemy.orm import Session

router = APIRouter(prefix="/v1", tags=["books"])


@router.get(
    "/books/{shelf_item_id}",
    response_model=BookDetailOut,
    dependencies=[
        Depends(
            rate_limiter(
                "book_detail",
                limit=settings.rate_limit_books_per_window,
                window_seconds=settings.rate_limit_window_secs,
            )
        )
    ],
)
def get_book_detail(
    shelf_item_id: str,
    db: Session = Depends(get_db),
    user=Depends(get_current_user),
):
    si = db.get(ShelfItem, shelf_item_id)
    if si is None or si.user_id != user.id:
        raise HTTPException(status_code=404, detail="Book not found")

    user_settings = db.execute(
        select(UserSettings).where(UserSettings.user_id == user.id)
    ).scalar_one_or_none()
    if user_settings is None:
        user_settings = UserSettings(user_id=user.id)
        db.add(user_settings)
        db.commit()
        db.refresh(user_settings)

    preferred_formats = list(user_settings.preferred_formats or [])

    m = (
        db.execute(
            select(CatalogMatch)
            .where(CatalogMatch.user_id == user.id)
            .where(CatalogMatch.shelf_item_id == si.id)
            .order_by(CatalogMatch.confidence.desc())
        )
        .scalars()
        .first()
    )

    availability: list[AvailabilityOut] = []
    match_out: BookDetailMatchOut | None = None

    if m is not None:
        ci = db.get(CatalogItem, m.catalog_item_id)

        if ci is not None:
            match_out = BookDetailMatchOut(
                catalog_item_id=m.catalog_item_id,
                provider=m.provider,
                provider_item_id=ci.provider_item_id,
                method=m.method,
                confidence=float(m.confidence or 0.0),
            )

        snaps = (
            db.execute(
                select(AvailabilitySnapshot)
                .where(AvailabilitySnapshot.user_id == user.id)
                .where(AvailabilitySnapshot.catalog_item_id == m.catalog_item_id)
            )
            .scalars()
            .all()
        )

        def _sort_key(a: AvailabilitySnapshot) -> tuple[int, str]:
            if a.format in preferred_formats:
                return (preferred_formats.index(a.format), a.format)
            return (999, a.format)

        for a in sorted(snaps, key=_sort_key):
            availability.append(
                AvailabilityOut(
                    format=a.format,
                    status=a.status,
                    copies_available=a.copies_available,
                    copies_total=a.copies_total,
                    holds=a.holds,
                    deep_link=a.deep_link,
                    last_checked_at=a.last_checked_at,
                )
            )

    rn = compute_read_next(availability, preferred_formats)

    source_out: BookDetailSourceOut | None = None
    if si.shelf_source_id:
        src = db.get(ShelfSource, si.shelf_source_id)
        if src is not None:
            source_out = BookDetailSourceOut(
                id=src.id,
                source_type=src.source_type,
                provider=src.provider,
                source_ref=src.source_ref,
                last_synced_at=src.last_synced_at,
                last_sync_status=src.last_sync_status,
                last_sync_error=src.last_sync_error,
            )

    return BookDetailOut(
        shelf_item=BookDetailShelfItemOut(
            id=si.id,
            title=si.title,
            author=si.author,
            isbn10=si.isbn10,
            isbn13=si.isbn13,
            asin=si.asin,
            shelf=si.shelf,
            needs_fuzzy_match=si.needs_fuzzy_match,
        ),
        match=match_out,
        availability=availability,
        source=source_out,
        settings=BookDetailSettingsOut(
            library_system=user_settings.library_system,
            preferred_formats=preferred_formats,
        ),
        read_next=ReadNextOut(**asdict(rn)),
        generated_at=datetime.now(timezone.utc),
    )
</file>

<file path="services/api/app/api/routes/dashboard.py">
from __future__ import annotations

from dataclasses import asdict
from datetime import datetime, timezone
from typing import Literal

from app.api.deps import get_current_user
from app.api.rate_limit import rate_limiter
from app.db.session import get_db
from app.models.availability_snapshot import AvailabilitySnapshot
from app.models.catalog_item import CatalogItem
from app.models.catalog_match import CatalogMatch
from app.models.shelf_item import ShelfItem
from app.models.shelf_source import ShelfSource
from app.models.user_settings import UserSettings
from app.schemas.dashboard import (
    AvailabilityOut,
    DashboardOut,
    DashboardRowOut,
    LastSyncOut,
    MatchMiniOut,
    PageOut,
    ReadNextOut,
)
from app.services.read_next_scoring import compute_read_next
from fastapi import APIRouter, Depends, Query
from sqlalchemy import select
from sqlalchemy.orm import Session

router = APIRouter(prefix="/v1", tags=["dashboard"])


@router.get(
    "/dashboard",
    response_model=DashboardOut,
    dependencies=[Depends(rate_limiter("dashboard", limit=120, window_seconds=60))],
)
def get_dashboard(
    *,
    db: Session = Depends(get_db),
    user=Depends(get_current_user),
    limit: int = Query(default=50, ge=1, le=200),
    offset: int = Query(default=0, ge=0),
    sort: Literal["read_next", "title", "updated"] = Query(default="read_next"),
) -> DashboardOut:
    # Settings
    user_settings = db.execute(
        select(UserSettings).where(UserSettings.user_id == user.id)
    ).scalar_one_or_none()
    if user_settings is None:
        user_settings = UserSettings(user_id=user.id)
        db.add(user_settings)
        db.commit()
        db.refresh(user_settings)

    preferred_formats = list(user_settings.preferred_formats or [])

    # Sources (used for last_sync and to keep dashboard scoped to user sources)
    sources = (
        db.execute(select(ShelfSource).where(ShelfSource.user_id == user.id))
        .scalars()
        .all()
    )
    source_ids = [s.id for s in sources]

    # Last sync (best effort)
    min_dt = datetime.min.replace(tzinfo=timezone.utc)
    latest_src = (
        max(sources, key=lambda s: s.last_synced_at or min_dt) if sources else None
    )
    last_sync = LastSyncOut(
        source_type=latest_src.source_type if latest_src else None,
        source_id=latest_src.id if latest_src else None,
        last_synced_at=latest_src.last_synced_at if latest_src else None,
        last_sync_status=latest_src.last_sync_status if latest_src else None,
        last_sync_error=latest_src.last_sync_error if latest_src else None,
    )

    # Load shelf items
    items_stmt = select(ShelfItem).where(ShelfItem.user_id == user.id)
    if source_ids:
        items_stmt = items_stmt.where(ShelfItem.shelf_source_id.in_(source_ids))

    all_items = db.execute(items_stmt).scalars().all()

    if not all_items:
        return DashboardOut(
            settings={
                "library_system": user_settings.library_system,
                "preferred_formats": preferred_formats,
                "updated_at": user_settings.updated_at,
            },
            last_sync=last_sync,
            page=PageOut(limit=limit, offset=offset, total=0),
            items=[],
        )

    # Load catalog matches (at most one per shelf item by constraint)
    shelf_item_ids = [i.id for i in all_items]
    matches = (
        db.execute(
            select(CatalogMatch).where(
                CatalogMatch.user_id == user.id,
                CatalogMatch.shelf_item_id.in_(shelf_item_ids),
            )
        )
        .scalars()
        .all()
    )
    match_by_shelf_id: dict[str, CatalogMatch] = {m.shelf_item_id: m for m in matches}

    # Load catalog items referenced by matches
    catalog_item_ids = {m.catalog_item_id for m in matches}
    catalog_items = (
        db.execute(
            select(CatalogItem).where(CatalogItem.id.in_(list(catalog_item_ids)))
        )
        .scalars()
        .all()
        if catalog_item_ids
        else []
    )
    catalog_by_id: dict[str, CatalogItem] = {c.id: c for c in catalog_items}

    # Load availability snapshots for those catalog items (grouped by catalog_item_id)
    snapshots = (
        db.execute(
            select(AvailabilitySnapshot).where(
                AvailabilitySnapshot.user_id == user.id,
                AvailabilitySnapshot.catalog_item_id.in_(list(catalog_item_ids)),
            )
        )
        .scalars()
        .all()
        if catalog_item_ids
        else []
    )
    snaps_by_catalog_id: dict[str, list[AvailabilitySnapshot]] = {}
    for s in snapshots:
        snaps_by_catalog_id.setdefault(s.catalog_item_id, []).append(s)

    rows: list[DashboardRowOut] = []
    for si in all_items:
        m = match_by_shelf_id.get(si.id)

        match_out: MatchMiniOut | None = None
        availability: list[AvailabilityOut] = []

        if m is not None:
            c = catalog_by_id.get(m.catalog_item_id)
            if c is not None:
                match_out = MatchMiniOut(
                    catalog_item_id=c.id,
                    provider=m.provider,
                    provider_item_id=c.provider_item_id,
                    method=m.method,
                    confidence=m.confidence,
                )

                for a in snaps_by_catalog_id.get(c.id, []):
                    availability.append(
                        AvailabilityOut(
                            format=a.format,
                            status=a.status,
                            copies_available=a.copies_available,
                            copies_total=a.copies_total,
                            holds=a.holds,
                            deep_link=a.deep_link,
                            last_checked_at=a.last_checked_at,
                        )
                    )

        rn = compute_read_next(availability, preferred_formats)

        rows.append(
            DashboardRowOut(
                shelf_item_id=si.id,
                title=si.title,
                author=si.author,
                shelf=si.shelf,
                needs_fuzzy_match=si.needs_fuzzy_match,
                match=match_out,
                availability=availability,
                read_next=ReadNextOut(**asdict(rn)),
            )
        )

    # Sorting
    if sort == "read_next":
        rows.sort(key=lambda r: r.read_next.score, reverse=True)
    elif sort == "title":
        rows.sort(key=lambda r: (r.title or "").lower())
    elif sort == "updated":
        id_to_updated = {si.id: si.updated_at for si in all_items}
        rows.sort(
            key=lambda r: id_to_updated.get(r.shelf_item_id)
            or datetime.min.replace(tzinfo=timezone.utc),
            reverse=True,
        )

    total = len(rows)
    page_items = rows[offset : offset + limit]

    return DashboardOut(
        settings={
            "library_system": user_settings.library_system,
            "preferred_formats": preferred_formats,
            "updated_at": user_settings.updated_at,
        },
        last_sync=last_sync,
        page=PageOut(limit=limit, offset=offset, total=total),
        items=page_items,
    )
</file>

<file path="services/api/app/api/routes/health.py">
from fastapi import APIRouter

router = APIRouter(tags=["health"])


@router.get("/health")
def health_check():
    return {"ok": True}
</file>

<file path="services/api/app/api/routes/shelf_items.py">
from __future__ import annotations

from app.api.deps import get_current_user
from app.db.session import get_db
from app.models.shelf_item import ShelfItem
from app.schemas.shelf import ShelfItemOut
from fastapi import APIRouter, Depends
from sqlalchemy import select
from sqlalchemy.orm import Session

router = APIRouter(prefix="/shelf-items", tags=["shelf-items"])


@router.get("", response_model=list[ShelfItemOut])
def list_shelf_items(
    source_id: str | None = None,
    shelf: str | None = None,
    limit: int = 50,
    offset: int = 0,
    db: Session = Depends(get_db),
    user=Depends(get_current_user),
):
    q = select(ShelfItem).where(ShelfItem.user_id == user.id)
    if source_id:
        q = q.where(ShelfItem.shelf_source_id == source_id)
    if shelf:
        q = q.where(ShelfItem.shelf == shelf)
    q = q.order_by(ShelfItem.updated_at.desc()).limit(limit).offset(offset)

    rows = db.execute(q).scalars().all()
    return rows
</file>

<file path="services/api/app/api/routes/sync_runs.py">
from __future__ import annotations

import json
from datetime import datetime, timezone
from typing import AsyncGenerator

from app.api.deps import get_current_user
from app.core.config import settings
from app.core.redis import get_redis_async
from app.core.security import hash_password
from app.crud.sync_runs import create_sync_run, get_sync_run
from app.db.session import get_db
from app.models.user import User
from app.models.user_settings import UserSettings
from app.schemas.sync_run import StartSyncRunIn, SyncRunOut
from app.workers.queue import enqueue_availability_refresh
from fastapi import APIRouter, Depends, HTTPException, Request, Response
from fastapi.responses import StreamingResponse
from sqlalchemy import select
from sqlalchemy.orm import Session

router = APIRouter(prefix="/v1", tags=["sync-runs"])


def _get_or_create_demo_user(db: Session) -> User:
    demo_email = "demo@example.com"
    u = db.execute(select(User).where(User.email == demo_email)).scalar_one_or_none()
    if u is not None:
        return u

    u = User(email=demo_email, password_hash=hash_password("password"))
    db.add(u)
    db.flush()
    db.add(UserSettings(user_id=u.id))
    db.commit()
    db.refresh(u)
    return u


def _optional_user(request: Request, db: Session) -> User | None:
    try:
        return get_current_user(request=request, db=db)
    except HTTPException:
        return None


@router.post("/sync-runs", response_model=SyncRunOut)
def start_sync_run(
    payload: StartSyncRunIn,
    request: Request,
    response: Response,
    db: Session = Depends(get_db),
):
    # Optional auth (test hits this endpoint without cookies)
    user = _optional_user(request, db)

    if user is None:
        if not (
            settings.demo_login_enabled
            and settings.env in {"local", "development", "dev"}
        ):
            raise HTTPException(status_code=401, detail="Not authenticated")
        user = _get_or_create_demo_user(db)

    run = create_sync_run(db, user_id=user.id, kind=payload.kind)
    enqueue_availability_refresh(sync_run_id=run.id)
    return run


@router.get("/sync-runs/{run_id}", response_model=SyncRunOut)
def get_sync_run_detail(
    run_id: str,
    db: Session = Depends(get_db),
    user=Depends(get_current_user),
):
    run = get_sync_run(db, run_id=run_id)
    if run is None or run.user_id != user.id:
        raise HTTPException(status_code=404, detail="Sync run not found")
    return run


@router.get("/sync-runs/{run_id}/events")
async def stream_sync_events(
    run_id: str,
    user=Depends(get_current_user),
) -> StreamingResponse:
    redis_client = get_redis_async(settings.redis_url)

    channel = f"sync:{user.id}:{run_id}"

    async def event_generator() -> AsyncGenerator[str, None]:
        pubsub = redis_client.pubsub()
        await pubsub.subscribe(channel)

        try:
            async for message in pubsub.listen():
                if message is None:
                    continue
                if message.get("type") != "message":
                    continue

                data_raw = message.get("data")
                if data_raw is None:
                    continue

                if isinstance(data_raw, (bytes, bytearray)):
                    data_str = data_raw.decode("utf-8")
                else:
                    data_str = str(data_raw)

                payload = json.loads(data_str)
                payload.setdefault("ts", datetime.now(timezone.utc).isoformat())
                payload["run_id"] = run_id

                yield f"data: {json.dumps(payload)}\n\n"
        finally:
            await pubsub.unsubscribe(channel)
            await pubsub.close()

    return StreamingResponse(event_generator(), media_type="text/event-stream")
</file>

<file path="services/api/app/api/deps.py">
from __future__ import annotations

from typing import Optional

from app.core.config import settings
from app.core.security import decode_access_token
from app.db.session import get_db
from app.models.user import User
from fastapi import Depends, HTTPException, Request, status
from jose import JWTError  # type: ignore[import-untyped]
from sqlalchemy.orm import Session


def _extract_bearer_token(request: Request) -> Optional[str]:
    auth = request.headers.get("Authorization")
    if not auth:
        return None
    parts = auth.split(" ", 1)
    if len(parts) != 2:
        return None
    scheme, token = parts
    if scheme.lower() != "bearer":
        return None
    return token


def get_current_user(request: Request, db: Session = Depends(get_db)) -> User:
    # Allow either Authorization: Bearer <token> OR cookie-based auth
    token = _extract_bearer_token(request) or request.cookies.get(
        settings.auth_cookie_name
    )
    if not token:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED, detail="Not authenticated"
        )

    try:
        payload = decode_access_token(token)
        user_id = payload.get("sub")
        if not user_id:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED, detail="Invalid token"
            )
    except (JWTError, HTTPException):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED, detail="Invalid token"
        )

    user = db.get(User, user_id)
    if not user or not user.is_active:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED, detail="User not found"
        )

    return user
</file>

<file path="services/api/app/api/router.py">
from __future__ import annotations

import importlib

from fastapi import APIRouter

api_router = APIRouter()


def _include(module_path: str) -> None:
    try:
        mod = importlib.import_module(module_path)
    except Exception:
        # Optional route module; ignore if not present.
        return

    router = getattr(mod, "router", None)
    if router is not None:
        api_router.include_router(router)


# Keep this list in the order you want routes registered.
for _mod in (
    "app.api.routes.health",
    "app.api.routes.auth",
    "app.api.routes.settings",
    "app.api.routes.libraries",
    "app.api.routes.shelf_sources",
    "app.api.routes.shelf_items",
    "app.api.routes.matching",
    "app.api.routes.dashboard",
    "app.api.routes.books",
    "app.api.routes.sync_runs",
):
    _include(_mod)
</file>

<file path="services/api/app/core/redis_client.py">
from __future__ import annotations

import logging
from functools import lru_cache

import redis
from app.core.config import settings
from redis import Redis

logger = logging.getLogger(__name__)


@lru_cache
def get_redis() -> Redis | None:
    try:
        client: Redis = redis.from_url(settings.redis_url, decode_responses=True)
        client.ping()
        return client
    except Exception as exc:
        logger.warning("Redis unavailable; caching/rate limiting disabled: %s", exc)
        return None
</file>

<file path="services/api/app/crud/availability.py">
from __future__ import annotations

from dataclasses import dataclass
from datetime import datetime, timezone
from typing import Iterable
from uuid import uuid4

from app.models.availability_snapshot import AvailabilitySnapshot
from app.models.catalog_match import CatalogMatch
from app.models.notification_event import NotificationEvent
from app.models.user_settings import UserSettings
from app.providers.types import AvailabilityResult
from sqlalchemy import select
from sqlalchemy.orm import Session


def utcnow() -> datetime:
    return datetime.now(timezone.utc)


@dataclass(frozen=True)
class NotificationCreated:
    id: str
    shelf_item_id: str
    title: str
    format: str


def upsert_snapshots(
    db: Session, *, user_id: str, results: Iterable[AvailabilityResult]
) -> list[NotificationCreated]:
    """Persist availability snapshots and create notifications when items become available.

    Notes:
    - Notification creation is durable (DB insert).
    - Real-time delivery (Redis/SSE) is best-effort and happens after commit.
    """

    # Read settings once per chunk
    s = db.get(UserSettings, user_id)
    notifications_on = bool(getattr(s, "notifications_enabled", True)) if s else True

    results_list = list(results)
    if not results_list:
        return []

    # Map catalog_item_id -> shelf_item_id for this user
    catalog_ids = {r.catalog_item_id for r in results_list}
    match_rows = (
        db.execute(
            select(CatalogMatch.catalog_item_id, CatalogMatch.shelf_item_id)
            .where(
                CatalogMatch.user_id == user_id,
                CatalogMatch.catalog_item_id.in_(list(catalog_ids)),
            )
        )
        .all()
    )
    catalog_to_shelf = {cid: sid for cid, sid in match_rows}

    # Preload existing snapshots for quick compare
    existing_rows = (
        db.execute(
            select(AvailabilitySnapshot)
            .where(
                AvailabilitySnapshot.user_id == user_id,
                AvailabilitySnapshot.catalog_item_id.in_(list(catalog_ids)),
            )
        )
        .scalars()
        .all()
    )
    existing_by_key: dict[tuple[str, str], AvailabilitySnapshot] = {
        (row.catalog_item_id, row.format): row for row in existing_rows
    }

    created: list[NotificationCreated] = []
    now = utcnow()

    for r in results_list:
        a = r.availability
        key = (r.catalog_item_id, a.format.value)

        prev = existing_by_key.get(key)
        old_status = prev.status if prev is not None else "unknown"
        new_status = a.status.value

        # Upsert snapshot
        if prev is not None:
            prev.status = new_status
            prev.copies_available = a.copies_available
            prev.copies_total = a.copies_total
            prev.holds = a.holds
            prev.deep_link = a.deep_link
            prev.last_checked_at = now
        else:
            row = AvailabilitySnapshot(
                id=str(uuid4()),
                user_id=user_id,
                catalog_item_id=r.catalog_item_id,
                format=a.format.value,
                status=new_status,
                copies_available=a.copies_available,
                copies_total=a.copies_total,
                holds=a.holds,
                deep_link=a.deep_link,
                last_checked_at=now,
            )
            db.add(row)
            existing_by_key[key] = row

        # Emit notification on transition -> available
        if (
            notifications_on
            and old_status in {"hold", "not_owned"}
            and new_status == "available"
        ):
            shelf_item_id = catalog_to_shelf.get(r.catalog_item_id)
            if shelf_item_id:
                ev = NotificationEvent(
                    id=str(uuid4()),
                    user_id=user_id,
                    shelf_item_id=shelf_item_id,
                    format=a.format.value,
                    old_status=old_status,
                    new_status=new_status,
                    deep_link=a.deep_link,
                    created_at=now,
                )
                db.add(ev)

                created.append(
                    NotificationCreated(
                        id=ev.id,
                        shelf_item_id=shelf_item_id,
                        title="",  # hydrated later (optional)
                        format=a.format.value,
                    )
                )

    return created
</file>

<file path="services/api/app/crud/shelf_items.py">
from __future__ import annotations

from app.models.shelf_item import ShelfItem
from sqlalchemy import select
from sqlalchemy.orm import Session


def list_shelf_items_for_user(db: Session, *, user_id: str) -> list[ShelfItem]:
    """Return the user's shelf items ordered from newest to oldest."""
    stmt = (
        select(ShelfItem)
        .where(ShelfItem.user_id == user_id)
        .order_by(ShelfItem.updated_at.desc())
    )
    return list(db.execute(stmt).scalars().all())
</file>

<file path="services/api/app/crud/sync_runs.py">
from __future__ import annotations

from datetime import datetime, timezone
from typing import Optional

from app.models.sync_run import SyncRun
from sqlalchemy.orm import Session


def _utcnow() -> datetime:
    return datetime.now(timezone.utc)


def create_sync_run(db: Session, *, user_id: str, kind: str) -> SyncRun:
    run = SyncRun(
        user_id=user_id,
        kind=kind,
        status="queued",
        progress_current=0,
        progress_total=0,
    )
    db.add(run)
    db.commit()
    db.refresh(run)
    return run


def set_sync_run_running(db: Session, *, run: SyncRun, total: int) -> SyncRun:
    run.status = "running"
    run.started_at = _utcnow()
    run.progress_total = total
    run.progress_current = 0
    db.commit()
    db.refresh(run)
    return run


def update_progress(
    db: Session, *, run: SyncRun, current: int, total: Optional[int] = None
) -> SyncRun:
    run.progress_current = current
    if total is not None:
        run.progress_total = total
    db.commit()
    db.refresh(run)
    return run


def set_sync_run_failed(db: Session, *, run: SyncRun, message: str) -> SyncRun:
    run.status = "failed"
    run.error_message = message
    run.finished_at = _utcnow()
    db.commit()
    db.refresh(run)
    return run


def set_sync_run_succeeded(db: Session, *, run: SyncRun) -> SyncRun:
    run.status = "succeeded"
    run.finished_at = _utcnow()
    db.commit()
    db.refresh(run)
    return run


def get_sync_run(db: Session, *, run_id: str) -> Optional[SyncRun]:
    return db.query(SyncRun).filter(SyncRun.id == run_id).first()


def latest_sync_run_for_user(
    db: Session, *, user_id: str, kind: str = "availability_refresh"
) -> Optional[SyncRun]:
    return (
        db.query(SyncRun)
        .filter(SyncRun.user_id == user_id, SyncRun.kind == kind)
        .order_by(SyncRun.created_at.desc())
        .first()
    )
</file>

<file path="services/api/app/domain/normalize.py">
from __future__ import annotations

import re
from dataclasses import dataclass

_non_alnum = re.compile(r"[^a-z0-9]+")
_digits_or_x = re.compile(r"[^0-9Xx]")


def normalize_text(s: str) -> str:
    s = s.strip().lower()
    s = _non_alnum.sub(" ", s)
    s = " ".join(s.split())
    return s


def normalize_isbn(raw: str) -> str:
    """Return a best-effort normalized ISBN string.

    - Removes hyphens/spaces.
    - Keeps digits (and X for ISBN-10 check digit).
    - Does not validate checksum in Phase 2 (keep it simple and resilient).

    If you want checksum validation later, add it as a non-fatal warning and keep ingestion permissive.
    """
    cleaned = _digits_or_x.sub("", raw or "").upper()
    return cleaned


@dataclass(frozen=True)
class NormalizedIdentifiers:
    isbn13: str | None
    isbn10: str | None
    asin: str | None

    normalized_title: str
    normalized_author: str
    normalized_key: str
    needs_fuzzy_match: bool


def build_normalized(
    *,
    title: str,
    author: str,
    isbn13: str | None = None,
    isbn10: str | None = None,
    asin: str | None = None,
) -> NormalizedIdentifiers:
    n_title = normalize_text(title)
    n_author = normalize_text(author)

    i13 = normalize_isbn(isbn13) if isbn13 else None
    i10 = normalize_isbn(isbn10) if isbn10 else None

    # Prefer ISBN-13, then ISBN-10, then ASIN, else title+author.
    if i13 and len(i13) == 13 and i13.isdigit():
        key = f"isbn13:{i13}"
        return NormalizedIdentifiers(i13, i10, asin, n_title, n_author, key, False)

    if i10 and len(i10) == 10:
        key = f"isbn10:{i10}"
        return NormalizedIdentifiers(i13, i10, asin, n_title, n_author, key, False)

    if asin:
        a = asin.strip()
        key = f"asin:{a}"
        return NormalizedIdentifiers(i13, i10, a, n_title, n_author, key, False)

    # Fallback to fuzzy matching later
    key = f"title_author:{n_title}|{n_author}"
    return NormalizedIdentifiers(i13, i10, asin, n_title, n_author, key, True)
</file>

<file path="services/api/app/models/catalog_item.py">
from __future__ import annotations

from datetime import datetime, timezone
from uuid import uuid4

from app.models.base import Base
from sqlalchemy import JSON, DateTime, String, UniqueConstraint
from sqlalchemy.orm import Mapped, mapped_column


class CatalogItem(Base):
    __tablename__ = "catalog_items"

    id: Mapped[str] = mapped_column(
        String(36), primary_key=True, default=lambda: str(uuid4())
    )

    provider: Mapped[str] = mapped_column(String(40), nullable=False)
    provider_item_id: Mapped[str] = mapped_column(String(160), nullable=False)

    title: Mapped[str] = mapped_column(String(400), nullable=False)
    author: Mapped[str | None] = mapped_column(String(240), nullable=True)

    isbn10: Mapped[str | None] = mapped_column(String(10), nullable=True)
    isbn13: Mapped[str | None] = mapped_column(String(13), nullable=True)
    asin: Mapped[str | None] = mapped_column(String(20), nullable=True)

    raw: Mapped[dict] = mapped_column(JSON, nullable=False, default=dict)

    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        default=lambda: datetime.now(timezone.utc),
        nullable=False,
    )
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        default=lambda: datetime.now(timezone.utc),
        onupdate=lambda: datetime.now(timezone.utc),
        nullable=False,
    )

    __table_args__ = (
        UniqueConstraint(
            "provider", "provider_item_id", name="uq_catalog_items_provider_item"
        ),
    )
</file>

<file path="services/api/app/models/catalog_match.py">
from __future__ import annotations

from datetime import datetime, timezone
from uuid import uuid4

from app.models.base import Base
from sqlalchemy import JSON, DateTime, Float, ForeignKey, String, UniqueConstraint
from sqlalchemy.orm import Mapped, mapped_column


class CatalogMatch(Base):
    __tablename__ = "catalog_matches"

    id: Mapped[str] = mapped_column(
        String(36), primary_key=True, default=lambda: str(uuid4())
    )

    user_id: Mapped[str] = mapped_column(
        String(36),
        ForeignKey("users.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
    )
    shelf_item_id: Mapped[str] = mapped_column(
        String(36),
        ForeignKey("shelf_items.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
    )
    catalog_item_id: Mapped[str] = mapped_column(
        String(36),
        ForeignKey("catalog_items.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
    )

    provider: Mapped[str] = mapped_column(String(40), nullable=False)
    method: Mapped[str] = mapped_column(String(40), nullable=False)  # isbn | fuzzy
    confidence: Mapped[float] = mapped_column(Float, nullable=False)

    # store explainability payload; keep it relatively small
    evidence: Mapped[dict] = mapped_column(JSON, nullable=False, default=dict)

    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        default=lambda: datetime.now(timezone.utc),
        nullable=False,
    )
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        default=lambda: datetime.now(timezone.utc),
        onupdate=lambda: datetime.now(timezone.utc),
        nullable=False,
    )

    __table_args__ = (
        UniqueConstraint(
            "user_id", "shelf_item_id", name="uq_catalog_match_user_shelf_item"
        ),
    )
</file>

<file path="services/api/app/models/sync_run.py">
from __future__ import annotations

from datetime import datetime, timezone
from uuid import uuid4

from app.models.base import Base
from sqlalchemy import DateTime, ForeignKey, Integer, String, Text
from sqlalchemy.orm import Mapped, mapped_column, relationship


def utcnow() -> datetime:
    return datetime.now(timezone.utc)


class SyncRun(Base):
    __tablename__ = "sync_runs"

    id: Mapped[str] = mapped_column(
        String(36), primary_key=True, default=lambda: str(uuid4())
    )

    user_id: Mapped[str] = mapped_column(
        String(36),
        ForeignKey("users.id", ondelete="CASCADE"),
        index=True,
        nullable=False,
    )

    # e.g. "availability_refresh"
    kind: Mapped[str] = mapped_column(String(50), index=True, nullable=False)

    # queued | running | succeeded | failed
    status: Mapped[str] = mapped_column(String(20), index=True, nullable=False)

    progress_current: Mapped[int] = mapped_column(Integer, nullable=False, default=0)
    progress_total: Mapped[int] = mapped_column(Integer, nullable=False, default=0)

    error_message: Mapped[str | None] = mapped_column(Text, nullable=True)

    started_at: Mapped[datetime | None] = mapped_column(
        DateTime(timezone=True), nullable=True
    )
    finished_at: Mapped[datetime | None] = mapped_column(
        DateTime(timezone=True), nullable=True
    )

    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), default=utcnow, nullable=False
    )
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), default=utcnow, onupdate=utcnow, nullable=False
    )

    user = relationship("User", back_populates="sync_runs")
</file>

<file path="services/api/app/models/user_settings.py">
from __future__ import annotations

from datetime import datetime, timezone

from app.models.base import Base
from sqlalchemy import JSON, DateTime, ForeignKey, String
from sqlalchemy.orm import Mapped, mapped_column, relationship


def utcnow() -> datetime:
    return datetime.now(timezone.utc)


class UserSettings(Base):
    __tablename__ = "user_settings"

    user_id: Mapped[str] = mapped_column(
        String(36), ForeignKey("users.id", ondelete="CASCADE"), primary_key=True
    )

    # Selected library system identifier (later phases can formalize this)
    library_system: Mapped[str | None] = mapped_column(String(200), nullable=True)

    # Example: ["ebook", "audiobook"]
    preferred_formats: Mapped[list[str]] = mapped_column(
        JSON, default=list, nullable=False
    )

    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), default=utcnow, onupdate=utcnow, nullable=False
    )

    user = relationship("User", back_populates="settings")
</file>

<file path="services/api/app/providers/factory.py">
from __future__ import annotations

from typing import Iterable

from app.models.catalog_item import CatalogItem
from app.models.catalog_match import CatalogMatch
from app.models.shelf_item import ShelfItem
from app.providers.types import AvailabilityResult
from app.services.catalog.factory import get_provider as get_catalog_provider
from app.workers.async_utils import run_async
from sqlalchemy import select
from sqlalchemy.orm import Session


class AvailabilityProvider:
    """Adapter that fetches provider availability for matched catalog items."""

    def __init__(self, db: Session, user_id: str):
        self._db = db
        self._user_id = user_id
        self._catalog_provider = get_catalog_provider()

    @property
    def name(self) -> str:
        return self._catalog_provider.name

    def availability_bulk(self, items: Iterable[ShelfItem]) -> list[AvailabilityResult]:
        shelf_ids = [s.id for s in items]
        if not shelf_ids:
            return []

        stmt = (
            select(CatalogMatch, CatalogItem)
            .where(CatalogMatch.user_id == self._user_id)
            .where(CatalogMatch.shelf_item_id.in_(shelf_ids))
            .join(CatalogItem, CatalogItem.id == CatalogMatch.catalog_item_id)
            .where(CatalogItem.provider == self._catalog_provider.name)
        )
        rows = self._db.execute(stmt).all()
        if not rows:
            return []

        provider_to_catalog: dict[str, str] = {}
        provider_item_ids: list[str] = []
        for _, catalog_item in rows:
            pid = catalog_item.provider_item_id
            if pid in provider_to_catalog:
                continue
            provider_to_catalog[pid] = catalog_item.id
            provider_item_ids.append(pid)

        # Ask the catalog provider for availability on its own IDs.
        availability_list = run_async(
            self._catalog_provider.availability_bulk(
                provider_item_ids=provider_item_ids
            )
        )

        out: list[AvailabilityResult] = []
        for availability in availability_list:
            catalog_id = provider_to_catalog.get(availability.provider_item_id)
            if not catalog_id:
                continue
            out.append(
                AvailabilityResult(
                    catalog_item_id=catalog_id, availability=availability
                )
            )

        return out


def get_provider(db: Session, user_id: str) -> AvailabilityProvider:
    """
    Return a provider configured for the given user.

    The provider looks up existing catalog matches and delegates availability
    lookups to the configured catalog provider.
    """
    return AvailabilityProvider(db=db, user_id=user_id)
</file>

<file path="services/api/app/providers/fixture_provider.py">
from __future__ import annotations

import os
from typing import Sequence

from app.models.shelf_item import ShelfItem
from app.providers.types import AvailabilityResult
from app.services.catalog.types import AvailabilityStatus, Format, ProviderAvailability


class FixtureProvider:
    """A tiny availability provider used for demos/tests.

    This is intentionally simple: it returns a deterministic "available" result per item.
    The SYNC_INJECT_FAILURE_ONCE env var can be used to force a single failure.
    """

    name = "fixture"

    def availability_bulk(self, items: Sequence[ShelfItem]) -> list[AvailabilityResult]:
        if os.getenv("SYNC_INJECT_FAILURE_ONCE") == "true":
            os.environ["SYNC_INJECT_FAILURE_ONCE"] = "false"
            raise RuntimeError("Injected provider failure (demo)")

        out: list[AvailabilityResult] = []
        for it in items:
            out.append(
                AvailabilityResult(
                    catalog_item_id=it.id,
                    availability=ProviderAvailability(
                        provider="fixture",
                        provider_item_id=it.id,
                        format=Format.ebook,
                        status=AvailabilityStatus.available,
                        copies_available=1,
                        copies_total=1,
                        holds=0,
                    ),
                )
            )
        return out
</file>

<file path="services/api/app/schemas/auth.py">
from __future__ import annotations

from pydantic import BaseModel, EmailStr, Field, field_validator


class SignUpIn(BaseModel):
    email: EmailStr
    password: str = Field(min_length=8, max_length=72)

    @field_validator("password")
    @classmethod
    def password_must_fit_bcrypt_limit(cls, v: str) -> str:
        if len(v.encode("utf-8")) > 72:
            raise ValueError("Password must be 72 bytes or fewer when UTF-8 encoded.")
        return v


class LoginIn(BaseModel):
    email: EmailStr
    password: str


class UserOut(BaseModel):
    id: str
    email: EmailStr

    class Config:
        from_attributes = True
</file>

<file path="services/api/app/schemas/dashboard.py">
from __future__ import annotations

from datetime import datetime

from pydantic import BaseModel


class MatchMiniOut(BaseModel):
    catalog_item_id: str
    provider: str
    provider_item_id: str
    method: str
    confidence: float


class AvailabilityOut(BaseModel):
    format: str
    status: str
    copies_available: int | None
    copies_total: int | None
    holds: int | None
    deep_link: str | None
    last_checked_at: datetime


class ReadNextOut(BaseModel):
    score: float
    tier: str
    best_format: str | None
    hold_ratio: float | None
    reasons: list[str]


class DashboardRowOut(BaseModel):
    shelf_item_id: str
    title: str
    author: str | None
    shelf: str | None
    needs_fuzzy_match: bool

    match: MatchMiniOut | None
    availability: list[AvailabilityOut]
    read_next: ReadNextOut


class LastSyncOut(BaseModel):
    source_type: str | None
    source_id: str | None
    last_synced_at: datetime | None
    last_sync_status: str | None
    last_sync_error: str | None


class PageOut(BaseModel):
    limit: int
    offset: int
    total: int


class DashboardOut(BaseModel):
    settings: dict
    last_sync: LastSyncOut
    page: PageOut
    items: list[DashboardRowOut]
</file>

<file path="services/api/app/schemas/sync_run.py">
from __future__ import annotations

from datetime import datetime

from pydantic import BaseModel


class StartSyncRunIn(BaseModel):
    kind: str


class SyncRunOut(BaseModel):
    id: str
    kind: str
    status: str
    progress_current: int
    progress_total: int
    error_message: str | None = None
    started_at: datetime | None = None
    finished_at: datetime | None = None
    created_at: datetime
    updated_at: datetime

    class Config:
        from_attributes = True


class SyncRunEvent(BaseModel):
    run_id: str
    type: str
    payload: dict
    ts: datetime
</file>

<file path="services/api/app/services/catalog/overdrive_provider.py">
from __future__ import annotations

from app.services.catalog.types import ProviderAvailability, ProviderBook


class OverDriveProvider:
    """Phase 3: interface placeholder.

    Phase 5+: implement real OverDrive/Libby calls (and/or scraping) behind env creds.
    """

    name = "overdrive"

    async def search(
        self,
        *,
        title: str | None,
        author: str | None,
        isbn10: str | None,
        isbn13: str | None,
        limit: int = 10,
    ) -> list[ProviderBook]:
        raise NotImplementedError("OverDriveProvider is implemented in Phase 5+")

    async def availability_bulk(
        self, *, provider_item_ids: list[str]
    ) -> list[ProviderAvailability]:
        raise NotImplementedError("OverDriveProvider is implemented in Phase 5+")
</file>

<file path="services/api/app/services/normalization.py">
import re

_ws = re.compile(r"\s+")
_non_alnum = re.compile(r"[^a-zA-Z0-9]+")


def normalize_text(s: str) -> str:
    # Remove leading and trailing whitespace
    s = (s or "").strip().lower()
    s = _non_alnum.sub(" ", s)
    s = _ws.sub(" ", s).strip()
    return s


def normalize_isbn(s: str | None) -> str | None:
    if not s:
        return None
    digits = re.sub(r"[^0-9xX]", "", s)
    return digits.upper() if digits else None
</file>

<file path="services/api/app/services/shelf_import.py">
from __future__ import annotations

from dataclasses import dataclass, field

from app.models.shelf_item import ShelfItem
from app.models.shelf_source import ShelfSource
from app.services.normalization import normalize_text
from sqlalchemy import select
from sqlalchemy.orm import Session


@dataclass
class ImportErrorItem:
    key: str
    error: str


@dataclass
class ImportSummary:
    created: int = 0
    updated: int = 0
    skipped: int = 0
    errors: list[ImportErrorItem] = field(default_factory=list)


def upsert_shelf_items(
    db: Session, *, user_id: str, source: ShelfSource, items: list[dict]
) -> ImportSummary:
    summary = ImportSummary()

    # Preload existing items by external_id (best effort)
    ext_ids = [it.get("external_id") for it in items if it.get("external_id")]
    existing_by_ext: dict[str, ShelfItem] = {}

    if ext_ids:
        rows = (
            db.execute(
                select(ShelfItem)
                .where(ShelfItem.shelf_source_id == source.id)
                .where(ShelfItem.external_id.in_(ext_ids))
            )
            .scalars()
            .all()
        )
        existing_by_ext = {r.external_id: r for r in rows if r.external_id}

    for it in items:
        try:
            title = (it.get("title") or "").strip()
            author = (it.get("author") or "").strip()
            if not title or not author:
                summary.skipped += 1
                continue

            isbn10 = it.get("isbn10")
            isbn13 = it.get("isbn13")
            asin = it.get("asin")
            ext = it.get("external_id")

            norm_title = normalize_text(title)
            norm_author = normalize_text(author)
            needs_fuzzy = not (isbn10 or isbn13 or asin)

            row = existing_by_ext.get(ext) if ext else None
            if row:
                row.title = title
                row.author = author
                row.isbn10 = isbn10
                row.isbn13 = isbn13
                row.asin = asin
                row.normalized_title = norm_title
                row.normalized_author = norm_author
                row.shelf = it.get("shelf")
                row.needs_fuzzy_match = needs_fuzzy
                summary.updated += 1
            else:
                db.add(
                    ShelfItem(
                        user_id=user_id,
                        shelf_source_id=source.id,
                        external_id=ext,
                        title=title,
                        author=author,
                        isbn10=isbn10,
                        isbn13=isbn13,
                        asin=asin,
                        normalized_title=norm_title,
                        normalized_author=norm_author,
                        shelf=it.get("shelf"),
                        needs_fuzzy_match=needs_fuzzy,
                    )
                )
                summary.created += 1

        except Exception as e:
            summary.errors.append(
                ImportErrorItem(key=str(it.get("external_id") or title), error=str(e))
            )

    db.commit()
    return summary
</file>

<file path="services/api/app/workers/async_utils.py">
from __future__ import annotations

import asyncio
from typing import Awaitable, TypeVar

T = TypeVar("T")


def run_async(coro: Awaitable[T]) -> T:
    """Run an async coroutine from a sync context.

    Uses a fresh event loop to avoid "asyncio.run() cannot be called" edge cases.
    """
    loop = asyncio.new_event_loop()
    try:
        asyncio.set_event_loop(loop)
        return loop.run_until_complete(coro)
    finally:
        try:
            loop.close()
        finally:
            asyncio.set_event_loop(None)
</file>

<file path="services/api/app/workers/events.py">
from __future__ import annotations

import json
from datetime import datetime
from typing import Any

from app.core.config import settings
from app.core.redis import get_redis


def publish_sync_event(
    *, user_id: str, run_id: str, type_: str, payload: dict[str, Any]
):
    r = get_redis(settings.redis_url)
    channel = f"sync:{user_id}:{run_id}"
    body = {
        "type": type_,
        "payload": payload,
        "ts": datetime.utcnow().isoformat() + "Z",
    }
    r.publish(channel, json.dumps(body))


def publish_notification_event(*, user_id: str, payload: dict[str, Any]) -> None:
    r = get_redis(settings.redis_url)
    channel = f"notify:{user_id}"
    body = {
        "type": "notification",
        "payload": payload,
        "ts": datetime.utcnow().isoformat() + "Z",
    }
    r.publish(channel, json.dumps(body))
</file>

<file path="services/api/tests/conftest.py">
import os

import pytest
from app.db.session import get_db
from app.main import app
from app.models import Base
from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import StaticPool


@pytest.fixture(scope="session")
def engine():
    # Prefer a dedicated Postgres DB for realism.
    # Override at runtime: DATABASE_URL=... pytest
    url = os.getenv("DATABASE_URL")
    if url:
        eng = create_engine(url, pool_pre_ping=True)
    else:
        # Default to in-memory SQLite so tests run without external services.
        eng = create_engine(
            "sqlite+pysqlite:///:memory:",
            connect_args={"check_same_thread": False},
            poolclass=StaticPool,
        )

    # For speed, create tables directly in tests.
    # In CI, consider running `alembic upgrade head` and omitting create_all.
    Base.metadata.create_all(bind=eng)
    yield eng
    Base.metadata.drop_all(bind=eng)


@pytest.fixture()
def db_session(engine):
    connection = engine.connect()
    tx = connection.begin()

    TestingSessionLocal = sessionmaker(
        autocommit=False, autoflush=False, bind=connection
    )
    session = TestingSessionLocal()

    try:
        yield session
    finally:
        session.close()
        tx.rollback()
        connection.close()


@pytest.fixture()
def client(db_session):
    def override_get_db():
        yield db_session

    app.dependency_overrides[get_db] = override_get_db
    with TestClient(app) as c:
        yield c
    app.dependency_overrides.clear()
</file>

<file path="services/api/tests/test_goodreads_csv_parser.py">
import pytest
from app.services.goodreads_csv import CsvImportError, parse_goodreads_csv


def test_parse_goodreads_csv_minimal():
    csv_bytes = (
        "Title,Author,Book Id,ISBN,ISBN13,Exclusive Shelf\n"
        "Dune,Frank Herbert,42,0441013597,9780441013593,to-read\n"
    ).encode("utf-8")

    rows, errors = parse_goodreads_csv(csv_bytes)
    assert errors == []
    assert len(rows) == 1
    assert rows[0]["title"] == "Dune"
    assert rows[0]["author"] == "Frank Herbert"
    assert rows[0]["external_id"] == "42"


def test_parse_goodreads_csv_missing_columns():
    bad = "A,B\n1,2\n".encode("utf-8")
    with pytest.raises(CsvImportError):
        parse_goodreads_csv(bad)
</file>

<file path="services/api/tests/test_goodreads_rss_parser.py">
import pytest
from app.services.goodreads_rss import parse_goodreads_rss


def test_parse_goodreads_rss_minimal():
    xml = """<?xml version="1.0"?>
<rss><channel>
  <item>
    <guid>123</guid>
    <book_title>The Hobbit</book_title>
    <author_name>J.R.R. Tolkien</author_name>
    <isbn13>9780547928227</isbn13>
  </item>
</channel></rss>
"""

    items = parse_goodreads_rss(xml, default_shelf="to-read")
    assert len(items) == 1
    assert items[0].external_id == "123"
    assert items[0].title == "The Hobbit"
    assert items[0].author == "J.R.R. Tolkien"
    assert items[0].isbn13 == "9780547928227"
    assert items[0].shelf == "to-read"


def test_parse_bad_xml_raises():
    with pytest.raises(ValueError):
        parse_goodreads_rss("<rss>")
</file>

<file path="services/api/tests/test_matching.py">
import pytest
from app.services.catalog.fixture_provider import FixtureProvider
from app.services.matching.matcher import match_shelf_item


class DummyShelfItem:
    def __init__(self, title, author=None, isbn10=None, isbn13=None):
        self.title = title
        self.author = author
        self.isbn10 = isbn10
        self.isbn13 = isbn13


@pytest.mark.asyncio
async def test_isbn_match(tmp_path):
    fixture = tmp_path / "f.json"
    fixture.write_text(
        '{"provider":"fixture","items":[{"provider_item_id":"x","title":"T","author":"A","isbn13":"9780593135204","formats":{}}]}',
        encoding="utf-8",
    )
    provider = FixtureProvider(str(fixture))
    item = DummyShelfItem(
        title="Project Hail Mary", author="Andy Weir", isbn13="9780593135204"
    )

    res = await match_shelf_item(provider, item)  # type: ignore[arg-type]
    assert res is not None
    assert res.method == "isbn"
    assert res.confidence == 1.0


@pytest.mark.asyncio
async def test_fuzzy_match_threshold(tmp_path):
    fixture = tmp_path / "f.json"
    fixture.write_text(
        '{"provider":"fixture","items":[{"provider_item_id":"x","title":"The Hobbit","author":"J.R.R. Tolkien","formats":{}}]}',
        encoding="utf-8",
    )
    provider = FixtureProvider(str(fixture))

    good = DummyShelfItem(title="Hobbit", author="Tolkien")
    res = await match_shelf_item(provider, good)  # type: ignore[arg-type]
    assert res is not None
    assert res.method == "fuzzy"

    bad = DummyShelfItem(title="Completely Different Book", author="Nobody")
    res2 = await match_shelf_item(provider, bad)  # type: ignore[arg-type]
    assert res2 is None
</file>

<file path="services/api/tests/test_shelf_import_idempotent.py">
from app.models.base import Base
from app.models.shelf_source import ShelfSource
from app.services.shelf_import import upsert_shelf_items
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker


def test_upsert_idempotent():
    eng = create_engine("sqlite+pysqlite:///:memory:")
    Base.metadata.create_all(bind=eng)
    Session = sessionmaker(bind=eng)

    db = Session()
    source = ShelfSource(
        user_id="u1",
        source_type="rss",
        provider="goodreads",
        source_ref="x",
        meta={},
        is_active=True,
    )
    db.add(source)
    db.commit()
    db.refresh(source)

    items = [
        {
            "external_id": "1",
            "title": "A",
            "author": "B",
            "isbn10": None,
            "isbn13": None,
            "asin": None,
            "shelf": "to-read",
        }
    ]

    s1 = upsert_shelf_items(db, user_id="u1", source=source, items=items)
    assert s1.created == 1

    s2 = upsert_shelf_items(db, user_id="u1", source=source, items=items)
    assert s2.created == 0
    assert s2.updated == 1
</file>

<file path="services/api/tests/test_sync_runs.py">
def test_start_sync_run_creates_run_and_enqueues_job(client, monkeypatch):
    # Arrange: sign in user (reuse existing helpers)
    # monkeypatch enqueue_availability_refresh to avoid hitting redis

    called = {}

    def fake_enqueue_availability_refresh(*, sync_run_id):
        called["id"] = str(sync_run_id)

    monkeypatch.setattr(
        "app.api.routes.sync_runs.enqueue_availability_refresh",
        fake_enqueue_availability_refresh,
    )

    # Act
    resp = client.post("/v1/sync-runs", json={"kind": "availability_refresh"})

    # Assert
    assert resp.status_code == 200
    body = resp.json()
    assert body["status"] == "queued"
    assert called["id"] == body["id"]
</file>

<file path="services/api/requirements-dev.txt">
black==24.8.0
isort==5.13.2
mypy==1.11.2
pytest==8.3.2
pytest-asyncio==0.24.0
pytest-cov==5.0.0
ruff==0.6.2
types-python-jose
APScheduler==3.11.2
</file>

<file path=".gitignore">
# Python
__pycache__/
*.py[cod]
.venv/
.pytest_cache/
.mypy_cache/

# Node
node_modules/
.next/
out/

# Env
.env
.env.*
!.env.example
!.env.*.example

# OS
.DS_Store
</file>

<file path="Makefile">
.PHONY: infra-up infra-down api-test web-check dev api-alembic

infra-up:
	docker compose -f infra/docker-compose.yml up -d

infra-down:
	docker compose -f infra/docker-compose.yml down

api-test:
	cd services/api && . .venv/bin/activate && black . && isort . && pytest

web-check:
	cd apps/web && npm run lint && npm run build

dev:
	./scripts/dev.sh

api-alembic:
	cd services/api && ./bin/alembic $(ARGS)
</file>

<file path="apps/web/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2020",
    "lib": [
      "DOM",
      "DOM.Iterable",
      "ES2020"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "baseUrl": ".",
    "paths": {
      "@/*": [
        "./src/*"
      ]
    },
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "types": ["vitest/globals"]
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="apps/web/tsconfig.tsbuildinfo">
{"fileNames":["./node_modules/typescript/lib/lib.es5.d.ts","./node_modules/typescript/lib/lib.es2015.d.ts","./node_modules/typescript/lib/lib.es2016.d.ts","./node_modules/typescript/lib/lib.es2017.d.ts","./node_modules/typescript/lib/lib.es2018.d.ts","./node_modules/typescript/lib/lib.es2019.d.ts","./node_modules/typescript/lib/lib.es2020.d.ts","./node_modules/typescript/lib/lib.dom.d.ts","./node_modules/typescript/lib/lib.dom.iterable.d.ts","./node_modules/typescript/lib/lib.es2015.core.d.ts","./node_modules/typescript/lib/lib.es2015.collection.d.ts","./node_modules/typescript/lib/lib.es2015.generator.d.ts","./node_modules/typescript/lib/lib.es2015.iterable.d.ts","./node_modules/typescript/lib/lib.es2015.promise.d.ts","./node_modules/typescript/lib/lib.es2015.proxy.d.ts","./node_modules/typescript/lib/lib.es2015.reflect.d.ts","./node_modules/typescript/lib/lib.es2015.symbol.d.ts","./node_modules/typescript/lib/lib.es2015.symbol.wellknown.d.ts","./node_modules/typescript/lib/lib.es2016.array.include.d.ts","./node_modules/typescript/lib/lib.es2016.intl.d.ts","./node_modules/typescript/lib/lib.es2017.arraybuffer.d.ts","./node_modules/typescript/lib/lib.es2017.date.d.ts","./node_modules/typescript/lib/lib.es2017.object.d.ts","./node_modules/typescript/lib/lib.es2017.sharedmemory.d.ts","./node_modules/typescript/lib/lib.es2017.string.d.ts","./node_modules/typescript/lib/lib.es2017.intl.d.ts","./node_modules/typescript/lib/lib.es2017.typedarrays.d.ts","./node_modules/typescript/lib/lib.es2018.asyncgenerator.d.ts","./node_modules/typescript/lib/lib.es2018.asynciterable.d.ts","./node_modules/typescript/lib/lib.es2018.intl.d.ts","./node_modules/typescript/lib/lib.es2018.promise.d.ts","./node_modules/typescript/lib/lib.es2018.regexp.d.ts","./node_modules/typescript/lib/lib.es2019.array.d.ts","./node_modules/typescript/lib/lib.es2019.object.d.ts","./node_modules/typescript/lib/lib.es2019.string.d.ts","./node_modules/typescript/lib/lib.es2019.symbol.d.ts","./node_modules/typescript/lib/lib.es2019.intl.d.ts","./node_modules/typescript/lib/lib.es2020.bigint.d.ts","./node_modules/typescript/lib/lib.es2020.date.d.ts","./node_modules/typescript/lib/lib.es2020.promise.d.ts","./node_modules/typescript/lib/lib.es2020.sharedmemory.d.ts","./node_modules/typescript/lib/lib.es2020.string.d.ts","./node_modules/typescript/lib/lib.es2020.symbol.wellknown.d.ts","./node_modules/typescript/lib/lib.es2020.intl.d.ts","./node_modules/typescript/lib/lib.es2020.number.d.ts","./node_modules/typescript/lib/lib.decorators.d.ts","./node_modules/typescript/lib/lib.decorators.legacy.d.ts","./node_modules/next/dist/styled-jsx/types/css.d.ts","./node_modules/@types/react/global.d.ts","./node_modules/csstype/index.d.ts","./node_modules/@types/prop-types/index.d.ts","./node_modules/@types/react/index.d.ts","./node_modules/next/dist/styled-jsx/types/index.d.ts","./node_modules/next/dist/styled-jsx/types/macro.d.ts","./node_modules/next/dist/styled-jsx/types/style.d.ts","./node_modules/next/dist/styled-jsx/types/global.d.ts","./node_modules/next/dist/shared/lib/amp.d.ts","./node_modules/next/amp.d.ts","./node_modules/@types/node/compatibility/disposable.d.ts","./node_modules/@types/node/compatibility/indexable.d.ts","./node_modules/@types/node/compatibility/iterators.d.ts","./node_modules/@types/node/compatibility/index.d.ts","./node_modules/@types/node/globals.typedarray.d.ts","./node_modules/@types/node/buffer.buffer.d.ts","./node_modules/@types/node/globals.d.ts","./node_modules/@types/node/web-globals/abortcontroller.d.ts","./node_modules/@types/node/web-globals/domexception.d.ts","./node_modules/@types/node/web-globals/events.d.ts","./node_modules/undici-types/header.d.ts","./node_modules/undici-types/readable.d.ts","./node_modules/undici-types/file.d.ts","./node_modules/undici-types/fetch.d.ts","./node_modules/undici-types/formdata.d.ts","./node_modules/undici-types/connector.d.ts","./node_modules/undici-types/client.d.ts","./node_modules/undici-types/errors.d.ts","./node_modules/undici-types/dispatcher.d.ts","./node_modules/undici-types/global-dispatcher.d.ts","./node_modules/undici-types/global-origin.d.ts","./node_modules/undici-types/pool-stats.d.ts","./node_modules/undici-types/pool.d.ts","./node_modules/undici-types/handlers.d.ts","./node_modules/undici-types/balanced-pool.d.ts","./node_modules/undici-types/agent.d.ts","./node_modules/undici-types/mock-interceptor.d.ts","./node_modules/undici-types/mock-agent.d.ts","./node_modules/undici-types/mock-client.d.ts","./node_modules/undici-types/mock-pool.d.ts","./node_modules/undici-types/mock-errors.d.ts","./node_modules/undici-types/proxy-agent.d.ts","./node_modules/undici-types/env-http-proxy-agent.d.ts","./node_modules/undici-types/retry-handler.d.ts","./node_modules/undici-types/retry-agent.d.ts","./node_modules/undici-types/api.d.ts","./node_modules/undici-types/interceptors.d.ts","./node_modules/undici-types/util.d.ts","./node_modules/undici-types/cookies.d.ts","./node_modules/undici-types/patch.d.ts","./node_modules/undici-types/websocket.d.ts","./node_modules/undici-types/eventsource.d.ts","./node_modules/undici-types/filereader.d.ts","./node_modules/undici-types/diagnostics-channel.d.ts","./node_modules/undici-types/content-type.d.ts","./node_modules/undici-types/cache.d.ts","./node_modules/undici-types/index.d.ts","./node_modules/@types/node/web-globals/fetch.d.ts","./node_modules/@types/node/assert.d.ts","./node_modules/@types/node/assert/strict.d.ts","./node_modules/@types/node/async_hooks.d.ts","./node_modules/@types/node/buffer.d.ts","./node_modules/@types/node/child_process.d.ts","./node_modules/@types/node/cluster.d.ts","./node_modules/@types/node/console.d.ts","./node_modules/@types/node/constants.d.ts","./node_modules/@types/node/crypto.d.ts","./node_modules/@types/node/dgram.d.ts","./node_modules/@types/node/diagnostics_channel.d.ts","./node_modules/@types/node/dns.d.ts","./node_modules/@types/node/dns/promises.d.ts","./node_modules/@types/node/domain.d.ts","./node_modules/@types/node/events.d.ts","./node_modules/@types/node/fs.d.ts","./node_modules/@types/node/fs/promises.d.ts","./node_modules/@types/node/http.d.ts","./node_modules/@types/node/http2.d.ts","./node_modules/@types/node/https.d.ts","./node_modules/@types/node/inspector.generated.d.ts","./node_modules/@types/node/module.d.ts","./node_modules/@types/node/net.d.ts","./node_modules/@types/node/os.d.ts","./node_modules/@types/node/path.d.ts","./node_modules/@types/node/perf_hooks.d.ts","./node_modules/@types/node/process.d.ts","./node_modules/@types/node/punycode.d.ts","./node_modules/@types/node/querystring.d.ts","./node_modules/@types/node/readline.d.ts","./node_modules/@types/node/readline/promises.d.ts","./node_modules/@types/node/repl.d.ts","./node_modules/@types/node/sea.d.ts","./node_modules/@types/node/stream.d.ts","./node_modules/@types/node/stream/promises.d.ts","./node_modules/@types/node/stream/consumers.d.ts","./node_modules/@types/node/stream/web.d.ts","./node_modules/@types/node/string_decoder.d.ts","./node_modules/@types/node/test.d.ts","./node_modules/@types/node/timers.d.ts","./node_modules/@types/node/timers/promises.d.ts","./node_modules/@types/node/tls.d.ts","./node_modules/@types/node/trace_events.d.ts","./node_modules/@types/node/tty.d.ts","./node_modules/@types/node/url.d.ts","./node_modules/@types/node/util.d.ts","./node_modules/@types/node/v8.d.ts","./node_modules/@types/node/vm.d.ts","./node_modules/@types/node/wasi.d.ts","./node_modules/@types/node/worker_threads.d.ts","./node_modules/@types/node/zlib.d.ts","./node_modules/@types/node/index.d.ts","./node_modules/next/dist/server/get-page-files.d.ts","./node_modules/@types/react/canary.d.ts","./node_modules/@types/react/experimental.d.ts","./node_modules/@types/react-dom/index.d.ts","./node_modules/@types/react-dom/canary.d.ts","./node_modules/@types/react-dom/experimental.d.ts","./node_modules/next/dist/compiled/webpack/webpack.d.ts","./node_modules/next/dist/server/config.d.ts","./node_modules/next/dist/lib/load-custom-routes.d.ts","./node_modules/next/dist/shared/lib/image-config.d.ts","./node_modules/next/dist/build/webpack/plugins/subresource-integrity-plugin.d.ts","./node_modules/next/dist/server/body-streams.d.ts","./node_modules/next/dist/server/future/route-kind.d.ts","./node_modules/next/dist/server/future/route-definitions/route-definition.d.ts","./node_modules/next/dist/server/future/route-matches/route-match.d.ts","./node_modules/next/dist/client/components/app-router-headers.d.ts","./node_modules/next/dist/server/request-meta.d.ts","./node_modules/next/dist/server/lib/revalidate.d.ts","./node_modules/next/dist/server/config-shared.d.ts","./node_modules/next/dist/server/base-http/index.d.ts","./node_modules/next/dist/server/api-utils/index.d.ts","./node_modules/next/dist/server/node-environment.d.ts","./node_modules/next/dist/server/require-hook.d.ts","./node_modules/next/dist/server/node-polyfill-crypto.d.ts","./node_modules/next/dist/lib/page-types.d.ts","./node_modules/next/dist/build/analysis/get-page-static-info.d.ts","./node_modules/next/dist/build/webpack/loaders/get-module-build-info.d.ts","./node_modules/next/dist/build/webpack/plugins/middleware-plugin.d.ts","./node_modules/next/dist/server/render-result.d.ts","./node_modules/next/dist/server/future/helpers/i18n-provider.d.ts","./node_modules/next/dist/server/web/next-url.d.ts","./node_modules/next/dist/compiled/@edge-runtime/cookies/index.d.ts","./node_modules/next/dist/server/web/spec-extension/cookies.d.ts","./node_modules/next/dist/server/web/spec-extension/request.d.ts","./node_modules/next/dist/server/web/spec-extension/fetch-event.d.ts","./node_modules/next/dist/server/web/spec-extension/response.d.ts","./node_modules/next/dist/server/web/types.d.ts","./node_modules/next/dist/lib/setup-exception-listeners.d.ts","./node_modules/next/dist/lib/constants.d.ts","./node_modules/next/dist/build/index.d.ts","./node_modules/next/dist/build/webpack/plugins/pages-manifest-plugin.d.ts","./node_modules/next/dist/shared/lib/router/utils/route-regex.d.ts","./node_modules/next/dist/shared/lib/router/utils/route-matcher.d.ts","./node_modules/next/dist/shared/lib/router/utils/parse-url.d.ts","./node_modules/next/dist/server/base-http/node.d.ts","./node_modules/next/dist/server/font-utils.d.ts","./node_modules/next/dist/build/webpack/plugins/flight-manifest-plugin.d.ts","./node_modules/next/dist/server/future/route-modules/route-module.d.ts","./node_modules/next/dist/shared/lib/deep-readonly.d.ts","./node_modules/next/dist/server/load-components.d.ts","./node_modules/next/dist/shared/lib/router/utils/middleware-route-matcher.d.ts","./node_modules/next/dist/build/webpack/plugins/next-font-manifest-plugin.d.ts","./node_modules/next/dist/server/future/route-definitions/locale-route-definition.d.ts","./node_modules/next/dist/server/future/route-definitions/pages-route-definition.d.ts","./node_modules/next/dist/shared/lib/mitt.d.ts","./node_modules/next/dist/client/with-router.d.ts","./node_modules/next/dist/client/router.d.ts","./node_modules/next/dist/client/route-loader.d.ts","./node_modules/next/dist/client/page-loader.d.ts","./node_modules/next/dist/shared/lib/bloom-filter.d.ts","./node_modules/next/dist/shared/lib/router/router.d.ts","./node_modules/next/dist/shared/lib/router-context.shared-runtime.d.ts","./node_modules/next/dist/shared/lib/loadable-context.shared-runtime.d.ts","./node_modules/next/dist/shared/lib/loadable.shared-runtime.d.ts","./node_modules/next/dist/shared/lib/image-config-context.shared-runtime.d.ts","./node_modules/next/dist/shared/lib/hooks-client-context.shared-runtime.d.ts","./node_modules/next/dist/shared/lib/head-manager-context.shared-runtime.d.ts","./node_modules/next/dist/server/future/route-definitions/app-page-route-definition.d.ts","./node_modules/next/dist/shared/lib/modern-browserslist-target.d.ts","./node_modules/next/dist/shared/lib/constants.d.ts","./node_modules/next/dist/build/webpack/loaders/metadata/types.d.ts","./node_modules/next/dist/build/page-extensions-type.d.ts","./node_modules/next/dist/build/webpack/loaders/next-app-loader.d.ts","./node_modules/next/dist/server/lib/app-dir-module.d.ts","./node_modules/next/dist/server/response-cache/types.d.ts","./node_modules/next/dist/server/response-cache/index.d.ts","./node_modules/next/dist/server/lib/incremental-cache/index.d.ts","./node_modules/next/dist/client/components/hooks-server-context.d.ts","./node_modules/next/dist/server/app-render/dynamic-rendering.d.ts","./node_modules/next/dist/client/components/static-generation-async-storage-instance.d.ts","./node_modules/next/dist/client/components/static-generation-async-storage.external.d.ts","./node_modules/next/dist/server/web/spec-extension/adapters/request-cookies.d.ts","./node_modules/next/dist/server/async-storage/draft-mode-provider.d.ts","./node_modules/next/dist/server/web/spec-extension/adapters/headers.d.ts","./node_modules/next/dist/client/components/request-async-storage-instance.d.ts","./node_modules/next/dist/client/components/request-async-storage.external.d.ts","./node_modules/next/dist/server/app-render/create-error-handler.d.ts","./node_modules/next/dist/server/app-render/app-render.d.ts","./node_modules/next/dist/shared/lib/server-inserted-html.shared-runtime.d.ts","./node_modules/next/dist/shared/lib/amp-context.shared-runtime.d.ts","./node_modules/next/dist/server/future/route-modules/app-page/vendored/contexts/entrypoints.d.ts","./node_modules/next/dist/server/future/route-modules/app-page/module.compiled.d.ts","./node_modules/@types/react/jsx-runtime.d.ts","./node_modules/next/dist/client/components/error-boundary.d.ts","./node_modules/next/dist/client/components/router-reducer/create-initial-router-state.d.ts","./node_modules/next/dist/client/components/app-router.d.ts","./node_modules/next/dist/client/components/layout-router.d.ts","./node_modules/next/dist/client/components/render-from-template-context.d.ts","./node_modules/next/dist/client/components/action-async-storage-instance.d.ts","./node_modules/next/dist/client/components/action-async-storage.external.d.ts","./node_modules/next/dist/client/components/client-page.d.ts","./node_modules/next/dist/client/components/search-params.d.ts","./node_modules/next/dist/client/components/not-found-boundary.d.ts","./node_modules/next/dist/server/app-render/rsc/preloads.d.ts","./node_modules/next/dist/server/app-render/rsc/postpone.d.ts","./node_modules/next/dist/server/app-render/rsc/taint.d.ts","./node_modules/next/dist/server/app-render/entry-base.d.ts","./node_modules/next/dist/build/templates/app-page.d.ts","./node_modules/next/dist/server/future/route-modules/app-page/module.d.ts","./node_modules/next/dist/server/lib/builtin-request-context.d.ts","./node_modules/next/dist/server/app-render/types.d.ts","./node_modules/next/dist/client/components/router-reducer/fetch-server-response.d.ts","./node_modules/next/dist/client/components/router-reducer/router-reducer-types.d.ts","./node_modules/next/dist/shared/lib/app-router-context.shared-runtime.d.ts","./node_modules/next/dist/server/future/route-modules/pages/vendored/contexts/entrypoints.d.ts","./node_modules/next/dist/server/future/route-modules/pages/module.compiled.d.ts","./node_modules/next/dist/build/templates/pages.d.ts","./node_modules/next/dist/server/future/route-modules/pages/module.d.ts","./node_modules/next/dist/server/render.d.ts","./node_modules/next/dist/server/future/route-definitions/pages-api-route-definition.d.ts","./node_modules/next/dist/server/future/route-matches/pages-api-route-match.d.ts","./node_modules/next/dist/server/future/route-matchers/route-matcher.d.ts","./node_modules/next/dist/server/future/route-matcher-providers/route-matcher-provider.d.ts","./node_modules/next/dist/server/future/route-matcher-managers/route-matcher-manager.d.ts","./node_modules/next/dist/server/future/normalizers/normalizer.d.ts","./node_modules/next/dist/server/future/normalizers/locale-route-normalizer.d.ts","./node_modules/next/dist/server/future/normalizers/request/pathname-normalizer.d.ts","./node_modules/next/dist/server/future/normalizers/request/suffix.d.ts","./node_modules/next/dist/server/future/normalizers/request/rsc.d.ts","./node_modules/next/dist/server/future/normalizers/request/prefix.d.ts","./node_modules/next/dist/server/future/normalizers/request/postponed.d.ts","./node_modules/next/dist/server/future/normalizers/request/action.d.ts","./node_modules/next/dist/server/future/normalizers/request/prefetch-rsc.d.ts","./node_modules/next/dist/server/future/normalizers/request/next-data.d.ts","./node_modules/next/dist/server/base-server.d.ts","./node_modules/next/dist/server/image-optimizer.d.ts","./node_modules/next/dist/server/next-server.d.ts","./node_modules/next/dist/lib/coalesced-function.d.ts","./node_modules/next/dist/server/lib/router-utils/types.d.ts","./node_modules/next/dist/trace/types.d.ts","./node_modules/next/dist/trace/trace.d.ts","./node_modules/next/dist/trace/shared.d.ts","./node_modules/next/dist/trace/index.d.ts","./node_modules/next/dist/build/load-jsconfig.d.ts","./node_modules/next/dist/build/webpack-config.d.ts","./node_modules/next/dist/build/webpack/plugins/define-env-plugin.d.ts","./node_modules/next/dist/build/swc/index.d.ts","./node_modules/next/dist/server/dev/parse-version-info.d.ts","./node_modules/next/dist/server/dev/hot-reloader-types.d.ts","./node_modules/next/dist/telemetry/storage.d.ts","./node_modules/next/dist/server/lib/types.d.ts","./node_modules/next/dist/server/lib/render-server.d.ts","./node_modules/next/dist/server/lib/router-server.d.ts","./node_modules/next/dist/shared/lib/router/utils/path-match.d.ts","./node_modules/next/dist/server/lib/router-utils/filesystem.d.ts","./node_modules/next/dist/server/lib/router-utils/setup-dev-bundler.d.ts","./node_modules/next/dist/server/lib/dev-bundler-service.d.ts","./node_modules/next/dist/server/dev/static-paths-worker.d.ts","./node_modules/next/dist/server/dev/next-dev-server.d.ts","./node_modules/next/dist/server/next.d.ts","./node_modules/next/dist/lib/metadata/types/alternative-urls-types.d.ts","./node_modules/next/dist/lib/metadata/types/extra-types.d.ts","./node_modules/next/dist/lib/metadata/types/metadata-types.d.ts","./node_modules/next/dist/lib/metadata/types/manifest-types.d.ts","./node_modules/next/dist/lib/metadata/types/opengraph-types.d.ts","./node_modules/next/dist/lib/metadata/types/twitter-types.d.ts","./node_modules/next/dist/lib/metadata/types/metadata-interface.d.ts","./node_modules/next/types/index.d.ts","./node_modules/next/dist/shared/lib/html-context.shared-runtime.d.ts","./node_modules/@next/env/dist/index.d.ts","./node_modules/next/dist/shared/lib/utils.d.ts","./node_modules/next/dist/pages/_app.d.ts","./node_modules/next/app.d.ts","./node_modules/next/dist/server/web/spec-extension/unstable-cache.d.ts","./node_modules/next/dist/server/web/spec-extension/revalidate.d.ts","./node_modules/next/dist/server/web/spec-extension/unstable-no-store.d.ts","./node_modules/next/cache.d.ts","./node_modules/next/dist/shared/lib/runtime-config.external.d.ts","./node_modules/next/config.d.ts","./node_modules/next/dist/pages/_document.d.ts","./node_modules/next/document.d.ts","./node_modules/next/dist/shared/lib/dynamic.d.ts","./node_modules/next/dynamic.d.ts","./node_modules/next/dist/pages/_error.d.ts","./node_modules/next/error.d.ts","./node_modules/next/dist/shared/lib/head.d.ts","./node_modules/next/head.d.ts","./node_modules/next/dist/client/components/draft-mode.d.ts","./node_modules/next/dist/client/components/headers.d.ts","./node_modules/next/headers.d.ts","./node_modules/next/dist/shared/lib/get-img-props.d.ts","./node_modules/next/dist/client/image-component.d.ts","./node_modules/next/dist/shared/lib/image-external.d.ts","./node_modules/next/image.d.ts","./node_modules/next/dist/client/link.d.ts","./node_modules/next/link.d.ts","./node_modules/next/dist/client/components/redirect-status-code.d.ts","./node_modules/next/dist/client/components/redirect.d.ts","./node_modules/next/dist/client/components/not-found.d.ts","./node_modules/next/dist/client/components/navigation.react-server.d.ts","./node_modules/next/dist/client/components/navigation.d.ts","./node_modules/next/navigation.d.ts","./node_modules/next/router.d.ts","./node_modules/next/dist/client/script.d.ts","./node_modules/next/script.d.ts","./node_modules/next/dist/server/web/spec-extension/user-agent.d.ts","./node_modules/next/dist/compiled/@edge-runtime/primitives/url.d.ts","./node_modules/next/dist/server/web/spec-extension/image-response.d.ts","./node_modules/next/dist/compiled/@vercel/og/satori/index.d.ts","./node_modules/next/dist/compiled/@vercel/og/emoji/index.d.ts","./node_modules/next/dist/compiled/@vercel/og/types.d.ts","./node_modules/next/server.d.ts","./node_modules/next/types/global.d.ts","./node_modules/next/types/compiled.d.ts","./node_modules/next/index.d.ts","./node_modules/next/image-types/global.d.ts","./next-env.d.ts","./node_modules/vite/types/hmrpayload.d.ts","./node_modules/vite/dist/node/chunks/modulerunnertransport.d.ts","./node_modules/vite/types/customevent.d.ts","./node_modules/@types/estree/index.d.ts","./node_modules/rollup/dist/rollup.d.ts","./node_modules/rollup/dist/parseast.d.ts","./node_modules/vite/types/hot.d.ts","./node_modules/vite/dist/node/module-runner.d.ts","./node_modules/esbuild/lib/main.d.ts","./node_modules/vite/types/internal/terseroptions.d.ts","./node_modules/source-map-js/source-map.d.ts","./node_modules/postcss/lib/previous-map.d.ts","./node_modules/postcss/lib/input.d.ts","./node_modules/postcss/lib/css-syntax-error.d.ts","./node_modules/postcss/lib/declaration.d.ts","./node_modules/postcss/lib/root.d.ts","./node_modules/postcss/lib/warning.d.ts","./node_modules/postcss/lib/lazy-result.d.ts","./node_modules/postcss/lib/no-work-result.d.ts","./node_modules/postcss/lib/processor.d.ts","./node_modules/postcss/lib/result.d.ts","./node_modules/postcss/lib/document.d.ts","./node_modules/postcss/lib/rule.d.ts","./node_modules/postcss/lib/node.d.ts","./node_modules/postcss/lib/comment.d.ts","./node_modules/postcss/lib/container.d.ts","./node_modules/postcss/lib/at-rule.d.ts","./node_modules/postcss/lib/list.d.ts","./node_modules/postcss/lib/postcss.d.ts","./node_modules/postcss/lib/postcss.d.mts","./node_modules/vite/types/internal/csspreprocessoroptions.d.ts","./node_modules/vite/types/internal/lightningcssoptions.d.ts","./node_modules/vite/types/importglob.d.ts","./node_modules/vite/types/metadata.d.ts","./node_modules/vite/dist/node/index.d.ts","./node_modules/@babel/types/lib/index.d.ts","./node_modules/@types/babel__generator/index.d.ts","./node_modules/@babel/parser/typings/babel-parser.d.ts","./node_modules/@types/babel__template/index.d.ts","./node_modules/@types/babel__traverse/index.d.ts","./node_modules/@types/babel__core/index.d.ts","./node_modules/@vitejs/plugin-react/dist/index.d.ts","./node_modules/@vitest/spy/dist/index.d.ts","./node_modules/@vitest/pretty-format/dist/index.d.ts","./node_modules/@vitest/utils/dist/types.d.ts","./node_modules/@vitest/utils/dist/helpers.d.ts","./node_modules/tinyrainbow/dist/index-8b61d5bc.d.ts","./node_modules/tinyrainbow/dist/node.d.ts","./node_modules/@vitest/utils/dist/index.d.ts","./node_modules/@vitest/utils/dist/types.d-bcelap-c.d.ts","./node_modules/@vitest/utils/dist/diff.d.ts","./node_modules/@vitest/expect/dist/index.d.ts","./node_modules/@vitest/runner/dist/tasks.d-cksck4of.d.ts","./node_modules/@vitest/runner/dist/types.d.ts","./node_modules/@vitest/utils/dist/error.d.ts","./node_modules/@vitest/runner/dist/index.d.ts","./node_modules/vitest/optional-types.d.ts","./node_modules/vitest/dist/chunks/environment.d.cl3nlxbe.d.ts","./node_modules/@vitest/mocker/dist/registry.d-d765pazg.d.ts","./node_modules/@vitest/mocker/dist/types.d-d_arzrdy.d.ts","./node_modules/@vitest/mocker/dist/index.d.ts","./node_modules/@vitest/utils/dist/source-map.d.ts","./node_modules/vite-node/dist/trace-mapping.d-dlvdeqop.d.ts","./node_modules/vite-node/dist/index.d-dgmxd2u7.d.ts","./node_modules/vite-node/dist/index.d.ts","./node_modules/@vitest/snapshot/dist/environment.d-dhdq1csl.d.ts","./node_modules/@vitest/snapshot/dist/rawsnapshot.d-lfsmjfud.d.ts","./node_modules/@vitest/snapshot/dist/index.d.ts","./node_modules/@vitest/snapshot/dist/environment.d.ts","./node_modules/vitest/dist/chunks/config.d.d2roskhv.d.ts","./node_modules/vitest/dist/chunks/worker.d.1gmbbd7g.d.ts","./node_modules/@types/deep-eql/index.d.ts","./node_modules/assertion-error/index.d.ts","./node_modules/@types/chai/index.d.ts","./node_modules/@vitest/runner/dist/utils.d.ts","./node_modules/tinybench/dist/index.d.ts","./node_modules/vitest/dist/chunks/benchmark.d.bwvbvtda.d.ts","./node_modules/vite-node/dist/client.d.ts","./node_modules/vitest/dist/chunks/coverage.d.s9rmnxie.d.ts","./node_modules/@vitest/snapshot/dist/manager.d.ts","./node_modules/vitest/dist/chunks/reporters.d.bflkqcl6.d.ts","./node_modules/vitest/dist/chunks/vite.d.cmlllifp.d.ts","./node_modules/vitest/dist/config.d.ts","./node_modules/vitest/config.d.ts","./vitest.config.ts","./src/app/api/proxy/sse/route.ts","./src/lib/api.ts","./src/lib/syncruns.ts","./src/hooks/usesyncrun.ts","./src/lib/readnext.ts","./node_modules/vitest/dist/chunks/worker.d.ckwwzbsj.d.ts","./node_modules/vitest/dist/chunks/global.d.mamajcmj.d.ts","./node_modules/vitest/dist/chunks/mocker.d.be_2ls6u.d.ts","./node_modules/vitest/dist/chunks/suite.d.fvehnv49.d.ts","./node_modules/expect-type/dist/utils.d.ts","./node_modules/expect-type/dist/overloads.d.ts","./node_modules/expect-type/dist/branding.d.ts","./node_modules/expect-type/dist/messages.d.ts","./node_modules/expect-type/dist/index.d.ts","./node_modules/vitest/dist/index.d.ts","./node_modules/@types/aria-query/index.d.ts","./node_modules/@testing-library/jest-dom/types/matchers.d.ts","./node_modules/@testing-library/jest-dom/types/vitest.d.ts","./node_modules/msw/node_modules/type-fest/source/primitive.d.ts","./node_modules/msw/node_modules/type-fest/source/typed-array.d.ts","./node_modules/msw/node_modules/type-fest/source/basic.d.ts","./node_modules/msw/node_modules/type-fest/source/json-value.d.ts","./node_modules/msw/node_modules/type-fest/source/characters.d.ts","./node_modules/msw/node_modules/type-fest/source/union-to-intersection.d.ts","./node_modules/msw/node_modules/type-fest/source/keys-of-union.d.ts","./node_modules/msw/node_modules/type-fest/source/distributed-omit.d.ts","./node_modules/msw/node_modules/type-fest/source/distributed-pick.d.ts","./node_modules/msw/node_modules/type-fest/source/empty-object.d.ts","./node_modules/msw/node_modules/type-fest/source/if-empty-object.d.ts","./node_modules/msw/node_modules/type-fest/source/is-any.d.ts","./node_modules/msw/node_modules/type-fest/source/is-optional-key-of.d.ts","./node_modules/msw/node_modules/type-fest/source/optional-keys-of.d.ts","./node_modules/msw/node_modules/type-fest/source/required-keys-of.d.ts","./node_modules/msw/node_modules/type-fest/source/has-required-keys.d.ts","./node_modules/msw/node_modules/type-fest/source/is-never.d.ts","./node_modules/msw/node_modules/type-fest/source/if.d.ts","./node_modules/msw/node_modules/type-fest/source/unknown-array.d.ts","./node_modules/msw/node_modules/type-fest/source/internal/type.d.ts","./node_modules/msw/node_modules/type-fest/source/internal/array.d.ts","./node_modules/msw/node_modules/type-fest/source/internal/characters.d.ts","./node_modules/msw/node_modules/type-fest/source/is-float.d.ts","./node_modules/msw/node_modules/type-fest/source/is-integer.d.ts","./node_modules/msw/node_modules/type-fest/source/numeric.d.ts","./node_modules/tagged-tag/index.d.ts","./node_modules/msw/node_modules/type-fest/source/tagged.d.ts","./node_modules/msw/node_modules/type-fest/source/is-literal.d.ts","./node_modules/msw/node_modules/type-fest/source/is-null.d.ts","./node_modules/msw/node_modules/type-fest/source/is-unknown.d.ts","./node_modules/msw/node_modules/type-fest/source/tuple-of.d.ts","./node_modules/msw/node_modules/type-fest/source/trim.d.ts","./node_modules/msw/node_modules/type-fest/source/internal/string.d.ts","./node_modules/msw/node_modules/type-fest/source/internal/keys.d.ts","./node_modules/msw/node_modules/type-fest/source/internal/numeric.d.ts","./node_modules/msw/node_modules/type-fest/source/simplify.d.ts","./node_modules/msw/node_modules/type-fest/source/is-equal.d.ts","./node_modules/msw/node_modules/type-fest/source/omit-index-signature.d.ts","./node_modules/msw/node_modules/type-fest/source/pick-index-signature.d.ts","./node_modules/msw/node_modules/type-fest/source/merge.d.ts","./node_modules/msw/node_modules/type-fest/source/internal/object.d.ts","./node_modules/msw/node_modules/type-fest/source/or.d.ts","./node_modules/msw/node_modules/type-fest/source/all-extend.d.ts","./node_modules/msw/node_modules/type-fest/source/and.d.ts","./node_modules/msw/node_modules/type-fest/source/greater-than.d.ts","./node_modules/msw/node_modules/type-fest/source/greater-than-or-equal.d.ts","./node_modules/msw/node_modules/type-fest/source/less-than.d.ts","./node_modules/msw/node_modules/type-fest/source/internal/tuple.d.ts","./node_modules/msw/node_modules/type-fest/source/internal/enforce-optional.d.ts","./node_modules/msw/node_modules/type-fest/source/internal/index.d.ts","./node_modules/msw/node_modules/type-fest/source/except.d.ts","./node_modules/msw/node_modules/type-fest/source/require-at-least-one.d.ts","./node_modules/msw/node_modules/type-fest/source/non-empty-object.d.ts","./node_modules/msw/node_modules/type-fest/source/non-empty-string.d.ts","./node_modules/msw/node_modules/type-fest/source/unknown-record.d.ts","./node_modules/msw/node_modules/type-fest/source/unknown-set.d.ts","./node_modules/msw/node_modules/type-fest/source/unknown-map.d.ts","./node_modules/msw/node_modules/type-fest/source/tagged-union.d.ts","./node_modules/msw/node_modules/type-fest/source/writable.d.ts","./node_modules/msw/node_modules/type-fest/source/writable-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/conditional-simplify-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/non-empty-tuple.d.ts","./node_modules/msw/node_modules/type-fest/source/array-tail.d.ts","./node_modules/msw/node_modules/type-fest/source/simplify-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/merge-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/merge-exclusive.d.ts","./node_modules/msw/node_modules/type-fest/source/require-exactly-one.d.ts","./node_modules/msw/node_modules/type-fest/source/require-all-or-none.d.ts","./node_modules/msw/node_modules/type-fest/source/require-one-or-none.d.ts","./node_modules/msw/node_modules/type-fest/source/is-union.d.ts","./node_modules/msw/node_modules/type-fest/source/single-key-object.d.ts","./node_modules/msw/node_modules/type-fest/source/partial-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/required-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/subtract.d.ts","./node_modules/msw/node_modules/type-fest/source/paths.d.ts","./node_modules/msw/node_modules/type-fest/source/pick-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/array-splice.d.ts","./node_modules/msw/node_modules/type-fest/source/literal-union.d.ts","./node_modules/msw/node_modules/type-fest/source/union-to-tuple.d.ts","./node_modules/msw/node_modules/type-fest/source/omit-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/partial-on-undefined-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/undefined-on-partial-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/readonly-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/promisable.d.ts","./node_modules/msw/node_modules/type-fest/source/arrayable.d.ts","./node_modules/msw/node_modules/type-fest/source/invariant-of.d.ts","./node_modules/msw/node_modules/type-fest/source/set-optional.d.ts","./node_modules/msw/node_modules/type-fest/source/set-readonly.d.ts","./node_modules/msw/node_modules/type-fest/source/set-required.d.ts","./node_modules/msw/node_modules/type-fest/source/set-required-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/set-non-nullable.d.ts","./node_modules/msw/node_modules/type-fest/source/set-non-nullable-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/value-of.d.ts","./node_modules/msw/node_modules/type-fest/source/async-return-type.d.ts","./node_modules/msw/node_modules/type-fest/source/extends-strict.d.ts","./node_modules/msw/node_modules/type-fest/source/is-tuple.d.ts","./node_modules/msw/node_modules/type-fest/source/tuple-to-object.d.ts","./node_modules/msw/node_modules/type-fest/source/conditional-keys.d.ts","./node_modules/msw/node_modules/type-fest/source/conditional-except.d.ts","./node_modules/msw/node_modules/type-fest/source/conditional-pick.d.ts","./node_modules/msw/node_modules/type-fest/source/conditional-pick-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/stringified.d.ts","./node_modules/msw/node_modules/type-fest/source/join.d.ts","./node_modules/msw/node_modules/type-fest/source/sum.d.ts","./node_modules/msw/node_modules/type-fest/source/less-than-or-equal.d.ts","./node_modules/msw/node_modules/type-fest/source/array-slice.d.ts","./node_modules/msw/node_modules/type-fest/source/string-slice.d.ts","./node_modules/msw/node_modules/type-fest/source/fixed-length-array.d.ts","./node_modules/msw/node_modules/type-fest/source/multidimensional-array.d.ts","./node_modules/msw/node_modules/type-fest/source/multidimensional-readonly-array.d.ts","./node_modules/msw/node_modules/type-fest/source/iterable-element.d.ts","./node_modules/msw/node_modules/type-fest/source/entry.d.ts","./node_modules/msw/node_modules/type-fest/source/entries.d.ts","./node_modules/msw/node_modules/type-fest/source/set-return-type.d.ts","./node_modules/msw/node_modules/type-fest/source/set-parameter-type.d.ts","./node_modules/msw/node_modules/type-fest/source/asyncify.d.ts","./node_modules/msw/node_modules/type-fest/source/jsonify.d.ts","./node_modules/msw/node_modules/type-fest/source/jsonifiable.d.ts","./node_modules/msw/node_modules/type-fest/source/find-global-type.d.ts","./node_modules/msw/node_modules/type-fest/source/structured-cloneable.d.ts","./node_modules/msw/node_modules/type-fest/source/schema.d.ts","./node_modules/msw/node_modules/type-fest/source/literal-to-primitive.d.ts","./node_modules/msw/node_modules/type-fest/source/literal-to-primitive-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/key-as-string.d.ts","./node_modules/msw/node_modules/type-fest/source/array-element.d.ts","./node_modules/msw/node_modules/type-fest/source/exact.d.ts","./node_modules/msw/node_modules/type-fest/source/readonly-tuple.d.ts","./node_modules/msw/node_modules/type-fest/source/override-properties.d.ts","./node_modules/msw/node_modules/type-fest/source/has-optional-keys.d.ts","./node_modules/msw/node_modules/type-fest/source/is-required-key-of.d.ts","./node_modules/msw/node_modules/type-fest/source/is-readonly-key-of.d.ts","./node_modules/msw/node_modules/type-fest/source/readonly-keys-of.d.ts","./node_modules/msw/node_modules/type-fest/source/has-readonly-keys.d.ts","./node_modules/msw/node_modules/type-fest/source/writable-keys-of.d.ts","./node_modules/msw/node_modules/type-fest/source/is-writable-key-of.d.ts","./node_modules/msw/node_modules/type-fest/source/has-writable-keys.d.ts","./node_modules/msw/node_modules/type-fest/source/spread.d.ts","./node_modules/msw/node_modules/type-fest/source/split-on-rest-element.d.ts","./node_modules/msw/node_modules/type-fest/source/extract-rest-element.d.ts","./node_modules/msw/node_modules/type-fest/source/exclude-rest-element.d.ts","./node_modules/msw/node_modules/type-fest/source/tuple-to-union.d.ts","./node_modules/msw/node_modules/type-fest/source/int-range.d.ts","./node_modules/msw/node_modules/type-fest/source/int-closed-range.d.ts","./node_modules/msw/node_modules/type-fest/source/if-any.d.ts","./node_modules/msw/node_modules/type-fest/source/if-never.d.ts","./node_modules/msw/node_modules/type-fest/source/if-unknown.d.ts","./node_modules/msw/node_modules/type-fest/source/array-indices.d.ts","./node_modules/msw/node_modules/type-fest/source/array-values.d.ts","./node_modules/msw/node_modules/type-fest/source/set-field-type.d.ts","./node_modules/msw/node_modules/type-fest/source/shared-union-fields.d.ts","./node_modules/msw/node_modules/type-fest/source/all-union-fields.d.ts","./node_modules/msw/node_modules/type-fest/source/shared-union-fields-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/if-null.d.ts","./node_modules/msw/node_modules/type-fest/source/is-undefined.d.ts","./node_modules/msw/node_modules/type-fest/source/xor.d.ts","./node_modules/msw/node_modules/type-fest/source/is-lowercase.d.ts","./node_modules/msw/node_modules/type-fest/source/is-uppercase.d.ts","./node_modules/msw/node_modules/type-fest/source/is-optional.d.ts","./node_modules/msw/node_modules/type-fest/source/is-nullable.d.ts","./node_modules/msw/node_modules/type-fest/source/exclusify-union.d.ts","./node_modules/msw/node_modules/type-fest/source/words.d.ts","./node_modules/msw/node_modules/type-fest/source/camel-case.d.ts","./node_modules/msw/node_modules/type-fest/source/camel-cased-properties.d.ts","./node_modules/msw/node_modules/type-fest/source/camel-cased-properties-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/remove-prefix.d.ts","./node_modules/msw/node_modules/type-fest/source/delimiter-case.d.ts","./node_modules/msw/node_modules/type-fest/source/kebab-case.d.ts","./node_modules/msw/node_modules/type-fest/source/delimiter-cased-properties.d.ts","./node_modules/msw/node_modules/type-fest/source/kebab-cased-properties.d.ts","./node_modules/msw/node_modules/type-fest/source/delimiter-cased-properties-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/kebab-cased-properties-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/pascal-case.d.ts","./node_modules/msw/node_modules/type-fest/source/pascal-cased-properties.d.ts","./node_modules/msw/node_modules/type-fest/source/pascal-cased-properties-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/snake-case.d.ts","./node_modules/msw/node_modules/type-fest/source/snake-cased-properties.d.ts","./node_modules/msw/node_modules/type-fest/source/snake-cased-properties-deep.d.ts","./node_modules/msw/node_modules/type-fest/source/screaming-snake-case.d.ts","./node_modules/msw/node_modules/type-fest/source/split.d.ts","./node_modules/msw/node_modules/type-fest/source/replace.d.ts","./node_modules/msw/node_modules/type-fest/source/string-repeat.d.ts","./node_modules/msw/node_modules/type-fest/source/includes.d.ts","./node_modules/msw/node_modules/type-fest/source/get.d.ts","./node_modules/msw/node_modules/type-fest/source/last-array-element.d.ts","./node_modules/msw/node_modules/type-fest/source/conditional-simplify.d.ts","./node_modules/msw/node_modules/type-fest/source/global-this.d.ts","./node_modules/msw/node_modules/type-fest/source/package-json.d.ts","./node_modules/msw/node_modules/type-fest/source/tsconfig-json.d.ts","./node_modules/msw/node_modules/type-fest/source/extract-strict.d.ts","./node_modules/msw/node_modules/type-fest/source/exclude-strict.d.ts","./node_modules/msw/node_modules/type-fest/index.d.ts","./node_modules/msw/lib/core/utils/internal/isiterable.d.mts","./node_modules/@open-draft/logger/lib/index.d.ts","./node_modules/strict-event-emitter/lib/index.d.ts","./node_modules/@mswjs/interceptors/lib/node/interceptor-dc0a39b5.d.ts","./node_modules/@mswjs/interceptors/lib/node/batchinterceptor-cb9a2eee.d.ts","./node_modules/@mswjs/interceptors/lib/node/index.d.ts","./node_modules/msw/lib/core/typeutils.d.mts","./node_modules/graphql/version.d.ts","./node_modules/graphql/jsutils/maybe.d.ts","./node_modules/graphql/language/source.d.ts","./node_modules/graphql/jsutils/objmap.d.ts","./node_modules/graphql/jsutils/path.d.ts","./node_modules/graphql/jsutils/promiseorvalue.d.ts","./node_modules/graphql/language/kinds.d.ts","./node_modules/graphql/language/tokenkind.d.ts","./node_modules/graphql/language/ast.d.ts","./node_modules/graphql/language/location.d.ts","./node_modules/graphql/error/graphqlerror.d.ts","./node_modules/graphql/language/directivelocation.d.ts","./node_modules/graphql/type/directives.d.ts","./node_modules/graphql/type/schema.d.ts","./node_modules/graphql/type/definition.d.ts","./node_modules/graphql/execution/execute.d.ts","./node_modules/graphql/graphql.d.ts","./node_modules/graphql/type/scalars.d.ts","./node_modules/graphql/type/introspection.d.ts","./node_modules/graphql/type/validate.d.ts","./node_modules/graphql/type/assertname.d.ts","./node_modules/graphql/type/index.d.ts","./node_modules/graphql/language/printlocation.d.ts","./node_modules/graphql/language/lexer.d.ts","./node_modules/graphql/language/parser.d.ts","./node_modules/graphql/language/printer.d.ts","./node_modules/graphql/language/visitor.d.ts","./node_modules/graphql/language/predicates.d.ts","./node_modules/graphql/language/index.d.ts","./node_modules/graphql/execution/subscribe.d.ts","./node_modules/graphql/execution/values.d.ts","./node_modules/graphql/execution/index.d.ts","./node_modules/graphql/subscription/index.d.ts","./node_modules/graphql/utilities/typeinfo.d.ts","./node_modules/graphql/validation/validationcontext.d.ts","./node_modules/graphql/validation/validate.d.ts","./node_modules/graphql/validation/rules/maxintrospectiondepthrule.d.ts","./node_modules/graphql/validation/specifiedrules.d.ts","./node_modules/graphql/validation/rules/executabledefinitionsrule.d.ts","./node_modules/graphql/validation/rules/fieldsoncorrecttyperule.d.ts","./node_modules/graphql/validation/rules/fragmentsoncompositetypesrule.d.ts","./node_modules/graphql/validation/rules/knownargumentnamesrule.d.ts","./node_modules/graphql/validation/rules/knowndirectivesrule.d.ts","./node_modules/graphql/validation/rules/knownfragmentnamesrule.d.ts","./node_modules/graphql/validation/rules/knowntypenamesrule.d.ts","./node_modules/graphql/validation/rules/loneanonymousoperationrule.d.ts","./node_modules/graphql/validation/rules/nofragmentcyclesrule.d.ts","./node_modules/graphql/validation/rules/noundefinedvariablesrule.d.ts","./node_modules/graphql/validation/rules/nounusedfragmentsrule.d.ts","./node_modules/graphql/validation/rules/nounusedvariablesrule.d.ts","./node_modules/graphql/validation/rules/overlappingfieldscanbemergedrule.d.ts","./node_modules/graphql/validation/rules/possiblefragmentspreadsrule.d.ts","./node_modules/graphql/validation/rules/providedrequiredargumentsrule.d.ts","./node_modules/graphql/validation/rules/scalarleafsrule.d.ts","./node_modules/graphql/validation/rules/singlefieldsubscriptionsrule.d.ts","./node_modules/graphql/validation/rules/uniqueargumentnamesrule.d.ts","./node_modules/graphql/validation/rules/uniquedirectivesperlocationrule.d.ts","./node_modules/graphql/validation/rules/uniquefragmentnamesrule.d.ts","./node_modules/graphql/validation/rules/uniqueinputfieldnamesrule.d.ts","./node_modules/graphql/validation/rules/uniqueoperationnamesrule.d.ts","./node_modules/graphql/validation/rules/uniquevariablenamesrule.d.ts","./node_modules/graphql/validation/rules/valuesofcorrecttyperule.d.ts","./node_modules/graphql/validation/rules/variablesareinputtypesrule.d.ts","./node_modules/graphql/validation/rules/variablesinallowedpositionrule.d.ts","./node_modules/graphql/validation/rules/loneschemadefinitionrule.d.ts","./node_modules/graphql/validation/rules/uniqueoperationtypesrule.d.ts","./node_modules/graphql/validation/rules/uniquetypenamesrule.d.ts","./node_modules/graphql/validation/rules/uniqueenumvaluenamesrule.d.ts","./node_modules/graphql/validation/rules/uniquefielddefinitionnamesrule.d.ts","./node_modules/graphql/validation/rules/uniqueargumentdefinitionnamesrule.d.ts","./node_modules/graphql/validation/rules/uniquedirectivenamesrule.d.ts","./node_modules/graphql/validation/rules/possibletypeextensionsrule.d.ts","./node_modules/graphql/validation/rules/custom/nodeprecatedcustomrule.d.ts","./node_modules/graphql/validation/rules/custom/noschemaintrospectioncustomrule.d.ts","./node_modules/graphql/validation/index.d.ts","./node_modules/graphql/error/syntaxerror.d.ts","./node_modules/graphql/error/locatederror.d.ts","./node_modules/graphql/error/index.d.ts","./node_modules/graphql/utilities/getintrospectionquery.d.ts","./node_modules/graphql/utilities/getoperationast.d.ts","./node_modules/graphql/utilities/getoperationroottype.d.ts","./node_modules/graphql/utilities/introspectionfromschema.d.ts","./node_modules/graphql/utilities/buildclientschema.d.ts","./node_modules/graphql/utilities/buildastschema.d.ts","./node_modules/graphql/utilities/extendschema.d.ts","./node_modules/graphql/utilities/lexicographicsortschema.d.ts","./node_modules/graphql/utilities/printschema.d.ts","./node_modules/graphql/utilities/typefromast.d.ts","./node_modules/graphql/utilities/valuefromast.d.ts","./node_modules/graphql/utilities/valuefromastuntyped.d.ts","./node_modules/graphql/utilities/astfromvalue.d.ts","./node_modules/graphql/utilities/coerceinputvalue.d.ts","./node_modules/graphql/utilities/concatast.d.ts","./node_modules/graphql/utilities/separateoperations.d.ts","./node_modules/graphql/utilities/stripignoredcharacters.d.ts","./node_modules/graphql/utilities/typecomparators.d.ts","./node_modules/graphql/utilities/assertvalidname.d.ts","./node_modules/graphql/utilities/findbreakingchanges.d.ts","./node_modules/graphql/utilities/typedquerydocumentnode.d.ts","./node_modules/graphql/utilities/resolveschemacoordinate.d.ts","./node_modules/graphql/utilities/index.d.ts","./node_modules/graphql/index.d.ts","./node_modules/msw/lib/core/utils/matching/matchrequesturl.d.mts","./node_modules/msw/lib/core/httpresponse-u6sfxblj.d.mts","./node_modules/msw/lib/core/handlers/requesthandler.d.mts","./node_modules/@mswjs/interceptors/lib/browser/interceptor-af98b768.d.ts","./node_modules/@mswjs/interceptors/lib/browser/interceptors/websocket/index.d.ts","./node_modules/msw/lib/core/handlers/websockethandler.d.mts","./node_modules/msw/lib/core/utils/request/onunhandledrequest.d.mts","./node_modules/msw/lib/core/sharedoptions.d.mts","./node_modules/msw/lib/core/utils/internal/disposable.d.mts","./node_modules/msw/lib/core/setupapi.d.mts","./node_modules/msw/lib/node/index.d.mts","./node_modules/msw/lib/core/handlers/httphandler.d.mts","./node_modules/msw/lib/core/http.d.mts","./node_modules/msw/lib/core/graphql.d.mts","./node_modules/msw/lib/core/ws.d.mts","./node_modules/msw/lib/core/sse.d.mts","./node_modules/msw/lib/core/utils/handlerequest.d.mts","./node_modules/msw/lib/core/getresponse.d.mts","./node_modules/msw/lib/core/utils/url/cleanurl.d.mts","./node_modules/msw/lib/core/delay.d.mts","./node_modules/msw/lib/core/bypass.d.mts","./node_modules/msw/lib/core/passthrough.d.mts","./node_modules/msw/lib/core/iscommonassetrequest.d.mts","./node_modules/msw/lib/core/index.d.mts","./src/test/msw/handlers.ts","./src/test/msw/server.ts","./src/test/setup.ts","./node_modules/next/dist/compiled/@next/font/dist/types.d.ts","./node_modules/next/dist/compiled/@next/font/dist/google/index.d.ts","./node_modules/next/font/google/index.d.ts","./src/app/layout.tsx","./node_modules/@types/react-dom/client.d.ts","./node_modules/@testing-library/dom/types/matches.d.ts","./node_modules/@testing-library/dom/types/wait-for.d.ts","./node_modules/@testing-library/dom/types/query-helpers.d.ts","./node_modules/@testing-library/dom/types/queries.d.ts","./node_modules/@testing-library/dom/types/get-queries-for-element.d.ts","./node_modules/pretty-format/build/types.d.ts","./node_modules/pretty-format/build/index.d.ts","./node_modules/@testing-library/dom/types/screen.d.ts","./node_modules/@testing-library/dom/types/wait-for-element-to-be-removed.d.ts","./node_modules/@testing-library/dom/types/get-node-text.d.ts","./node_modules/@testing-library/dom/types/events.d.ts","./node_modules/@testing-library/dom/types/pretty-dom.d.ts","./node_modules/@testing-library/dom/types/role-helpers.d.ts","./node_modules/@testing-library/dom/types/config.d.ts","./node_modules/@testing-library/dom/types/suggestions.d.ts","./node_modules/@testing-library/dom/types/index.d.ts","./node_modules/@types/react-dom/test-utils/index.d.ts","./node_modules/@testing-library/react/types/index.d.ts","./src/components/trydemobutton.tsx","./src/app/page.tsx","./src/app/page.test.tsx","./src/app/books/[id]/page.tsx","./src/app/dashboard/page.tsx","./src/app/dashboard/matches/page.tsx","./src/components/authguard.tsx","./src/app/settings/page.tsx","./src/app/settings/goodreads/page.tsx","./src/app/signin/page.tsx","./src/app/signup/page.tsx","./node_modules/vitest/globals.d.ts"],"fileIdsList":[[64,110,373,374],[64,110,411],[64,110],[64,110,671,672],[64,110,671,672,782],[64,110,672,673],[64,110,671,672,673,674],[64,110,814],[64,110,811,812,813,814,815,818,819,820,821,822,823,824,825],[64,110,476],[64,110,817],[64,110,811,812,813],[64,110,811,812],[64,110,814,815,817],[64,110,812],[64,110,475,477,478],[52,64,110,163,810,826,827],[64,110,411,412,413,414,415],[64,110,411,413],[64,110,447,448],[64,107,110],[64,109,110],[110],[64,110,115,143],[64,110,111,116,121,129,140,151],[64,110,111,112,121,129],[59,60,61,64,110],[64,110,113,152],[64,110,114,115,122,130],[64,110,115,140,148],[64,110,116,118,121,129],[64,109,110,117],[64,110,118,119],[64,110,120,121],[64,109,110,121],[64,110,121,122,123,140,151],[64,110,121,122,123,136,140,143],[64,110,118,121,124,129,140,151],[64,110,121,122,124,125,129,140,148,151],[64,110,124,126,140,148,151],[62,63,64,65,66,67,68,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],[64,110,121,127],[64,110,128,151,156],[64,110,118,121,129,140],[64,110,130],[64,110,131],[64,109,110,132],[64,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],[64,110,134],[64,110,135],[64,110,121,136,137],[64,110,136,138,152,154],[64,110,121,140,141,143],[64,110,142,143],[64,110,140,141],[64,110,143],[64,110,144],[64,107,110,140,145],[64,110,121,146,147],[64,110,146,147],[64,110,115,129,140,148],[64,110,149],[64,110,129,150],[64,110,124,135,151],[64,110,115,152],[64,110,140,153],[64,110,128,154],[64,110,155],[64,105,110],[64,105,110,121,123,132,140,143,151,154,156],[64,110,140,157],[52,64,110,162,163,164,810],[52,64,110],[52,64,110,162,163],[52,64,110,827],[52,56,64,110,161,326,369],[52,56,64,110,160,326,369],[49,50,51,64,110],[64,110,410,416,457],[64,110,418,423,424,426],[64,110,434,435],[64,110,424,426,428,429,430],[64,110,424],[64,110,424,426,428],[64,110,424,428],[64,110,441],[64,110,419,441,442],[64,110,419,441],[64,110,419,425],[64,110,420],[64,110,419,420,421,423],[64,110,419],[64,110,470,471],[64,110,470,471,472,473],[64,110,470,472],[64,110,470],[64,110,678,679,685,686],[64,110,687,752,753],[64,110,678,685,687],[64,110,679,687],[64,110,678,680,681,682,685,687,690,691],[64,110,681,692,706,707],[64,110,678,685,690,691,692],[64,110,678,680,685,687,689,690,691],[64,110,678,679,690,691,692],[64,110,677,693,698,705,708,709,751,754,777],[64,110,678],[64,110,679,683,684],[64,110,679,683,684,685,686,688,699,700,701,702,703,704],[64,110,679,684,685],[64,110,679],[64,110,678,679,684,685,687,700],[64,110,685],[64,110,679,685,686],[64,110,683,685],[64,110,692,706],[64,110,678,680,681,682,685,690],[64,110,678,685,688,691],[64,110,681,689,690,691,694,695,696,697],[64,110,691],[64,110,678,680,685,687,689,691],[64,110,687,690],[64,110,687],[64,110,678,685,691],[64,110,679,685,690,701],[64,110,690,755],[64,110,687,691],[64,110,685,690],[64,110,690],[64,110,678,688],[64,110,678,685],[64,110,685,690,691],[64,110,710,755,756,757,758,759,760,761,762,763,764,765,766,767,768,769,770,771,772,773,774,775,776],[64,110,690,691],[64,110,679,685,689,690,691],[64,110,680,685],[64,110,678,685,689,690,691,703],[64,110,678,680,685,691],[64,110,678,680,685],[64,110,711,712,713,714,715,716,717,718,719,720,721,722,723,724,725,726,727,728,729,730,731,732,733,734,735,736,737,738,739,740,741,742,743,744,745,746,747,748,749,750],[64,110,703,711],[64,110,711,713],[64,110,678,685,687,690,710,711],[64,110,678,685,687,689,690,691,703,710],[64,110,670,675,676,778,779,780],[64,110,672,779,783],[64,110,670,675,676,778,779,780,790],[64,110,670,675,676,778,779],[64,110,670,672,675,676,778,779,780,783,784,785,786,787,788,790,791,792,793,794,795,796,797,798,799,800,801],[64,110,670,672,675,676,778,779,780,783,784,785,786,787],[64,110,672,785],[64,110,670,672,675,676,778,779,780,790],[64,110,670,672,675,676,778,779,780,785,786],[64,110,672,779,783,784],[64,110,669,675,781,784,786,788],[64,110,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496,497,501,502,503,505,506,507,508,509,510,514,515,516,517,518,520,521,522,523,524,525,529,530,531,532,533,534,535,536,537,538,539,540,541,542,543,544,545,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,566,567,568,569,570,571,572,573,574,575,576,577,578,579,580,581,582,583,584,585,586,587,588,589,590,591,592,593,594,595,596,597,598,599,600,601,602,603,604,605,606,607,608,609,610,611,612,613,614,615,616,617,618,619,620,621,622,623,624,625,626,627,628,629,630,631,632,633,634,635,636,637,638,639,640,641,642,643,644,645,646,647,648,649,650,651,652,653,654,655,656,657,658,659,660,661,662,663,664,665,666,667,668],[64,110,490,495,496,497,498,499,519,520],[64,110,485,497,514,528,628],[64,110,521],[64,110,497],[64,110,495,503,515,522,523,524,528,555,582,583],[64,110,497,509,524,528,552],[64,110,496,497,528],[64,110,592],[64,110,528,639],[64,110,497,528,640],[64,110,528,640],[64,110,529,576],[64,110,497,498,573,575],[64,110,488,515,528,533,539,577],[64,110,576],[64,110,506,518,528,639,643],[64,110,497,528,639,644],[64,110,528,639,644],[64,110,485],[64,110,590],[64,110,479,485,508,515,528,603],[64,110,515,528],[64,110,497,498,499,616],[64,110,485,496,498,508,514],[64,110,490,495],[64,110,497,616],[64,110,509,529],[64,110,483,528,553,556,602,657],[64,110,523],[64,110,503,515,520,522,528],[64,110,492],[64,110,610],[64,110,493],[64,110,612],[64,110,490],[64,110,488],[64,110,495],[64,110,507],[64,110,508],[64,110,515],[64,110,582,620],[64,110,509,552],[64,110,492,495,496,497,498],[64,110,514],[64,110,498,499,500,511,512,513,519,526,527],[64,110,490,506,508,511],[64,110,495,497,498,503,511],[64,110,485,490,492,493,495,496,498,511,512,514,515,518],[64,110,500,503,509,510],[64,110,497,503,523,525],[64,110,479,490,495,496,497],[64,110,501,503,528],[64,110,479,495,503,505,528],[64,110,490,515],[64,110,490,491,498],[64,110,490,495,496,497,528],[64,110,490,498,609],[64,110,482],[64,110,480,482,488,490,495,497,503,508,528],[64,110,528,639,644,648],[64,110,528,639,644,646],[64,110,484],[64,110,524],[64,110,516,600],[64,110,479],[64,110,497,516,517,518,528,533,539,540,541,542],[64,110,514,516,517],[64,110,515,552],[64,110,494,530],[64,110,501,502],[64,110,495,497,515,528,542,553,555,556,557],[64,110,491],[64,110,495,496],[64,110,518],[64,110,482,556],[64,110,495,528],[64,110,496,508,518,528],[64,110,528,640,650],[64,110,490,495,497,523,528,552],[64,110,484,495,497,509,514,528,553],[64,110,528],[64,110,609],[64,110,509],[64,110,498,506,519,520],[64,110,490,495,496,528],[64,110,490,495,496,528,529],[64,110,490,495,496,528,545],[64,110,492,497,498,514,519],[64,110,528,639,644,653],[64,110,514,528],[64,110,497,514,528,553,557,569],[64,110,514,528,529],[64,110,497,508,528],[64,110,490,497,528,542,551,553,557,567],[64,110,492,496,497,514,528,529],[64,110,495,497,528],[64,110,495,497,514,528,548],[64,110,528,539],[64,110,488,496,548],[64,110,491,496,497,498,499,519],[64,110,506,520,522,528],[64,110,493,514],[64,110,503,506],[64,110,528,581,584],[64,110,480,597],[64,110,503,509,525,528],[64,110,503,509,528,552],[64,110,504],[64,110,496,497,498,503],[64,110,490,496,497,574],[64,110,484,495],[64,110,528,634,635],[64,110,514,529],[64,110,498,520,522],[57,64,110],[64,110,330],[64,110,332,333,334],[64,110,336],[64,110,167,177,183,185,326],[64,110,167,174,176,179,197],[64,110,177],[64,110,177,179,304],[64,110,232,250,265,372],[64,110,274],[64,110,167,177,184,218,228,301,302,372],[64,110,184,372],[64,110,177,228,229,230,372],[64,110,177,184,218,372],[64,110,372],[64,110,167,184,185,372],[64,110,258],[64,109,110,158,257],[52,64,110,251,252,253,271,272],[52,64,110,251],[64,110,241],[64,110,240,242,346],[52,64,110,251,252,269],[64,110,247,272,358],[64,110,356,357],[64,110,191,355],[64,110,244],[64,109,110,158,191,207,240,241,242,243],[52,64,110,269,271,272],[64,110,269,271],[64,110,269,270,272],[64,110,135,158],[64,110,239],[64,109,110,158,176,178,235,236,237,238],[52,64,110,168,349],[52,64,110,151,158],[52,64,110,184,216],[52,64,110,184],[64,110,214,219],[52,64,110,215,329],[64,110,806],[52,56,64,110,124,158,160,161,326,367,368],[64,110,326],[64,110,166],[64,110,319,320,321,322,323,324],[64,110,321],[52,64,110,215,251,329],[52,64,110,251,327,329],[52,64,110,251,329],[64,110,124,158,178,329],[64,110,124,158,175,176,187,205,207,239,244,245,267,269],[64,110,236,239,244,252,254,255,256,258,259,260,261,262,263,264,372],[64,110,237],[52,64,110,135,158,176,177,205,207,208,210,235,267,268,272,326,372],[64,110,124,158,178,179,191,192,240],[64,110,124,158,177,179],[64,110,124,140,158,175,178,179],[64,110,124,135,151,158,175,176,177,178,179,184,187,188,198,199,201,204,205,207,208,209,210,234,235,268,269,277,279,282,284,287,289,290,291,292],[64,110,124,140,158],[64,110,167,168,169,175,176,326,329,372],[64,110,124,140,151,158,172,303,305,306,372],[64,110,135,151,158,172,175,178,195,199,201,202,203,208,235,282,293,295,301,315,316],[64,110,177,181,235],[64,110,175,177],[64,110,188,283],[64,110,285,286],[64,110,285],[64,110,283],[64,110,285,288],[64,110,171,172],[64,110,171,211],[64,110,171],[64,110,173,188,281],[64,110,280],[64,110,172,173],[64,110,173,278],[64,110,172],[64,110,267],[64,110,124,158,175,187,206,226,232,246,249,266,269],[64,110,220,221,222,223,224,225,247,248,272,327],[64,110,276],[64,110,124,158,175,187,206,212,273,275,277,326,329],[64,110,124,151,158,168,175,177,234],[64,110,231],[64,110,124,158,309,314],[64,110,198,207,234,329],[64,110,297,301,315,318],[64,110,124,181,301,309,310,318],[64,110,167,177,198,209,312],[64,110,124,158,177,184,209,296,297,307,308,311,313],[64,110,159,205,206,207,326,329],[64,110,124,135,151,158,173,175,176,178,181,186,187,195,198,199,201,202,203,204,208,210,234,235,279,293,294,329],[64,110,124,158,175,177,181,295,317],[64,110,124,158,176,178],[52,64,110,124,135,158,166,168,175,176,179,187,204,205,207,208,210,276,326,329],[64,110,124,135,151,158,170,173,174,178],[64,110,171,233],[64,110,124,158,171,176,187],[64,110,124,158,177,188],[64,110,124,158],[64,110,191],[64,110,190],[64,110,192],[64,110,177,189,191,195],[64,110,177,189,191],[64,110,124,158,170,177,178,184,192,193,194],[52,64,110,269,270,271],[64,110,227],[52,64,110,168],[52,64,110,201],[52,64,110,159,204,207,210,326,329],[64,110,168,349,350],[52,64,110,219],[52,64,110,135,151,158,166,213,215,217,218,329],[64,110,178,184,201],[64,110,200],[52,64,110,122,124,135,158,166,219,228,326,327,328],[48,52,53,54,55,64,110,160,161,326,369],[64,110,115],[64,110,298,299,300],[64,110,298],[64,110,338],[64,110,340],[64,110,342],[64,110,807],[64,110,344],[64,110,347],[64,110,351],[56,58,64,110,326,331,335,337,339,341,343,345,348,352,354,360,361,363,370,371,372],[64,110,353],[64,110,359],[64,110,215],[64,110,362],[64,109,110,192,193,194,195,364,365,366,369],[64,110,158],[52,56,64,110,124,126,135,158,160,161,162,164,166,179,318,325,329,369],[64,110,401],[64,110,399,401],[64,110,390,398,399,400,402,404],[64,110,388],[64,110,391,396,401,404],[64,110,387,404],[64,110,391,392,395,396,397,404],[64,110,391,392,393,395,396,404],[64,110,388,389,390,391,392,396,397,398,400,401,402,404],[64,110,404],[64,110,386,388,389,390,391,392,393,395,396,397,398,399,400,401,402,403],[64,110,386,404],[64,110,391,393,394,396,397,404],[64,110,395,404],[64,110,396,397,401,404],[64,110,389,399],[64,110,816],[64,110,380,409,410],[64,110,379,380],[64,110,422],[64,77,81,110,151],[64,77,110,140,151],[64,72,110],[64,74,77,110,148,151],[64,110,129,148],[64,72,110,158],[64,74,77,110,129,151],[64,69,70,73,76,110,121,140,151],[64,77,84,110],[64,69,75,110],[64,77,98,99,110],[64,73,77,110,143,151,158],[64,98,110,158],[64,71,72,110,158],[64,77,110],[64,71,72,73,74,75,76,77,78,79,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,99,100,101,102,103,104,110],[64,77,92,110],[64,77,84,85,110],[64,75,77,85,86,110],[64,76,110],[64,69,72,77,110],[64,77,81,85,86,110],[64,81,110],[64,75,77,80,110,151],[64,69,74,77,84,110],[64,110,140],[64,72,77,98,110,156,158],[64,110,438,439],[64,110,438],[64,110,376],[64,110,121,122,124,125,126,129,140,148,151,157,158,376,377,378,380,381,383,384,385,405,406,407,408,409,410],[64,110,376,377,378,382],[64,110,378],[64,110,380,410],[64,110,427,458,467],[64,110,431,450,451,467],[64,110,419,426,431,443,444,467],[64,110,453],[64,110,432],[64,110,419,427,431,433,443,452,467],[64,110,436],[64,110,113,122,140,410,419,424,426,431,433,436,437,440,443,445,446,449,452,454,455,457,467],[64,110,431,450,451,452,467],[64,110,410,456,457],[64,110,431,433,440,443,445,467],[64,110,156,446],[64,110,113,122,140,410,419,424,426,431,432,433,436,437,440,443,444,445,446,449,450,451,452,453,454,455,456,457,467],[64,110,113,122,140,156,410,418,419,424,426,427,431,432,433,436,437,440,443,444,445,446,449,450,451,452,453,454,455,456,457,466,467,468,469,474],[64,110,475,478],[64,110,370],[64,110,354,462,465],[52,64,110,462],[64,110,373,808],[64,110,475,828,830],[64,110,354,829],[52,64,110,354,462,835],[52,64,110,360,462],[52,64,110,463],[64,110,462],[64,110,802],[64,110,789,803],[64,110,475,478,804],[64,110,131,417,459]],"fileInfos":[{"version":"c430d44666289dae81f30fa7b2edebf186ecc91a2d4c71266ea6ae76388792e1","affectsGlobalScope":true,"impliedFormat":1},{"version":"45b7ab580deca34ae9729e97c13cfd999df04416a79116c3bfb483804f85ded4","impliedFormat":1},{"version":"3facaf05f0c5fc569c5649dd359892c98a85557e3e0c847964caeb67076f4d75","impliedFormat":1},{"version":"e44bb8bbac7f10ecc786703fe0a6a4b952189f908707980ba8f3c8975a760962","impliedFormat":1},{"version":"5e1c4c362065a6b95ff952c0eab010f04dcd2c3494e813b493ecfd4fcb9fc0d8","impliedFormat":1},{"version":"68d73b4a11549f9c0b7d352d10e91e5dca8faa3322bfb77b661839c42b1ddec7","impliedFormat":1},{"version":"5efce4fc3c29ea84e8928f97adec086e3dc876365e0982cc8479a07954a3efd4","impliedFormat":1},{"version":"080941d9f9ff9307f7e27a83bcd888b7c8270716c39af943532438932ec1d0b9","affectsGlobalScope":true,"impliedFormat":1},{"version":"2e80ee7a49e8ac312cc11b77f1475804bee36b3b2bc896bead8b6e1266befb43","affectsGlobalScope":true,"impliedFormat":1},{"version":"c57796738e7f83dbc4b8e65132f11a377649c00dd3eee333f672b8f0a6bea671","affectsGlobalScope":true,"impliedFormat":1},{"version":"dc2df20b1bcdc8c2d34af4926e2c3ab15ffe1160a63e58b7e09833f616efff44","affectsGlobalScope":true,"impliedFormat":1},{"version":"515d0b7b9bea2e31ea4ec968e9edd2c39d3eebf4a2d5cbd04e88639819ae3b71","affectsGlobalScope":true,"impliedFormat":1},{"version":"0559b1f683ac7505ae451f9a96ce4c3c92bdc71411651ca6ddb0e88baaaad6a3","affectsGlobalScope":true,"impliedFormat":1},{"version":"0dc1e7ceda9b8b9b455c3a2d67b0412feab00bd2f66656cd8850e8831b08b537","affectsGlobalScope":true,"impliedFormat":1},{"version":"ce691fb9e5c64efb9547083e4a34091bcbe5bdb41027e310ebba8f7d96a98671","affectsGlobalScope":true,"impliedFormat":1},{"version":"8d697a2a929a5fcb38b7a65594020fcef05ec1630804a33748829c5ff53640d0","affectsGlobalScope":true,"impliedFormat":1},{"version":"4ff2a353abf8a80ee399af572debb8faab2d33ad38c4b4474cff7f26e7653b8d","affectsGlobalScope":true,"impliedFormat":1},{"version":"fb0f136d372979348d59b3f5020b4cdb81b5504192b1cacff5d1fbba29378aa1","affectsGlobalScope":true,"impliedFormat":1},{"version":"d15bea3d62cbbdb9797079416b8ac375ae99162a7fba5de2c6c505446486ac0a","affectsGlobalScope":true,"impliedFormat":1},{"version":"68d18b664c9d32a7336a70235958b8997ebc1c3b8505f4f1ae2b7e7753b87618","affectsGlobalScope":true,"impliedFormat":1},{"version":"eb3d66c8327153d8fa7dd03f9c58d351107fe824c79e9b56b462935176cdf12a","affectsGlobalScope":true,"impliedFormat":1},{"version":"38f0219c9e23c915ef9790ab1d680440d95419ad264816fa15009a8851e79119","affectsGlobalScope":true,"impliedFormat":1},{"version":"69ab18c3b76cd9b1be3d188eaf8bba06112ebbe2f47f6c322b5105a6fbc45a2e","affectsGlobalScope":true,"impliedFormat":1},{"version":"a680117f487a4d2f30ea46f1b4b7f58bef1480456e18ba53ee85c2746eeca012","affectsGlobalScope":true,"impliedFormat":1},{"version":"2f11ff796926e0832f9ae148008138ad583bd181899ab7dd768a2666700b1893","affectsGlobalScope":true,"impliedFormat":1},{"version":"4de680d5bb41c17f7f68e0419412ca23c98d5749dcaaea1896172f06435891fc","affectsGlobalScope":true,"impliedFormat":1},{"version":"954296b30da6d508a104a3a0b5d96b76495c709785c1d11610908e63481ee667","affectsGlobalScope":true,"impliedFormat":1},{"version":"ac9538681b19688c8eae65811b329d3744af679e0bdfa5d842d0e32524c73e1c","affectsGlobalScope":true,"impliedFormat":1},{"version":"0a969edff4bd52585473d24995c5ef223f6652d6ef46193309b3921d65dd4376","affectsGlobalScope":true,"impliedFormat":1},{"version":"9e9fbd7030c440b33d021da145d3232984c8bb7916f277e8ffd3dc2e3eae2bdb","affectsGlobalScope":true,"impliedFormat":1},{"version":"811ec78f7fefcabbda4bfa93b3eb67d9ae166ef95f9bff989d964061cbf81a0c","affectsGlobalScope":true,"impliedFormat":1},{"version":"717937616a17072082152a2ef351cb51f98802fb4b2fdabd32399843875974ca","affectsGlobalScope":true,"impliedFormat":1},{"version":"d7e7d9b7b50e5f22c915b525acc5a49a7a6584cf8f62d0569e557c5cfc4b2ac2","affectsGlobalScope":true,"impliedFormat":1},{"version":"71c37f4c9543f31dfced6c7840e068c5a5aacb7b89111a4364b1d5276b852557","affectsGlobalScope":true,"impliedFormat":1},{"version":"576711e016cf4f1804676043e6a0a5414252560eb57de9faceee34d79798c850","affectsGlobalScope":true,"impliedFormat":1},{"version":"89c1b1281ba7b8a96efc676b11b264de7a8374c5ea1e6617f11880a13fc56dc6","affectsGlobalScope":true,"impliedFormat":1},{"version":"74f7fa2d027d5b33eb0471c8e82a6c87216223181ec31247c357a3e8e2fddc5b","affectsGlobalScope":true,"impliedFormat":1},{"version":"d6d7ae4d1f1f3772e2a3cde568ed08991a8ae34a080ff1151af28b7f798e22ca","affectsGlobalScope":true,"impliedFormat":1},{"version":"063600664504610fe3e99b717a1223f8b1900087fab0b4cad1496a114744f8df","affectsGlobalScope":true,"impliedFormat":1},{"version":"934019d7e3c81950f9a8426d093458b65d5aff2c7c1511233c0fd5b941e608ab","affectsGlobalScope":true,"impliedFormat":1},{"version":"52ada8e0b6e0482b728070b7639ee42e83a9b1c22d205992756fe020fd9f4a47","affectsGlobalScope":true,"impliedFormat":1},{"version":"3bdefe1bfd4d6dee0e26f928f93ccc128f1b64d5d501ff4a8cf3c6371200e5e6","affectsGlobalScope":true,"impliedFormat":1},{"version":"59fb2c069260b4ba00b5643b907ef5d5341b167e7d1dbf58dfd895658bda2867","affectsGlobalScope":true,"impliedFormat":1},{"version":"639e512c0dfc3fad96a84caad71b8834d66329a1f28dc95e3946c9b58176c73a","affectsGlobalScope":true,"impliedFormat":1},{"version":"368af93f74c9c932edd84c58883e736c9e3d53cec1fe24c0b0ff451f529ceab1","affectsGlobalScope":true,"impliedFormat":1},{"version":"8e7f8264d0fb4c5339605a15daadb037bf238c10b654bb3eee14208f860a32ea","affectsGlobalScope":true,"impliedFormat":1},{"version":"782dec38049b92d4e85c1585fbea5474a219c6984a35b004963b00beb1aab538","affectsGlobalScope":true,"impliedFormat":1},{"version":"0990a7576222f248f0a3b888adcb7389f957928ce2afb1cd5128169086ff4d29","impliedFormat":1},{"version":"eb5b19b86227ace1d29ea4cf81387279d04bb34051e944bc53df69f58914b788","affectsGlobalScope":true,"impliedFormat":1},{"version":"ac51dd7d31333793807a6abaa5ae168512b6131bd41d9c5b98477fc3b7800f9f","impliedFormat":1},{"version":"87d9d29dbc745f182683f63187bf3d53fd8673e5fca38ad5eaab69798ed29fbc","impliedFormat":1},{"version":"7a3aa194cfd5919c4da251ef04ea051077e22702638d4edcb9579e9101653519","affectsGlobalScope":true,"impliedFormat":1},{"version":"cc69795d9954ee4ad57545b10c7bf1a7260d990231b1685c147ea71a6faa265c","impliedFormat":1},{"version":"8bc6c94ff4f2af1f4023b7bb2379b08d3d7dd80c698c9f0b07431ea16101f05f","impliedFormat":1},{"version":"1b61d259de5350f8b1e5db06290d31eaebebc6baafd5f79d314b5af9256d7153","impliedFormat":1},{"version":"57194e1f007f3f2cbef26fa299d4c6b21f4623a2eddc63dfeef79e38e187a36e","impliedFormat":1},{"version":"0f6666b58e9276ac3a38fdc80993d19208442d6027ab885580d93aec76b4ef00","impliedFormat":1},{"version":"05fd364b8ef02fb1e174fbac8b825bdb1e5a36a016997c8e421f5fab0a6da0a0","impliedFormat":1},{"version":"70521b6ab0dcba37539e5303104f29b721bfb2940b2776da4cc818c07e1fefc1","affectsGlobalScope":true,"impliedFormat":1},{"version":"ab41ef1f2cdafb8df48be20cd969d875602483859dc194e9c97c8a576892c052","affectsGlobalScope":true,"impliedFormat":1},{"version":"d153a11543fd884b596587ccd97aebbeed950b26933ee000f94009f1ab142848","affectsGlobalScope":true,"impliedFormat":1},{"version":"21d819c173c0cf7cc3ce57c3276e77fd9a8a01d35a06ad87158781515c9a438a","impliedFormat":1},{"version":"98cffbf06d6bab333473c70a893770dbe990783904002c4f1a960447b4b53dca","affectsGlobalScope":true,"impliedFormat":1},{"version":"ba481bca06f37d3f2c137ce343c7d5937029b2468f8e26111f3c9d9963d6568d","affectsGlobalScope":true,"impliedFormat":1},{"version":"6d9ef24f9a22a88e3e9b3b3d8c40ab1ddb0853f1bfbd5c843c37800138437b61","affectsGlobalScope":true,"impliedFormat":1},{"version":"1db0b7dca579049ca4193d034d835f6bfe73096c73663e5ef9a0b5779939f3d0","affectsGlobalScope":true,"impliedFormat":1},{"version":"9798340ffb0d067d69b1ae5b32faa17ab31b82466a3fc00d8f2f2df0c8554aaa","affectsGlobalScope":true,"impliedFormat":1},{"version":"f26b11d8d8e4b8028f1c7d618b22274c892e4b0ef5b3678a8ccbad85419aef43","affectsGlobalScope":true,"impliedFormat":1},{"version":"5929864ce17fba74232584d90cb721a89b7ad277220627cc97054ba15a98ea8f","impliedFormat":1},{"version":"763fe0f42b3d79b440a9b6e51e9ba3f3f91352469c1e4b3b67bfa4ff6352f3f4","impliedFormat":1},{"version":"25c8056edf4314820382a5fdb4bb7816999acdcb929c8f75e3f39473b87e85bc","impliedFormat":1},{"version":"c464d66b20788266e5353b48dc4aa6bc0dc4a707276df1e7152ab0c9ae21fad8","impliedFormat":1},{"version":"78d0d27c130d35c60b5e5566c9f1e5be77caf39804636bc1a40133919a949f21","impliedFormat":1},{"version":"c6fd2c5a395f2432786c9cb8deb870b9b0e8ff7e22c029954fabdd692bff6195","impliedFormat":1},{"version":"1d6e127068ea8e104a912e42fc0a110e2aa5a66a356a917a163e8cf9a65e4a75","impliedFormat":1},{"version":"5ded6427296cdf3b9542de4471d2aa8d3983671d4cac0f4bf9c637208d1ced43","impliedFormat":1},{"version":"7f182617db458e98fc18dfb272d40aa2fff3a353c44a89b2c0ccb3937709bfb5","impliedFormat":1},{"version":"cadc8aced301244057c4e7e73fbcae534b0f5b12a37b150d80e5a45aa4bebcbd","impliedFormat":1},{"version":"385aab901643aa54e1c36f5ef3107913b10d1b5bb8cbcd933d4263b80a0d7f20","impliedFormat":1},{"version":"9670d44354bab9d9982eca21945686b5c24a3f893db73c0dae0fd74217a4c219","impliedFormat":1},{"version":"0b8a9268adaf4da35e7fa830c8981cfa22adbbe5b3f6f5ab91f6658899e657a7","impliedFormat":1},{"version":"11396ed8a44c02ab9798b7dca436009f866e8dae3c9c25e8c1fbc396880bf1bb","impliedFormat":1},{"version":"ba7bc87d01492633cb5a0e5da8a4a42a1c86270e7b3d2dea5d156828a84e4882","impliedFormat":1},{"version":"4893a895ea92c85345017a04ed427cbd6a1710453338df26881a6019432febdd","impliedFormat":1},{"version":"c21dc52e277bcfc75fac0436ccb75c204f9e1b3fa5e12729670910639f27343e","impliedFormat":1},{"version":"13f6f39e12b1518c6650bbb220c8985999020fe0f21d818e28f512b7771d00f9","impliedFormat":1},{"version":"9b5369969f6e7175740bf51223112ff209f94ba43ecd3bb09eefff9fd675624a","impliedFormat":1},{"version":"4fe9e626e7164748e8769bbf74b538e09607f07ed17c2f20af8d680ee49fc1da","impliedFormat":1},{"version":"24515859bc0b836719105bb6cc3d68255042a9f02a6022b3187948b204946bd2","impliedFormat":1},{"version":"ea0148f897b45a76544ae179784c95af1bd6721b8610af9ffa467a518a086a43","impliedFormat":1},{"version":"24c6a117721e606c9984335f71711877293a9651e44f59f3d21c1ea0856f9cc9","impliedFormat":1},{"version":"dd3273ead9fbde62a72949c97dbec2247ea08e0c6952e701a483d74ef92d6a17","impliedFormat":1},{"version":"405822be75ad3e4d162e07439bac80c6bcc6dbae1929e179cf467ec0b9ee4e2e","impliedFormat":1},{"version":"0db18c6e78ea846316c012478888f33c11ffadab9efd1cc8bcc12daded7a60b6","impliedFormat":1},{"version":"e61be3f894b41b7baa1fbd6a66893f2579bfad01d208b4ff61daef21493ef0a8","impliedFormat":1},{"version":"bd0532fd6556073727d28da0edfd1736417a3f9f394877b6d5ef6ad88fba1d1a","impliedFormat":1},{"version":"89167d696a849fce5ca508032aabfe901c0868f833a8625d5a9c6e861ef935d2","impliedFormat":1},{"version":"615ba88d0128ed16bf83ef8ccbb6aff05c3ee2db1cc0f89ab50a4939bfc1943f","impliedFormat":1},{"version":"a4d551dbf8746780194d550c88f26cf937caf8d56f102969a110cfaed4b06656","impliedFormat":1},{"version":"8bd86b8e8f6a6aa6c49b71e14c4ffe1211a0e97c80f08d2c8cc98838006e4b88","impliedFormat":1},{"version":"317e63deeb21ac07f3992f5b50cdca8338f10acd4fbb7257ebf56735bf52ab00","impliedFormat":1},{"version":"4732aec92b20fb28c5fe9ad99521fb59974289ed1e45aecb282616202184064f","impliedFormat":1},{"version":"2e85db9e6fd73cfa3d7f28e0ab6b55417ea18931423bd47b409a96e4a169e8e6","impliedFormat":1},{"version":"c46e079fe54c76f95c67fb89081b3e399da2c7d109e7dca8e4b58d83e332e605","impliedFormat":1},{"version":"bf67d53d168abc1298888693338cb82854bdb2e69ef83f8a0092093c2d562107","impliedFormat":1},{"version":"2cbe0621042e2a68c7cbce5dfed3906a1862a16a7d496010636cdbdb91341c0f","affectsGlobalScope":true,"impliedFormat":1},{"version":"e2677634fe27e87348825bb041651e22d50a613e2fdf6a4a3ade971d71bac37e","impliedFormat":1},{"version":"7394959e5a741b185456e1ef5d64599c36c60a323207450991e7a42e08911419","impliedFormat":1},{"version":"8c0bcd6c6b67b4b503c11e91a1fb91522ed585900eab2ab1f61bba7d7caa9d6f","impliedFormat":1},{"version":"8cd19276b6590b3ebbeeb030ac271871b9ed0afc3074ac88a94ed2449174b776","affectsGlobalScope":true,"impliedFormat":1},{"version":"696eb8d28f5949b87d894b26dc97318ef944c794a9a4e4f62360cd1d1958014b","impliedFormat":1},{"version":"3f8fa3061bd7402970b399300880d55257953ee6d3cd408722cb9ac20126460c","impliedFormat":1},{"version":"35ec8b6760fd7138bbf5809b84551e31028fb2ba7b6dc91d95d098bf212ca8b4","affectsGlobalScope":true,"impliedFormat":1},{"version":"5524481e56c48ff486f42926778c0a3cce1cc85dc46683b92b1271865bcf015a","impliedFormat":1},{"version":"68bd56c92c2bd7d2339457eb84d63e7de3bd56a69b25f3576e1568d21a162398","affectsGlobalScope":true,"impliedFormat":1},{"version":"3e93b123f7c2944969d291b35fed2af79a6e9e27fdd5faa99748a51c07c02d28","impliedFormat":1},{"version":"9d19808c8c291a9010a6c788e8532a2da70f811adb431c97520803e0ec649991","impliedFormat":1},{"version":"87aad3dd9752067dc875cfaa466fc44246451c0c560b820796bdd528e29bef40","impliedFormat":1},{"version":"4aacb0dd020eeaef65426153686cc639a78ec2885dc72ad220be1d25f1a439df","impliedFormat":1},{"version":"f0bd7e6d931657b59605c44112eaf8b980ba7f957a5051ed21cb93d978cf2f45","impliedFormat":1},{"version":"8db0ae9cb14d9955b14c214f34dae1b9ef2baee2fe4ce794a4cd3ac2531e3255","affectsGlobalScope":true,"impliedFormat":1},{"version":"15fc6f7512c86810273af28f224251a5a879e4261b4d4c7e532abfbfc3983134","impliedFormat":1},{"version":"58adba1a8ab2d10b54dc1dced4e41f4e7c9772cbbac40939c0dc8ce2cdb1d442","impliedFormat":1},{"version":"2fd4c143eff88dabb57701e6a40e02a4dbc36d5eb1362e7964d32028056a782b","impliedFormat":1},{"version":"714435130b9015fae551788df2a88038471a5a11eb471f27c4ede86552842bc9","impliedFormat":1},{"version":"855cd5f7eb396f5f1ab1bc0f8580339bff77b68a770f84c6b254e319bbfd1ac7","impliedFormat":1},{"version":"5650cf3dace09e7c25d384e3e6b818b938f68f4e8de96f52d9c5a1b3db068e86","impliedFormat":1},{"version":"1354ca5c38bd3fd3836a68e0f7c9f91f172582ba30ab15bb8c075891b91502b7","affectsGlobalScope":true,"impliedFormat":1},{"version":"27fdb0da0daf3b337c5530c5f266efe046a6ceb606e395b346974e4360c36419","impliedFormat":1},{"version":"2d2fcaab481b31a5882065c7951255703ddbe1c0e507af56ea42d79ac3911201","impliedFormat":1},{"version":"a192fe8ec33f75edbc8d8f3ed79f768dfae11ff5735e7fe52bfa69956e46d78d","impliedFormat":1},{"version":"ca867399f7db82df981d6915bcbb2d81131d7d1ef683bc782b59f71dda59bc85","affectsGlobalScope":true,"impliedFormat":1},{"version":"d9e971bba9cf977c7774abbd4d2e3413a231af8a06a2e8b16af2a606bc91ddd0","affectsGlobalScope":true,"impliedFormat":1},{"version":"9e043a1bc8fbf2a255bccf9bf27e0f1caf916c3b0518ea34aa72357c0afd42ec","impliedFormat":1},{"version":"b4f70ec656a11d570e1a9edce07d118cd58d9760239e2ece99306ee9dfe61d02","impliedFormat":1},{"version":"3bc2f1e2c95c04048212c569ed38e338873f6a8593930cf5a7ef24ffb38fc3b6","impliedFormat":1},{"version":"6e70e9570e98aae2b825b533aa6292b6abd542e8d9f6e9475e88e1d7ba17c866","impliedFormat":1},{"version":"f9d9d753d430ed050dc1bf2667a1bab711ccbb1c1507183d794cc195a5b085cc","impliedFormat":1},{"version":"9eece5e586312581ccd106d4853e861aaaa1a39f8e3ea672b8c3847eedd12f6e","impliedFormat":1},{"version":"47ab634529c5955b6ad793474ae188fce3e6163e3a3fb5edd7e0e48f14435333","impliedFormat":1},{"version":"37ba7b45141a45ce6e80e66f2a96c8a5ab1bcef0fc2d0f56bb58df96ec67e972","impliedFormat":1},{"version":"45650f47bfb376c8a8ed39d4bcda5902ab899a3150029684ee4c10676d9fbaee","impliedFormat":1},{"version":"0225ecb9ed86bdb7a2c7fd01f1556906902929377b44483dc4b83e03b3ef227d","affectsGlobalScope":true,"impliedFormat":1},{"version":"74cf591a0f63db318651e0e04cb55f8791385f86e987a67fd4d2eaab8191f730","impliedFormat":1},{"version":"5eab9b3dc9b34f185417342436ec3f106898da5f4801992d8ff38ab3aff346b5","impliedFormat":1},{"version":"12ed4559eba17cd977aa0db658d25c4047067444b51acfdcbf38470630642b23","affectsGlobalScope":true,"impliedFormat":1},{"version":"f3ffabc95802521e1e4bcba4c88d8615176dc6e09111d920c7a213bdda6e1d65","impliedFormat":1},{"version":"f9ab232778f2842ffd6955f88b1049982fa2ecb764d129ee4893cbc290f41977","impliedFormat":1},{"version":"ae56f65caf3be91108707bd8dfbccc2a57a91feb5daabf7165a06a945545ed26","impliedFormat":1},{"version":"a136d5de521da20f31631a0a96bf712370779d1c05b7015d7019a9b2a0446ca9","impliedFormat":1},{"version":"c3b41e74b9a84b88b1dca61ec39eee25c0dbc8e7d519ba11bb070918cfacf656","affectsGlobalScope":true,"impliedFormat":1},{"version":"4737a9dc24d0e68b734e6cfbcea0c15a2cfafeb493485e27905f7856988c6b29","affectsGlobalScope":true,"impliedFormat":1},{"version":"36d8d3e7506b631c9582c251a2c0b8a28855af3f76719b12b534c6edf952748d","impliedFormat":1},{"version":"1ca69210cc42729e7ca97d3a9ad48f2e9cb0042bada4075b588ae5387debd318","impliedFormat":1},{"version":"f5ebe66baaf7c552cfa59d75f2bfba679f329204847db3cec385acda245e574e","impliedFormat":1},{"version":"ed59add13139f84da271cafd32e2171876b0a0af2f798d0c663e8eeb867732cf","affectsGlobalScope":true,"impliedFormat":1},{"version":"05db535df8bdc30d9116fe754a3473d1b6479afbc14ae8eb18b605c62677d518","impliedFormat":1},{"version":"b1810689b76fd473bd12cc9ee219f8e62f54a7d08019a235d07424afbf074d25","impliedFormat":1},{"version":"8caa5c86be1b793cd5f599e27ecb34252c41e011980f7d61ae4989a149ff6ccc","impliedFormat":1},{"version":"91b0f6d01993021ecbe01eb076db6a3cf1b66359c1d99104f43436010e81afb5","impliedFormat":1},{"version":"d1bd4e51810d159899aad1660ccb859da54e27e08b8c9862b40cd36c1d9ff00f","impliedFormat":1},{"version":"17ed71200119e86ccef2d96b73b02ce8854b76ad6bd21b5021d4269bec527b5f","impliedFormat":1},{"version":"1cfa8647d7d71cb03847d616bd79320abfc01ddea082a49569fda71ac5ece66b","impliedFormat":1},{"version":"bb7a61dd55dc4b9422d13da3a6bb9cc5e89be888ef23bbcf6558aa9726b89a1c","impliedFormat":1},{"version":"db6d2d9daad8a6d83f281af12ce4355a20b9a3e71b82b9f57cddcca0a8964a96","impliedFormat":1},{"version":"cfe4ef4710c3786b6e23dae7c086c70b4f4835a2e4d77b75d39f9046106e83d3","impliedFormat":1},{"version":"cbea99888785d49bb630dcbb1613c73727f2b5a2cf02e1abcaab7bcf8d6bf3c5","impliedFormat":1},{"version":"3a8bddb66b659f6bd2ff641fc71df8a8165bafe0f4b799cc298be5cd3755bb20","impliedFormat":1},{"version":"a86f82d646a739041d6702101afa82dcb935c416dd93cbca7fd754fd0282ce1f","impliedFormat":1},{"version":"2dad084c67e649f0f354739ec7df7c7df0779a28a4f55c97c6b6883ae850d1ce","impliedFormat":1},{"version":"fa5bbc7ab4130dd8cdc55ea294ec39f76f2bc507a0f75f4f873e38631a836ca7","impliedFormat":1},{"version":"df45ca1176e6ac211eae7ddf51336dc075c5314bc5c253651bae639defd5eec5","impliedFormat":1},{"version":"cf86de1054b843e484a3c9300d62fbc8c97e77f168bbffb131d560ca0474d4a8","impliedFormat":1},{"version":"196c960b12253fde69b204aa4fbf69470b26daf7a430855d7f94107a16495ab0","impliedFormat":1},{"version":"ee15ea5dd7a9fc9f5013832e5843031817a880bf0f24f37a29fd8337981aae07","impliedFormat":1},{"version":"bf24f6d35f7318e246010ffe9924395893c4e96d34324cde77151a73f078b9ad","impliedFormat":1},{"version":"ea53732769832d0f127ae16620bd5345991d26bf0b74e85e41b61b27d74ea90f","impliedFormat":1},{"version":"10595c7ff5094dd5b6a959ccb1c00e6a06441b4e10a87bc09c15f23755d34439","impliedFormat":1},{"version":"9620c1ff645afb4a9ab4044c85c26676f0a93e8c0e4b593aea03a89ccb47b6d0","impliedFormat":1},{"version":"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855","impliedFormat":1},{"version":"a9af0e608929aaf9ce96bd7a7b99c9360636c31d73670e4af09a09950df97841","impliedFormat":1},{"version":"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855","impliedFormat":1},{"version":"c86fe861cf1b4c46a0fb7d74dffe596cf679a2e5e8b1456881313170f092e3fa","impliedFormat":1},{"version":"08ed0b3f0166787f84a6606f80aa3b1388c7518d78912571b203817406e471da","impliedFormat":1},{"version":"47e5af2a841356a961f815e7c55d72554db0c11b4cba4d0caab91f8717846a94","impliedFormat":1},{"version":"65f43099ded6073336e697512d9b80f2d4fec3182b7b2316abf712e84104db00","impliedFormat":1},{"version":"f5f541902bf7ae0512a177295de9b6bcd6809ea38307a2c0a18bfca72212f368","impliedFormat":1},{"version":"b0decf4b6da3ebc52ea0c96095bdfaa8503acc4ac8e9081c5f2b0824835dd3bd","impliedFormat":1},{"version":"ca1b882a105a1972f82cc58e3be491e7d750a1eb074ffd13b198269f57ed9e1b","impliedFormat":1},{"version":"fc3e1c87b39e5ba1142f27ec089d1966da168c04a859a4f6aab64dceae162c2b","impliedFormat":1},{"version":"3b414b99a73171e1c4b7b7714e26b87d6c5cb03d200352da5342ab4088a54c85","impliedFormat":1},{"version":"61888522cec948102eba94d831c873200aa97d00d8989fdfd2a3e0ee75ec65a2","impliedFormat":1},{"version":"4e10622f89fea7b05dd9b52fb65e1e2b5cbd96d4cca3d9e1a60bb7f8a9cb86a1","impliedFormat":1},{"version":"74b2a5e5197bd0f2e0077a1ea7c07455bbea67b87b0869d9786d55104006784f","impliedFormat":1},{"version":"59bf32919de37809e101acffc120596a9e45fdbab1a99de5087f31fdc36e2f11","impliedFormat":1},{"version":"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855","impliedFormat":1},{"version":"faa03dffb64286e8304a2ca96dd1317a77db6bfc7b3fb385163648f67e535d77","impliedFormat":1},{"version":"c40c848daad198266370c1c72a7a8c3d18d2f50727c7859fcfefd3ff69a7f288","impliedFormat":1},{"version":"ac60bbee0d4235643cc52b57768b22de8c257c12bd8c2039860540cab1fa1d82","impliedFormat":1},{"version":"6428e6edd944ce6789afdf43f9376c1f2e4957eea34166177625aaff4c0da1a0","impliedFormat":1},{"version":"ada39cbb2748ab2873b7835c90c8d4620723aedf323550e8489f08220e477c7f","impliedFormat":1},{"version":"6e5f5cee603d67ee1ba6120815497909b73399842254fc1e77a0d5cdc51d8c9c","impliedFormat":1},{"version":"8dba67056cbb27628e9b9a1cba8e57036d359dceded0725c72a3abe4b6c79cd4","impliedFormat":1},{"version":"70f3814c457f54a7efe2d9ce9d2686de9250bb42eb7f4c539bd2280a42e52d33","impliedFormat":1},{"version":"154dd2e22e1e94d5bc4ff7726706bc0483760bae40506bdce780734f11f7ec47","impliedFormat":1},{"version":"ef61792acbfa8c27c9bd113f02731e66229f7d3a169e3c1993b508134f1a58e0","impliedFormat":1},{"version":"9c82171d836c47486074e4ca8e059735bf97b205e70b196535b5efd40cbe1bc5","impliedFormat":1},{"version":"0131e203d8560edb39678abe10db42564a068f98c4ebd1ed9ffe7279c78b3c81","impliedFormat":1},{"version":"f6404e7837b96da3ea4d38c4f1a3812c96c9dcdf264e93d5bdb199f983a3ef4b","impliedFormat":1},{"version":"c5426dbfc1cf90532f66965a7aa8c1136a78d4d0f96d8180ecbfc11d7722f1a5","impliedFormat":1},{"version":"65a15fc47900787c0bd18b603afb98d33ede930bed1798fc984d5ebb78b26cf9","impliedFormat":1},{"version":"9d202701f6e0744adb6314d03d2eb8fc994798fc83d91b691b75b07626a69801","impliedFormat":1},{"version":"de9d2df7663e64e3a91bf495f315a7577e23ba088f2949d5ce9ec96f44fba37d","impliedFormat":1},{"version":"c7af78a2ea7cb1cd009cfb5bdb48cd0b03dad3b54f6da7aab615c2e9e9d570c5","impliedFormat":1},{"version":"1ee45496b5f8bdee6f7abc233355898e5bf9bd51255db65f5ff7ede617ca0027","impliedFormat":1},{"version":"8b8f00491431fe82f060dfe8c7f2180a9fb239f3d851527db909b83230e75882","affectsGlobalScope":true,"impliedFormat":1},{"version":"db01d18853469bcb5601b9fc9826931cc84cc1a1944b33cad76fd6f1e3d8c544","affectsGlobalScope":true,"impliedFormat":1},{"version":"dba114fb6a32b355a9cfc26ca2276834d72fe0e94cd2c3494005547025015369","impliedFormat":1},{"version":"903e299a28282fa7b714586e28409ed73c3b63f5365519776bf78e8cf173db36","affectsGlobalScope":true,"impliedFormat":1},{"version":"fa6c12a7c0f6b84d512f200690bfc74819e99efae69e4c95c4cd30f6884c526e","impliedFormat":1},{"version":"f1c32f9ce9c497da4dc215c3bc84b722ea02497d35f9134db3bb40a8d918b92b","impliedFormat":1},{"version":"b73c319af2cc3ef8f6421308a250f328836531ea3761823b4cabbd133047aefa","affectsGlobalScope":true,"impliedFormat":1},{"version":"e433b0337b8106909e7953015e8fa3f2d30797cea27141d1c5b135365bb975a6","impliedFormat":1},{"version":"dd3900b24a6a8745efeb7ad27629c0f8a626470ac229c1d73f1fe29d67e44dca","impliedFormat":1},{"version":"ddff7fc6edbdc5163a09e22bf8df7bef75f75369ebd7ecea95ba55c4386e2441","impliedFormat":1},{"version":"106c6025f1d99fd468fd8bf6e5bda724e11e5905a4076c5d29790b6c3745e50c","impliedFormat":1},{"version":"ec29be0737d39268696edcec4f5e97ce26f449fa9b7afc2f0f99a86def34a418","impliedFormat":1},{"version":"aeab39e8e0b1a3b250434c3b2bb8f4d17bbec2a9dbce5f77e8a83569d3d2cbc2","impliedFormat":1},{"version":"ec6cba1c02c675e4dd173251b156792e8d3b0c816af6d6ad93f1a55d674591aa","impliedFormat":1},{"version":"b620391fe8060cf9bedc176a4d01366e6574d7a71e0ac0ab344a4e76576fcbb8","impliedFormat":1},{"version":"d729408dfde75b451530bcae944cf89ee8277e2a9df04d1f62f2abfd8b03c1e1","impliedFormat":1},{"version":"e15d3c84d5077bb4a3adee4c791022967b764dc41cb8fa3cfa44d4379b2c95f5","impliedFormat":1},{"version":"5f58e28cd22e8fc1ac1b3bc6b431869f1e7d0b39e2c21fbf79b9fa5195a85980","impliedFormat":1},{"version":"e1fc1a1045db5aa09366be2b330e4ce391550041fc3e925f60998ca0b647aa97","impliedFormat":1},{"version":"63533978dcda286422670f6e184ac516805a365fb37a086eeff4309e812f1402","impliedFormat":1},{"version":"43ba4f2fa8c698f5c304d21a3ef596741e8e85a810b7c1f9b692653791d8d97a","impliedFormat":1},{"version":"31fb49ef3aa3d76f0beb644984e01eab0ea222372ea9b49bb6533be5722d756c","impliedFormat":1},{"version":"33cd131e1461157e3e06b06916b5176e7a8ec3fce15a5cfe145e56de744e07d2","impliedFormat":1},{"version":"889ef863f90f4917221703781d9723278db4122d75596b01c429f7c363562b86","impliedFormat":1},{"version":"3556cfbab7b43da96d15a442ddbb970e1f2fc97876d055b6555d86d7ac57dae5","impliedFormat":1},{"version":"437751e0352c6e924ddf30e90849f1d9eb00ca78c94d58d6a37202ec84eb8393","impliedFormat":1},{"version":"48e8af7fdb2677a44522fd185d8c87deff4d36ee701ea003c6c780b1407a1397","impliedFormat":1},{"version":"d11308de5a36c7015bb73adb5ad1c1bdaac2baede4cc831a05cf85efa3cc7f2f","impliedFormat":1},{"version":"38e4684c22ed9319beda6765bab332c724103d3a966c2e5e1c5a49cf7007845f","impliedFormat":1},{"version":"f9812cfc220ecf7557183379531fa409acd249b9e5b9a145d0d52b76c20862de","affectsGlobalScope":true,"impliedFormat":1},{"version":"e650298721abc4f6ae851e60ae93ee8199791ceec4b544c3379862f81f43178c","impliedFormat":1},{"version":"2e4f37ffe8862b14d8e24ae8763daaa8340c0df0b859d9a9733def0eee7562d9","impliedFormat":1},{"version":"13283350547389802aa35d9f2188effaeac805499169a06ef5cd77ce2a0bd63f","impliedFormat":1},{"version":"680793958f6a70a44c8d9ae7d46b7a385361c69ac29dcab3ed761edce1c14ab8","impliedFormat":1},{"version":"6ac6715916fa75a1f7ebdfeacac09513b4d904b667d827b7535e84ff59679aff","impliedFormat":1},{"version":"42c169fb8c2d42f4f668c624a9a11e719d5d07dacbebb63cbcf7ef365b0a75b3","impliedFormat":1},{"version":"913ddbba170240070bd5921b8f33ea780021bdf42fbdfcd4fcb2691b1884ddde","impliedFormat":1},{"version":"b4e6d416466999ff40d3fe5ceb95f7a8bfb7ac2262580287ac1a8391e5362431","impliedFormat":1},{"version":"5fe23bd829e6be57d41929ac374ee9551ccc3c44cee893167b7b5b77be708014","impliedFormat":1},{"version":"0a626484617019fcfbfc3c1bc1f9e84e2913f1adb73692aa9075817404fb41a1","impliedFormat":1},{"version":"438c7513b1df91dcef49b13cd7a1c4720f91a36e88c1df731661608b7c055f10","impliedFormat":1},{"version":"cf185cc4a9a6d397f416dd28cca95c227b29f0f27b160060a95c0e5e36cda865","impliedFormat":1},{"version":"0086f3e4ad898fd7ca56bb223098acfacf3fa065595182aaf0f6c4a6a95e6fbd","impliedFormat":1},{"version":"efaa078e392f9abda3ee8ade3f3762ab77f9c50b184e6883063a911742a4c96a","impliedFormat":1},{"version":"54a8bb487e1dc04591a280e7a673cdfb272c83f61e28d8a64cf1ac2e63c35c51","impliedFormat":1},{"version":"021a9498000497497fd693dd315325484c58a71b5929e2bbb91f419b04b24cea","impliedFormat":1},{"version":"9385cdc09850950bc9b59cca445a3ceb6fcca32b54e7b626e746912e489e535e","impliedFormat":1},{"version":"2894c56cad581928bb37607810af011764a2f511f575d28c9f4af0f2ef02d1ab","impliedFormat":1},{"version":"0a72186f94215d020cb386f7dca81d7495ab6c17066eb07d0f44a5bf33c1b21a","impliedFormat":1},{"version":"84124384abae2f6f66b7fbfc03862d0c2c0b71b826f7dbf42c8085d31f1d3f95","impliedFormat":1},{"version":"63a8e96f65a22604eae82737e409d1536e69a467bb738bec505f4f97cce9d878","impliedFormat":1},{"version":"3fd78152a7031315478f159c6a5872c712ece6f01212c78ea82aef21cb0726e2","impliedFormat":1},{"version":"b01bd582a6e41457bc56e6f0f9de4cb17f33f5f3843a7cf8210ac9c18472fb0f","impliedFormat":1},{"version":"58b49e5c1def740360b5ae22ae2405cfac295fee74abd88d74ac4ea42502dc03","impliedFormat":1},{"version":"512fc15cca3a35b8dbbf6e23fe9d07e6f87ad03c895acffd3087ce09f352aad0","impliedFormat":1},{"version":"9a0946d15a005832e432ea0cd4da71b57797efb25b755cc07f32274296d62355","impliedFormat":1},{"version":"a52ff6c0a149e9f370372fc3c715d7f2beee1f3bab7980e271a7ab7d313ec677","impliedFormat":1},{"version":"fd933f824347f9edd919618a76cdb6a0c0085c538115d9a287fa0c7f59957ab3","impliedFormat":1},{"version":"6ac6715916fa75a1f7ebdfeacac09513b4d904b667d827b7535e84ff59679aff","impliedFormat":1},{"version":"6a1aa3e55bdc50503956c5cd09ae4cd72e3072692d742816f65c66ca14f4dfdd","impliedFormat":1},{"version":"ab75cfd9c4f93ffd601f7ca1753d6a9d953bbedfbd7a5b3f0436ac8a1de60dfa","impliedFormat":1},{"version":"f95180f03d827525ca4f990f49e17ec67198c316dd000afbe564655141f725cd","impliedFormat":1},{"version":"b73cbf0a72c8800cf8f96a9acfe94f3ad32ca71342a8908b8ae484d61113f647","impliedFormat":1},{"version":"bae6dd176832f6423966647382c0d7ba9e63f8c167522f09a982f086cd4e8b23","impliedFormat":1},{"version":"1364f64d2fb03bbb514edc42224abd576c064f89be6a990136774ecdd881a1da","impliedFormat":1},{"version":"c9958eb32126a3843deedda8c22fb97024aa5d6dd588b90af2d7f2bfac540f23","impliedFormat":1},{"version":"950fb67a59be4c2dbe69a5786292e60a5cb0e8612e0e223537784c731af55db1","impliedFormat":1},{"version":"e927c2c13c4eaf0a7f17e6022eee8519eb29ef42c4c13a31e81a611ab8c95577","impliedFormat":1},{"version":"07ca44e8d8288e69afdec7a31fa408ce6ab90d4f3d620006701d5544646da6aa","impliedFormat":1},{"version":"70246ad95ad8a22bdfe806cb5d383a26c0c6e58e7207ab9c431f1cb175aca657","impliedFormat":1},{"version":"f00f3aa5d64ff46e600648b55a79dcd1333458f7a10da2ed594d9f0a44b76d0b","impliedFormat":1},{"version":"772d8d5eb158b6c92412c03228bd9902ccb1457d7a705b8129814a5d1a6308fc","impliedFormat":1},{"version":"4e4475fba4ed93a72f167b061cd94a2e171b82695c56de9899275e880e06ba41","impliedFormat":1},{"version":"97c5f5d580ab2e4decd0a3135204050f9b97cd7908c5a8fbc041eadede79b2fa","impliedFormat":1},{"version":"c99a3a5f2215d5b9d735aa04cec6e61ed079d8c0263248e298ffe4604d4d0624","impliedFormat":1},{"version":"49b2375c586882c3ac7f57eba86680ff9742a8d8cb2fe25fe54d1b9673690d41","impliedFormat":1},{"version":"802e797bcab5663b2c9f63f51bdf67eff7c41bc64c0fd65e6da3e7941359e2f7","impliedFormat":1},{"version":"847e160d709c74cc714fbe1f99c41d3425b74cd47b1be133df1623cd87014089","impliedFormat":1},{"version":"9fee04f1e1afa50524862289b9f0b0fdc3735b80e2a0d684cec3b9ff3d94cecc","impliedFormat":1},{"version":"5cdc27fbc5c166fc5c763a30ac21cbac9859dc5ba795d3230db6d4e52a1965bb","impliedFormat":1},{"version":"6459054aabb306821a043e02b89d54da508e3a6966601a41e71c166e4ea1474f","impliedFormat":1},{"version":"f416c9c3eee9d47ff49132c34f96b9180e50485d435d5748f0e8b72521d28d2e","impliedFormat":1},{"version":"05c97cddbaf99978f83d96de2d8af86aded9332592f08ce4a284d72d0952c391","impliedFormat":1},{"version":"14e5cdec6f8ae82dfd0694e64903a0a54abdfe37e1d966de3d4128362acbf35f","impliedFormat":1},{"version":"bbc183d2d69f4b59fd4dd8799ffdf4eb91173d1c4ad71cce91a3811c021bf80c","impliedFormat":1},{"version":"7b6ff760c8a240b40dab6e4419b989f06a5b782f4710d2967e67c695ef3e93c4","impliedFormat":1},{"version":"8dbc4134a4b3623fc476be5f36de35c40f2768e2e3d9ed437e0d5f1c4cd850f6","impliedFormat":1},{"version":"4e06330a84dec7287f7ebdd64978f41a9f70a668d3b5edc69d5d4a50b9b376bb","impliedFormat":1},{"version":"65bfa72967fbe9fc33353e1ac03f0480aa2e2ea346d61ff3ea997dfd850f641a","impliedFormat":1},{"version":"c06f0bb92d1a1a5a6c6e4b5389a5664d96d09c31673296cb7da5fe945d54d786","impliedFormat":1},{"version":"f974e4a06953682a2c15d5bd5114c0284d5abf8bc0fe4da25cb9159427b70072","impliedFormat":1},{"version":"872caaa31423f4345983d643e4649fb30f548e9883a334d6d1c5fff68ede22d4","impliedFormat":1},{"version":"94404c4a878fe291e7578a2a80264c6f18e9f1933fbb57e48f0eb368672e389c","impliedFormat":1},{"version":"5c1b7f03aa88be854bc15810bfd5bd5a1943c5a7620e1c53eddd2a013996343e","impliedFormat":1},{"version":"09dfc64fcd6a2785867f2368419859a6cc5a8d4e73cbe2538f205b1642eb0f51","impliedFormat":1},{"version":"bcf6f0a323653e72199105a9316d91463ad4744c546d1271310818b8cef7c608","impliedFormat":1},{"version":"01aa917531e116485beca44a14970834687b857757159769c16b228eb1e49c5f","impliedFormat":1},{"version":"351475f9c874c62f9b45b1f0dc7e2704e80dfd5f1af83a3a9f841f9dfe5b2912","impliedFormat":1},{"version":"ac457ad39e531b7649e7b40ee5847606eac64e236efd76c5d12db95bf4eacd17","impliedFormat":1},{"version":"187a6fdbdecb972510b7555f3caacb44b58415da8d5825d03a583c4b73fde4cf","impliedFormat":1},{"version":"d4c3250105a612202289b3a266bb7e323db144f6b9414f9dea85c531c098b811","impliedFormat":1},{"version":"95b444b8c311f2084f0fb51c616163f950fb2e35f4eaa07878f313a2d36c98a4","impliedFormat":1},{"version":"741067675daa6d4334a2dc80a4452ca3850e89d5852e330db7cb2b5f867173b1","impliedFormat":1},{"version":"f8acecec1114f11690956e007d920044799aefeb3cece9e7f4b1f8a1d542b2c9","impliedFormat":1},{"version":"178071ccd043967a58c5d1a032db0ddf9bd139e7920766b537d9783e88eb615e","impliedFormat":1},{"version":"3a17f09634c50cce884721f54fd9e7b98e03ac505889c560876291fcf8a09e90","impliedFormat":1},{"version":"32531dfbb0cdc4525296648f53b2b5c39b64282791e2a8c765712e49e6461046","impliedFormat":1},{"version":"0ce1b2237c1c3df49748d61568160d780d7b26693bd9feb3acb0744a152cd86d","impliedFormat":1},{"version":"e489985388e2c71d3542612685b4a7db326922b57ac880f299da7026a4e8a117","impliedFormat":1},{"version":"5cad4158616d7793296dd41e22e1257440910ea8d01c7b75045d4dfb20c5a41a","impliedFormat":1},{"version":"04d3aad777b6af5bd000bfc409907a159fe77e190b9d368da4ba649cdc28d39e","affectsGlobalScope":true,"impliedFormat":1},{"version":"74efc1d6523bd57eb159c18d805db4ead810626bc5bc7002a2c7f483044b2e0f","impliedFormat":1},{"version":"19252079538942a69be1645e153f7dbbc1ef56b4f983c633bf31fe26aeac32cd","impliedFormat":1},{"version":"bc11f3ac00ac060462597add171220aed628c393f2782ac75dd29ff1e0db871c","impliedFormat":1},{"version":"616775f16134fa9d01fc677ad3f76e68c051a056c22ab552c64cc281a9686790","impliedFormat":1},{"version":"65c24a8baa2cca1de069a0ba9fba82a173690f52d7e2d0f1f7542d59d5eb4db0","impliedFormat":1},{"version":"f9fe6af238339a0e5f7563acee3178f51db37f32a2e7c09f85273098cee7ec49","impliedFormat":1},{"version":"3b0b1d352b8d2e47f1c4df4fb0678702aee071155b12ef0185fce9eb4fa4af1e","impliedFormat":1},{"version":"77e71242e71ebf8528c5802993697878f0533db8f2299b4d36aa015bae08a79c","impliedFormat":1},{"version":"a344403e7a7384e0e7093942533d309194ad0a53eca2a3100c0b0ab4d3932773","impliedFormat":1},{"version":"b7fff2d004c5879cae335db8f954eb1d61242d9f2d28515e67902032723caeab","impliedFormat":1},{"version":"5f3dc10ae646f375776b4e028d2bed039a93eebbba105694d8b910feebbe8b9c","impliedFormat":1},{"version":"bb18bf4a61a17b4a6199eb3938ecfa4a59eb7c40843ad4a82b975ab6f7e3d925","impliedFormat":1},{"version":"4545c1a1ceca170d5d83452dd7c4994644c35cf676a671412601689d9a62da35","impliedFormat":1},{"version":"e9b6fc05f536dfddcdc65dbcf04e09391b1c968ab967382e48924f5cb90d88e1","impliedFormat":1},{"version":"a2d648d333cf67b9aeac5d81a1a379d563a8ffa91ddd61c6179f68de724260ff","impliedFormat":1},{"version":"2b664c3cc544d0e35276e1fb2d4989f7d4b4027ffc64da34ec83a6ccf2e5c528","impliedFormat":1},{"version":"a3f41ed1b4f2fc3049394b945a68ae4fdefd49fa1739c32f149d32c0545d67f5","impliedFormat":1},{"version":"3cd8f0464e0939b47bfccbb9bb474a6d87d57210e304029cd8eb59c63a81935d","impliedFormat":1},{"version":"47699512e6d8bebf7be488182427189f999affe3addc1c87c882d36b7f2d0b0e","impliedFormat":1},{"version":"3026abd48e5e312f2328629ede6e0f770d21c3cd32cee705c450e589d015ee09","impliedFormat":1},{"version":"8b140b398a6afbd17cc97c38aea5274b2f7f39b1ae5b62952cfe65bf493e3e75","impliedFormat":1},{"version":"7663d2c19ce5ef8288c790edba3d45af54e58c84f1b37b1249f6d49d962f3d91","impliedFormat":1},{"version":"5cce3b975cdb72b57ae7de745b3c5de5790781ee88bcb41ba142f07c0fa02e97","impliedFormat":1},{"version":"00bd6ebe607246b45296aa2b805bd6a58c859acecda154bfa91f5334d7c175c6","impliedFormat":1},{"version":"ad036a85efcd9e5b4f7dd5c1a7362c8478f9a3b6c3554654ca24a29aa850a9c5","impliedFormat":1},{"version":"fedebeae32c5cdd1a85b4e0504a01996e4a8adf3dfa72876920d3dd6e42978e7","impliedFormat":1},{"version":"0d28b974a7605c4eda20c943b3fa9ae16cb452c1666fc9b8c341b879992c7612","impliedFormat":1},{"version":"cdf21eee8007e339b1b9945abf4a7b44930b1d695cc528459e68a3adc39a622e","impliedFormat":1},{"version":"db036c56f79186da50af66511d37d9fe77fa6793381927292d17f81f787bb195","impliedFormat":1},{"version":"87ac2fb61e629e777f4d161dff534c2023ee15afd9cb3b1589b9b1f014e75c58","impliedFormat":1},{"version":"13c8b4348db91e2f7d694adc17e7438e6776bc506d5c8f5de9ad9989707fa3fe","impliedFormat":1},{"version":"3c1051617aa50b38e9efaabce25e10a5dd9b1f42e372ef0e8a674076a68742ed","impliedFormat":1},{"version":"07a3e20cdcb0f1182f452c0410606711fbea922ca76929a41aacb01104bc0d27","impliedFormat":1},{"version":"1de80059b8078ea5749941c9f863aa970b4735bdbb003be4925c853a8b6b4450","impliedFormat":1},{"version":"1d079c37fa53e3c21ed3fa214a27507bda9991f2a41458705b19ed8c2b61173d","impliedFormat":1},{"version":"4cd4b6b1279e9d744a3825cbd7757bbefe7f0708f3f1069179ad535f19e8ed2c","impliedFormat":1},{"version":"5835a6e0d7cd2738e56b671af0e561e7c1b4fb77751383672f4b009f4e161d70","impliedFormat":1},{"version":"c0eeaaa67c85c3bb6c52b629ebbfd3b2292dc67e8c0ffda2fc6cd2f78dc471e6","impliedFormat":1},{"version":"4b7f74b772140395e7af67c4841be1ab867c11b3b82a51b1aeb692822b76c872","impliedFormat":1},{"version":"27be6622e2922a1b412eb057faa854831b95db9db5035c3f6d4b677b902ab3b7","impliedFormat":1},{"version":"b95a6f019095dd1d48fd04965b50dfd63e5743a6e75478343c46d2582a5132bf","impliedFormat":99},{"version":"c2008605e78208cfa9cd70bd29856b72dda7ad89df5dc895920f8e10bcb9cd0a","impliedFormat":99},{"version":"b97cb5616d2ab82a98ec9ada7b9e9cabb1f5da880ec50ea2b8dc5baa4cbf3c16","impliedFormat":99},{"version":"d23df9ff06ae8bf1dcb7cc933e97ae7da418ac77749fecee758bb43a8d69f840","affectsGlobalScope":true,"impliedFormat":1},{"version":"040c71dde2c406f869ad2f41e8d4ce579cc60c8dbe5aa0dd8962ac943b846572","affectsGlobalScope":true,"impliedFormat":1},{"version":"3586f5ea3cc27083a17bd5c9059ede9421d587286d5a47f4341a4c2d00e4fa91","impliedFormat":1},{"version":"a6df929821e62f4719551f7955b9f42c0cd53c1370aec2dd322e24196a7dfe33","impliedFormat":1},{"version":"b789bf89eb19c777ed1e956dbad0925ca795701552d22e68fd130a032008b9f9","impliedFormat":1},"9dd9d642cdb87d4d5b3173217e0c45429b3e47a6f5cf5fb0ead6c644ec5fed01",{"version":"a7ca8df4f2931bef2aa4118078584d84a0b16539598eaadf7dce9104dfaa381c","impliedFormat":1},{"version":"10073cdcf56982064c5337787cc59b79586131e1b28c106ede5bff362f912b70","impliedFormat":99},{"version":"72950913f4900b680f44d8cab6dd1ea0311698fc1eefb014eb9cdfc37ac4a734","impliedFormat":1},{"version":"151ff381ef9ff8da2da9b9663ebf657eac35c4c9a19183420c05728f31a6761d","impliedFormat":1},{"version":"4e741b9c88e80c9e4cedf07b5a698e8e3a3bd73cf649f664d6dd3f868c05c2f3","affectsGlobalScope":true,"impliedFormat":1},{"version":"a660aa95476042d3fdcc1343cf6bb8fdf24772d31712b1db321c5a4dcc325434","impliedFormat":1},{"version":"36977c14a7f7bfc8c0426ae4343875689949fb699f3f84ecbe5b300ebf9a2c55","impliedFormat":1},{"version":"ff0a83c9a0489a627e264ffcb63f2264b935b20a502afa3a018848139e3d8575","impliedFormat":99},{"version":"161c8e0690c46021506e32fda85956d785b70f309ae97011fd27374c065cac9b","affectsGlobalScope":true,"impliedFormat":1},{"version":"f582b0fcbf1eea9b318ab92fb89ea9ab2ebb84f9b60af89328a91155e1afce72","impliedFormat":1},{"version":"402e5c534fb2b85fa771170595db3ac0dd532112c8fa44fc23f233bc6967488b","impliedFormat":1},{"version":"8885cf05f3e2abf117590bbb951dcf6359e3e5ac462af1c901cfd24c6a6472e2","impliedFormat":1},{"version":"333caa2bfff7f06017f114de738050dd99a765c7eb16571c6d25a38c0d5365dc","impliedFormat":1},{"version":"e61df3640a38d535fd4bc9f4a53aef17c296b58dc4b6394fd576b808dd2fe5e6","impliedFormat":1},{"version":"459920181700cec8cbdf2a5faca127f3f17fd8dd9d9e577ed3f5f3af5d12a2e4","impliedFormat":1},{"version":"4719c209b9c00b579553859407a7e5dcfaa1c472994bd62aa5dd3cc0757eb077","impliedFormat":1},{"version":"7ec359bbc29b69d4063fe7dad0baaf35f1856f914db16b3f4f6e3e1bca4099fa","impliedFormat":1},{"version":"70790a7f0040993ca66ab8a07a059a0f8256e7bb57d968ae945f696cbff4ac7a","impliedFormat":1},{"version":"d1b9a81e99a0050ca7f2d98d7eedc6cda768f0eb9fa90b602e7107433e64c04c","impliedFormat":1},{"version":"a022503e75d6953d0e82c2c564508a5c7f8556fad5d7f971372d2d40479e4034","impliedFormat":1},{"version":"b215c4f0096f108020f666ffcc1f072c81e9f2f95464e894a5d5f34c5ea2a8b1","impliedFormat":1},{"version":"644491cde678bd462bb922c1d0cfab8f17d626b195ccb7f008612dc31f445d2d","impliedFormat":1},{"version":"dfe54dab1fa4961a6bcfba68c4ca955f8b5bbeb5f2ab3c915aa7adaa2eabc03a","impliedFormat":1},{"version":"1251d53755b03cde02466064260bb88fd83c30006a46395b7d9167340bc59b73","impliedFormat":1},{"version":"47865c5e695a382a916b1eedda1b6523145426e48a2eae4647e96b3b5e52024f","impliedFormat":1},{"version":"4cdf27e29feae6c7826cdd5c91751cc35559125e8304f9e7aed8faef97dcf572","impliedFormat":1},{"version":"331b8f71bfae1df25d564f5ea9ee65a0d847c4a94baa45925b6f38c55c7039bf","impliedFormat":1},{"version":"2a771d907aebf9391ac1f50e4ad37952943515eeea0dcc7e78aa08f508294668","impliedFormat":1},{"version":"0146fd6262c3fd3da51cb0254bb6b9a4e42931eb2f56329edd4c199cb9aaf804","impliedFormat":1},{"version":"183f480885db5caa5a8acb833c2be04f98056bdcc5fb29e969ff86e07efe57ab","impliedFormat":99},{"version":"960bd764c62ac43edc24eaa2af958a4b4f1fa5d27df5237e176d0143b36a39c6","affectsGlobalScope":true,"impliedFormat":1},{"version":"4ec16d7a4e366c06a4573d299e15fe6207fc080f41beac5da06f4af33ea9761e","impliedFormat":1},{"version":"59f8dc89b9e724a6a667f52cdf4b90b6816ae6c9842ce176d38fcc973669009e","affectsGlobalScope":true,"impliedFormat":1},{"version":"e4af494f7a14b226bbe732e9c130d8811f8c7025911d7c58dd97121a85519715","impliedFormat":1},{"version":"c1d587d31636bf51527d349f4786a36472e5aa311add673073c833c9853493c8","impliedFormat":99},{"version":"c2c2a861a338244d7dd700d0c52a78916b4bb75b98fc8ca5e7c501899fc03796","impliedFormat":1},{"version":"b6d03c9cfe2cf0ba4c673c209fcd7c46c815b2619fd2aad59fc4229aaef2ed43","impliedFormat":1},{"version":"adb467429462e3891de5bb4a82a4189b92005d61c7f9367c089baf03997c104e","impliedFormat":1},{"version":"670a76db379b27c8ff42f1ba927828a22862e2ab0b0908e38b671f0e912cc5ed","impliedFormat":1},{"version":"13b77ab19ef7aadd86a1e54f2f08ea23a6d74e102909e3c00d31f231ed040f62","impliedFormat":1},{"version":"069bebfee29864e3955378107e243508b163e77ab10de6a5ee03ae06939f0bb9","impliedFormat":1},{"version":"9514ca3c09ba583cc23dbaba5580e637360590ad3cc3c69049fc6abb88d6d6f1","impliedFormat":99},{"version":"04471dc55f802c29791cc75edda8c4dd2a121f71c2401059da61eff83099e8ab","impliedFormat":99},{"version":"5c54a34e3d91727f7ae840bfe4d5d1c9a2f93c54cb7b6063d06ee4a6c3322656","impliedFormat":99},{"version":"db4da53b03596668cf6cc9484834e5de3833b9e7e64620cf08399fe069cd398d","impliedFormat":99},{"version":"ac7c28f153820c10850457994db1462d8c8e462f253b828ad942a979f726f2f9","impliedFormat":99},{"version":"f9b028d3c3891dd817e24d53102132b8f696269309605e6ed4f0db2c113bbd82","impliedFormat":99},{"version":"fb7c8d90e52e2884509166f96f3d591020c7b7977ab473b746954b0c8d100960","impliedFormat":99},{"version":"0bff51d6ed0c9093f6955b9d8258ce152ddb273359d50a897d8baabcb34de2c4","impliedFormat":99},{"version":"ef13c73d6157a32933c612d476c1524dd674cf5b9a88571d7d6a0d147544d529","impliedFormat":99},{"version":"13918e2b81c4288695f9b1f3dcc2468caf0f848d5c1f3dc00071c619d34ff63a","impliedFormat":99},{"version":"120a80aa556732f684db3ed61aeff1d6671e1655bd6cba0aa88b22b88ac9a6b1","affectsGlobalScope":true,"impliedFormat":99},{"version":"45cec9a1ba6549060552eead8959d47226048e0b71c7d0702ae58b7e16a28912","impliedFormat":99},{"version":"6907b09850f86610e7a528348c15484c1e1c09a18a9c1e98861399dfe4b18b46","impliedFormat":99},{"version":"12deea8eaa7a4fc1a2908e67da99831e5c5a6b46ad4f4f948fd4759314ea2b80","impliedFormat":99},{"version":"f0a8b376568a18f9a4976ecb0855187672b16b96c4df1c183a7e52dc1b5d98e8","impliedFormat":99},{"version":"8124828a11be7db984fcdab052fd4ff756b18edcfa8d71118b55388176210923","impliedFormat":99},{"version":"092944a8c05f9b96579161e88c6f211d5304a76bd2c47f8d4c30053269146bc8","impliedFormat":99},{"version":"b34b5f6b506abb206b1ea73c6a332b9ee9c8c98be0f6d17cdbda9430ecc1efab","impliedFormat":99},{"version":"75d4c746c3d16af0df61e7b0afe9606475a23335d9f34fcc525d388c21e9058b","impliedFormat":99},{"version":"fa959bf357232201c32566f45d97e70538c75a093c940af594865d12f31d4912","impliedFormat":99},{"version":"d2c52abd76259fc39a30dfae70a2e5ce77fd23144457a7ff1b64b03de6e3aec7","impliedFormat":99},{"version":"e6233e1c976265e85aa8ad76c3881febe6264cb06ae3136f0257e1eab4a6cc5a","impliedFormat":99},{"version":"f73e2335e568014e279927321770da6fe26facd4ac96cdc22a56687f1ecbb58e","impliedFormat":99},{"version":"317878f156f976d487e21fd1d58ad0461ee0a09185d5b0a43eedf2a56eb7e4ea","impliedFormat":99},{"version":"324ac98294dab54fbd580c7d0e707d94506d7b2c3d5efe981a8495f02cf9ad96","impliedFormat":99},{"version":"9ec72eb493ff209b470467e24264116b6a8616484bca438091433a545dfba17e","impliedFormat":99},{"version":"d6ee22aba183d5fc0c7b8617f77ee82ecadc2c14359cc51271c135e23f6ed51f","impliedFormat":99},{"version":"49747416f08b3ba50500a215e7a55d75268b84e31e896a40313c8053e8dec908","impliedFormat":99},{"version":"81e634f1c5e1ca309e7e3dc69e2732eea932ef07b8b34517d452e5a3e9a36fa3","impliedFormat":99},{"version":"34f39f75f2b5aa9c84a9f8157abbf8322e6831430e402badeaf58dd284f9b9a6","impliedFormat":99},{"version":"427fe2004642504828c1476d0af4270e6ad4db6de78c0b5da3e4c5ca95052a99","impliedFormat":1},{"version":"2eeffcee5c1661ddca53353929558037b8cf305ffb86a803512982f99bcab50d","impliedFormat":99},{"version":"9afb4cb864d297e4092a79ee2871b5d3143ea14153f62ef0bb04ede25f432030","affectsGlobalScope":true,"impliedFormat":99},{"version":"891694d3694abd66f0b8872997b85fd8e52bc51632ce0f8128c96962b443189f","impliedFormat":99},{"version":"69bf2422313487956e4dacf049f30cb91b34968912058d244cb19e4baa24da97","impliedFormat":99},{"version":"971a2c327ff166c770c5fb35699575ba2d13bba1f6d2757309c9be4b30036c8e","impliedFormat":99},{"version":"4f45e8effab83434a78d17123b01124259fbd1e335732135c213955d85222234","impliedFormat":99},{"version":"7bd51996fb7717941cbe094b05adc0d80b9503b350a77b789bbb0fc786f28053","impliedFormat":99},{"version":"b62006bbc815fe8190c7aee262aad6bff993e3f9ade70d7057dfceab6de79d2f","impliedFormat":99},{"version":"13497c0d73306e27f70634c424cd2f3b472187164f36140b504b3756b0ff476d","impliedFormat":99},{"version":"a23a08b626aa4d4a1924957bd8c4d38a7ffc032e21407bbd2c97413e1d8c3dbd","impliedFormat":99},{"version":"c320fe76361c53cad266b46986aac4e68d644acda1629f64be29c95534463d28","impliedFormat":99},{"version":"7bbff6783e96c691a41a7cf12dd5486b8166a01b0c57d071dbcfca55c9525ec4","impliedFormat":99},{"version":"12d4cfb0cb2b4bc0ee04f3df8b506258e3b34f253a5dd7313342143a6b663b9d","signature":"4b96dd19fd2949d28ce80e913412b0026dc421e5bf6c31d87c7b5eb11b5753b4"},{"version":"adb79899e5b0ef5aa594e483a2e1d16652971b94df43a52a47a58e1da6ec613b","signature":"a305ea07b4cece96b37a2a79f6d32f7e992771aa8ee969d9def3ffb3c236b3bd"},{"version":"c57fb24f1ca30a13a78e4a8ed9f15cc93e5990605dcda761d50ffff7a0077355","signature":"013d002fa4525f92c5f081d3ee1ffea15ec8fa22c85cc5f58d579461e5486e3c"},{"version":"0df4d77422d454236db2d4284e3fda10ef7542f8d912c6550ff160ffc6b8bd02","signature":"eb39a7a6897f26dd2df7b12e1009e9d47ee1b5946937e09dd6b15bbc19bedb88"},{"version":"710b9966b879d001d814a6d5586b900dffa4a5ee766761d95f8f0c093bc24d54","signature":"7f59b5b79c23648404ddda9844fd718f37ce3e9afec7f6f9b42a866545a373d4"},{"version":"ae68ddb3ce9fe1b0ab70fd75507648c15122c71fc2c934b85c622786b70b2d76","signature":"e32671d6827b9e96efd18971a80deb2e71923d8f4adbe9ab099c890f30fb76b1"},{"version":"bf7a2d0f6d9e72d59044079d61000c38da50328ccdff28c47528a1a139c610ec","impliedFormat":99},{"version":"e58c0b5226aff07b63be6ac6e1bec9d55bc3d2bda3b11b9b68cccea8c24ae839","affectsGlobalScope":true,"impliedFormat":99},{"version":"5a88655bf852c8cc007d6bc874ab61d1d63fba97063020458177173c454e9b4a","impliedFormat":99},{"version":"7e4dfae2da12ec71ffd9f55f4641a6e05610ce0d6784838659490e259e4eb13c","impliedFormat":99},{"version":"c30a41267fc04c6518b17e55dcb2b810f267af4314b0b6d7df1c33a76ce1b330","impliedFormat":1},{"version":"72422d0bac4076912385d0c10911b82e4694fc106e2d70added091f88f0824ba","impliedFormat":1},{"version":"da251b82c25bee1d93f9fd80c5a61d945da4f708ca21285541d7aff83ecb8200","impliedFormat":1},{"version":"64db14db2bf37ac089766fdb3c7e1160fabc10e9929bc2deeede7237e4419fc8","impliedFormat":1},{"version":"98b94085c9f78eba36d3d2314affe973e8994f99864b8708122750788825c771","impliedFormat":1},{"version":"13573a613314e40482386fe9c7934f9d86f3e06f19b840466c75391fb833b99b","impliedFormat":99},{"version":"ae77d81a5541a8abb938a0efedf9ac4bea36fb3a24cc28cfa11c598863aba571","impliedFormat":1},{"version":"f329dfad7970297cbf07ddc8fce2ad4a24e2a3855917c661922ef86eb24dd1f1","impliedFormat":1},{"version":"480f05e466e86ee6c80af99695d90079f9e2956a4986e930ebd3d578688ff05c","impliedFormat":1},{"version":"fad635d25316340230cfbe1f879f00fcee7eb405afc038bd5986c0cecc72ad01","impliedFormat":99},{"version":"2541d503eedc53e66126a427975ce9676d56260bd70b15f6d58635fc444afddc","impliedFormat":99},{"version":"04dc33f1dbf2f463c6480d431da59a772140be86c438f9445a0f2181b2893bfc","impliedFormat":99},{"version":"ecd444940f4a7726b83d004060652c1ea7dba9e79384f9e14c7c893dd35ee5a6","impliedFormat":99},{"version":"e415a5f905d75b3f182c691edfce1d9f1edb386f77af750c6891e1d4ca8b288c","impliedFormat":99},{"version":"fcbe9793459370632b0f82e12725dd31e3bf6ae7e82e4316c62e25eb173b5e9d","impliedFormat":99},{"version":"aa969e7dad9951038af0d9f6e1bb8c0c4b973e05fff06bd5b23d6b7be498dd43","impliedFormat":99},{"version":"76985078db2a2afb696cfd76e3f450cc2d1a03ad91332304a575c4afe355ff3c","impliedFormat":99},{"version":"683538ba1d7acfc6f72ea369e323ade04e484f2fccb0a224baab7e5703a3c3fc","impliedFormat":99},{"version":"6f3551de528b50b53bb34fb50654417d2632ecefa842eef0a0ce3912f9cae78b","impliedFormat":99},{"version":"bead1f5a73e14e9425a757dce08aa2551c029cd679a1b20f4ac94cfb2d26af60","impliedFormat":99},{"version":"c13be7c697ba7c5497070a9899e3eb5b6a1bd8e873d54ef4c0cd3292a0c9d80b","impliedFormat":99},{"version":"f45b6b08aaa4c86dd4b909a6ef6120d0d25f006031ce3677dea240040d79cd7e","impliedFormat":99},{"version":"2da759c66256885ffe262664a03c99c84f66c12160124bc9c54bbe4626a98b34","impliedFormat":99},{"version":"b539fdc12a246bce588611a2d2f471128f99cbe4feb982b84e292a7c185c19b1","impliedFormat":99},{"version":"dca91fcde2a3db4b14224c3b725c0248cf07ed631c827a20dddeb6cb1b6f1305","impliedFormat":99},{"version":"fa7fc235fa0c8bae69d2dcbca8cd9618844c092ce3b51b46cffd6c43f795672d","impliedFormat":99},{"version":"d80a35ec56d6a8cee40e1bf7496551a57d41e194a0bc602a7433b52aad88e2a7","impliedFormat":99},{"version":"575430260af36058251660050741d9d5ddf2e267ff10a2595099ff8199f4cfbb","impliedFormat":99},{"version":"3182fcb5d452d8c1384bbb1b11592fb1d0e7f17b10d275a9dc621bd83f2d58b5","impliedFormat":99},{"version":"1eb0099770c7e12c6bde5416e9c0b9b816e7dcc7379977d8de13ba41766446c5","impliedFormat":99},{"version":"7fcf64c42e0bf1cebc851540ab03cf87600b4b5c7741b853c953aa0a88b9bbb5","impliedFormat":99},{"version":"b25e6c44ae3ec126eb11223357c4cb372ea57a6b719cd2b1f7efcdf5050fc5b5","impliedFormat":99},{"version":"1230096a6cd704cda5552621d79da577be08e32c8f8e28c448a03585f62c0248","impliedFormat":99},{"version":"54cf9cd842aef687620cb9993b5cb0e3ea8d96aed6d578206b5ba64f48550232","impliedFormat":99},{"version":"4af74a8e255575812dfeb09390e0cebc8a6aefaec59a7985478106f8e4a3fb1d","impliedFormat":99},{"version":"13353b1c0ffdae258eeeff35bd5a171833b4580845bff19bb9f4d7bf3d9aab72","impliedFormat":99},{"version":"636f4ed8444decfec99eb4c28dd311fce48e5f1a5d2039aec779cd74f55851c5","impliedFormat":99},{"version":"ac224c8d6f0fb529961be77e07cc57b3de3a0e2d9e07431c984bbf85f864535c","impliedFormat":99},{"version":"f8e70199820c5cd61a35330ded2c5d08a4f557f27917590108283269ba9dabae","impliedFormat":99},{"version":"bdb051ceb53455fce5c84506ae247d489be06fa2a7bc3cebba9f570970b065b4","impliedFormat":99},{"version":"4163e075fce2172b06114df8c5f612164fe8338fcd0d554fd4194f9160f4925e","impliedFormat":99},{"version":"956c883591f1211fd6892ad2c7d144940217691563652d9c3d6090c38c53ee69","impliedFormat":99},{"version":"9afabe247476cc002fd389492897aede8d929c884b9b320f17761f15966f6289","impliedFormat":99},{"version":"66c52fc68c2de656bf4314093f9544a9a707e353a260d1b0ca1e459829c63d60","impliedFormat":99},{"version":"c9ca5bce1637322c8fe4e3759a32102d6bfe37e437e784d193019984516236f8","impliedFormat":99},{"version":"a47aa9d0c43619319e6ff68b01cefad692159e7fb14da5fd71c7ddedc64c98a6","impliedFormat":99},{"version":"577db44339c49eb652093d5adbd7393db583e9eb906c491ee74bff55f67bf54d","impliedFormat":99},{"version":"3db294c132bd83df923a78cc7125bab8bc4253280296dcccc7e823c964e73696","impliedFormat":99},{"version":"a9e4abd81eb95309e1b707e2f14ed86feec574239d7505ab0a154049ec3de685","impliedFormat":99},{"version":"99a8cbce56aa152d94b38363b5c9acdfc7858a933490bafc985c9a907498a4d7","impliedFormat":99},{"version":"0c02bd9395d3868e460750f7f6b33cb8062cfbfed35b1af38bdb3c6867ed18de","impliedFormat":99},{"version":"5096c40abf93338a35833bc22751878c397b7f5ae51845d7c1ed569020e5a37a","impliedFormat":99},{"version":"915bd2338b4f424769da91d7dd3a2d211a397aba958548dcefdeb930d17ef37a","impliedFormat":99},{"version":"1b2d4dca2a0d58faaecb02a1b8564731ad5e96607bc55a59764332f8a4265fc2","impliedFormat":99},{"version":"14ea4d90b555061996e99c1e9dc3d98954ae86c96d7d0007a412375ae36eb8d3","impliedFormat":99},{"version":"f75be57983752af002d904d6e8bf8df84f718153c45edba8899603e7f1316bdd","impliedFormat":99},{"version":"61c79154642f423dcbdccf8c3673bfb3720c3c8133ec8488ed75c7aea5fdc806","impliedFormat":99},{"version":"72fa28b198e60cb3f6fc7e85847a808b1aaa93d6362419bb350363b77056c061","impliedFormat":99},{"version":"2dcd17e5dea10ba55d976e3c304d185aabaa4a7589efaeebba61679b18b7108b","impliedFormat":99},{"version":"cc951386f6fe35bf7ba5768e1a40cc9038fffbcaed85f0171d108d959bc8b3fa","impliedFormat":99},{"version":"9c06b36de8e61d1fc7e2438393a84f0f29535d5b04ffa5cff8dcc397f2980d58","impliedFormat":99},{"version":"f9c434fb4157a0aa57b651ac5d18d47a8e1585779a805507d6015422e36cf95e","impliedFormat":99},{"version":"e55207c948364304d77f089851d812bc46ac0179bc9c30642a5d8ff504116267","impliedFormat":99},{"version":"f4989ad6c87ea151dcdf62d4555e9266f3787c23dc984ef3b4fa615462dbc2a0","impliedFormat":99},{"version":"a3e55e768780c3422867fd252c593444166c1b4aab83f711d4cafe018c151bcc","impliedFormat":99},{"version":"2f0fad277179e920e6e1e3a1f404663ef44e7d6daad888c7e7c1d5e4ac35660f","impliedFormat":99},{"version":"8dee13aa32d22ed4803116c8ec86779d47755c077cd91df1f5f8c92f004a974e","impliedFormat":99},{"version":"a1c72caebf691bb64f68a12382bc0421edb9e88b794c4246e87c78be9e0346d8","impliedFormat":99},{"version":"d3ad0bc42dcc11b07c57f2252f153a61c35c356964700e4dc8de47dcc93e4f7e","impliedFormat":99},{"version":"b2e849ed44a3d8f15a296dd401274591d46f688d78af226a36723ef61f6a50bc","impliedFormat":99},{"version":"5243ee3371c55c6faa399f2bad1dc2c921022b1b13d259521993c821da5f4524","impliedFormat":99},{"version":"37df01381ecd3595e4c63c67d8bb959bb9794282e88b6e3f768b6f8fb4cb7093","impliedFormat":99},{"version":"e16cb0ada3e7f7d5c2f921bcf500cf2a8301d0f5fb188055b7983b05f4e2f38c","impliedFormat":99},{"version":"a87de89d64ce710d92670da5636f6cd8932981774520f0f6c16e2f730badc241","impliedFormat":99},{"version":"fe69a3dbed1df1139aa81886334ec44f249160a557b823e69276ca8509abe0a1","impliedFormat":99},{"version":"e6245fc381ef24001584f922d5c578e90ad1c128267ee384cdc4b6b9f68a9c50","impliedFormat":99},{"version":"06955e8ec56f5a1928e6d528bf153f00992405088ca6e5ff1b102db66c92cb63","impliedFormat":99},{"version":"2f81cfb3c124dc21ed6ea92cd8f83a7df7ab8aa40124a1a5eded2836183f77cb","impliedFormat":99},{"version":"ec10113cc447f2f2c22b2d5280fe9dc1f0ab782951090e821c6dacc964bbf411","impliedFormat":99},{"version":"9821bd794030358a4ca9b693d3b2604baaa9a439fd8bd31b03c6bdc35e5c4d52","impliedFormat":99},{"version":"98b246418724cedc735c91e3d51676b010c40907d33c954fa4c2ce032f1940bf","impliedFormat":99},{"version":"9ad6f0239d00b9e9c4d996f2986223dd3fe93abd64b4200cc51759eccbc5dc43","impliedFormat":99},{"version":"d29a205d6e07925685f7b3c097a0840637690c73a3c5cbd43af1080799262027","impliedFormat":99},{"version":"6c2638bffe332692fdce3e285f893a63d8a37ee1b67e08c12d0c2d8b7b41e21a","impliedFormat":99},{"version":"52d743f53dc6dd6318b5b80b30e0ab8a23f3a7dde9d845dc84f43b55ba85e996","impliedFormat":99},{"version":"dfec0c669964b3df6b37e7a16af981aede5df2df3c07f1d04aa91436f88192b7","impliedFormat":99},{"version":"7c23e1fb4ddaa292fbbe141c74446d1d84c8ad27eb3fe9e8183b63ca2a313319","impliedFormat":99},{"version":"819cc8d4816ac04ab30a8af172be6bb04ff8337167d3de191a183b0489b7b374","impliedFormat":99},{"version":"6e6ae535c8a7328e6d5216c118391b64f50e438124c8d17f671740ef13293231","impliedFormat":99},{"version":"e4e2459598e499579a64881664c0413c8caac0134b6044696246345dbc3fd287","impliedFormat":99},{"version":"4a88bd904cef785320a507d51e358e082624bbd2bdae93f47be7f8ddd2c1b60d","impliedFormat":99},{"version":"63eeb2aaf04255f32ed3fb52b1ae7f28247f6c35c86936d80ae313591fd48e34","impliedFormat":99},{"version":"9681b978f529c62ea3b7feb6e6c16979f97de629a9de0c9bccd697d642937b05","impliedFormat":99},{"version":"4b8b7b1100b1f9a92ce02a3efdf9c4b588ba71bdd3d426217cf13722a60f5295","impliedFormat":99},{"version":"e6af1e7c1b560b80c9291bc861168d1656a6ef8d3fffd3a83f07b61c82e9d0cf","impliedFormat":99},{"version":"8c3bf95a14a085c8c234ef872e8f7003b1f8fa53ac44dbfc1e8365f5fefcffd3","impliedFormat":99},{"version":"b843df433799abe84fa03313e2f95d68c5bea494d5c1fc74535920bd32f6e3fb","impliedFormat":99},{"version":"dc5d4622b065d34f14d06437c89583a33b96e156c8a902b333572064038023c7","impliedFormat":99},{"version":"f04376c68bb34e4223ecca96e5b3ed0a144318b9cf6f0d9682fe04527bfc4f53","impliedFormat":99},{"version":"141a55219ac69f98aabb7c7c808340d31859262ec27d669882579e0e0b1b50a0","impliedFormat":99},{"version":"7078e6f856e70acf8a4283fcd3d491576ade4a62d5b79eec872928ad56ddd0af","impliedFormat":99},{"version":"540d03004d2369e8ae1891eb98017c9056dd294be5fabc94e8dfd90a750aed72","impliedFormat":99},{"version":"34a1307870b94bd744d6a651f8ec27f3e3654ed1a3203901660111227b761fe3","impliedFormat":99},{"version":"dcc8f81552eeaef09b6b9be4ebc1c4674a7217317f5ed19558cc8979aedf84f7","impliedFormat":99},{"version":"2969c703518c1721e27d429c3cc85220d0b16231d224aa33073ca75e76ede280","impliedFormat":99},{"version":"eda7fef38fea54dafecee496bfc5efbe74d22e50d6884925eac7b83910de0176","impliedFormat":99},{"version":"2341cbc1c1f2bd3f46ce96ce17c3f8e3defd88d5ec93e24bd3bd66bc0c680ca6","impliedFormat":99},{"version":"1558bcadf70f6b363eaeb655cc2cae7360397804de1d9bd585d2feda385192f6","impliedFormat":99},{"version":"04675afa3698dbfeff6f653a392799bcee1380b360035ecc088e29272445d57f","impliedFormat":99},{"version":"308dce9ae4370611602972d7ada2ea7d4bef894d20ce2b69849f4856c9972269","impliedFormat":99},{"version":"11669d8c5e86ff67b984f8bee64d1faab863ec1c8ff89c262c27e75c063ebdff","impliedFormat":99},{"version":"cfff369fdf1d2afd4c6642a6ebf7c8d727393d532146f42be42283bdbbc5377b","impliedFormat":99},{"version":"148009b5ec85085cfbc305677dbfe866dcfd0404651f94f2f8dcdea1cd4ea6c1","impliedFormat":99},{"version":"e5e1fa725e64a002512285417a3d26792a777d5cdc9f7fa1c2b5675c9e7536fe","impliedFormat":99},{"version":"97a9d092dbe2871b5d3cfeb0617d574b5da5babd3f29d09b8ba69c55a90ec258","impliedFormat":99},{"version":"4e4541ebeb4ebbca40df0f0bd8e4ef0d6db0d6425616393109285e5c147eb02b","impliedFormat":99},{"version":"41cd67a41b6007ca1882f25e8b96adb4680645ca0de673b6a6ff6a5c44a2dc07","impliedFormat":99},{"version":"c7162e1093589e93715dfa031d97727c541b93bc9056a30a89419ed1371732a8","impliedFormat":99},{"version":"0077a54522584a9cee73d8184e0aee2d5723ee552a555f137ed2daaece869bb2","impliedFormat":99},{"version":"f48b048b153bd31930b2f70cac08c4463a0ada321551fba69711e7de3a990196","impliedFormat":99},{"version":"f4e9a9f1ec5d81b115add7440f238083349be7db4dadbfe84dd8a1c8aae7a196","impliedFormat":99},{"version":"021e8ecc4631ee51473cbd41a7a68253243889c5fbc490a0e7b674396e2a7f87","impliedFormat":99},{"version":"8a9402f86c59f3574a743d0f2068984cd80997a0ed43882a9724a4cff33c59a1","impliedFormat":99},{"version":"d2bb22cbc986fdd935a3ea080a0b976c88e06d24330dd5d5b9cf9252cde09baf","impliedFormat":99},{"version":"98aef5c1cf67ba83fd511cf763045a0906f4192b9a963ca31d66fe99a085d255","impliedFormat":99},{"version":"ee1c322747b80d3b71cba301c626be12468b26ed00a272945d1be24cae8d7514","impliedFormat":99},{"version":"d13df34622a3c890cd473093b0d939de87cf31ccb0805d56855f86d338c867fe","impliedFormat":99},{"version":"d4c1041683629f6239e6984e36689c93ca47a10875627eac4ce458359ff05403","impliedFormat":99},{"version":"c8a8b70029abc4ee30637b5c9a3d80ea0762f9ee99f5ed6c537fc08ca710be81","impliedFormat":99},{"version":"d079c9f2b773fa302eddf3299ba175eb4b6236b4571d53de803334164d9b322d","impliedFormat":99},{"version":"fc70a8fcb9f99896d3be4aef03d31d978518c234750853719a956016362e6e15","impliedFormat":99},{"version":"7b839a06f4fe489e14e4420fa43e29901b726de6c8e827708805846f7ae8cafc","impliedFormat":99},{"version":"972ed35b9bc63164402f3988804fcbbad08d8b563c1d3dc519c0e8cbba91abda","impliedFormat":99},{"version":"a23b404fbd4eeb4dbe9a16c3cb6c77cdb6969d433c0b723b0f5aa4de5f7b7953","impliedFormat":99},{"version":"15b3bb5afa5fbdc3bab2eb32c680acad262896e334edca4bf2f3249823969d6a","impliedFormat":99},{"version":"a45bce2e799baf2fdfc9642fc05803f66ac8131a168942485dd25620fc9f7651","impliedFormat":99},{"version":"60ebb0b3da635426a5381d6898cb60203955c1d949b8bad780deea4d74ca33d9","impliedFormat":99},{"version":"81436ea435859136dd7fb59891f54a0ed776958a6a62eed2dbcd478e1a29fb41","impliedFormat":99},{"version":"a620d02ba9bdb7a894cc1bdb911f0123ce0647264fc2de6913d1cae0421128df","impliedFormat":99},{"version":"e6749b3c1e0a0f0541269a9058386ccdce75fa33daad48134cc710ab68a25833","impliedFormat":99},{"version":"e2bc4ead8e63387393a8f7c7b618cd8d2b5595f27e3b3997b664c63841f6df84","impliedFormat":99},{"version":"2cebe66fe593e490899f8814eafcc7370d0f7d34cfe23afa3805953c91d5be7c","impliedFormat":99},{"version":"78f7166e49230242132f49fe71ad3e31fa8c2f95f53e4960d35e5cb797c7d820","impliedFormat":99},{"version":"93f5ab10abfa1761b9f90954f50256ca01ee9e657e6a5f9995a2714ae11c516a","impliedFormat":99},{"version":"846a2ad35720423a39a5c1ae8e474007c1fc72b70909c68e36918205269db9c7","impliedFormat":99},{"version":"772d6476e8bc54c2020f2b55266af47292696dde8655307195d460fde6cfac84","impliedFormat":99},{"version":"144e4e4d4ba1af5abcc9223a49d30cb83d6be777acdff86dd8af7e60d0278a74","impliedFormat":99},{"version":"34767bf6796c20eff1bce8ccb895d7598e9c01f560147a8ab211fa51f5a8ed68","impliedFormat":99},{"version":"5a2294bf5e00b47d98da988551bd638b8d29022fc6f382423f36b92157ca03c9","impliedFormat":99},{"version":"d55eb7b0b892550e84ad1b2c5b23c6c56843012676f993e5e819a36156f5f89f","impliedFormat":99},{"version":"204e3c1199a8ff00e780760e2294ea52b8fc3ea51be2e20a07d540925334c6d8","impliedFormat":99},{"version":"7d16779ef8d91d807b47b295d0cd62a286a8248f3c8ae283a015341c011aceaa","impliedFormat":99},{"version":"d1344da8b59b8190baca55ee1631f2cdcf9107646e98847588a3210bb4ae0ed7","impliedFormat":99},{"version":"d1ff278bedcd43322c961d38d8619d58070b55e0347d49ad6757849af4332dbc","impliedFormat":99},{"version":"40a38756055ab3ab7f359dd22c55c11b4651b75b273c6ed76d1a6620fd4fcf47","impliedFormat":99},{"version":"6124185e0daf9151bb72f01273bc892e6e2c853c5e8acd7fef17c286838a902b","impliedFormat":99},{"version":"5f17ae4cbfc34d8a68e5e6199884eb9dc9dfc931d526ead14a02ab49177efabd","impliedFormat":99},{"version":"0896a5e1c7bb06ee49e7205c66c6b1c0c4f0b3d1ed157826302350d14d3183e0","impliedFormat":99},{"version":"6261575784cedab32fff2e1fc15cc4c6dfba815562b9010dd1eac1c6fac57579","impliedFormat":99},{"version":"6af20a73779a78649a41382199d5e22e7b0d62383134491a4667fa0da5927152","impliedFormat":99},{"version":"456f26b8cec72e3ac2a8451a4d625cf56db0fed963fbfee75bfd4c0492cd51a4","impliedFormat":99},{"version":"6e0fecd3f3e7ac0ec8d06971ddd01dfe7aa95da8aa65c56db375a28c15134fd9","impliedFormat":99},{"version":"3f65ad2a5d60095fae96c2d46e2fc61c66d1fb65afdc50c04452aa68422aa933","impliedFormat":99},{"version":"2cb16ba31547631b5604acbf7e4c826fb4c776579a9faea542a8432735917361","impliedFormat":99},{"version":"1ba1caf4981cb5344a7d34d69a9a6c7a0b6fac89cf36e93a6a88b0c53aad951d","impliedFormat":99},{"version":"4682eefaf56f525acfbb3780761496edf9e6671c134ebacc755ee8a046515a98","impliedFormat":99},{"version":"0c32d0c4a2605c3cfee63b60ade3722d6211d0bd7151d5dcb7d19aa185f92e20","impliedFormat":99},{"version":"5a79fc998e1c6841498cd9769ad4b8d212af1fa3ce1be575e244614048fa56f4","impliedFormat":99},{"version":"f3c0df6dda358699bf50c38f9177a56c5c0e331f65d30db40e8e4ccbb459a426","impliedFormat":99},{"version":"b05a83f9b61183714d06fb3c3e9919033887a169e4db50d6b1a0e27070683dbc","impliedFormat":99},{"version":"5f8bf6c28e04fef2aba1f4d1cefee0fdb4847689c3a91ee63b4f6b20e259c61e","impliedFormat":99},{"version":"476ebbc97baa56646c797a799528f55024368b033ba62bada2eaac7fdf371c3b","impliedFormat":99},{"version":"193105d191f5d05a79a6ba5941f5205948d923e16cec8c302d9bd56591cd4a9b","impliedFormat":99},{"version":"d313dd230790183dce7536f12890b7b30b952b2b7d6eb7b72d4d4bab30459506","impliedFormat":99},{"version":"585b17054b21efb28e6094ce71a27ef9ca22f535742acaf9836a42e791b9d41f","impliedFormat":99},{"version":"899339f85726c08258218a84eaaed6b069f9fe94da132752ae7e5a632af52813","impliedFormat":99},{"version":"85969e67e0a23df10f683cc9eb718ca9628f7b0753571d8b57df117b02571c43","impliedFormat":99},{"version":"988ab8e0d56e89cf0e5e3159cc11b226c3819de93f71b8cc8b8b9850b29b2502","impliedFormat":99},{"version":"b4743a82f5ebe3bb27d63dd05ed9f01e73178a7afa5d28fb8a4ceb518edbf2e0","impliedFormat":99},{"version":"a864c02bf9bb161c011230595b34768b95048e0f966d1615a5c39213607d1ca1","impliedFormat":99},{"version":"38f79623aae9437e57f8898b61640ab0f065772b42f7bc43ca2f8ea56ba86ef3","impliedFormat":99},{"version":"1e4ff5bc584ff3f5376e2259cc8d351baf1884b1985b89b5c0778adba0428887","impliedFormat":99},{"version":"1831393806fb461d650f204911f314d585952e87963920adb9ab83a17704e42d","impliedFormat":99},{"version":"ae8b2ed036aa78e3c0af12d3052904c7ee595560cfacc16ef174d509077f41d2","impliedFormat":99},{"version":"1921c8a190ed73209c1ace5483cd110cb279cdc35b795f7b4b2be5cb1dc8a319","impliedFormat":99},{"version":"fe34a3ab7d890cae11f2b345ca080ac82f02eb45603967682f358c564f1d4424","impliedFormat":99},{"version":"618f6960275a061b20965603373dadc369de65cab5ed3b9283a8d96360520654","impliedFormat":99},{"version":"947e4a380943362c6df9272f85fb4b9ca1e95f13682dce29487da6c86798d16e","impliedFormat":99},{"version":"e22eef485f44913fad187abd8f86e5ac038a22c9c3809c4dabadbb63f3c4bb8e","impliedFormat":99},{"version":"d07721e52493fc8a347ce48c1d2cb503192402a5e6b6ca58369eacec64b99dd6","impliedFormat":99},{"version":"a981ad35e7f6bfe68e26317ada681bc51d09f3abe24603f61f5ff4dd9bcd1d39","impliedFormat":99},{"version":"bf9f9eaca5fcf5553d05aef77feebcc0249ae7becbc5d03dc865a8a3bd80e1b7","impliedFormat":99},{"version":"b1547158e990c15fff0e1c7a58bce35aad7c5a2f4d1bc806159153f1e2364ab9","impliedFormat":99},{"version":"2a6d709681fbf73106c1daa64360eb0f7563a7f6d7527666d25b22ac5ec3d89b","impliedFormat":99},{"version":"a5f9bc96e9c35a8c4afbbd326f46f4ce42def2d053ca65d32b261bfd3462d112","impliedFormat":99},{"version":"3898a03a3022575c893558c324fe7926718d1dfb803ac5df72b7c7f31441d06c","impliedFormat":99},{"version":"a9b4659d54cb5b54c1101fcb92ebbe8684b2867305ec4e5ffbb13c324898bbd7","impliedFormat":99},{"version":"668192f288841913bf9afe0d34afde995d7c8bc63fb4d5e2b584db305cea0aa9","impliedFormat":99},{"version":"68c13200f8a1b994c2911340cee34fe972c121e06ae9e7111b220a387771ad85","impliedFormat":99},{"version":"a27eb3acf3ae490f153d1f426b2a7ea41a21810b670e91dc545e9dbc07c7245e","impliedFormat":99},{"version":"5059763982439cdb46b7207b35d7ce5d609bf099cf883e84f030e59db62188af","impliedFormat":99},{"version":"f62d186e99d5df777f4370eff808bcdbd464420fe49c48ffc99eb540b957534c","impliedFormat":1},{"version":"3b9c88853864c2b7518cdde70631901f844275d7cd786df431ef17b222a8ce9f","impliedFormat":1},{"version":"6576af141b9ffaf89a0b15c0145631c24f2bfc8c96d1324cbb54784a4330424a","impliedFormat":1},{"version":"be7428e232681ca6a8a90161837e1857d1ad5b2b95db414965d728ddfe907a76","impliedFormat":1},{"version":"caaf7b6278bd335355b345da2cb0d435fdf1b7ec3176fca782695315f3762299","impliedFormat":1},{"version":"ae8ce9bb401298d004af8ef409473e463fc9d73592536de062a7c6935e5a8f52","impliedFormat":99},{"version":"78647004e18e4c16b8a2e8345fca9267573d1c5a29e11ddfee71858fd077ef6e","impliedFormat":1},{"version":"0804044cd0488cb7212ddbc1d0f8e1a5bd32970335dbfc613052304a1b0318f9","impliedFormat":1},{"version":"b725acb041d2a18fde8f46c48a1408418489c4aa222f559b1ef47bf267cb4be0","impliedFormat":1},{"version":"85084ae98c1d319e38ef99b1216d3372a9afd7a368022c01c3351b339d52cb58","impliedFormat":1},{"version":"898ec2410fae172e0a9416448b0838bed286322a5c0c8959e8e39400cd4c5697","impliedFormat":1},{"version":"692345a43bac37c507fa7065c554258435ab821bbe4fb44b513a70063e932b45","impliedFormat":1},{"version":"7283aaea55499e5a9760db0ef199e3c12a35ff5391733fe1495b2d3add0c58ab","impliedFormat":1},{"version":"c1c8ccb14c76efb31ff84038ec7833a5715ba23e681b158b3c83cc012b8c3cfa","impliedFormat":1},{"version":"abb0a41fa0432cdec9595dbe84bd3efc5b59f04aa85dcd5cec7b453908fc85c3","impliedFormat":1},{"version":"522edc786ed48304671b935cf7d3ed63acc6636ab9888c6e130b97a6aea92b46","impliedFormat":1},{"version":"a9607a8f1ce7582dbeebc0816897925bf9b307cc05235e582b272a48364f8aa0","impliedFormat":1},{"version":"de21641eb8edcbc08dd0db4ee70eea907cd07fe72267340b5571c92647f10a77","impliedFormat":1},{"version":"48af3609dc95fa62c22c8ec047530daf1776504524d284d2c3f9c163725bdbd4","impliedFormat":1},{"version":"6758f7b72fa4d38f4f4b865516d3d031795c947a45cc24f2cfba43c91446d678","impliedFormat":1},{"version":"1fefab6dc739d33b7cb3fd08cd9d35dd279fcd7746965e200500b1a44d32db9e","impliedFormat":1},{"version":"cb719e699d1643112cc137652ed66341602a7d3cc5ec7062f10987ffe81744f6","impliedFormat":1},{"version":"bdf7abbd7df4f29b3e0728684c790e80590b69d92ed8d3bf8e66d4bd713941fe","impliedFormat":1},{"version":"8decb32fc5d44b403b46c3bb4741188df4fbc3c66d6c65669000c5c9cd506523","impliedFormat":1},{"version":"4beaf337ee755b8c6115ff8a17e22ceab986b588722a52c776b8834af64e0f38","impliedFormat":1},{"version":"c26dd198f2793bbdcc55103823a2767d6223a7fdb92486c18b86deaf63208354","impliedFormat":1},{"version":"93551b302a808f226f0846ad8012354f2d53d6dedc33b540d6ca69836781a574","impliedFormat":1},{"version":"040cb635dff5fc934413fa211d3a982122bf0e46acae9f7a369c61811f277047","impliedFormat":1},{"version":"778b684ebc6b006fcffeab77d25b34bf6e400100e0ec0c76056e165c6399ab05","impliedFormat":1},{"version":"285d50a08440314f7aea3246a5e15acbc38e2867ff07d21ef457ae8cb4e8a31f","impliedFormat":1},{"version":"672701f824ff6b9dab50514c6c4db711fb7ec5e7c2f0f6bc27b2dbe2e445a52a","impliedFormat":1},{"version":"be8f369f8d7e887eab87a3e4e41f1afcf61bf06056801383152aa83bda1f6a72","impliedFormat":1},{"version":"352bfb5f3a9d8a9c2464ad2dc0b2dc56a8212650a541fb550739c286dd341de1","impliedFormat":1},{"version":"ebef680e3597d7b3c8a9fc9e5581eb078461fa1406ded8d9859353dd6286eff2","impliedFormat":1},{"version":"dc923d45c03261241cefb03ea952883784e28fbc1d089af1a5a553a7b0f5e2b5","impliedFormat":1},{"version":"764150c107451d2fd5b6de305cff0a9dcecf799e08e6f14b5a6748724db46d8a","impliedFormat":1},{"version":"b04cf223c338c09285010f5308b980ee6d8bfa203824ed2537516f15e92e8c43","impliedFormat":1},{"version":"4b387f208d1e468193a45a51005b1ed5b666010fc22a15dc1baf4234078b636e","impliedFormat":1},{"version":"70441eda704feffd132be0c1541f2c7f6bbaafce25cb9b54b181e26af3068e79","impliedFormat":1},{"version":"d1addb12403afea87a1603121396261a45190886c486c88e1a5d456be17c2049","impliedFormat":1},{"version":"1e50bda67542964dbb2cfb21809f9976be97b2f79a4b6f8124463d42c95a704c","impliedFormat":1},{"version":"ea4b5d319625203a5a96897b057fddf6017d0f9a902c16060466fe69cc007243","impliedFormat":1},{"version":"a186fde3b1dde9642dda936e23a21cb73428340eb817e62f4442bb0fca6fa351","impliedFormat":1},{"version":"985ac70f005fb77a2bc0ed4f2c80d55919ded6a9b03d00d94aab75205b0778ec","impliedFormat":1},{"version":"ab01d8fcb89fae8eda22075153053fefac69f7d9571a389632099e7a53f1922d","impliedFormat":1},{"version":"bac0ec1f4c61abc7c54ccebb0f739acb0cdbc22b1b19c91854dc142019492961","impliedFormat":1},{"version":"566b0806f9016fa067b7fecf3951fcc295c30127e5141223393bde16ad04aa4a","impliedFormat":1},{"version":"8e801abfeda45b1b93e599750a0a8d25074d30d4cc01e3563e56c0ff70edeb68","impliedFormat":1},{"version":"902997f91b09620835afd88e292eb217fbd55d01706b82b9a014ff408f357559","impliedFormat":1},{"version":"a3727a926e697919fb59407938bd8573964b3bf543413b685996a47df5645863","impliedFormat":1},{"version":"83f36c0792d352f641a213ee547d21ea02084a148355aa26b6ef82c4f61c1280","impliedFormat":1},{"version":"dce7d69c17a438554c11bbf930dec2bee5b62184c0494d74da336daee088ab69","impliedFormat":1},{"version":"1e8f2cda9735002728017933c54ccea7ebee94b9c68a59a4aac1c9a58aa7da7d","impliedFormat":1},{"version":"e327a2b222cf9e5c93d7c1ed6468ece2e7b9d738e5da04897f1a99f49d42cca1","impliedFormat":1},{"version":"65165246b59654ec4e1501dd87927a0ef95d57359709e00e95d1154ad8443bc7","impliedFormat":1},{"version":"f1bacba19e2fa2eb26c499e36b5ab93d6764f2dba44be3816f12d2bc9ac9a35b","impliedFormat":1},{"version":"bce38da5fd851520d0cb4d1e6c3c04968cec2faa674ed321c118e97e59872edc","impliedFormat":1},{"version":"3398f46037f21fb6c33560ceca257259bd6d2ea03737179b61ea9e17cbe07455","impliedFormat":1},{"version":"6e14fc6c27cb2cb203fe1727bb3a923588f0be8c2604673ad9f879182548daca","impliedFormat":1},{"version":"12b9bcf8395d33837f301a8e6d545a24dfff80db9e32f8e8e6cf4b11671bb442","impliedFormat":1},{"version":"04295cc38689e32a4ea194c954ea6604e6afb6f1c102104f74737cb8cf744422","impliedFormat":1},{"version":"7418f434c136734b23f634e711cf44613ca4c74e63a5ae7429acaee46c7024c8","impliedFormat":1},{"version":"27d40290b7caba1c04468f2b53cf7112f247f8acdd7c20589cd7decf9f762ad0","impliedFormat":1},{"version":"2608b8b83639baf3f07316df29202eead703102f1a7e32f74a1b18cf1eee54b5","impliedFormat":1},{"version":"c93657567a39bd589effe89e863aaadbc339675fca6805ae4d97eafbcce0a05d","impliedFormat":1},{"version":"909d5db5b3b19f03dfb4a8f1d00cf41d2f679857c28775faf1f10794cbbe9db9","impliedFormat":1},{"version":"e4504bffce13574bab83ab900b843590d85a0fd38faab7eff83d84ec55de4aff","impliedFormat":1},{"version":"8ab707f3c833fc1e8a51106b8746c8bc0ce125083ea6200ad881625ae35ce11e","impliedFormat":1},{"version":"730ddc2386276ac66312edbcc60853fedbb1608a99cb0b1ff82ebf26911dba1f","impliedFormat":1},{"version":"c1b3fa201aa037110c43c05ea97800eb66fea3f2ecc5f07c6fd47f2b6b5b21d2","impliedFormat":1},{"version":"636b44188dc6eb326fd566085e6c1c6035b71f839d62c343c299a35888c6f0a9","impliedFormat":1},{"version":"3b2105bf9823b53c269cabb38011c5a71360c8daabc618fec03102c9514d230c","impliedFormat":1},{"version":"f96e63eb56e736304c3aef6c745b9fe93db235ddd1fec10b45319c479de1a432","impliedFormat":1},{"version":"acb4f3cee79f38ceba975e7ee3114eb5cd96ccc02742b0a4c7478b4619f87cd6","impliedFormat":1},{"version":"cfc85d17c1493b6217bad9052a8edc332d1fde81a919228edab33c14aa762939","impliedFormat":1},{"version":"eebda441c4486c26de7a8a7343ebbc361d2b0109abff34c2471e45e34a93020a","impliedFormat":1},{"version":"727b4b8eb62dd98fa4e3a0937172c1a0041eb715b9071c3de96dad597deddcab","impliedFormat":1},{"version":"708e2a347a1b9868ccdb48f3e43647c6eccec47b8591b220afcafc9e7eeb3784","impliedFormat":1},{"version":"6bb598e2d45a170f302f113a5b68e518c8d7661ae3b59baf076be9120afa4813","impliedFormat":1},{"version":"c28e058db8fed2c81d324546f53d2a7aaefff380cbe70f924276dbad89acd7d1","impliedFormat":1},{"version":"89d029475445d677c18cf9a8c75751325616d353925681385da49aeef9260ab7","impliedFormat":1},{"version":"826a98cb79deab45ccc4e5a8b90fa64510b2169781a7cbb83c4a0a8867f4cc58","impliedFormat":1},{"version":"618189f94a473b7fdc5cb5ba8b94d146a0d58834cd77cd24d56995f41643ccd5","impliedFormat":1},{"version":"1645dc6f3dd9a3af97eb5a6a4c794f5b1404cab015832eba67e3882a8198ec27","impliedFormat":1},{"version":"b5267af8d0a1e00092cceed845f69f5c44264cb770befc57d48dcf6a098cb731","impliedFormat":1},{"version":"91b0965538a5eaafa8c09cf9f62b46d6125aa1b3c0e0629dce871f5f41413f90","impliedFormat":1},{"version":"2978e33a00b4b5fb98337c5e473ab7337030b2f69d1480eccef0290814af0d51","impliedFormat":1},{"version":"ba71e9777cb5460e3278f0934fd6354041cb25853feca542312807ce1f18e611","impliedFormat":1},{"version":"608dbaf8c8bb64f4024013e73d7107c16dba4664999a8c6e58f3e71545e48f66","impliedFormat":1},{"version":"61937cefd7f4d6fa76013d33d5a3c5f9b0fc382e90da34790764a0d17d6277fb","impliedFormat":1},{"version":"af7db74826f455bfef6a55a188eb6659fd85fdc16f720a89a515c48724ee4c42","impliedFormat":1},{"version":"d6ce98a960f1b99a72de771fb0ba773cb202c656b8483f22d47d01d68f59ea86","impliedFormat":1},{"version":"2a47dc4a362214f31689870f809c7d62024afb4297a37b22cb86f679c4d04088","impliedFormat":1},{"version":"42d907ac511459d7c4828ee4f3f81cc331a08dc98d7b3cb98e3ff5797c095d2e","impliedFormat":1},{"version":"63d010bff70619e0cdf7900e954a7e188d3175461182f887b869c312a77ecfbd","impliedFormat":1},{"version":"1452816d619e636de512ca98546aafb9a48382d570af1473f0432a9178c4b1ff","impliedFormat":1},{"version":"9e3e3932fe16b9288ec8c948048aef4edf1295b09a5412630d63f4a42265370e","impliedFormat":1},{"version":"8bdba132259883bac06056f7bacd29a4dcf07e3f14ce89edb022fe9b78dcf9b3","impliedFormat":1},{"version":"5a5406107d9949d83e1225273bcee1f559bb5588942907d923165d83251a0e37","impliedFormat":1},{"version":"ca0ca4ca5ad4772161ee2a99741d616fea780d777549ba9f05f4a24493ab44e1","impliedFormat":1},{"version":"e7ee7be996db0d7cce41a85e4cae3a5fc86cf26501ad94e0a20f8b6c1c55b2d4","impliedFormat":1},{"version":"72263ae386d6a49392a03bde2f88660625da1eca5df8d95120d8ccf507483d20","impliedFormat":1},{"version":"b498375d015f01585269588b6221008aae6f0c0dc53ead8796ace64bdfcf62ea","impliedFormat":1},{"version":"c37aa3657fa4d1e7d22565ae609b1370c6b92bafb8c92b914403d45f0e610ddc","impliedFormat":1},{"version":"34534c0ead52cc753bdfdd486430ef67f615ace54a4c0e5a3652b4116af84d6d","impliedFormat":1},{"version":"a848339c272ab23e686b5d0b81297e3a7116ba7d27589c66ca1f4ebcd65e7f19","impliedFormat":1},{"version":"566315d39e476ca9e7fd0b1908074cb2a5ff9246cc3ed7da64cde5ad30f7e0b1","impliedFormat":1},{"version":"5f7ed82e82aa5017fe830ac40105321c32e3bf45d3cfcd557601f2ed58ff6ca4","impliedFormat":1},{"version":"dbb8d4b96528fe81fe54e1abe4491b1730551bb8f5daa02d3f5a09b5c3c94dad","impliedFormat":99},{"version":"f31342df19dc8b832f986fdfbb53824153f84d8c58cba5d6b042ab59f201ad18","impliedFormat":99},{"version":"7011c6a9e86949421a0b56ec590e7c6371b350834dcf63423aac5f5c2ea29cf7","impliedFormat":99},{"version":"94e29f539033dc9388b676c51f9ea5679018823bb7fb95af29e6756fdc2fdf6a","impliedFormat":1},{"version":"6b4f6be91f6f5ad7e6647ebc73932efc698cf07627c747072503e9d25e388964","impliedFormat":1},{"version":"5a5574432d64a842b8ce1400b7f81e0bca6c838feef14865a56cef33d6f0c589","impliedFormat":99},{"version":"aff83d38ef47a636d4962ee7b8727d83a684410e4597f5fe0e0c3359d752aa14","impliedFormat":99},{"version":"0955db781f9d0d6617a3d8b645ab8ee951e49d33ba5987d5d02a2aacab45b3af","impliedFormat":99},{"version":"0b0ed0c620dc45a41ba5256c163fa302865b3851c6c9a8b5352e65d367891915","impliedFormat":99},{"version":"bb493eccfb5190ce83a3faf1a07d07a8f287f2be5db11bed567c5987548326ef","impliedFormat":99},{"version":"95df8c27b063b0a309b4f08c00678655d887bdcc9536eb88b6f45c5b10b5537c","impliedFormat":99},{"version":"6ec86e3756badcb66457daad0be967e89517f27d03053552eb1275a0831d5dca","impliedFormat":99},{"version":"f6192301c9f6f18512a10437a8a1097bc69b9e829395ce29a7052cac9fb901ec","impliedFormat":99},{"version":"e3575b6bf4ccd064599da38680b6c33cd9380fc7d0df655b7ded7abb95b212ee","impliedFormat":99},{"version":"eb94b85e03d485e8033971cf9e341829ed54c9282ca067803408287258df2f67","impliedFormat":99},{"version":"3164843cb20ba3261d00d3b327089df39cf7b4d5e6f499ab07f2a05ac1925342","impliedFormat":99},{"version":"baab2794e169be595d264d5caffa50082bbc5ec41d8b4d80d0aaed4fa3949156","impliedFormat":99},{"version":"747ce5eedc500939c39638dc7d53670fea097f55c4297643489d3ae5f3b2db55","impliedFormat":99},{"version":"ad0cd76ec74a2e54df59e396a9adab1d3a527db3d5f054113a9a04128d31f7fe","impliedFormat":99},{"version":"958a09aeddfc2e1de2ab81ca4da2088404a254ef26cd9f38e3c7ab4129c70efc","impliedFormat":99},{"version":"fa30060fde9dc4f42e52f95ca5f2d97a895b0e42f60abc0603e25ffb3439bba5","impliedFormat":99},{"version":"1b795078ffed43f6902514d63c11436dba921f4d649108e2f1a15ee30f597e96","impliedFormat":99},{"version":"17592a385d3689d13ed88158b0a44ff3562208687b407f6d24f97517efc3a699","impliedFormat":99},{"version":"9bc9fafdd8e561d94aa5d7f48f7cb4898157de03a32e18b750a3dfca083ccf62","impliedFormat":99},{"version":"fad88eced08a82832232ee363fd67ead7821e2162c60c9a3b41faa66f2f29d03","signature":"faffdcb550f7acc30b7dcc6388b2f1841c6ee7932ce025a9080d26490fbce462"},{"version":"7f9159a6f98ca7b7fdc01347a4c7e0571962046691a5acd21d97b171b450219e","signature":"4fbf5b658864956542a4c3f4496742f826af53a30aad402f9690a5434b8dc68f"},{"version":"8f0f7034a041acb87f8cf23fe12d9b26660b4872c560a36ed39bb5745008bf52","signature":"9b328c4843431fa76d8de00008fc159e95f99a840211085ff3b8f25e53d14409"},{"version":"fe93c474ab38ac02e30e3af073412b4f92b740152cf3a751fdaee8cbea982341","impliedFormat":1},{"version":"aa4feed67c9af19fa98fe02a12f424def3cdc41146fb87b8d8dab077ad9ceb3c","impliedFormat":1},{"version":"1e00b8bf9e3766c958218cd6144ffe08418286f89ff44ba5a2cc830c03dd22c7","impliedFormat":1},{"version":"55e4c7c1f0fcbe498d8a12c402fbfc86081696446ba4020aa53d06815f1ca603","signature":"d50234446709c93924529c0508fb514f3a19916424febb911dd43644b268c3ce"},{"version":"05321b823dd3781d0b6aac8700bfdc0c9181d56479fe52ba6a40c9196fd661a8","impliedFormat":1},{"version":"3cfb7c0c642b19fb75132154040bb7cd840f0002f9955b14154e69611b9b3f81","impliedFormat":1},{"version":"8387ec1601cf6b8948672537cf8d430431ba0d87b1f9537b4597c1ab8d3ade5b","impliedFormat":1},{"version":"d16f1c460b1ca9158e030fdf3641e1de11135e0c7169d3e8cf17cc4cc35d5e64","impliedFormat":1},{"version":"a934063af84f8117b8ce51851c1af2b76efe960aa4c7b48d0343a1b15c01aedf","impliedFormat":1},{"version":"e3c5ad476eb2fca8505aee5bdfdf9bf11760df5d0f9545db23f12a5c4d72a718","impliedFormat":1},{"version":"462bccdf75fcafc1ae8c30400c9425e1a4681db5d605d1a0edb4f990a54d8094","impliedFormat":1},{"version":"5923d8facbac6ecf7c84739a5c701a57af94a6f6648d6229a6c768cf28f0f8cb","impliedFormat":1},{"version":"d0570ce419fb38287e7b39c910b468becb5b2278cf33b1000a3d3e82a46ecae2","impliedFormat":1},{"version":"3aca7f4260dad9dcc0a0333654cb3cde6664d34a553ec06c953bce11151764d7","impliedFormat":1},{"version":"a0a6f0095f25f08a7129bc4d7cb8438039ec422dc341218d274e1e5131115988","impliedFormat":1},{"version":"b58f396fe4cfe5a0e4d594996bc8c1bfe25496fbc66cf169d41ac3c139418c77","impliedFormat":1},{"version":"45785e608b3d380c79e21957a6d1467e1206ac0281644e43e8ed6498808ace72","impliedFormat":1},{"version":"bece27602416508ba946868ad34d09997911016dbd6893fb884633017f74e2c5","impliedFormat":1},{"version":"2a90177ebaef25de89351de964c2c601ab54d6e3a157cba60d9cd3eaf5a5ee1a","impliedFormat":1},{"version":"82200e963d3c767976a5a9f41ecf8c65eca14a6b33dcbe00214fcbe959698c46","impliedFormat":1},{"version":"b4966c503c08bbd9e834037a8ab60e5f53c5fd1092e8873c4a1c344806acdab2","impliedFormat":1},{"version":"b598deb1da203a2b58c76cf8d91cfc2ca172d785dacd8466c0a11e400ff6ab2d","impliedFormat":1},{"version":"480c20eddc2ee5f57954609b2f7a3368f6e0dda4037aa09ccf0d37e0b20d4e5c","impliedFormat":1},{"version":"4da5f388e15e717cedd2ef0b470a85bf52dd5b14cc41116a1eeb7f73fc40333a","signature":"b50ab63c92ac3855a542f1294c12b4c22ff1969bf7b4b8841cb7cb75acf863ff"},{"version":"206110bf829fe90a20b6ba987f79688fbf7bc3348eb4b8531d0c3dd833d326c5","signature":"3eb972ae325aa293fdb6077cdf956f209ee6ea34b4e874ff7ec8686b3079972f"},{"version":"353425c7301e0f3dcca8c3997aff8014ecc3fdfc77535b384e4ae0fe1f4ff5a4","signature":"8e609bb71c20b858c77f0e9f90bb1319db8477b13f9f965f1a1e18524bf50881"},{"version":"022007e5dfddb40b246e84a9fde1640c4696ac34c6184b356779e82ff9ddd9bd","signature":"89c49dfd174dae8185ab749f18320683d2d3d0ace7857787d011264c51fc49b0"},{"version":"66bf2137cae960982445158efc5bddaa0d6b6b770a1ebd67889881fd6ef1ad57","signature":"431ab37b2a5b217ca851dfa7fbed33e5c4e5f4a96635b9968d299426925dfd38"},{"version":"7b9f3ea7234e9a7bf7c12937af0cbb626881c06513830abfbd3ac240b4e833d9","signature":"6a7a8138bc7c5fa710018c96b5d7741f3f63105100f3c69f40c0edef54958cb7"},{"version":"0c8307f6fbff58390baa1244d33495bc6c8f15ecb58adbb2201d2ee941aec13f","signature":"f508182e20953c59b7d92a7d561e77df25bf329b2e0bbfec0322ce3042eec885"},{"version":"4be812d52df36180a01b0cfe6d42467214146734059b9c6d467c24de6f410a16","signature":"3a8523bfa20e149df671c3166d3c2e0c8e5b9f015b121a6855deedf209096b5e"},{"version":"4ccf8e6c1c4ba819bb9c7818babb2d33aece19737d122dc34eba598ef95ef603","signature":"43f8a38e40e3e47b540d9898800312fd2ca00087347451c874ae0483cba0b4b0"},{"version":"14a6a70fa31a30d107c14f4b218e6c37f2bdd58e0e22f7b11725d16bfad7460a","signature":"0e1a01e31948d9dff3699bc0ed40cbbc514b38e6c577102f07486de8556fb431"},{"version":"f12755b47bb4369777da706bbf84df9f7adbeee2fa6862ca28b2d4a595cf54f1","signature":"bed8187286d7adb93a9ecb59cbab0d7e66062733b9c0c195e3d4b1811a3399d5"},{"version":"ed09d42b14a604190e8c9fc972d18ea47d5c03c6c4a0003c9620dca915a1973d","affectsGlobalScope":true,"impliedFormat":99}],"root":[375,[460,465],[803,805],809,[829,839]],"options":{"allowJs":true,"esModuleInterop":true,"jsx":1,"module":99,"skipLibCheck":true,"strict":true,"target":7},"referencedMap":[[375,1],[413,2],[411,3],[782,4],[783,5],[674,6],[675,7],[673,4],[328,3],[671,3],[824,3],[821,3],[820,3],[815,8],[826,9],[811,10],[822,11],[814,12],[813,13],[823,3],[818,14],[825,3],[819,15],[812,3],[477,10],[478,16],[828,17],[476,3],[416,18],[412,2],[414,19],[415,2],[449,20],[447,3],[379,3],[107,21],[108,21],[109,22],[64,23],[110,24],[111,25],[112,26],[59,3],[62,27],[60,3],[61,3],[113,28],[114,29],[115,30],[116,31],[117,32],[118,33],[119,33],[120,34],[121,35],[122,36],[123,37],[65,3],[63,3],[124,38],[125,39],[126,40],[158,41],[127,42],[128,43],[129,44],[130,45],[131,46],[132,47],[133,48],[134,49],[135,50],[136,51],[137,51],[138,52],[139,3],[140,53],[142,54],[141,55],[143,56],[144,57],[145,58],[146,59],[147,60],[148,61],[149,62],[150,63],[151,64],[152,65],[153,66],[154,67],[155,68],[66,3],[67,3],[68,3],[106,69],[156,70],[157,71],[51,3],[163,72],[810,73],[164,74],[162,73],[827,75],[160,76],[161,77],[49,3],[52,78],[251,73],[417,79],[427,80],[436,81],[434,3],[435,3],[419,3],[431,82],[428,83],[429,84],[450,85],[441,3],[444,86],[443,87],[455,87],[442,88],[418,3],[426,89],[430,89],[421,90],[424,91],[437,90],[425,92],[420,3],[448,3],[50,3],[384,3],[472,93],[474,94],[473,95],[471,96],[470,3],[687,97],[754,98],[753,99],[752,100],[692,101],[708,102],[706,103],[707,104],[693,105],[778,106],[678,3],[680,3],[681,107],[682,3],[685,108],[688,3],[705,109],[683,3],[700,110],[686,111],[701,112],[704,113],[702,113],[699,114],[679,3],[684,3],[703,115],[709,116],[697,3],[691,117],[689,118],[698,119],[695,120],[694,120],[690,121],[696,122],[773,123],[767,124],[760,125],[759,126],[768,127],[769,113],[761,128],[774,129],[755,130],[756,131],[757,132],[777,133],[758,126],[762,129],[763,134],[776,135],[770,136],[771,111],[772,134],[775,113],[764,132],[710,137],[765,138],[766,139],[751,140],[749,141],[750,141],[715,141],[716,141],[717,141],[718,141],[719,141],[720,141],[721,141],[722,141],[741,141],[713,141],[723,141],[724,141],[725,141],[726,141],[727,141],[728,141],[748,141],[729,141],[730,141],[731,141],[746,141],[732,141],[747,141],[733,141],[744,141],[745,141],[734,141],[735,141],[736,141],[742,141],[743,141],[737,141],[738,141],[739,141],[740,141],[714,142],[712,143],[711,144],[677,3],[799,3],[798,3],[796,145],[792,145],[790,145],[781,145],[784,146],[791,147],[780,148],[802,149],[801,3],[800,145],[788,150],[786,151],[794,152],[676,3],[795,153],[787,3],[670,3],[779,3],[785,3],[797,3],[793,154],[789,155],[669,156],[521,157],[629,158],[522,159],[603,160],[625,3],[584,161],[555,162],[541,163],[626,3],[563,3],[572,3],[594,164],[481,3],[640,165],[642,166],[641,167],[483,3],[577,168],[576,169],[579,170],[578,171],[539,3],[663,3],[644,172],[648,173],[646,174],[486,175],[487,175],[488,3],[591,176],[590,3],[604,177],[529,178],[618,179],[668,3],[638,180],[573,181],[617,182],[667,3],[597,3],[586,183],[661,184],[664,3],[524,185],[523,186],[607,187],[611,188],[494,189],[614,190],[622,191],[489,192],[623,193],[631,194],[624,195],[496,193],[660,196],[621,197],[620,198],[499,199],[500,3],[527,200],[528,201],[512,202],[513,203],[519,204],[511,205],[526,206],[498,207],[564,3],[490,3],[515,193],[501,3],[502,208],[506,209],[634,159],[495,3],[507,3],[637,191],[491,191],[636,191],[609,210],[608,211],[574,212],[632,3],[548,193],[508,194],[635,159],[613,213],[589,3],[581,3],[482,3],[596,214],[595,215],[645,174],[649,216],[647,217],[602,3],[485,218],[662,3],[583,185],[525,219],[601,220],[600,3],[556,221],[543,222],[544,3],[518,223],[587,224],[588,224],[531,225],[532,3],[540,3],[503,226],[558,227],[516,3],[492,228],[520,229],[606,230],[665,231],[550,232],[559,233],[650,167],[652,234],[651,234],[553,235],[554,236],[517,3],[479,3],[562,3],[561,237],[610,238],[605,239],[643,240],[658,237],[546,241],[530,242],[545,241],[547,243],[551,232],[493,187],[599,244],[656,245],[627,246],[570,247],[569,3],[565,248],[593,249],[566,248],[568,250],[567,251],[592,195],[630,252],[628,253],[542,254],[514,3],[549,255],[653,174],[655,216],[654,217],[616,256],[657,257],[615,258],[659,259],[585,260],[580,3],[598,261],[552,262],[582,263],[536,3],[505,264],[510,237],[666,3],[509,265],[575,266],[619,3],[480,3],[560,237],[484,3],[557,267],[497,3],[535,3],[533,3],[534,3],[571,3],[639,268],[538,237],[612,188],[537,269],[633,270],[58,271],[331,272],[335,273],[337,274],[184,275],[198,276],[302,277],[230,3],[305,278],[266,279],[275,280],[303,281],[185,282],[229,3],[231,283],[304,284],[205,285],[186,286],[210,285],[199,285],[169,285],[257,287],[258,288],[174,3],[254,289],[259,290],[346,291],[252,290],[347,292],[236,3],[255,293],[359,294],[358,295],[261,290],[357,3],[355,3],[356,296],[256,73],[243,297],[244,298],[253,299],[270,300],[271,301],[260,302],[238,303],[239,304],[350,305],[353,306],[217,307],[216,308],[215,309],[362,73],[214,310],[190,3],[365,3],[807,311],[806,3],[368,3],[367,73],[369,312],[165,3],[296,3],[197,313],[167,314],[319,3],[320,3],[322,3],[325,315],[321,3],[323,316],[324,316],[183,3],[196,3],[330,317],[338,318],[342,319],[179,320],[246,321],[245,3],[237,303],[265,322],[263,323],[262,3],[264,3],[269,324],[241,325],[178,326],[203,327],[293,328],[170,329],[177,330],[166,277],[307,331],[317,332],[306,3],[316,333],[204,3],[188,334],[284,335],[283,3],[290,336],[292,337],[285,338],[289,339],[291,336],[288,338],[287,336],[286,338],[226,340],[211,340],[278,341],[212,341],[172,342],[171,3],[282,343],[281,344],[280,345],[279,346],[173,347],[250,348],[267,349],[249,350],[274,351],[276,352],[273,350],[206,347],[159,3],[294,353],[232,354],[268,3],[315,355],[235,356],[310,357],[176,3],[311,358],[313,359],[314,360],[297,3],[309,329],[208,361],[295,362],[318,363],[180,3],[182,3],[187,364],[277,365],[175,366],[181,3],[234,367],[233,368],[189,369],[242,370],[240,371],[191,372],[193,373],[366,3],[192,374],[194,375],[333,3],[332,3],[334,3],[364,3],[195,376],[248,73],[57,3],[272,377],[218,3],[228,378],[207,3],[340,73],[349,379],[225,73],[344,290],[224,380],[327,381],[223,379],[168,3],[351,382],[221,73],[222,73],[213,3],[227,3],[220,383],[219,384],[209,385],[202,302],[312,3],[201,386],[200,3],[336,3],[247,73],[329,387],[48,3],[56,388],[53,73],[54,3],[55,3],[308,389],[301,390],[300,3],[299,391],[298,3],[339,392],[341,393],[343,394],[808,395],[345,396],[348,397],[374,398],[352,398],[373,399],[354,400],[360,401],[361,402],[363,403],[370,404],[372,3],[371,405],[326,406],[402,407],[400,408],[401,409],[389,410],[390,408],[397,411],[388,412],[393,413],[403,3],[394,414],[399,415],[405,416],[404,417],[387,418],[395,419],[396,420],[391,421],[398,407],[392,422],[817,423],[816,3],[381,424],[380,425],[386,3],[672,3],[504,3],[451,3],[422,3],[423,426],[46,3],[47,3],[8,3],[9,3],[11,3],[10,3],[2,3],[12,3],[13,3],[14,3],[15,3],[16,3],[17,3],[18,3],[19,3],[3,3],[20,3],[21,3],[4,3],[22,3],[26,3],[23,3],[24,3],[25,3],[27,3],[28,3],[29,3],[5,3],[30,3],[31,3],[32,3],[33,3],[6,3],[37,3],[34,3],[35,3],[36,3],[38,3],[7,3],[39,3],[44,3],[45,3],[40,3],[41,3],[42,3],[43,3],[1,3],[84,427],[94,428],[83,427],[104,429],[75,430],[74,431],[103,405],[97,432],[102,433],[77,434],[91,435],[76,436],[100,437],[72,438],[71,405],[101,439],[73,440],[78,441],[79,3],[82,441],[69,3],[105,442],[95,443],[86,444],[87,445],[89,446],[85,447],[88,448],[98,405],[80,449],[81,450],[90,451],[70,452],[93,443],[92,441],[96,3],[99,453],[453,454],[439,455],[440,454],[438,3],[377,456],[410,457],[383,458],[378,456],[376,3],[382,459],[408,3],[406,3],[407,3],[385,3],[409,460],[459,461],[452,462],[445,463],[454,464],[433,465],[467,466],[468,467],[456,468],[469,469],[457,470],[446,471],[466,472],[458,473],[475,474],[840,475],[432,3],[461,476],[832,477],[834,478],[833,477],[809,479],[831,480],[830,481],[837,478],[836,482],[838,483],[839,483],[835,483],[829,483],[464,484],[462,3],[465,3],[463,485],[803,486],[804,487],[805,488],[460,489]],"affectedFilesPendingEmit":[461,832,834,833,809,831,830,837,836,838,839,835,829,464,462,465,463,803,804,805,460],"version":"5.9.3"}
</file>

<file path="services/api/alembic/versions/8f008b42145c_phase2_ingestion_fields.py">
"""phase2 ingestion fields

Revision ID: 8f008b42145c
Revises: 8399dceac96e
Create Date: 2025-12-23 10:43:34.266235

"""

from typing import Sequence, Union

import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision: str = "8f008b42145c"
down_revision: Union[str, Sequence[str], None] = "8399dceac96e"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "shelf_items", sa.Column("isbn13", sa.String(length=13), nullable=True)
    )
    op.add_column(
        "shelf_items", sa.Column("isbn10", sa.String(length=10), nullable=True)
    )
    op.add_column("shelf_items", sa.Column("asin", sa.String(length=20), nullable=True))
    op.add_column(
        "shelf_items",
        sa.Column("goodreads_book_id", sa.String(length=40), nullable=True),
    )
    op.add_column(
        "shelf_items",
        sa.Column("normalized_title", sa.String(length=600), nullable=False),
    )
    op.add_column(
        "shelf_items",
        sa.Column("normalized_author", sa.String(length=400), nullable=False),
    )
    op.add_column(
        "shelf_items",
        sa.Column("normalized_key", sa.String(length=1100), nullable=False),
    )
    op.add_column(
        "shelf_items", sa.Column("needs_fuzzy_match", sa.Boolean(), nullable=False)
    )
    op.add_column(
        "shelf_items",
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
    )
    op.drop_index(op.f("ix_shelf_items_user_title_author"), table_name="shelf_items")
    op.create_index(
        "ix_shelf_items_user_normkey",
        "shelf_items",
        ["user_id", "normalized_key"],
        unique=False,
    )
    op.create_unique_constraint(
        "uq_shelf_item_user_normkey", "shelf_items", ["user_id", "normalized_key"]
    )
    op.add_column(
        "shelf_sources", sa.Column("shelf_name", sa.String(length=200), nullable=True)
    )
    op.add_column("shelf_sources", sa.Column("is_active", sa.Boolean(), nullable=False))
    op.add_column(
        "shelf_sources",
        sa.Column("last_imported_at", sa.DateTime(timezone=True), nullable=True),
    )
    op.create_unique_constraint(
        "uq_shelf_source_user_type_ref",
        "shelf_sources",
        ["user_id", "source_type", "source_ref"],
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint("uq_shelf_source_user_type_ref", "shelf_sources", type_="unique")
    op.drop_column("shelf_sources", "last_imported_at")
    op.drop_column("shelf_sources", "is_active")
    op.drop_column("shelf_sources", "shelf_name")
    op.drop_constraint("uq_shelf_item_user_normkey", "shelf_items", type_="unique")
    op.drop_index("ix_shelf_items_user_normkey", table_name="shelf_items")
    op.create_index(
        op.f("ix_shelf_items_user_title_author"),
        "shelf_items",
        ["user_id", "title", "author"],
        unique=False,
    )
    op.drop_column("shelf_items", "updated_at")
    op.drop_column("shelf_items", "needs_fuzzy_match")
    op.drop_column("shelf_items", "normalized_key")
    op.drop_column("shelf_items", "normalized_author")
    op.drop_column("shelf_items", "normalized_title")
    op.drop_column("shelf_items", "goodreads_book_id")
    op.drop_column("shelf_items", "asin")
    op.drop_column("shelf_items", "isbn10")
    op.drop_column("shelf_items", "isbn13")
    # ### end Alembic commands ###
</file>

<file path="services/api/app/api/routes/auth.py">
from __future__ import annotations

from datetime import timedelta

from app.api.deps import get_current_user
from app.core.config import settings
from app.core.security import (
    create_access_token,
    hash_password,
    password_needs_rehash,
    verify_password,
)
from app.db.session import get_db
from app.models.user import User
from app.models.user_settings import UserSettings
from app.schemas.auth import LoginIn, SignUpIn, UserOut
from fastapi import APIRouter, Depends, HTTPException, Response
from sqlalchemy import select
from sqlalchemy.orm import Session

router = APIRouter(prefix="/v1/auth", tags=["auth"])

DEMO_EMAIL = "demo@example.com"


def _get_user_by_email(db: Session, email: str) -> User | None:
    return db.execute(select(User).where(User.email == email)).scalar_one_or_none()


def _ensure_user_settings(db: Session, user_id: str) -> None:
    existing = db.execute(
        select(UserSettings).where(UserSettings.user_id == user_id)
    ).scalar_one_or_none()
    if existing is None:
        db.add(UserSettings(user_id=user_id))
        db.flush()


def _create_user(db: Session, *, email: str, password: str) -> User:
    u = User(email=email, password_hash=hash_password(password))
    db.add(u)
    db.flush()
    _ensure_user_settings(db, u.id)
    db.commit()
    db.refresh(u)
    return u


def _update_user_password(db: Session, u: User, password: str) -> None:
    u.password_hash = hash_password(password)
    db.add(u)
    db.commit()
    db.refresh(u)


def _set_auth_cookie(response: Response, *, subject: str) -> None:
    token = create_access_token(
        subject=subject,
        expires_delta=timedelta(minutes=settings.auth_access_token_ttl_minutes),
    )
    response.set_cookie(
        key=settings.auth_cookie_name,
        value=token,
        httponly=True,
        secure=settings.auth_cookie_secure,
        samesite=settings.auth_cookie_samesite,
        path="/",
    )


@router.post("/signup", response_model=UserOut)
def signup(payload: SignUpIn, response: Response, db: Session = Depends(get_db)):
    existing = _get_user_by_email(db, payload.email)
    if existing is not None:
        raise HTTPException(status_code=400, detail="Email already registered")

    u = _create_user(db, email=payload.email, password=payload.password)
    _set_auth_cookie(response, subject=u.id)
    return UserOut(id=u.id, email=u.email)


@router.post("/login", response_model=UserOut)
def login(payload: LoginIn, response: Response, db: Session = Depends(get_db)):
    u = _get_user_by_email(db, payload.email)

    # Demo auto-create for local/dev if enabled
    if (
        u is None
        and settings.demo_login_enabled
        and settings.env in {"local", "development", "dev"}
    ):
        if payload.email == DEMO_EMAIL:
            u = _create_user(db, email=payload.email, password=payload.password)

    if u is None:
        raise HTTPException(status_code=401, detail="Invalid email or password")

    if not verify_password(payload.password, u.password_hash):
        raise HTTPException(status_code=401, detail="Invalid email or password")

    # If this was a legacy hash, upgrade it automatically.
    if password_needs_rehash(u.password_hash):
        _update_user_password(db, u, payload.password)

    _set_auth_cookie(response, subject=u.id)
    return UserOut(id=u.id, email=u.email)


@router.get("/me", response_model=UserOut)
def me(user: User = Depends(get_current_user)) -> UserOut:
    return UserOut(id=user.id, email=user.email)


@router.post("/logout")
def logout(response: Response):
    response.delete_cookie(settings.auth_cookie_name, path="/")
    return {"ok": True}
</file>

<file path="services/api/app/api/routes/matching.py">
from __future__ import annotations

from app.api.deps import get_current_user
from app.db.session import get_db
from app.models.availability_snapshot import AvailabilitySnapshot
from app.models.catalog_item import CatalogItem
from app.models.catalog_match import CatalogMatch
from app.models.shelf_item import ShelfItem
from app.schemas.matching import (
    AvailabilityOut,
    CatalogItemOut,
    JobStatusOut,
    MatchOut,
    RefreshEnqueuedOut,
)
from app.workers.jobs import refresh_matching_for_user
from app.workers.queue import get_queue
from app.workers.redis_conn import get_redis_connection
from fastapi import APIRouter, Depends, HTTPException
from rq import Retry
from rq.job import Job
from sqlalchemy import select
from sqlalchemy.orm import Session

router = APIRouter(prefix="/v1", tags=["matching"])


@router.post("/matching/refresh", response_model=RefreshEnqueuedOut)
def refresh_matching(user=Depends(get_current_user)):
    q = get_queue()
    job = q.enqueue(
        refresh_matching_for_user, user.id, retry=Retry(max=2, interval=[5, 15])
    )
    return {"job_id": job.id}


@router.get("/matching/refresh/{job_id}", response_model=JobStatusOut)
def refresh_status(job_id: str, user=Depends(get_current_user)):
    # user param enforces auth; job is keyed only by id
    try:
        conn = get_redis_connection()
        job = Job.fetch(job_id, connection=conn)
    except Exception as e:
        raise HTTPException(status_code=404, detail=f"Job not found: {e}")

    return JobStatusOut(
        id=job.id,
        status=job.get_status(),
        created_at=job.created_at,
        started_at=job.started_at,
        ended_at=job.ended_at,
        result=job.result if isinstance(job.result, dict) else None,
        exc_info=job.exc_info,
    )


@router.get("/matches", response_model=list[MatchOut])
def list_matches(
    db: Session = Depends(get_db),
    user=Depends(get_current_user),
    limit: int = 50,
    offset: int = 0,
):
    # Join: shelf_items ‚Üí catalog_matches ‚Üí catalog_items, then attach availability snapshots
    rows = db.execute(
        select(ShelfItem, CatalogMatch, CatalogItem)
        .join(CatalogMatch, CatalogMatch.shelf_item_id == ShelfItem.id)
        .join(CatalogItem, CatalogItem.id == CatalogMatch.catalog_item_id)
        .where(ShelfItem.user_id == user.id)
        .order_by(ShelfItem.created_at.desc())
        .limit(limit)
        .offset(offset)
    ).all()

    catalog_ids = [ci.id for _, _, ci in rows]
    av_rows = (
        db.execute(
            select(AvailabilitySnapshot)
            .where(AvailabilitySnapshot.user_id == user.id)
            .where(AvailabilitySnapshot.catalog_item_id.in_(catalog_ids))
        )
        .scalars()
        .all()
    )
    avail_by_catalog: dict[str, list[AvailabilitySnapshot]] = {}
    for a in av_rows:
        avail_by_catalog.setdefault(a.catalog_item_id, []).append(a)

    out: list[MatchOut] = []
    for si, m, ci in rows:
        av_out = [
            AvailabilityOut(
                format=a.format,
                status=a.status,
                copies_available=a.copies_available,
                copies_total=a.copies_total,
                holds=a.holds,
                deep_link=a.deep_link,
                last_checked_at=a.last_checked_at,
            )
            for a in sorted(avail_by_catalog.get(ci.id, []), key=lambda x: x.format)
        ]

        out.append(
            MatchOut(
                shelf_item_id=si.id,
                catalog_item=CatalogItemOut(
                    id=ci.id,
                    provider=ci.provider,
                    provider_item_id=ci.provider_item_id,
                    title=ci.title,
                    author=ci.author,
                    isbn10=ci.isbn10,
                    isbn13=ci.isbn13,
                    asin=ci.asin,
                ),
                method=m.method,
                confidence=m.confidence,
                evidence=m.evidence,
                availability=av_out,
            )
        )

    return out


@router.get("/matches/{shelf_item_id}", response_model=MatchOut)
def get_match(
    shelf_item_id: str,
    db: Session = Depends(get_db),
    user=Depends(get_current_user),
):
    row = db.execute(
        select(ShelfItem, CatalogMatch, CatalogItem)
        .join(CatalogMatch, CatalogMatch.shelf_item_id == ShelfItem.id)
        .join(CatalogItem, CatalogItem.id == CatalogMatch.catalog_item_id)
        .where(ShelfItem.user_id == user.id)
        .where(ShelfItem.id == shelf_item_id)
    ).first()

    if not row:
        raise HTTPException(status_code=404, detail="Match not found")

    si, m, ci = row
    av = (
        db.execute(
            select(AvailabilitySnapshot)
            .where(AvailabilitySnapshot.user_id == user.id)
            .where(AvailabilitySnapshot.catalog_item_id == ci.id)
        )
        .scalars()
        .all()
    )

    return MatchOut(
        shelf_item_id=si.id,
        catalog_item=CatalogItemOut(
            id=ci.id,
            provider=ci.provider,
            provider_item_id=ci.provider_item_id,
            title=ci.title,
            author=ci.author,
            isbn10=ci.isbn10,
            isbn13=ci.isbn13,
            asin=ci.asin,
        ),
        method=m.method,
        confidence=m.confidence,
        evidence=m.evidence,
        availability=[
            AvailabilityOut(
                format=a.format,
                status=a.status,
                copies_available=a.copies_available,
                copies_total=a.copies_total,
                holds=a.holds,
                deep_link=a.deep_link,
                last_checked_at=a.last_checked_at,
            )
            for a in sorted(av, key=lambda x: x.format)
        ],
    )
</file>

<file path="services/api/app/api/routes/shelf_sources.py">
from __future__ import annotations

from app.api.deps import get_current_user
from app.db.session import get_db
from app.models.shelf_source import ShelfSource
from app.schemas.shelf import (
    ImportErrorOut,
    ImportSummaryOut,
    RssConnectIn,
    ShelfSourceOut,
    SyncEnqueuedOut,
)
from app.services.goodreads_csv import parse_goodreads_csv
from app.services.shelf_import import upsert_shelf_items
from app.workers.jobs import sync_goodreads_rss
from app.workers.queue import get_queue
from fastapi import APIRouter, Depends, File, HTTPException, UploadFile
from rq import Retry
from sqlalchemy import select
from sqlalchemy.orm import Session

router = APIRouter(prefix="/v1/shelf-sources", tags=["shelf-sources"])


@router.get("", response_model=list[ShelfSourceOut])
def list_sources(db: Session = Depends(get_db), user=Depends(get_current_user)):
    return (
        db.execute(select(ShelfSource).where(ShelfSource.user_id == user.id))
        .scalars()
        .all()
    )


@router.post("/rss", response_model=ShelfSourceOut)
def connect_rss(
    payload: RssConnectIn, db: Session = Depends(get_db), user=Depends(get_current_user)
):
    existing = db.execute(
        select(ShelfSource)
        .where(ShelfSource.user_id == user.id)
        .where(ShelfSource.source_type == "rss")
        .where(ShelfSource.provider == "goodreads")
        .where(ShelfSource.source_ref == payload.rss_url)
    ).scalar_one_or_none()

    if existing is None:
        source = ShelfSource(
            user_id=user.id,
            source_type="rss",
            provider="goodreads",
            source_ref=payload.rss_url,
            meta={"shelf": payload.shelf} if payload.shelf else {},
            is_active=True,
        )
        db.add(source)
        db.commit()
        db.refresh(source)
    else:
        existing.meta = {
            **(existing.meta or {}),
            **({"shelf": payload.shelf} if payload.shelf else {}),
        }
        existing.is_active = True
        db.add(existing)
        db.commit()
        db.refresh(existing)
        source = existing

    if payload.sync_now:
        q = get_queue()
        q.enqueue(sync_goodreads_rss, source.id, retry=Retry(max=2, interval=[5, 15]))

    return source


@router.post("/csv", response_model=ImportSummaryOut)
def import_csv(
    file: UploadFile = File(...),
    db: Session = Depends(get_db),
    user=Depends(get_current_user),
):
    raw = file.file.read()

    rows, parse_errors = parse_goodreads_csv(raw)

    source = db.execute(
        select(ShelfSource)
        .where(ShelfSource.user_id == user.id)
        .where(ShelfSource.source_type == "csv")
        .where(ShelfSource.provider == "goodreads")
    ).scalar_one_or_none()
    if source is None:
        source = ShelfSource(
            user_id=user.id,
            source_type="csv",
            provider="goodreads",
            source_ref=file.filename or "upload",
            meta={},
            is_active=True,
        )
        db.add(source)
        db.commit()
        db.refresh(source)

    summary = upsert_shelf_items(db, user_id=user.id, source=source, items=rows)

    errors_out: list[ImportErrorOut] = [
        ImportErrorOut(key=e.key, error=e.error) for e in summary.errors
    ] + [
        ImportErrorOut(key=f"line:{e['line']}", error=e["error"]) for e in parse_errors
    ]

    return ImportSummaryOut(
        created=summary.created,
        updated=summary.updated,
        skipped=summary.skipped + len(parse_errors),
        errors=errors_out,
    )


@router.post("/{source_id}/sync", response_model=SyncEnqueuedOut)
def sync_source(
    source_id: str, db: Session = Depends(get_db), user=Depends(get_current_user)
):
    source = db.get(ShelfSource, source_id)
    if source is None or source.user_id != user.id:
        raise HTTPException(status_code=404, detail="Source not found")

    if source.source_type != "rss":
        raise HTTPException(status_code=400, detail="Only RSS sources can be synced")

    q = get_queue()
    job = q.enqueue(sync_goodreads_rss, source.id, retry=Retry(max=2, interval=[5, 15]))
    return SyncEnqueuedOut(job_id=job.id)


@router.delete("/{source_id}", status_code=204)
def delete_source(
    source_id: str, db: Session = Depends(get_db), user=Depends(get_current_user)
):
    source = db.get(ShelfSource, source_id)
    if source is None or source.user_id != user.id:
        raise HTTPException(status_code=404, detail="Source not found")
    db.delete(source)
    db.commit()
    return None
</file>

<file path="services/api/app/api/rate_limit.py">
from __future__ import annotations

import time
from typing import Callable, cast

from app.api.deps import get_current_user
from app.core.redis_client import get_redis
from fastapi import Depends, HTTPException
from redis import Redis


def rate_limiter(
    scope: str,
    *,
    limit: int,
    window_seconds: int,
) -> Callable[[], None]:
    """Simple fixed-window rate limiter using Redis INCR + EXPIRE.

    If Redis is unavailable, the limiter becomes a no-op (fail open).
    """

    def _dep(user=Depends(get_current_user)) -> None:
        r = get_redis()
        if r is None:
            return

        # Fixed-window bucket
        now = int(time.time())
        bucket = now // window_seconds
        key = f"rl:{scope}:{user.id}:{bucket}"

        try:
            # redis-py typing can be `Awaitable[Any] | Any` in stubs; cast to satisfy mypy.
            count = cast(int, cast(Redis, r).incr(key))
            if count == 1:
                cast(Redis, r).expire(key, window_seconds)
        except Exception:
            # If Redis errors, don't block requests.
            return

        if count > limit:
            retry_after = max(1, window_seconds - (now % window_seconds))
            raise HTTPException(
                status_code=429,
                detail="Rate limit exceeded",
                headers={"Retry-After": str(retry_after)},
            )

    return _dep
</file>

<file path="services/api/app/core/otel.py">
from __future__ import annotations

from app.core.config import settings
from opentelemetry import trace
from opentelemetry.exporter.otlp.proto.http.trace_exporter import OTLPSpanExporter
from opentelemetry.instrumentation.fastapi import FastAPIInstrumentor
from opentelemetry.instrumentation.httpx import HTTPXClientInstrumentor
from opentelemetry.sdk.resources import Resource
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor


def init_otel(app) -> None:
    if not getattr(settings, "otel_enabled", False):
        return

    resource = Resource.create(
        {"service.name": getattr(settings, "api_name", "shelfsync-api")}
    )
    provider = TracerProvider(resource=resource)

    # Prefer env vars (OTEL_EXPORTER_OTLP_ENDPOINT, etc.); allow an optional settings override.
    endpoint = getattr(settings, "otel_otlp_endpoint", None)
    exporter = OTLPSpanExporter(endpoint=endpoint) if endpoint else OTLPSpanExporter()

    provider.add_span_processor(BatchSpanProcessor(exporter))
    trace.set_tracer_provider(provider)

    FastAPIInstrumentor.instrument_app(app)
    HTTPXClientInstrumentor().instrument()
</file>

<file path="services/api/app/core/security.py">
from __future__ import annotations

from datetime import datetime, timedelta, timezone

from app.core.config import settings
from jose import jwt
from passlib.context import CryptContext  # type: ignore[import-untyped]

# Support legacy PBKDF2 hashes for login migration, but always *create* bcrypt hashes.
pwd_context = CryptContext(
    schemes=["bcrypt", "pbkdf2_sha256"],
    deprecated="auto",
)


def verify_password(plain_password: str, hashed_password: str) -> bool:
    return pwd_context.verify(plain_password, hashed_password)


def hash_password(password: str) -> str:
    return pwd_context.hash(password)


def password_needs_rehash(hashed_password: str) -> bool:
    # True when the stored hash uses a deprecated scheme/params (e.g., pbkdf2_sha256).
    return pwd_context.needs_update(hashed_password)


def create_access_token(subject: str, expires_delta: timedelta | None = None) -> str:
    if expires_delta is None:
        expires_delta = timedelta(minutes=settings.auth_access_token_ttl_minutes)

    expire = datetime.now(timezone.utc) + expires_delta
    to_encode = {"sub": subject, "exp": expire}
    return jwt.encode(
        to_encode, settings.auth_secret_key, algorithm=settings.auth_algorithm
    )


def decode_access_token(token: str) -> dict:
    return jwt.decode(
        token, settings.auth_secret_key, algorithms=[settings.auth_algorithm]
    )
</file>

<file path="services/api/app/ingestion/csv_import.py">
from __future__ import annotations

import csv
import io

REQUIRED = {"title", "author"}


def _normalize_header(h: str) -> str:
    return " ".join((h or "").strip().lower().split())


def parse_goodreads_csv(csv_bytes: bytes) -> tuple[list[dict], list[str]]:
    """Parse Goodreads export CSV.

    Returns: (items, errors)
    Each item contains minimal fields:
    - title
    - author
    - isbn13
    - isbn10
    - asin

    Parsing is forgiving about extra columns.
    It collects row-level errors and continues, unless the file is structurally invalid.
    """

    errors: list[str] = []

    try:
        text = csv_bytes.decode("utf-8-sig")
    except UnicodeDecodeError:
        text = csv_bytes.decode("utf-8", errors="replace")

    buf = io.StringIO(text)
    reader = csv.DictReader(buf)

    if not reader.fieldnames:
        return [], ["CSV appears to be missing a header row."]

    # Build a header map so we can handle variants like "ISBN13" vs "ISBN 13".
    header_map = {_normalize_header(h): h for h in reader.fieldnames}

    missing = [h for h in REQUIRED if h not in header_map]
    if missing:
        return [], [f"CSV is missing required column(s): {', '.join(sorted(missing))}"]

    title_col = header_map["title"]
    author_col = header_map["author"]

    isbn13_col = header_map.get("isbn13") or header_map.get("isbn 13")
    isbn10_col = (
        header_map.get("isbn") or header_map.get("isbn10") or header_map.get("isbn 10")
    )
    asin_col = header_map.get("asin")

    items: list[dict] = []

    for idx, row in enumerate(reader, start=2):
        title = (row.get(title_col) or "").strip()
        author = (row.get(author_col) or "").strip()

        if not title or not author:
            errors.append(f"Row {idx}: missing title or author")
            continue

        items.append(
            {
                "title": title,
                "author": author,
                "isbn13": (row.get(isbn13_col) or "").strip() if isbn13_col else None,
                "isbn10": (row.get(isbn10_col) or "").strip() if isbn10_col else None,
                "asin": (row.get(asin_col) or "").strip() if asin_col else None,
            }
        )

    return items, errors
</file>

<file path="services/api/app/ingestion/fetch.py">
from __future__ import annotations

from urllib.parse import urlparse, urlunparse

import httpx
from app.core.config import settings


def _rewrite_goodreads_url(url: str, base_url: str | None) -> str:
    if not base_url:
        return url

    parsed = urlparse(url)
    hostname = (parsed.hostname or "").lower()
    if not hostname or not (
        hostname == "goodreads.com" or hostname.endswith(".goodreads.com")
    ):
        return url

    base = urlparse(base_url)
    if not base.scheme or not base.netloc:
        return url

    base_path = base.path.rstrip("/")
    incoming_path = parsed.path or "/"
    merged_path = f"{base_path}{incoming_path}" if base_path else incoming_path

    rewritten = parsed._replace(
        scheme=base.scheme, netloc=base.netloc, path=merged_path
    )
    return urlunparse(rewritten)


async def fetch_text(url: str) -> str:
    request_url = _rewrite_goodreads_url(url, settings.goodreads_base_url)
    async with httpx.AsyncClient(timeout=15.0, follow_redirects=True) as client:
        resp = await client.get(request_url, headers={"User-Agent": "ShelfSync/0.1"})
        resp.raise_for_status()
        return resp.text
</file>

<file path="services/api/app/ingestion/rss.py">
from __future__ import annotations

import re
import xml.etree.ElementTree as ET

from bs4 import BeautifulSoup

ISBN_RE = re.compile(
    r"\b(?:ISBN(?:-13)?|ISBN13)\s*[:#]?\s*([0-9\-]{10,17})\b", re.IGNORECASE
)
ASIN_RE = re.compile(r"\bASIN\s*[:#]?\s*([A-Z0-9]{8,20})\b", re.IGNORECASE)


def _local(tag: str) -> str:
    # Handles namespaced tags like {http://purl.org/dc/elements/1.1/}creator
    return tag.split("}")[-1]


def _find_first_text(elem: ET.Element, wanted: set[str]) -> str | None:
    for child in elem.iter():
        if _local(child.tag) in wanted and (child.text or "").strip():
            return (child.text or "").strip()
    return None


def _extract_identifiers_from_description(
    description_html: str,
) -> tuple[str | None, str | None]:
    if not description_html:
        return None, None

    # Goodreads often embeds metadata in HTML inside <description>.
    soup = BeautifulSoup(description_html, "html.parser")
    text = soup.get_text(" ", strip=True)

    isbn = None
    asin = None

    m = ISBN_RE.search(text)
    if m:
        isbn = m.group(1)

    m2 = ASIN_RE.search(text)
    if m2:
        asin = m2.group(1)

    return isbn, asin


def parse_goodreads_rss(xml_text: str) -> list[dict]:
    """Parse a Goodreads shelf RSS feed.

    Returns a list of dicts with minimal fields:
    - title
    - author
    - isbn (raw-ish, may be isbn10 or isbn13)
    - asin
    - goodreads_book_id (best-effort)

    The parser is defensive: it will skip items missing title/author.
    """

    root = ET.fromstring(xml_text)
    items = root.findall(".//item")

    out: list[dict] = []

    for item in items:
        title = _find_first_text(item, {"title"})
        author = _find_first_text(item, {"author_name", "creator", "author"})
        link = _find_first_text(item, {"link"})
        description = _find_first_text(item, {"description", "encoded"})

        if not title or not author:
            continue

        isbn_from_desc, asin_from_desc = _extract_identifiers_from_description(
            description or ""
        )

        goodreads_book_id = None
        if link and "/book/show/" in link:
            # https://www.goodreads.com/book/show/<id>-...
            try:
                part = link.split("/book/show/", 1)[1]
                goodreads_book_id = part.split("-", 1)[0].strip("/")
            except Exception:
                goodreads_book_id = None

        out.append(
            {
                "title": title.strip(),
                "author": author.strip(),
                "isbn": isbn_from_desc,
                "asin": asin_from_desc,
                "goodreads_book_id": goodreads_book_id,
            }
        )

    return out
</file>

<file path="services/api/app/models/__init__.py">
from app.models.availability_snapshot import AvailabilitySnapshot
from app.models.base import Base
from app.models.catalog_item import CatalogItem
from app.models.catalog_match import CatalogMatch
from app.models.library import Library
from app.models.shelf_item import ShelfItem
from app.models.shelf_source import ShelfSource
from app.models.sync_run import SyncRun
from app.models.user import User
from app.models.user_settings import UserSettings
from app.models.notification_event import NotificationEvent


__all__ = [
    "Base",
    "User",
    "UserSettings",
    "ShelfSource",
    "ShelfItem",
    "Library",
    "CatalogItem",
    "CatalogMatch",
    "AvailabilitySnapshot",
    "SyncRun",
    "NotificationEvent",
]
</file>

<file path="services/api/app/models/availability_snapshot.py">
from __future__ import annotations

from datetime import datetime
from uuid import uuid4

from app.models.base import Base
from sqlalchemy import DateTime, ForeignKey, Integer, String, UniqueConstraint
from sqlalchemy.orm import Mapped, mapped_column


class AvailabilitySnapshot(Base):
    __tablename__ = "availability_snapshots"

    id: Mapped[str] = mapped_column(
        String(36), primary_key=True, default=lambda: str(uuid4())
    )

    user_id: Mapped[str] = mapped_column(
        String(36),
        ForeignKey("users.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
    )
    catalog_item_id: Mapped[str] = mapped_column(
        String(36),
        ForeignKey("catalog_items.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
    )

    format: Mapped[str] = mapped_column(String(20), nullable=False)  # ebook | audiobook
    status: Mapped[str] = mapped_column(
        String(20), nullable=False
    )  # available | hold | not_owned

    copies_available: Mapped[int | None] = mapped_column(Integer, nullable=True)
    copies_total: Mapped[int | None] = mapped_column(Integer, nullable=True)
    holds: Mapped[int | None] = mapped_column(Integer, nullable=True)

    deep_link: Mapped[str | None] = mapped_column(String(500), nullable=True)

    last_checked_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False
    )

    __table_args__ = (
        UniqueConstraint(
            "user_id", "catalog_item_id", "format", name="uq_avail_user_item_format"
        ),
    )
</file>

<file path="services/api/app/models/user.py">
from __future__ import annotations

from datetime import datetime, timezone
from uuid import uuid4

from app.models.base import Base
from sqlalchemy import Boolean, DateTime, String
from sqlalchemy.orm import Mapped, mapped_column, relationship


def utcnow() -> datetime:
    return datetime.now(timezone.utc)


class User(Base):
    __tablename__ = "users"

    id: Mapped[str] = mapped_column(
        String(36), primary_key=True, default=lambda: str(uuid4())
    )
    email: Mapped[str] = mapped_column(
        String(320), unique=True, index=True, nullable=False
    )
    password_hash: Mapped[str] = mapped_column(String(255), nullable=False)

    is_active: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)

    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), default=utcnow, nullable=False
    )

    settings = relationship(
        "UserSettings",
        back_populates="user",
        uselist=False,
        cascade="all, delete-orphan",
    )
    shelf_sources = relationship(
        "ShelfSource", back_populates="user", cascade="all, delete-orphan"
    )
    shelf_items = relationship(
        "ShelfItem", back_populates="user", cascade="all, delete-orphan"
    )
    sync_runs = relationship(
        "SyncRun", back_populates="user", cascade="all, delete-orphan"
    )
</file>

<file path="services/api/app/schemas/shelf.py">
from __future__ import annotations

from datetime import datetime

from pydantic import BaseModel, Field


class ImportErrorOut(BaseModel):
    key: str
    error: str


class ImportSummaryOut(BaseModel):
    created: int
    updated: int
    skipped: int
    errors: list[ImportErrorOut] = Field(default_factory=list)


class ShelfSourceOut(BaseModel):
    id: str
    source_type: str
    provider: str
    source_ref: str
    meta: dict
    is_active: bool
    last_synced_at: datetime | None
    last_sync_status: str | None
    last_sync_error: str | None

    class Config:
        from_attributes = True


class ShelfItemOut(BaseModel):
    id: str
    title: str
    author: str
    isbn10: str | None
    isbn13: str | None
    asin: str | None
    shelf: str | None
    needs_fuzzy_match: bool

    class Config:
        from_attributes = True


class RssConnectIn(BaseModel):
    rss_url: str
    shelf: str | None = "to-read"
    sync_now: bool = True


class SyncEnqueuedOut(BaseModel):
    job_id: str
</file>

<file path="services/api/app/services/goodreads_csv.py">
from __future__ import annotations

import csv
import io

from app.services.normalization import normalize_isbn


class CsvImportError(Exception):
    pass


def parse_goodreads_csv(content: bytes) -> tuple[list[dict], list[dict]]:
    """Return (rows, errors).

    Each row dict is normalized to the same shape consumed by the ingest layer.
    """
    errors: list[dict] = []

    try:
        text = content.decode("utf-8-sig")
    except UnicodeDecodeError:
        raise CsvImportError(
            "CSV must be UTF-8 encoded (Goodreads export is usually UTF-8)."
        )

    reader = csv.DictReader(io.StringIO(text))
    required = {"Title", "Author"}

    if not reader.fieldnames or not required.issubset(set(reader.fieldnames)):
        raise CsvImportError(
            "CSV is missing required columns. Expected at least: Title, Author. "
            "Tip: export from Goodreads: My Books ‚Üí Import and Export ‚Üí Export Library."
        )

    out: list[dict] = []
    for i, row in enumerate(reader, start=2):  # header is line 1
        try:
            title = (row.get("Title") or "").strip()
            author = (row.get("Author") or "").strip()
            if not title or not author:
                errors.append({"line": i, "error": "Missing Title/Author"})
                continue

            external_id = (row.get("Book Id") or "").strip() or None
            isbn10 = normalize_isbn(row.get("ISBN"))
            isbn13 = normalize_isbn(row.get("ISBN13"))
            shelf = (row.get("Exclusive Shelf") or "").strip() or None

            out.append(
                {
                    "external_id": external_id,
                    "title": title,
                    "author": author,
                    "isbn10": isbn10,
                    "isbn13": isbn13,
                    "asin": None,
                    "shelf": shelf,
                }
            )
        except Exception as e:
            errors.append({"line": i, "error": f"Unexpected row error: {e}"})

    return out, errors
</file>

<file path="services/api/app/services/goodreads_rss.py">
from __future__ import annotations

from dataclasses import dataclass
from typing import Iterable
from urllib.parse import urljoin, urlparse
from xml.etree import ElementTree as ET

import httpx
from app.core.config import settings
from app.services.normalization import normalize_isbn


@dataclass(frozen=True)
class GoodreadsRssItem:
    external_id: str | None
    title: str
    author: str
    isbn10: str | None
    isbn13: str | None
    asin: str | None
    shelf: str | None


def _local(tag: str) -> str:
    # "{namespace}name" -> "name"
    return tag.split("}", 1)[-1]


def _child_text(item: ET.Element, wanted: Iterable[str]) -> str | None:
    wanted = {w.lower() for w in wanted}
    for child in item:
        if _local(child.tag).lower() in wanted:
            if child.text:
                return child.text.strip()
    return None


def _split_title_author(title: str) -> tuple[str, str]:
    # Many feeds format title as: "Book Title by Author"
    if " by " in title:
        t, a = title.rsplit(" by ", 1)
        return t.strip(), a.strip()
    return title.strip(), ""


def parse_goodreads_rss(
    xml_text: str, default_shelf: str | None = None
) -> list[GoodreadsRssItem]:
    try:
        root = ET.fromstring(xml_text)
    except ET.ParseError as e:
        raise ValueError(f"Invalid RSS XML: {e}")

    items: list[GoodreadsRssItem] = []

    # RSS can be rss/channel/item OR feed/entry (be tolerant)
    for node in root.iter():
        if _local(node.tag).lower() in {"item", "entry"}:
            title = _child_text(node, ["book_title", "title"]) or ""
            author = _child_text(node, ["author_name", "creator", "dc:creator"]) or ""
            guid = _child_text(node, ["guid", "book_id", "id"])  # prefer stable ID

            isbn = normalize_isbn(_child_text(node, ["isbn"]))
            isbn13 = normalize_isbn(_child_text(node, ["isbn13"]))
            asin = normalize_isbn(_child_text(node, ["asin"]))

            # If title exists but author doesn't, attempt split fallback
            if title and not author:
                t2, a2 = _split_title_author(title)
                title, author = t2, (author or a2)

            if not title:
                # Skip empty items instead of crashing
                continue

            items.append(
                GoodreadsRssItem(
                    external_id=(guid.strip() if guid else None),
                    title=title.strip(),
                    author=author.strip() or "Unknown",
                    isbn10=isbn if isbn and len(isbn) <= 10 else None,
                    isbn13=(
                        isbn13
                        if isbn13
                        else (isbn if isbn and len(isbn) == 13 else None)
                    ),
                    asin=asin,
                    shelf=default_shelf,
                )
            )

    return items


def normalize_rss_input_url(rss_url_or_path: str) -> str:
    s = (rss_url_or_path or "").strip()
    if not s:
        raise ValueError("RSS URL is required")

    # Full URL
    if s.startswith("http://") or s.startswith("https://"):
        u = urlparse(s)
        if not u.scheme or not u.netloc:
            raise ValueError("Invalid RSS URL")
        return s

    # Treat as path relative to base
    base_url = settings.goodreads_base_url
    if not base_url:
        raise ValueError("GOODREADS_BASE_URL is not configured")
    base = base_url.rstrip("/") + "/"
    return urljoin(base, s.lstrip("/"))


async def fetch_rss(url: str) -> str:
    timeout = float(settings.goodreads_fetch_timeout_secs)
    async with httpx.AsyncClient(
        timeout=timeout,
        follow_redirects=True,
        headers={"User-Agent": settings.user_agent},
    ) as client:
        res = await client.get(url)
        res.raise_for_status()
        return res.text
</file>

<file path="services/api/app/services/import_service.py">
from __future__ import annotations

from dataclasses import dataclass

from app.domain.normalize import build_normalized
from app.models.shelf_item import ShelfItem
from sqlalchemy.orm import Session


@dataclass
class ImportSummary:
    created: int
    updated: int
    skipped: int
    errors: list[str]


def upsert_shelf_items(
    *,
    db: Session,
    user_id: str,
    shelf_source_id: str | None,
    items: list[dict],
    errors: list[str] | None = None,
) -> ImportSummary:
    errors_out = list(errors or [])

    def _external_id(item: dict) -> str | None:
        raw = item.get("external_id") or item.get("goodreads_book_id")
        if raw is None:
            return None
        value = str(raw).strip()
        return value or None

    ext_ids = [ext for ext in (_external_id(it) for it in items) if ext]
    existing_by_ext: dict[str, ShelfItem] = {}
    if ext_ids:
        query = db.query(ShelfItem).filter(ShelfItem.user_id == user_id)
        if shelf_source_id is None:
            query = query.filter(ShelfItem.shelf_source_id.is_(None))
        else:
            query = query.filter(ShelfItem.shelf_source_id == shelf_source_id)
        existing = query.filter(ShelfItem.external_id.in_(ext_ids)).all()
        existing_by_ext = {it.external_id: it for it in existing if it.external_id}

    created = updated = skipped = 0

    for it in items:
        title = (it.get("title") or "").strip()
        author = (it.get("author") or "").strip()

        if not title or not author:
            skipped += 1
            errors_out.append("Skipped item missing title/author")
            continue

        isbn13 = it.get("isbn13")
        isbn10 = it.get("isbn10")

        # RSS provides a single "isbn" sometimes; treat as isbn10/13 raw.
        if not isbn13 and not isbn10 and it.get("isbn"):
            raw_isbn = it.get("isbn")
            if raw_isbn and len(str(raw_isbn).strip()) >= 10:
                # Best-effort: put into isbn13 if it looks 13 digits, else isbn10.
                s = str(raw_isbn).strip()
                if len("".join([c for c in s if c.isdigit()])) >= 13:
                    isbn13 = s
                else:
                    isbn10 = s

        asin = it.get("asin")
        external_id = _external_id(it)

        norm = build_normalized(
            title=title,
            author=author,
            isbn13=isbn13,
            isbn10=isbn10,
            asin=asin,
        )

        existing_item = existing_by_ext.get(external_id) if external_id else None
        if existing_item:
            # Update key fields (keep this conservative).
            existing_item.title = title
            existing_item.author = author
            existing_item.isbn13 = norm.isbn13
            existing_item.isbn10 = norm.isbn10
            existing_item.asin = norm.asin
            existing_item.normalized_title = norm.normalized_title
            existing_item.normalized_author = norm.normalized_author
            existing_item.needs_fuzzy_match = norm.needs_fuzzy_match
            existing_item.shelf_source_id = shelf_source_id
            existing_item.external_id = external_id
            existing_item.shelf = it.get("shelf")

            updated += 1
            continue

        new_item = ShelfItem(
            user_id=user_id,
            shelf_source_id=shelf_source_id,
            external_id=external_id,
            title=title,
            author=author,
            isbn13=norm.isbn13,
            isbn10=norm.isbn10,
            asin=norm.asin,
            normalized_title=norm.normalized_title,
            normalized_author=norm.normalized_author,
            shelf=it.get("shelf"),
            needs_fuzzy_match=norm.needs_fuzzy_match,
        )
        db.add(new_item)
        if external_id:
            existing_by_ext[external_id] = new_item
        created += 1

    return ImportSummary(
        created=created, updated=updated, skipped=skipped, errors=errors_out
    )
</file>

<file path="services/api/.env.example">
ENV=local
API_NAME=ShelfSyncAPI

DATABASE_URL=postgresql+psycopg2://shelfsync:shelfsync@localhost:5432/shelfsync
REDIS_URL=redis://localhost:6379/0
OTEL_ENABLED=false

GOODREADS_BASE_URL=http://localhost:4010

# Demo toggles (reserved for local/dev flows)
DEMO_LOGIN_ENABLED=true
DEMO_SEED_ENABLED=false

# pydantic-settings can parse JSON lists; keep it simple in dev
CORS_ORIGINS=["http://localhost:3000"]

AUTH_SECRET_KEY=CHANGE_ME_IN_PROD
AUTH_ACCESS_TOKEN_TTL_MINUTES=10080
AUTH_COOKIE_NAME=access_token
AUTH_COOKIE_SECURE=false
AUTH_COOKIE_SAMESITE=lax
GOODREADS_FETCH_TIMEOUT_SECS=10
USER_AGENT=ShelfSync/0.1

CATALOG_PROVIDER=fixture
FIXTURE_CATALOG_PATH=app/fixtures/catalog_fixture.json
AVAILABILITY_CACHE_TTL_SECS=300
RATE_LIMIT_WINDOW_SECS=60
RATE_LIMIT_DASHBOARD_PER_WINDOW=30
RATE_LIMIT_BOOKS_PER_WINDOW=60
</file>

<file path="apps/web/src/app/dashboard/page.tsx">
import Link from "next/link";

import { NotificationBell } from "@/components/NotificationBell";
import { apiFetch } from "@/lib/api";
import { compareReadNext, readNextTooltip, type ReadNext } from "@/lib/readNext";


type MatchMini = {
  catalog_item_id: string;
  provider: string;
  provider_item_id: string;
  method: string;
  confidence: number;
};

type Availability = {
  format: string;
  status: "available" | "hold" | "not_owned";
  copies_available: number | null;
  copies_total: number | null;
  holds: number | null;
  deep_link: string | null;
  last_checked_at: string;
};

type DashboardRow = {
  shelf_item_id: string;
  title: string;
  author: string | null;
  shelf: string | null;
  needs_fuzzy_match: boolean;
  match: MatchMini | null;
  availability: Availability[];
  read_next: ReadNext;
};

type DashboardResponse = {
  settings: {
    library_system: string | null;
    preferred_formats: string[];
    updated_at: string;
  };
  last_sync: {
    source_type: string | null;
    source_id: string | null;
    last_synced_at: string | null;
    last_sync_status: string | null;
    last_sync_error: string | null;
  };
  page: {
    limit: number;
    offset: number;
    total: number;
  };
  items: DashboardRow[];
};

type SortKey = "read_next" | "availability" | "title";

type FilterKey = "all" | "available" | "hold" | "not_owned";

function availabilityStatus(row: DashboardRow): FilterKey {
  if (!row.match) return "not_owned";
  if (row.availability.some((a) => a.status === "available")) return "available";
  if (row.availability.some((a) => a.status === "hold")) return "hold";
  return "not_owned";
}

function availabilityRank(row: DashboardRow): number {
  const s = availabilityStatus(row);
  if (s === "available") return 3;
  if (s === "hold") return 2;
  if (s === "not_owned") return 1;
  return 0;
}

export default async function DashboardPage() {
  const data = await apiFetch<DashboardResponse>(`/v1/dashboard?limit=200&offset=0&sort=read_next`);

  // Default sort is Read Next
  const defaultSort: SortKey = "read_next";
  const defaultFilter: FilterKey = "all";

  const rows = [...data.items];

  const sorted = rows.sort((a, b) => {
    if (defaultSort === "read_next") return compareReadNext(a, b);
    if (defaultSort === "availability") {
      const ra = availabilityRank(a);
      const rb = availabilityRank(b);
      if (ra !== rb) return rb - ra;
      return a.title.localeCompare(b.title);
    }
    return a.title.localeCompare(b.title);
  });

  const filtered = sorted.filter((r) => {
    if (defaultFilter === "all") return true;
    return availabilityStatus(r) === defaultFilter;
  });

  return (
    <main className="p-6 max-w-6xl mx-auto">
      <div className="flex items-start justify-between gap-4">
        <div>
          <h1 className="text-2xl font-semibold">Dashboard</h1>
          <p className="text-sm text-gray-600">
            Sorted by <span className="font-medium">Read Next</span>. This ranking prioritizes
            items available now, then shorter hold queues, using your format preferences.
          </p>
          <p className="text-xs text-gray-500 mt-1">
            Tip: hover ‚ìò to see the explanation (tier, format, queue details).
          </p>
        </div>
        <NotificationBell />
        <Link href="/settings" className="px-3 py-2 rounded border text-sm hover:bg-gray-50">
          Settings
        </Link>
      </div>

      <div className="mt-4 rounded border overflow-hidden">
        <table className="w-full text-sm">
          <thead className="bg-gray-50 text-gray-700">
            <tr>
              <th className="text-left p-3">Title</th>
              <th className="text-left p-3">Shelf</th>
              <th className="text-left p-3">Availability</th>
              <th className="text-left p-3">Read Next</th>
            </tr>
          </thead>
          <tbody>
            {filtered.map((row) => {
              const status = availabilityStatus(row);
              const rnTitle = readNextTooltip(row.read_next);
              return (
                <tr key={row.shelf_item_id} className="border-t">
                  <td className="p-3">
                    <div className="flex items-center gap-2">
                      <Link href={`/books/${row.shelf_item_id}`} className="font-medium hover:underline">
                        {row.title}
                      </Link>
                      <span
                        className="text-xs text-gray-500 cursor-help"
                        title={rnTitle}
                        aria-label="Read Next explanation"
                      >
                        ‚ìò
                      </span>
                    </div>
                    {row.author ? <div className="text-gray-600">{row.author}</div> : null}
                    {row.needs_fuzzy_match ? (
                      <div className="text-xs text-amber-700 mt-1">Needs fuzzy match</div>
                    ) : null}
                  </td>
                  <td className="p-3">{row.shelf ?? "‚Äî"}</td>
                  <td className="p-3">
                    <div className="capitalize">{status.replace("_", " ")}</div>
                    {row.availability.length ? (
                      <div className="text-xs text-gray-600 mt-1">
                        {row.availability
                          .map((a) => {
                            const bits = [a.format, a.status];
                            if (a.status === "available" && a.copies_available != null) {
                              bits.push(`${a.copies_available} available`);
                            }
                            if (a.status === "hold" && a.holds != null) {
                              bits.push(`${a.holds} holds`);
                            }
                            return bits.join(" ‚Ä¢ ");
                          })
                          .join(" | ")}
                      </div>
                    ) : null}
                  </td>
                  <td className="p-3">
                    <div className="capitalize">{row.read_next.tier.replace("_", " ")}</div>
                    <div className="text-xs text-gray-600 mt-1">Score: {row.read_next.score.toFixed(1)}</div>
                    {row.read_next.best_format ? (
                      <div className="text-xs text-gray-600">Best: {row.read_next.best_format}</div>
                    ) : null}
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      <div className="mt-6 text-xs text-gray-600">
        <p>
          <span className="font-medium">How Read Next works:</span> Available now ‚Üí Holds ‚Üí Not owned.
          Within a tier, your preferred format order matters, and hold queue size breaks ties.
        </p>
      </div>
    </main>
  );
}
</file>

<file path="services/api/app/models/shelf_item.py">
from __future__ import annotations

from datetime import datetime, timezone
from uuid import uuid4

from app.models.base import Base
from sqlalchemy import Boolean, DateTime, ForeignKey, Index, String
from sqlalchemy.orm import Mapped, mapped_column, relationship


def utcnow() -> datetime:
    return datetime.now(timezone.utc)


class ShelfItem(Base):
    __tablename__ = "shelf_items"

    id: Mapped[str] = mapped_column(
        String(36), primary_key=True, default=lambda: str(uuid4())
    )

    user_id: Mapped[str] = mapped_column(
        String(36),
        ForeignKey("users.id", ondelete="CASCADE"),
        index=True,
        nullable=False,
    )

    shelf_source_id: Mapped[str | None] = mapped_column(
        String(36),
        ForeignKey("shelf_sources.id", ondelete="SET NULL"),
        index=True,
        nullable=True,
    )

    # RSS: guid/book_id; CSV: "Book Id" (stringified)
    external_id: Mapped[str | None] = mapped_column(String(120), nullable=True)

    title: Mapped[str] = mapped_column(String(600), nullable=False)
    author: Mapped[str] = mapped_column(String(400), nullable=False)

    isbn10: Mapped[str | None] = mapped_column(String(20), nullable=True)
    isbn13: Mapped[str | None] = mapped_column(String(20), nullable=True)
    asin: Mapped[str | None] = mapped_column(String(20), nullable=True)

    normalized_title: Mapped[str] = mapped_column(String(600), nullable=False)
    normalized_author: Mapped[str] = mapped_column(String(400), nullable=False)

    # A single primary shelf for now (e.g. to-read/read/currently-reading)
    shelf: Mapped[str | None] = mapped_column(String(80), nullable=True)

    needs_fuzzy_match: Mapped[bool] = mapped_column(
        Boolean, nullable=False, default=False
    )

    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), default=utcnow, nullable=False
    )
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), default=utcnow, onupdate=utcnow, nullable=False
    )

    user = relationship("User", back_populates="shelf_items")
    shelf_source = relationship("ShelfSource", back_populates="items")


# Idempotency: if an external_id exists, it must be unique per source.
# NOTE: Items without external_id can still duplicate; Phase 3 can improve with additional keys.
Index(
    "ix_shelf_items_source_external_unique",
    ShelfItem.shelf_source_id,
    ShelfItem.external_id,
    unique=True,
    postgresql_where=(ShelfItem.external_id.isnot(None)),
)
</file>

<file path="services/api/app/models/shelf_source.py">
from __future__ import annotations

from datetime import datetime, timezone
from uuid import uuid4

from app.models.base import Base
from sqlalchemy import JSON, Boolean, DateTime, ForeignKey, String
from sqlalchemy.orm import Mapped, mapped_column, relationship


def utcnow() -> datetime:
    return datetime.now(timezone.utc)


class ShelfSource(Base):
    __tablename__ = "shelf_sources"

    id: Mapped[str] = mapped_column(
        String(36), primary_key=True, default=lambda: str(uuid4())
    )
    user_id: Mapped[str] = mapped_column(
        String(36),
        ForeignKey("users.id", ondelete="CASCADE"),
        index=True,
        nullable=False,
    )

    # "rss" | "csv"
    source_type: Mapped[str] = mapped_column(String(20), nullable=False)

    # For now: only "goodreads" (later phases can add "libby" etc)
    provider: Mapped[str] = mapped_column(
        String(40), nullable=False, default="goodreads"
    )

    # RSS URL or a logical identifier for CSV imports
    source_ref: Mapped[str] = mapped_column(String(2000), nullable=False)

    # Arbitrary metadata, e.g. {"shelf": "to-read"}
    meta: Mapped[dict] = mapped_column(JSON, nullable=False, default=dict)

    is_active: Mapped[bool] = mapped_column(Boolean, nullable=False, default=True)

    # Sync metadata
    last_synced_at: Mapped[datetime | None] = mapped_column(
        DateTime(timezone=True), nullable=True
    )
    last_sync_status: Mapped[str | None] = mapped_column(
        String(30), nullable=True
    )  # "ok" | "error"
    last_sync_error: Mapped[str | None] = mapped_column(String(2000), nullable=True)

    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), default=utcnow, nullable=False
    )
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), default=utcnow, onupdate=utcnow, nullable=False
    )

    user = relationship("User", back_populates="shelf_sources")
    items = relationship(
        "ShelfItem", back_populates="shelf_source", cascade="all, delete-orphan"
    )
</file>

<file path="services/api/app/workers/jobs.py">
from __future__ import annotations

import asyncio
import inspect
import logging
from datetime import datetime, timezone

from app.crud.availability import upsert_snapshots
from app.crud.shelf_items import list_shelf_items_for_user
from app.crud.sync_runs import (
    get_sync_run,
    set_sync_run_failed,
    set_sync_run_running,
    set_sync_run_succeeded,
    update_progress,
)
from app.db.session import SessionLocal
from app.models.shelf_source import ShelfSource
from app.providers.factory import get_provider
from app.services.catalog.factory import get_provider as get_catalog_provider
from app.services.goodreads_rss import fetch_rss, parse_goodreads_rss
from app.services.matching.matcher import match_shelf_item
from app.services.matching.persist import upsert_catalog_item, upsert_match
from app.services.shelf_import import upsert_shelf_items
from app.workers.async_utils import run_async
from app.workers.events import publish_sync_event
from sqlalchemy.orm import Session
from sqlalchemy import select

from app.models.shelf_item import ShelfItem
from app.workers.events import publish_notification_event

logger = logging.getLogger(__name__)


def availability_refresh_job(sync_run_id: str) -> None:
    db: Session = SessionLocal()
    run = None
    try:
        run = get_sync_run(db, run_id=sync_run_id)
        if run is None:
            raise RuntimeError("sync run not found")

        items = list_shelf_items_for_user(db, user_id=run.user_id)
        total = len(items)

        set_sync_run_running(db, run=run, total=total)

        provider = get_provider(db, run.user_id)

        processed = 0
        batch_size = 50

        for i in range(0, total, batch_size):
            chunk = items[i : i + batch_size]
            results = provider.availability_bulk(chunk)

            upsert_snapshots(db, user_id=run.user_id, results=results)
            processed += len(chunk)


            created = upsert_snapshots(db, user_id=run.user_id, results=results)
            processed += len(chunk)

            update_progress(db, run=run, current=processed)  # typically commits

            if created:
                # Hydrate titles for nicer live notifications
                ids = [c.shelf_item_id for c in created]
                items = (
                    db.execute(select(ShelfItem.id, ShelfItem.title).where(ShelfItem.id.in_(ids)))
                    .all()
                )
                id_to_title = {sid: title for sid, title in items}

                for c in created:
                    publish_notification_event(
                        user_id=run.user_id,
                        payload={
                            "id": c.id,
                            "shelf_item_id": c.shelf_item_id,
                            "title": id_to_title.get(c.shelf_item_id, ""),
                            "format": c.format,
                        },
                    )
            publish_sync_event(
                user_id=run.user_id,
                run_id=run.id,
                type_="availability_progress",
                payload={"current": processed, "total": total},
            )

        set_sync_run_succeeded(db, run=run)
        publish_sync_event(
            user_id=run.user_id, run_id=run.id, type_="availability_done", payload={}
        )

    except Exception as e:
        logger.exception("availability_refresh_job failed")
        try:
            if run is None:
                run = get_sync_run(db, run_id=sync_run_id)
            if run is not None:
                set_sync_run_failed(db, run=run, message=str(e))
                publish_sync_event(
                    user_id=run.user_id,
                    run_id=run.id,
                    type_="availability_failed",
                    payload={"error": str(e)},
                )
        except Exception:
            logger.exception("failed to mark sync run as failed")
        raise
    finally:
        db.close()


def refresh_matching_for_user(user_id: str) -> dict:
    """Refresh catalog matching for all of a user's shelf items.

    Returns a small dict that RQ can store as the job result.
    """
    db: Session = SessionLocal()
    try:
        provider = get_catalog_provider()
        items = list_shelf_items_for_user(db, user_id=user_id)

        processed = 0
        matched = 0

        for item in items:
            processed += 1
            res = run_async(match_shelf_item(provider, item))
            if res is None:
                continue

            catalog_item = upsert_catalog_item(db, res.book)
            db.flush()  # ensure catalog_item.id is available

            upsert_match(
                db,
                user_id=user_id,
                shelf_item_id=item.id,
                catalog_item_id=catalog_item.id,
                provider=catalog_item.provider,
                method=res.method,
                confidence=res.confidence,
                evidence=res.evidence,
            )

            item.needs_fuzzy_match = False
            matched += 1

            if processed % 50 == 0:
                db.commit()

        db.commit()
        return {"processed": processed, "matched": matched}
    except Exception:
        db.rollback()
        logger.exception("refresh_matching_for_user failed", extra={"user_id": user_id})
        raise
    finally:
        db.close()


def sync_goodreads_rss(source_id: str) -> None:
    """Fetch + parse Goodreads RSS and upsert shelf items for a ShelfSource."""
    db: Session = SessionLocal()
    try:
        source = db.get(ShelfSource, source_id)
        if source is None:
            logger.warning("shelf_source_not_found", extra={"source_id": source_id})
            return

        # Mark as running (best effort)
        if hasattr(source, "last_sync_status"):
            setattr(source, "last_sync_status", "running")
        if hasattr(source, "last_sync_started_at"):
            setattr(source, "last_sync_started_at", datetime.now(timezone.utc))
        db.commit()

        # Fetch RSS - fetch_rss is async in our service, but we run inside sync worker.
        rss_coro_or_text = fetch_rss(getattr(source, "source_ref", ""))
        if inspect.isawaitable(rss_coro_or_text):
            xml_text = asyncio.run(rss_coro_or_text)
        else:
            xml_text = rss_coro_or_text  # type: ignore[assignment]

        items = parse_goodreads_rss(
            xml_text, default_shelf=getattr(source, "default_shelf", None)
        )
        payload_items = [
            {
                "external_id": it.external_id,
                "title": it.title,
                "author": it.author,
                "isbn10": it.isbn10,
                "isbn13": it.isbn13,
                "asin": it.asin,
                "shelf": it.shelf,
            }
            for it in items
        ]

        summary = upsert_shelf_items(
            db,
            user_id=str(getattr(source, "user_id")),
            source=source,
            items=payload_items,
        )

        # Mark ok
        if hasattr(source, "last_sync_status"):
            setattr(source, "last_sync_status", "ok")
        if hasattr(source, "last_synced_at"):
            setattr(source, "last_synced_at", datetime.now(timezone.utc))
        if hasattr(source, "last_sync_error"):
            setattr(source, "last_sync_error", None)
        db.commit()

        logger.info(
            "goodreads_rss_synced",
            extra={
                "source_id": source_id,
                "user_id": str(getattr(source, "user_id")),
                "created": getattr(summary, "created", None),
                "updated": getattr(summary, "updated", None),
                "errors": len(getattr(summary, "errors", []) or []),
            },
        )

    except Exception as e:
        logger.exception(
            "goodreads_rss_sync_failed", extra={"source_id": source_id, "error": str(e)}
        )

        try:
            source = db.get(ShelfSource, source_id)
            if source is not None:
                if hasattr(source, "last_sync_status"):
                    setattr(source, "last_sync_status", "error")
                if hasattr(source, "last_sync_error"):
                    setattr(source, "last_sync_error", str(e))
                db.commit()
        except Exception:
            logger.exception(
                "goodreads_rss_sync_failed_marking_error",
                extra={"source_id": source_id},
            )
        raise
    finally:
        db.close()
</file>

<file path="services/api/app/workers/queue.py">
from __future__ import annotations

from app.core.config import settings
from app.workers.redis_conn import get_redis_connection
from rq import Queue, Retry
from rq.job import Job


def get_queue() -> Queue:
    conn = get_redis_connection()
    return Queue("default", connection=conn)


def enqueue_availability_refresh(*, sync_run_id: str) -> Job:
    q = get_queue()
    return q.enqueue(
        "app.workers.jobs.availability_refresh_job",
        sync_run_id,
        retry=Retry(max=2, interval=[5, 15]),
        job_timeout=settings.worker_job_timeout_secs,
    )
</file>

<file path="services/api/tests/test_auth.py">
def test_signup_sets_cookie_and_returns_user(client):
    resp = client.post(
        "/v1/auth/signup", json={"email": "a@example.com", "password": "password123"}
    )
    assert resp.status_code == 200
    body = resp.json()
    assert body["email"] == "a@example.com"
    assert "set-cookie" in resp.headers


def test_login_and_me(client):
    client.post(
        "/v1/auth/signup", json={"email": "b@example.com", "password": "password123"}
    )

    # logout to clear cookie
    client.post("/v1/auth/logout")

    resp = client.post(
        "/v1/auth/login", json={"email": "b@example.com", "password": "password123"}
    )
    assert resp.status_code == 200

    me = client.get("/v1/auth/me")
    assert me.status_code == 200
    assert me.json()["email"] == "b@example.com"


def test_me_requires_auth(client):
    resp = client.get("/v1/auth/me")
    assert resp.status_code in (401, 403)


def test_login_rejects_bad_password(client):
    client.post(
        "/v1/auth/signup", json={"email": "c@example.com", "password": "password123"}
    )
    resp = client.post(
        "/v1/auth/login", json={"email": "c@example.com", "password": "wrongwrong"}
    )
    assert resp.status_code in (401, 403)


def test_login_accepts_legacy_pbkdf2_hash(client, db_session):
    from app.models.user import User
    from passlib.context import CryptContext

    legacy_context = CryptContext(schemes=["pbkdf2_sha256"], deprecated="auto")
    db_session.add(
        User(
            email="legacy@example.com", password_hash=legacy_context.hash("password123")
        )
    )
    db_session.flush()

    resp = client.post(
        "/v1/auth/login",
        json={"email": "legacy@example.com", "password": "password123"},
    )
    assert resp.status_code == 200


def test_login_auto_creates_demo_user(client):
    resp = client.post(
        "/v1/auth/login", json={"email": "demo@example.com", "password": "password123"}
    )
    assert resp.status_code == 200
    assert resp.json()["email"] == "demo@example.com"


def test_login_auto_creates_demo_user_with_simple_password(client):
    resp = client.post(
        "/v1/auth/login", json={"email": "demo@example.com", "password": "password"}
    )
    assert resp.status_code == 200
    assert resp.json()["email"] == "demo@example.com"
</file>

<file path="services/api/requirements.txt">
fastapi
uvicorn[standard]
httpx
requests
beautifulsoup4
selectolax
playwright
selenium
python-dotenv
pydantic

sqlalchemy
alembic
psycopg2-binary
redis
rq
celery
apscheduler
passlib[bcrypt]
bcrypt<4

opentelemetry-api
opentelemetry-sdk
opentelemetry-instrumentation-fastapi
opentelemetry-instrumentation-httpx
opentelemetry-exporter-otlp

python-jose[cryptography]
pydantic-settings
email-validator
python-multipart
APScheduler==3.11.2
</file>

<file path="pyproject.toml">
[tool.pytest.ini_options]
addopts = "-q"
asyncio_mode = "auto"
asyncio_default_fixture_loop_scope = "function"
pythonpath = ["services/api"]

[tool.black]
line-length = 88

[tool.isort]
profile = "black"
</file>

<file path="README.md">
# ShelfSync

ShelfSync links your Goodreads shelves to your local library catalog (Libby/OverDrive-backed) and shows availability in one place.

## Monorepo layout

- `apps/web`: Next.js UI
- `services/api`: FastAPI API
- `infra`: Docker Compose for API + Postgres + Redis
- `docs`: architecture notes + ADRs

## Phase 0: local dev

### Prereqs
- Docker
- Node.js 24
- Python 3.14

### Backing services

Alembic, the API, and many dev workflows rely on Postgres (plus Redis and the Goodreads mock when those APIs are called). Start the backing services before running database commands or starting the API.

```bash
make infra-up
# or: docker compose -f infra/docker-compose.yml up -d
```

When done, tear them down to free resources:

```bash
make infra-down
# or: docker compose -f infra/docker-compose.yml down
```

### First-time setup

#### Local env vars

Load the API env vars into your shell before running CLI tools like `rq` or `redis-cli`:

```bash
source scripts/dev-env.sh
# or: eval "$(scripts/dev-env.sh --print)"
```

#### API

```bash
cd services/api
python -m venv .venv
source .venv/bin/activate
pip install -r requirements-dev.txt
pytest
```

#### Migrations

Make sure the backing services described above are running before applying migrations.

Use the repo wrapper so Alembic runs with the `services/api/.venv` interpreter:
If `alembic` resolves to `/opt/homebrew/bin/alembic`, you're using the Homebrew
install (Python 3.11) and will hit `psycopg2` import errors.

```bash
cd services/api
./bin/alembic upgrade head
```

Generate new migrations once the database is at head.
If you see `Target database is not up to date`, run `./bin/alembic upgrade head`
before autogenerating.

```bash
cd services/api
./bin/alembic revision --autogenerate -m "phase1 init schema"
```

From the repo root:

```bash
make api-alembic ARGS="revision --autogenerate -m 'phase1 init schema'"
```
</file>

<file path="services/api/app/core/config.py">
from __future__ import annotations

from typing import Literal

from pydantic import Field
from pydantic_settings import BaseSettings, SettingsConfigDict


class Settings(BaseSettings):
    model_config = SettingsConfigDict(
        env_file=".env", env_file_encoding="utf-8", extra="ignore"
    )

    env: str = Field(default="local", validation_alias="ENV")
    api_name: str = Field(default="ShelfSync API", validation_alias="API_NAME")

    database_url: str = Field(
        default="sqlite:///./app.db", validation_alias="DATABASE_URL"
    )
    redis_url: str = Field(
        default="redis://localhost:6379/0", validation_alias="REDIS_URL"
    )

    cors_origins: list[str] = Field(
        default_factory=lambda: ["http://localhost:3000"],
        validation_alias="CORS_ORIGINS",
    )

    auth_secret_key: str = Field(
        default="dev-secret", validation_alias="AUTH_SECRET_KEY"
    )
    auth_algorithm: str = Field(default="HS256", validation_alias="AUTH_ALGORITHM")
    auth_access_token_ttl_minutes: int = Field(
        default=60 * 24 * 7, validation_alias="AUTH_ACCESS_TOKEN_TTL_MINUTES"
    )

    auth_cookie_name: str = Field(
        default="shelfsync_token", validation_alias="AUTH_COOKIE_NAME"
    )
    auth_cookie_secure: bool = Field(
        default=False, validation_alias="AUTH_COOKIE_SECURE"
    )
    auth_cookie_samesite: Literal["lax", "strict", "none"] = Field(
        default="lax", validation_alias="AUTH_COOKIE_SAMESITE"
    )

    demo_login_enabled: bool = Field(
        default=False, validation_alias="DEMO_LOGIN_ENABLED"
    )
    demo_seed_enabled: bool = Field(default=False, validation_alias="DEMO_SEED_ENABLED")

    goodreads_base_url: str = Field(
        default="https://www.goodreads.com", validation_alias="GOODREADS_BASE_URL"
    )
    goodreads_fetch_timeout_secs: int = Field(
        default=15, validation_alias="GOODREADS_FETCH_TIMEOUT_SECS"
    )
    user_agent: str = Field(default="ShelfSync/0.1", validation_alias="USER_AGENT")

    catalog_provider: str = Field(
        default="fixture", validation_alias="CATALOG_PROVIDER"
    )
    fixture_catalog_path: str = Field(
        default="app/fixtures/catalog_fixture.json",
        validation_alias="FIXTURE_CATALOG_PATH",
    )

    availability_cache_ttl_secs: int = Field(
        default=300, validation_alias="AVAILABILITY_CACHE_TTL_SECS"
    )

    rate_limit_window_secs: int = Field(
        default=60, validation_alias="RATE_LIMIT_WINDOW_SECS"
    )
    rate_limit_books_per_window: int = Field(
        default=120, validation_alias="RATE_LIMIT_BOOKS_PER_WINDOW"
    )
    rate_limit_dashboard_per_window: int = Field(
        default=60, validation_alias="RATE_LIMIT_DASHBOARD_PER_WINDOW"
    )

    worker_job_timeout_secs: int = Field(
        default=600, validation_alias="WORKER_JOB_TIMEOUT_SECS"
    )

    otel_enabled: bool = Field(default=False, validation_alias="OTEL_ENABLED")
    otel_otlp_endpoint: str | None = Field(
        default=None, validation_alias="OTEL_OTLP_ENDPOINT"
    )


settings = Settings()
</file>

<file path="services/api/app/main.py">
from __future__ import annotations

from app.api.router import api_router
from app.core.config import settings
from app.core.otel import init_otel
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.api.routes.notifications import router as notifications_router


app = FastAPI(title=settings.api_name)

app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

app.include_router(api_router)
app.include_router(notifications_router)

init_otel(app)
</file>

</files>
